<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Lystaria</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/luxon@3/build/global/luxon.min.js"></script>
  
  <link href="https://fonts.googleapis.com/css2?family=Lily+Script+One&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Symbols+2&display=swap" rel="stylesheet">
  <style>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Symbols&display=swap" rel="stylesheet">
/* =========================================================
   RESET
   ========================================================= */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

/* =========================================================
   TOKENS (BASE + GLASS MOVED TO TOP)
   ========================================================= */
:root {
  --bg-color: #07070a;
  --card-bg: rgba(255, 255, 255, 0.06);

  --text-primary: #ffffff;
  --text-secondary: #888888;

  --accent: #5b8def;
  --accent-hover: #4a7bd8;

  --success: #4caf50;
  --danger: #f44336;
  --warning: #ff9800;

  --border: rgba(255, 255, 255, 0.12);
  --shadow: rgba(0, 0, 0, 0.3);

  /* Telegram viewport height (will be set by JS) */
  --tg-viewport-height: 100vh;
  --tg-safe-top: 0px;
  --tg-safe-bottom: 0px;

  --gradient-blue: linear-gradient(135deg, #5b8def 0%, #8b7def 100%);

  /* Glass surface tokens */
  --glass-surface: rgba(255, 255, 255, 0.06);
  --glass-surface-2: rgba(255, 255, 255, 0.09);
  --glass-border: rgba(255, 255, 255, 0.14);
  --glass-border-strong: rgba(255, 255, 255, 0.22);

  --glass-shadow: rgba(0, 0, 0, 0.45);
  --glass-highlight: rgba(255, 255, 255, 0.16);

  --glass-blur: 18px;
  
  --font-heading: 'Lily Script One', sans-serif;
}

/* HEADINGS FONT DEF */
h1, h2, h3 {
  font-family: var(--font-heading);
  letter-spacing: 0.5px;
}

/* =========================================================
   GLOBAL
   ========================================================= */
html, body {
  height: 100%;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
  background: var(--bg-color);
  color: var(--text-primary);
  overflow: hidden; /* prevent the page from trying to scroll the whole viewport */
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
  position: relative;
}

/* =========================================================
   GLASS BACKDROP (MOVED TO TOP)
   ========================================================= */
body::before {
  content: "";
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: -2;
  background:
    radial-gradient(900px 700px at 50% 10%, rgba(255,255,255,0.06), transparent 65%),
    radial-gradient(1100px 900px at 50% 92%, rgba(0,0,0,0.40), transparent 62%);
  filter: blur(6px);
  opacity: 1;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: -1;

  background:
    /* Purple dominant */
    radial-gradient(900px 650px at 28% 18%, rgba(128, 0, 254, 0.34), transparent 62%),

    /* Teal/Blue dominant */
    radial-gradient(950px 720px at 76% 78%, rgba(0, 219, 255, 0.22), transparent 64%),

    /* Yellow accent - pull it into the visible "top middle" */
    radial-gradient(520px 420px at 58% 26%, rgba(246, 246, 132, 0.22), transparent 70%),

    /* Pink accent - pull it into the visible "lower middle-left" */
    radial-gradient(520px 420px at 42% 74%, rgba(224, 25, 212, 0.14), transparent 72%);

  background-blend-mode: normal;
  opacity: 1;
  filter: blur(2px) saturate(1.18);
}

/* =========================================================
   GLASS SURFACES + FALLBACK (MOVED TO TOP)
   NOTE: header intentionally NOT included to preserve your
         "transparent header fix" behavior.
   ========================================================= */
@supports ((-webkit-backdrop-filter: blur(1px)) or (backdrop-filter: blur(1px))) {
  .card,
  .bottom-nav,
  .modal,
  .quick-action,
  .form-input,
  .form-textarea,
  .form-select,
  .calendar-event,
  .calendar-no-events,
  .calendar-add-event,
  .tag-item,
  .journal-filter-bar,
  .qh-box,
  .share-code-box,
  .event-share-card,
  .log-row,
  .streak-stat,
  .settings-card {
    background: var(--glass-surface) !important;
    border: 1px solid var(--glass-border) !important;
    -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(150%);
    backdrop-filter: blur(var(--glass-blur)) saturate(150%);
    box-shadow: 0 14px 40px var(--glass-shadow);
  }

  /* stronger surfaces */
  .modal {
    background: rgba(25, 25, 32, 0.58) !important;
    border-color: rgba(255, 255, 255, 0.18) !important;
    box-shadow: 0 22px 70px rgba(0,0,0,0.65);
  }

  .bottom-nav {
    background: rgba(20, 20, 26, 0.55) !important;
    border-top: 1px solid rgba(255,255,255,0.10) !important;
    -webkit-backdrop-filter: blur(calc(var(--glass-blur) + 8px)) saturate(160%);
    backdrop-filter: blur(calc(var(--glass-blur) + 8px)) saturate(160%);
    box-shadow: 0 -10px 30px rgba(0,0,0,0.35);
  }

  /* Glass edge shine */
  .card,
  .modal,
  .calendar-event,
  .calendar-no-events,
  .calendar-add-event,
  .tag-item,
  .journal-filter-bar,
  .qh-box,
  .share-code-box,
  .event-share-card,
  .log-row,
  .streak-stat {
    position: relative;
    overflow: hidden;
  }

  .card::before,
  .modal::before,
  .calendar-event::before,
  .calendar-no-events::before,
  .calendar-add-event::before,
  .tag-item::before,
  .journal-filter-bar::before,
  .qh-box::before,
  .share-code-box::before,
  .event-share-card::before,
  .log-row::before,
  .streak-stat::before {
    content: "";
    position: absolute;
    inset: 0;
    pointer-events: none;
    border-radius: inherit;
    background: linear-gradient(
      135deg,
      rgba(255,255,255,0.18),
      rgba(255,255,255,0.06) 35%,
      rgba(255,255,255,0.00) 60%
    );
    opacity: 0.55;
    mix-blend-mode: screen;
  }

  /* Hover glow */
  .card:hover,
  .tag-item:hover,
  .calendar-event:hover {
    border-color: rgba(91, 141, 239, 0.40) !important;
    box-shadow: 0 18px 54px rgba(0,0,0,0.52);
  }

  /* Inputs */
  .form-input,
  .form-textarea,
  .form-select {
    background: rgba(255, 255, 255, 0.07) !important;
    border-color: rgba(255,255,255,0.14) !important;
    box-shadow: inset 0 1px 0 rgba(255,255,255,0.10);
  }

  .form-input:focus,
  .form-textarea:focus,
  .form-select:focus {
    border-color: rgba(91, 141, 239, 0.60) !important;
    box-shadow: 0 0 0 3px rgba(91, 141, 239, 0.18), inset 0 1px 0 rgba(255,255,255,0.12);
    background: rgba(255, 255, 255, 0.09) !important;
  }

  /* Buttons: subtle gloss */
  .btn {
    box-shadow: inset 0 1px 0 rgba(255,255,255,0.12);
  }

  .btn-secondary {
    background: rgba(255,255,255,0.08) !important;
    border: 1px solid rgba(255,255,255,0.12) !important;
    -webkit-backdrop-filter: blur(12px) saturate(150%);
    backdrop-filter: blur(12px) saturate(150%);
  }

  .btn-secondary:hover {
    background: rgba(255,255,255,0.11) !important;
    border-color: rgba(91, 141, 239, 0.35) !important;
  }

  /* Badges: glass border */
  .card-badge,
  .badge-habit-daily,
  .badge-habit-weekly,
  .badge-habit-active,
  .badge-habit-paused,
  .badge-once,
  .badge-daily,
  .badge-weekly,
  .badge-monthly,
  .badge-interval {
    border: 1px solid rgba(255,255,255,0.14) !important;
    -webkit-backdrop-filter: blur(10px) saturate(150%);
    backdrop-filter: blur(10px) saturate(150%);
  }

  /* Modal overlay */
  .modal-overlay {
    background: rgba(0,0,0,0.55) !important;
    -webkit-backdrop-filter: blur(8px);
    backdrop-filter: blur(8px);
  }

  /* FAB: glossier */
  .fab {
    box-shadow:
      0 10px 30px rgba(91, 141, 239, 0.38),
      inset 0 1px 0 rgba(255,255,255,0.22);
  }
}

@supports not ((-webkit-backdrop-filter: blur(1px)) or (backdrop-filter: blur(1px))) {
  .card,
  .bottom-nav,
  .modal,
  .calendar-event,
  .calendar-no-events,
  .calendar-add-event,
  .tag-item,
  .journal-filter-bar,
  .qh-box,
  .share-code-box,
  .event-share-card,
  .log-row,
  .streak-stat {
    background: rgba(20, 20, 26, 0.92) !important;
    border: 1px solid rgba(255, 255, 255, 0.10) !important;
  }
}

/* =========================================================
   APP LAYOUT
   ========================================================= */
#root {
  height: 100%;
  min-height: 0;
  padding-bottom: calc(96px + env(safe-area-inset-bottom));
}

.app-shell {
  height: 100%;
  display: flex;
  flex-direction: column;
}

.app-content {
  flex: 1;
  min-height: 0;                 /* critical for nested flex scrolling */
  overflow-y: auto;
  overflow-x: hidden;            /* KEY: no sideways scroll */
  -webkit-overflow-scrolling: touch;

  width: 100%;
  max-width: 100%;
  box-sizing: border-box;

  padding-top: var(--tg-safe-top, env(safe-area-inset-top, 0px));
  padding-bottom: calc(96px + var(--tg-safe-bottom, env(safe-area-inset-bottom, 0px)));

  overscroll-behavior: contain;  /* reduces iOS rubber-band weirdness */
}
/* =========================================================
   BOTTOM NAV
   ========================================================= */
.bottom-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  display: flex;
  justify-content: space-around;
  padding: 12px 0 calc(12px + var(--tg-safe-bottom, env(safe-area-inset-bottom)));
  z-index: 1000;
}

.nav-item {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  cursor: pointer;
  padding: 8px;
  color: var(--text-secondary);
  transition: all 0.2s;
  border: none;
  background: none;
}

.nav-item.active {
  color: var(--accent);
}

.nav-item-icon {
  font-size: 24px;
}

.nav-item-label {
  font-size: 11px;
  font-weight: 600;
}

/* =========================================================
   VIEW CONTAINER
   ========================================================= */
.view-container {
  display: none;
  animation: fadeIn 0.3s;
}

.view-container.active {
  display: block;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

/* =========================================================
   HEADER
   ========================================================= */
.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
  padding: 16px;
  padding-bottom: 16px;
  border-bottom: 1px solid var(--glass-border);
}

.header h1 {
  font-size: 28px;
  font-weight: 700;
  background: linear-gradient(135deg, #e019d4 0%, #8000fe 50%, #00dbff 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.toggle {
  display: flex;
  gap: 8px;
  align-items: center;
  font-size: 14px;
  color: var(--text-secondary);
  cursor: pointer;
  user-select: none;
}

.toggle-switch {
  width: 44px;
  height: 24px;
  background: var(--border);
  border-radius: 12px;
  position: relative;
  transition: background 0.2s;
}

.toggle-switch.active {
  background: var(--accent);
}

.toggle-switch::after {
  content: '';
  position: absolute;
  width: 18px;
  height: 18px;
  background: white;
  border-radius: 50%;
  top: 3px;
  left: 3px;
  transition: left 0.2s;
}

.toggle-switch.active::after {
  left: 23px;
}

/* =========================================================
   CARDS
   ========================================================= */
.card {
  border-radius: 16px;
  padding: 20px;
  margin: 0 16px 12px;
  transition: all 0.2s;
  cursor: pointer;
}

.card:hover {
  border-color: var(--accent);
  transform: translateY(-2px);
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;   /* âœ… this is the fix */
  gap: 12px;
  margin-bottom: 12px;
  overflow: visible;
}

/* keep your existing card-time, but make it wrap cleanly if you have multiple pills */
.card-time {
  display: flex;
  align-items: center;
  gap: 8px;               /* ðŸ‘ˆ this is the key fix */
  line-height: 1;
}

.card-times-inline {
  display: flex;
  align-items: center;
  gap: 6px;
}

.card-time-pill {
  padding: 2px 8px;
  font-size: 12px;
  border-radius: 999px;
  background: rgba(255, 255, 255, 0.08);
  color: var(--text-secondary);
  line-height: 1.4;
  white-space: nowrap;
}

.card-time img {
  width: 18px;
  height: 18px;
  flex: 0 0 18px;
  display: block;           /* kills baseline weirdness */
  opacity: 0.9;             /* optional: makes it match your muted text */
  transform: translateY(1px); /* optical alignment (tweak 0â€“2px) */
}

.card-badge {
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;

  display: inline-flex;
  align-items: center;
  gap: 6px;

  position: static !important;
  line-height: 1;
  white-space: nowrap;
}

/* Badge icon support */
.card-badge .badge-icon {
  width: 12px;
  height: 12px;
  object-fit: contain;
  opacity: 0.95;
  vertical-align: -0.12em;
}

/* ONCE -- Blue */
.badge-once {
  background: rgba(59, 130, 246, 0.18);
  color: #3b82f6;
}

/* DAILY -- Purple */
.badge-daily {
  background: rgba(168, 85, 247, 0.18);
  color: #a855f7;
}

/* WEEKLY -- White */
.badge-weekly {
  background: rgba(255, 255, 255, 0.25);
  color: #ffffff;
  border: 1px solid rgba(255, 255, 255, 0.35);
}

/* MONTHLY -- Pink */
.badge-monthly {
  background: rgba(236, 72, 153, 0.18);
  color: #ec4899;
}

/* INTERVAL -- Yellow */
.badge-interval {
  background: rgba(234, 179, 8, 0.22);
  color: #eab308;
}

.card-actions {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

/* =========================================================
   HABITS VIEW
   ========================================================= */
.habits-header-actions {
  display: flex;
  align-items: center;
  gap: 10px;
}

.habit-title {
  font-size: 16px;
  font-weight: 800;
  margin-bottom: 6px;
}

.habit-sub {
  color: var(--text-secondary);
  font-size: 13px;
  line-height: 1.35;
}

.habit-meta-row {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
  margin-top: 10px;
}

.badge-habit-daily {
  background: rgba(91, 141, 239, 0.15);
  color: #5b8def;
}
.badge-habit-weekly {
  background: rgba(233, 160, 72, 0.18);
  color: #e9a048;
}
.badge-habit-active {
  background: rgba(76, 175, 80, 0.15);
  color: #4caf50;
}
.badge-habit-paused {
  background: rgba(244, 67, 54, 0.12);
  color: #f44336;
}

.habit-target {
  margin-top: 10px;
  color: var(--text-secondary);
  font-size: 13px;
}

.habit-actions {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-top: 12px;
}

.habit-actions .btn {
  flex: 1;
  justify-content: center;
  min-width: 140px;
}

/* Times list inside modal */
.times-list {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

/* (Merged duplicate: keep the later "column" version) */
.times-item {
  display: flex;
  flex-direction: column;
  gap: 10px;
  width: 100%;
}

.times-item input[type="time"] {
  flex: 1;
}

.times-item .btn {
  width: auto;
  min-width: unset;
  flex: 0;
}

.times-item .form-input {
  width: 100%;
}

/* Logs list */
.logs-list {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.log-row {
  display: flex;
  flex-direction: column;
  gap: 8px;
  padding: 12px;
  border-radius: 14px;
}

.log-top {
  display: flex;
  justify-content: space-between;
  gap: 10px;
  flex-wrap: wrap;
  align-items: baseline;
}

.log-amount {
  font-weight: 800;
  color: var(--text-primary);
}

.log-time {
  color: var(--text-secondary);
  font-size: 12px;
}

.log-actions {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.log-actions .btn {
  flex: 1;
  justify-content: center;
  min-width: 120px;
}

.form-help {
  color: var(--text-secondary);
  font-size: 12px;
  line-height: 1.35;
  margin-top: 8px;
}

.modal-divider {
  height: 1px;
  background: rgba(255, 255, 255, 0.08);
  margin: 14px 0;
}

/* -------- Reading Progress -------- */
.progress-wrap {
  margin-top: 14px;
  margin-bottom: 14px;
}

.progress-top {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  gap: 12px;
  margin-bottom: 8px;
  color: var(--text-secondary);
  font-size: 13px;
}

.progress-pct {
  color: var(--text-primary);
  font-weight: 700;
  font-size: 13px;
}

.progress-bar {
  width: 100%;
  height: 10px;
  background: rgba(255, 255, 255, 0.08);
  border: 1px solid var(--border);
  border-radius: 999px;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  width: 0%;
  background: var(--gradient-blue);
  border-radius: 999px;
  transition: width 0.2s ease;
}

.book-summary {
  font-size: 13.5px;
  line-height: 1.45;
  color: var(--text-secondary);
  margin: 10px 0 12px;
  display: -webkit-box;
  -webkit-line-clamp: 8;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

/* =========================================================
   BUTTONS (MERGED: ONE BASE ONLY)
   ========================================================= */
.btn {
  border: none;
  border-radius: 12px;
  padding: 10px 14px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: transform 0.15s ease, filter 0.15s ease, box-shadow 0.15s ease, background 0.2s ease;
  display: flex;
  align-items: center;
  gap: 6px;
}

.btn:hover {
  transform: translateY(-1px);
}

.btn:active {
  transform: scale(0.95);
}

.btn-primary {
  background: var(--accent);
  color: white;
}

.btn-primary:hover {
  background: var(--accent-hover);
}

.btn-success {
  background: var(--success);
  color: white;
}

.btn-danger {
  background: var(--danger);
  color: white;
}

.btn-secondary {
  background: rgba(255, 255, 255, 0.1);
  color: var(--text-primary);
}

.btn-secondary:hover {
  background: rgba(255, 255, 255, 0.15);
}

/* -------- Reading Streak Card -------- */
.streak-row {
  display: flex;
  gap: 12px;
  margin-top: 12px;
  flex-wrap: wrap;
}

.streak-stat {
  flex: 1;
  min-width: 140px;
  padding: 12px;
  border-radius: 14px;
}

.streak-stat-label {
  font-size: 12px;
  color: var(--text-secondary);
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.4px;
  margin-bottom: 6px;
}

.streak-stat-value {
  font-size: 22px;
  font-weight: 800;
  color: var(--text-primary);
}

.streak-actions {
  margin-top: 14px;
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

/* -------- Reading Streak Button (ONLY) -------- */
.streak-actions .btn.btn-success {
  background: var(--gradient-blue);
  color: #fff;
  border: 1px solid rgba(91, 141, 239, 0.45);
  box-shadow: 0 6px 16px rgba(91, 141, 239, 0.22);
}

.streak-actions .btn.btn-success:hover {
  filter: brightness(1.08);
}

.streak-actions .btn.btn-success:active {
  transform: scale(0.96);
  filter: brightness(0.95);
}

.streak-actions .btn.btn-success:disabled {
  opacity: 0.55;
  cursor: not-allowed;
  filter: none;
  transform: none;
  box-shadow: none;
}

/* =========================================================
   FAB
   ========================================================= */
.fab {
  position: fixed;
  bottom: calc(96px + env(safe-area-inset-bottom));
  right: 24px;
  width: 56px;
  height: 56px;
  border-radius: 50%;
  background: var(--gradient-blue);
  border: none;
  color: white;
  font-size: 24px;
  cursor: pointer;
  transition: all 0.2s;
  z-index: 999;
}

.fab:hover {
  transform: scale(1.1);
}

.fab:active {
  transform: scale(0.95);
}

/* =========================================================
   MODAL
   ========================================================= */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;

  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 2000;
  animation: fadeIn 0.2s;
}

.modal {
  border-radius: 20px;
  padding: 24px;
  width: 90%;
  max-width: 500px;
  max-height: 80vh;
  overflow-y: auto;
  animation: slideUp 0.3s;
  display: flex;
  flex-direction: column;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
  flex-shrink: 0;
}

.modal-body {
  flex: 1;
  min-height: 0;
  /* scrolling */
  overflow-y: auto;
  overflow-x: hidden;
  -webkit-overflow-scrolling: touch;
  overscroll-behavior: contain;
  /* containment + spacing */
  padding: 16px 16px 24px;
  box-sizing: border-box;
  /* prevents stretching from long text/symbol runs */
  word-break: break-word;
  overflow-wrap: anywhere;
  /* ensures it never overflows viewport */
  max-height: 70vh;
}

/* Prevent background scroll when modal is open */
body.modal-open {
  overflow: hidden !important;
  position: fixed !important;
  width: 100% !important;
  height: 100% !important;
  top: 0;
  left: 0;
}

body.modal-open .app-content {
  overflow: hidden !important;
}

.modal-actions {
  display: flex;
  gap: 12px;
  margin-top: 24px;
  flex-shrink: 0;
}

@keyframes slideUp {
  from { transform: translateY(100px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.modal-header h2 {
  font-size: 24px;
  font-weight: 700;
}

.modal-close {
  background: none;
  border: none;
  color: var(--text-secondary);
  font-size: 24px;
  cursor: pointer;
  padding: 0;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: all 0.2s;
}

.modal-close:hover {
  background: rgba(255, 255, 255, 0.1);
}

/* =========================================================
   FORMS
   ========================================================= */
.form-group {
  margin-bottom: 20px;
}

.form-label {
  display: block;
  font-size: 13px;
  font-weight: 600;
  color: var(--text-secondary);
  margin-bottom: 8px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.form-input,
.form-textarea {
  width: 100%;
  padding: 12px 16px;
  border-radius: 12px;
  color: var(--text-primary);
  font-size: 15px;
  transition: all 0.2s;
}

.form-input:focus,
.form-textarea:focus {
  outline: none;
  border-color: var(--accent);
}

.form-textarea {
  resize: vertical;
  min-height: 100px;
  font-family: inherit;
}

.form-textarea.form-textarea--sm {
  min-height: 80px;
}

.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

.form-select {
  width: 100%;
  padding: 12px 16px;
  border-radius: 12px;
  color: var(--text-primary);
  font-size: 15px;
  cursor: pointer;
  transition: all 0.2s;
}

.form-select:focus {
  outline: none;
  border-color: var(--accent);
}

.modal-actions .btn {
  flex: 1;
  justify-content: center;
  padding: 12px;
}

/* ---- iOS time/date input normalization ---- */
input[type="time"].form-input,
input[type="date"].form-input {
  -webkit-appearance: none;
  appearance: none;
  height: 44px;
  line-height: 44px;
  padding-top: 0;
  padding-bottom: 0;
}

input[type="time"].form-input::-webkit-date-and-time-value,
input[type="date"].form-input::-webkit-date-and-time-value {
  height: 44px;
  line-height: 44px;
}

input[type="time"].form-input::-webkit-datetime-edit,
input[type="date"].form-input::-webkit-datetime-edit {
  padding: 0;
}

/* Checkbox row */
.checkbox-row {
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
}

/* =========================================================
   EMPTY / LOADING
   ========================================================= */
.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--text-secondary);
}

.empty-state-icon {
  font-size: 64px;
  margin-bottom: 16px;
  opacity: 0.3;
}

.empty-state-text {
  font-size: 16px;
  line-height: 1.6;
}

.loading {
  text-align: center;
  padding: 40px;
  color: var(--text-secondary);
}

.spinner {
  width: 40px;
  height: 40px;
  border: 3px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin: 0 auto 16px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.reminders-greeting {
  margin-top: 6px;
  font-size: 14px;
  opacity: 0.75;
  letter-spacing: 0.2px;
}

/* =========================================================
   CALENDAR HEADER
   ========================================================= */
.calendar-header {
  padding: 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid var(--border);
}

.calendar-month {
  font-size: 24px;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 12px;
}

.calendar-nav-btn {
  border-radius: 8px;
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  color: var(--text-primary);
  font-size: 18px;
  transition: all 0.2s;
}

.calendar-nav-btn:hover {
  border-color: var(--accent);
}

/* =========================================================
   CALENDAR VIEW
   ========================================================= */
.calendar-body {
  padding: 16px;
}

.calendar-day {
  margin-bottom: 16px;
}

.calendar-day-row {
  display: flex;
  align-items: flex-start;
  gap: 16px;
}

.calendar-datebox {
  min-width: 60px;
  text-align: center;
}

.calendar-datebox-day {
  font-size: 28px;
  font-weight: 700;
  color: #fff;
  line-height: 1;
}

.calendar-datebox-day.is-today {
  color: #5b8def;
}

.calendar-datebox-dow {
  font-size: 12px;
  color: #888;
  text-transform: uppercase;
  margin-top: 4px;
}

.calendar-events {
  flex: 1;
}

.calendar-no-events {
  border-radius: 12px;
  padding: 16px;
  color: var(--text-secondary);
  font-size: 14px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.calendar-add-icon-btn {
  background: rgba(91, 141, 239, 0.15);
  border: none;
  border-radius: 8px;
  width: 32px;
  height: 32px;
  color: #5b8def;
  font-size: 20px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.calendar-event {
  border-left: 4px solid #5b8def;
  border-radius: 12px;
  padding: 12px 16px;
  margin-bottom: 8px;
  cursor: pointer;
  transition: all 0.2s;
}

.calendar-event:hover {
  background: rgba(255, 255, 255, 0.05);
}

.calendar-event-top {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
}

.calendar-event-main {
  flex: 1;
}

.calendar-event-allday {
  display: inline-flex;
  align-items: center;
  background: rgba(76, 175, 80, 0.15);
  color: #4caf50;
  font-size: 11px;
  font-weight: 600;
  padding: 2px 8px;
  border-radius: 6px;
  margin-bottom: 4px;
}

.calendar-event-title {
  font-size: 15px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 4px;
}

.calendar-event-time {
  font-size: 13px;
  color: var(--text-secondary);
}

.calendar-event-location {
  font-size: 13px;
  color: var(--text-secondary);
  margin-top: 2px;
}

.calendar-event-delete {
  background: none;
  border: none;
  color: var(--danger);
  font-size: 18px;
  cursor: pointer;
  padding: 4px;
}

.calendar-add-event {
  border-radius: 12px;
  width: 100%;
  padding: 12px;
  color: var(--text-secondary);
  font-size: 14px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.event-reminder-dot {
  display: inline-block;
  width: 8px;
  height: 8px;
  border-radius: 999px;
  background: var(--warning);
  margin-left: 8px;
  transform: translateY(-1px);
  opacity: 0.9;
}

.calendar-header-right {
  display: flex;
  align-items: center;
  gap: 10px;
}

.icon-btn {
  border-radius: 10px;
  width: 38px;
  height: 38px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s;
}

.icon-btn:hover {
  border-color: var(--accent);
}

.icon-btn img {
  width: 18px;
  height: 18px;
  opacity: 0.9;
}

/* =========================================================
   EVENT SHARE VIEW
   ========================================================= */
.event-share-wrap {
  padding: 16px;
}

.event-share-card {
  border-radius: 16px;
  padding: 20px;
}

.event-share-title {
  font-size: 22px;
  font-weight: 800;
  margin-bottom: 6px;
}

.event-share-meta {
  font-size: 13px;
  color: var(--text-secondary);
  margin-bottom: 14px;
}

.event-share-desc {
  font-size: 15px;
  line-height: 1.6;
  margin-bottom: 16px;
}

.event-share-actions {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-top: 16px;
}

.event-share-input {
  width: 100%;
  margin-bottom: 12px;
}

.event-share-status {
  margin-top: 14px;
  font-size: 14px;
  color: var(--text-secondary);
}

.event-share-status.success {
  color: var(--success);
}

.event-share-status.error {
  color: var(--danger);
}

.event-share-actions .btn {
  flex: 1;
  justify-content: center;
}

/* =========================================================
   SHARE CODE MODAL
   ========================================================= */
.share-code-box {
  padding: 14px;
  border-radius: 14px;
}

.share-code-label {
  font-size: 12px;
  color: var(--text-secondary);
  font-weight: 800;
  text-transform: uppercase;
  letter-spacing: 0.4px;
  margin-bottom: 8px;
}

.share-code-token {
  width: 100%;
  padding: 12px 14px;
  border-radius: 12px;
  border: 1px solid var(--border);
  background: rgba(0,0,0,0.35);
  color: var(--text-primary);
  font-size: 15px;
  font-weight: 800;
  letter-spacing: 0.4px;
  word-break: break-all;
  user-select: text;
}

.share-code-help {
  margin-top: 10px;
  color: var(--text-secondary);
  font-size: 13px;
  line-height: 1.45;
}

/* Utility */
.is-hidden {
  display: none !important;
}

/* =========================================================
   JOURNAL VIEW
   ========================================================= */
.journal-header-actions {
  display: flex;
  align-items: center;
  gap: 8px;
}

.tag-row {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-top: 10px;
}

.tag-pill {
  display: inline-flex;
  align-items: center;
  padding: 6px 10px;
  border-radius: 999px;
  font-size: 12px;
  font-weight: 600;
  background: linear-gradient(135deg, #8b7def 0%, #5b8def 100%);
  color: white;
  border: 1px solid rgba(91, 141, 239, 0.45);
  box-shadow: 0 4px 10px rgba(91, 141, 239, 0.18);
}

.journal-preview {
  font-size: 14px;
  line-height: 1.5;
  color: var(--text-primary);
  white-space: pre-line;
  word-break: break-word;
  opacity: 0.95;
}

.journal-body-preview {
  display: -webkit-box;
  -webkit-line-clamp: 4;
  -webkit-box-orient: vertical;
  overflow: hidden;
  white-space: pre-line;
}

.journal-preview-actions {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.journal-preview-actions .btn {
  width: 100%;
  justify-content: center;
}

.tag-chip {
  display: inline-flex;
  align-items: center;
  padding: 6px 10px;
  border-radius: 999px;
  font-size: 12px;
  font-weight: 600;
  background: linear-gradient(135deg, #8b7def 0%, #5b8def 100%);
  color: white;
  border: 1px solid rgba(91, 141, 239, 0.45);
  margin-right: 8px;
  margin-top: 8px;
  box-shadow: 0 4px 10px rgba(91, 141, 239, 0.18);
}

.load-more-container {
  margin: 16px;
}

.btn-prompt {
  background: linear-gradient(135deg, #8b7def 0%, #5b8def 100%);
  color: white;
}

.btn-prompt:hover {
  filter: brightness(1.08);
}

.btn-prompt:active {
  transform: scale(0.96);
}

.load-more-btn {
  width: 100%;
  justify-content: center;
  padding: 12px;
}

/* -------- Journal Tags View -------- */
.tags-search {
  margin: 0 16px 16px;
}

.tags-list {
  display: flex;
  flex-direction: column;
  gap: 10px;
  padding: 0 16px 16px;
}

.tag-item {
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  padding: 14px 16px;
  border-radius: 14px;
  cursor: pointer;
  transition: all 0.2s;
}

.tag-item:hover {
  border-color: var(--accent);
  background: rgba(255, 255, 255, 0.04);
}

.tag-item-name {
  font-weight: 800;
}

.tag-item-count {
  color: var(--text-secondary);
  font-size: 13px;
  font-weight: 700;
}

.journal-filter-bar {
  margin: 0 16px 14px;
  padding: 10px 12px;
  border-radius: 14px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
}

.journal-filter-left {
  display: flex;
  align-items: center;
  gap: 10px;
  min-width: 0;
}

.journal-filter-left img {
  width: 16px;
  height: 16px;
  opacity: 0.9;
}

.journal-filter-text {
  font-size: 13px;
  color: var(--text-primary);
  font-weight: 700;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.journal-filter-clear {
  padding: 8px 10px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: rgba(255,255,255,0.06);
  color: var(--text-primary);
  font-size: 12px;
  font-weight: 800;
  cursor: pointer;
}

.journal-filter-clear:hover {
  border-color: var(--accent);
}

/* =========================================================
   DAILY INTENTION CARD
   ========================================================= */
.intention-card {
  margin: 0 16px 20px;
  padding: 20px;
  border-radius: 16px;
  background: var(--glass-surface);
  border: 1px solid var(--glass-border);
  -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(150%);
  backdrop-filter: blur(var(--glass-blur)) saturate(150%);
  box-shadow: 0 14px 40px var(--glass-shadow);
  position: relative;
  overflow: hidden;
}

.intention-card::before {
  content: "";
  position: absolute;
  inset: 0;
  pointer-events: none;
  border-radius: inherit;
  background: linear-gradient(
    135deg,
    rgba(255,255,255,0.18),
    rgba(255,255,255,0.06) 35%,
    rgba(255,255,255,0.00) 60%
  );
  opacity: 0.55;
  mix-blend-mode: screen;
}

.intention-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 14px;
}

.intention-header img {
  width: 20px;
  height: 20px;
  opacity: 0.9;
}

.intention-title {
  font-size: 16px;
  font-weight: 800;
  color: var(--text-primary);
  letter-spacing: 0.3px;
}

.intention-input-group {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.intention-textarea {
  width: 100%;
  padding: 12px 16px;
  border-radius: 12px;
  background: rgba(255, 255, 255, 0.07) !important;
  border: 1px solid rgba(255,255,255,0.14) !important;
  color: var(--text-primary);
  font-size: 15px;
  font-family: inherit;
  resize: vertical;
  min-height: 80px;
  transition: all 0.2s;
  box-shadow: inset 0 1px 0 rgba(255,255,255,0.10);
}

.intention-textarea:focus {
  outline: none;
  border-color: rgba(91, 141, 239, 0.60) !important;
  box-shadow: 0 0 0 3px rgba(91, 141, 239, 0.18), inset 0 1px 0 rgba(255,255,255,0.12);
  background: rgba(255, 255, 255, 0.09) !important;
}

.intention-textarea::placeholder {
  color: var(--text-secondary);
  opacity: 0.6;
}

.intention-display {
  position: relative;
  z-index: 1;
}

.intention-text {
  font-size: 15px;
  line-height: 1.6;
  color: var(--text-primary);
  white-space: pre-line;
  word-break: break-word;
  margin-bottom: 12px;
  padding: 12px;
  background: rgba(139, 125, 239, 0.08);
  border-left: 3px solid #8b7def;
  border-radius: 8px;
}

.intention-meta {
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-size: 12px;
  color: var(--text-secondary);
}

.intention-date {
  display: flex;
  align-items: center;
  gap: 6px;
}

.intention-date img {
  width: 14px;
  height: 14px;
  opacity: 0.8;
}

.intention-actions {
  display: flex;
  gap: 8px;
}

.intention-edit-btn {
  padding: 6px 12px;
  border-radius: 8px;
  background: rgba(255, 255, 255, 0.08);
  border: 1px solid rgba(255, 255, 255, 0.12);
  color: var(--text-primary);
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.intention-edit-btn:hover {
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(91, 141, 239, 0.35);
}

.intention-clear-btn {
  padding: 6px 12px;
  border-radius: 8px;
  background: rgba(244, 67, 54, 0.12);
  border: 1px solid rgba(244, 67, 54, 0.25);
  color: #f44336;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.intention-clear-btn:hover {
  background: rgba(244, 67, 54, 0.18);
  border-color: rgba(244, 67, 54, 0.40);
}


/* =========================================================
   ICON SYSTEM (SVG icons replacing emojis)
   ========================================================= */
img {
  max-width: 100%;
  height: auto;
}

.card-time img,
.btn img,
.nav-item-icon img,
.empty-state-icon img,
.calendar-add-icon-btn img,
.calendar-event-location img {
  display: inline-block;
  width: 1em;
  height: 1em;
  vertical-align: -0.12em;
  object-fit: contain;
}

.card-time img {
  width: 16px;
  height: 16px;
  opacity: 0.9;
}

.btn img {
  width: 16px;
  height: 16px;
}

.nav-item-icon {
  font-size: 0;
  line-height: 0;
}
.nav-item-icon img {
  width: 24px;
  height: 24px;
  opacity: 0.9;
}

.nav-item.active .nav-item-icon img {
  opacity: 1;
}

.empty-state-icon img {
  width: 64px;
  height: 64px;
  opacity: 0.3;
}

.calendar-add-icon-btn img {
  width: 18px;
  height: 18px;
}

.calendar-event-location {
  display: flex;
  align-items: center;
  gap: 8px;
}
.calendar-event-location img {
  width: 14px;
  height: 14px;
  opacity: 0.85;
}

/* =========================================================
   SETTINGS VIEW POLISH
   ========================================================= */
.settings-card {
  cursor: default !important;
  transform: none !important;
}
.settings-card:hover {
  border-color: var(--border) !important;
  box-shadow: none !important;
  transform: none !important;
}

.settings-title {
  font-size: 14px;
  font-weight: 800;
  margin-bottom: 10px;
  letter-spacing: 0.2px;
}

.settings-help {
  color: var(--text-secondary);
  font-size: 13px;
  line-height: 1.45;
  margin-bottom: 12px;
}

.settings-actions {
  margin-top: 12px;
  display: flex;
  gap: 10px;
}

.qh-box {
  margin-top: 14px;
  padding: 16px;
  border-radius: 14px;
}

.qh-title {
  font-size: 14px;
  font-weight: 800;
  margin-bottom: 8px;
}

.qh-sub {
  color: var(--text-secondary);
  font-size: 13px;
  line-height: 1.45;
  margin-bottom: 12px;
}

.qh-toggle {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  padding: 10px 12px;
  border: 1px solid var(--border);
  border-radius: 12px;
  background: rgba(255, 255, 255, 0.03);
  margin-bottom: 12px;
}

.qh-toggle label {
  display: flex;
  align-items: center;
  gap: 10px;
  cursor: pointer;
  user-select: none;
  color: var(--text-primary);
  font-weight: 600;
}

.qh-toggle input[type="checkbox"] {
  width: 18px;
  height: 18px;
}

.qh-times {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-bottom: 12px;
}

.qh-times .form-label {
  margin-bottom: 6px;
}

.qh-disabled {
  opacity: 0.55;
  pointer-events: none;
}

.qh-actions {
  display: flex;
  justify-content: flex-start;
  gap: 10px;
}

.btn.btn-sm {
  padding: 10px 14px;
  font-size: 13px;
  border-radius: 10px;
}

/* =========================================================
   PATCH: ONLY icon/utility buttons (no tag pills touched)
   Paste at VERY END
   ========================================================= */

/* iOS WebView: stop default white button rendering on icon buttons */
.icon-btn,
.calendar-nav-btn,
.calendar-add-icon-btn,
.header button {
  -webkit-appearance: none;
  appearance: none;

  background: rgba(255, 255, 255, 0.08) !important;
  border: 1px solid rgba(255, 255, 255, 0.14) !important;
  color: var(--text-primary) !important;

  -webkit-backdrop-filter: blur(14px) saturate(150%);
  backdrop-filter: blur(14px) saturate(150%);
}

/* hover polish */
.icon-btn:hover,
.calendar-nav-btn:hover,
.calendar-add-icon-btn:hover,
.header button:hover {
  background: rgba(255, 255, 255, 0.12) !important;
  border-color: rgba(91, 141, 239, 0.35) !important;
}

/* Make sure icon images donâ€™t get washed out */
.icon-btn img,
.header button img,
.calendar-add-icon-btn img {
  opacity: 0.9 !important;
}

/* Explicitly protect your colorful tags in case they are <button> */
.tag-pill,
.tag-chip {
  background: linear-gradient(135deg, #8b7def 0%, #5b8def 100%) !important;
  color: #fff !important;
  border: 1px solid rgba(91, 141, 239, 0.45) !important;
  box-shadow: 0 4px 10px rgba(91, 141, 239, 0.18) !important;
}

/* =========================================================
   COMPLETED BADGE -- PERFECT PILL (NO CLIP)
   ========================================================= */
.card-badge.badge-completed {
  display: inline-flex !important;
  align-items: center !important;
  justify-content: center !important;

  gap: 8px !important;
  white-space: nowrap !important;

  padding: 8px 14px !important;
  min-height: 32px !important;

  border-radius: 999px !important;
  line-height: 1 !important;
}

.card-badge.badge-completed .badge-icon {
  width: 14px !important;
  height: 14px !important;
  flex: 0 0 14px !important;
  display: block !important;
}

/* =========================================================
   PATCH: restore gradients + fix calendar trash + fix habits
   Paste at VERY END
   ========================================================= */

/* ---------- HEADER: Prompt + Summary must stay gradient ---------- */
/* (works whether they're .btn-prompt, .btn-summary, or just buttons with those classes) */
.btn-prompt,
.btn-summary {
  background: linear-gradient(135deg, #8b7def 0%, #5b8def 100%) !important;
  color: #ffffff !important;
  border: 1px solid rgba(91, 141, 239, 0.45) !important;
  box-shadow: 0 8px 22px rgba(91, 141, 239, 0.22) !important;
}

/* If your header rule is still overriding, this wins */
.header .btn-prompt,
.header .btn-summary,
.header button.btn-prompt,
.header button.btn-summary {
  background: linear-gradient(135deg, #8b7def 0%, #5b8def 100%) !important;
  color: #ffffff !important;
  border: 1px solid rgba(91, 141, 239, 0.45) !important;
}

/* ---------- HABITS: force your intended button colors ---------- */
/* Base: stop iOS "white default" rendering */
.habit-actions button.btn {
  -webkit-appearance: none;
  appearance: none;

  border: none !important;
  border-radius: 12px !important;

  color: #ffffff !important;
}

/* Log Session -- PURPLE */
.habit-actions button.btn-log {
  background: linear-gradient(135deg, #8000fe, #8000fe) !important;
  box-shadow: 0 8px 22px rgba(123, 108, 255, 0.45) !important;
}

/* Edit -- TEAL */
.habit-actions button.btn-edit {
  background: linear-gradient(135deg, #00dbff, #00dbff) !important;
  color: #062b2a !important;
  box-shadow: 0 8px 22px rgba(47, 212, 201, 0.45) !important;
}

/* Delete -- YELLOW */
.habit-actions button.btn-delete {
  background: linear-gradient(135deg, #f6f684, #f6f684) !important;
  color: #000001 !important;
  box-shadow: 0 8px 22px rgba(255, 102, 179, 0.45) !important;
}

/* View / Pause -- neutral glass */
.habit-actions button.btn-view,
.habit-actions button.btn-pause {
  background: rgba(255, 255, 255, 0.12) !important;
  color: rgba(255, 255, 255, 0.95) !important;
  border: 1px solid rgba(255, 255, 255, 0.18) !important;
  -webkit-backdrop-filter: blur(14px) saturate(150%);
  backdrop-filter: blur(14px) saturate(150%);
}

/* =========================
   STAR RATING (Reading Card)
   ========================= */

.book-rating-row {
  margin-top: 8px;
}

.star-rating {
  display: inline-flex;
  gap: 8px;
  align-items: center;
}

.star-btn {
  background: transparent;
  border: none;
  padding: 0;
  margin: 0;
  cursor: pointer;

  /* iOS tap + baseline fixes */
  line-height: 0;
  -webkit-tap-highlight-color: transparent;
}

.star-icon {
  /* FORCE a real box so SVGs can't collapse */
  width: 18px !important;
  height: 18px !important;
  display: block !important;

  /* default "off" look */
  opacity: 0.35;
  filter: grayscale(1);
}

.star-btn.is-on .star-icon {
  opacity: 1;
  filter: none;
}

/* Optional: small press feedback */
.star-btn:active {
  transform: scale(0.92);
}

/* =========================================================
   BOOK RECOMMENDATIONS (CHIP BUTTONS)
   ========================================================= */
.chip-row {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 12px;
}

.chip {
  padding: 8px 14px;
  border-radius: 999px;
  border: 1px solid var(--border);
  background: rgba(255, 255, 255, 0.08);
  color: var(--text-primary);
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.chip:hover {
  background: rgba(255, 255, 255, 0.12);
  border-color: var(--accent);
}

.chip.is-on {
  background: var(--accent);
  color: white;
  border-color: var(--accent);
}

/* Recommendations list */
.recs-list {
  display: flex;
  flex-direction: column;
  gap: 14px;
  margin-top: 14px;
}

.rec-card {
  padding: 14px;
  border-radius: 12px;
  background: rgba(255, 255, 255, 0.04);
  border: 1px solid var(--border);
}

.rec-title {
  font-size: 15px;
  font-weight: 700;
  margin-bottom: 4px;
  color: var(--text-primary);
}

.rec-author {
  font-size: 13px;
  color: var(--text-secondary);
  margin-bottom: 8px;
}

.rec-summary {
  font-size: 14px;
  line-height: 1.5;
  color: var(--text-primary);
  opacity: 0.9;
}

.muted {
  color: var(--text-secondary);
  font-size: 14px;
  margin-top: 10px;
}

.error-text {
  color: var(--danger);
  font-size: 14px;
  margin-top: 10px;
}

/* =========================================================
   CHECKLIST SPECIFIC STYLES
   ========================================================= */
.checklist-item-row {
  display: flex;
  align-items: center;
  gap: 12px;
}

.checklist-checkbox {
  width: 24px;
  height: 24px;
  min-width: 24px;
  border-radius: 8px;
  border: 2px solid var(--border);
  background: transparent;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  padding: 0;
}

.checklist-checkbox:hover {
  border-color: var(--accent);
}

.checklist-checkbox.done {
  background: var(--success);
  border-color: var(--success);
}

.checklist-checkbox img {
  width: 14px;
  height: 14px;
  opacity: 0;
  transition: opacity 0.2s;
}

.checklist-checkbox.done img {
  opacity: 1;
}

.checklist-text {
  flex: 1;
  font-size: 15px;
  line-height: 1.5;
  color: var(--text-primary);
  transition: all 0.2s;
  white-space: pre-wrap;
}

.checklist-text.done {
  text-decoration: line-through;
  opacity: 0.5;
}

.card.checklist-item {
  cursor: default;
}

.card.checklist-item:hover {
  transform: none;
}

/* Checklist "more/expand" icon button -- kill white overlay and match your glass style */
.checklist-expand {
  width: 44px;
  height: 44px;
  padding: 0;

  border-radius: 12px !important;

  background: rgba(255, 255, 255, 0.08) !important;
  border: 1px solid rgba(255, 255, 255, 0.12) !important;

  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);

  display: inline-flex;
  align-items: center;
  justify-content: center;

  box-shadow: none !important;
  outline: none;
  position: relative;
  overflow: hidden;
}

/* If any inherited "inner tile" overlay exists, remove it */
.checklist-expand::before,
.checklist-expand::after {
  content: none !important;
  display: none !important;
}

/* Make sure the icon renders above everything */
.checklist-expand img,
.checklist-expand svg {
  width: 18px;
  height: 18px;
  display: block;
  opacity: 0.9;

  position: relative;
  z-index: 1;
}

/* REMINDERS VIEW ICON BUTTONS */
/* Header right-side actions: stop icon buttons from clashing */
.header-actions {
  display: flex;
  align-items: center;
  gap: 10px;              /* space between the two icon buttons + toggle */
}

/* Give icon buttons a real box so they canâ€™t overlap */
.icon-btn {
  width: 38px;
  height: 38px;
  padding: 0;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  border-radius: 12px;
  flex: 0 0 auto;         /* donâ€™t shrink */
}

/* Keep the icon graphic consistent */
.icon-btn img {
  width: 18px;
  height: 18px;
  display: block;
}

/* Make trash button match the day "+": outer plate + inner tile */
.calendar-event-delete {
  width: 32px;
  height: 32px;
  padding: 0;

  /* FORCE rounded-square (overrides any global "circle" styles) */
  border-radius: 8px !important;

  /* outer plate */
  background: rgba(255, 255, 255, 0.06) !important;
  border: 1px solid rgba(255, 255, 255, 0.10) !important;
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);

  display: inline-flex;
  align-items: center;
  justify-content: center;

  position: relative;
  overflow: hidden;

  box-shadow: none !important;
  outline: none;
  transform: none;
}

/* inner tile (this is what your day "+" has) */
.calendar-event-delete::before {
  content: "";
  position: absolute;
  inset: 9px; /* controls inner tile size */
  border-radius: 11px;

  background: rgba(255, 255, 255, 0.10);
  border: 1px solid rgba(255, 255, 255, 0.12);

  /* subtle inset to look "pressed" like the + */
  box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.10);
}

/* keep the trash icon above the inner tile */
.calendar-event-delete img,
.calendar-event-delete svg {
  position: relative;
  z-index: 1;
  opacity: 0.9;
  width: 18px;
  height: 18px;
  color: #5b8def;
  font-size: 20px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* ============================
   Reminder card time row overrides
   (PUT AT BOTTOM OF CSS)
   ============================ */

/* Turn the left side into a 2-row grid:
   row 1 = icon + "Tomorrow at ..."
   row 2 = time chips under the text
*/
.card-time-row{
  display: grid;
  grid-template-columns: 18px 1fr;  /* icon col + text col */
  grid-template-rows: auto auto;    /* text row + chips row */
  column-gap: 10px;
  row-gap: 6px;                     /* space between Tomorrow line and chips */
  align-items: center;
  min-width: 0;                     /* prevent overflow weirdness */
}

/* Icon sits on the left and spans both rows */
.card-time-icon{
  grid-column: 1;
  grid-row: 1 / 3;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 18px;
  height: 18px;
}

.card-time-icon img{
  width: 16px;     /* keep it slightly smaller than its box */
  height: 16px;
  display: block;
  opacity: 0.9;
}

/* Chips UNDER the Tomorrow line */
.card-times-inline{
  grid-column: 2;
  grid-row: 2;
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  align-items: center;
  margin: 0;
  padding: 0;
}

/* Transparent "ghost pill" like the badge vibe */
.time-chip{
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 4px 10px;
  border-radius: 999px;

  font-size: 13px;
  line-height: 1;
  font-weight: 600;

  color: rgba(255, 255, 255, 0.78);

  background: rgba(255, 255, 255, 0.08);
  border: 1px solid rgba(255, 255, 255, 0.14);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
}

/* --- Fine-tune card time alignment --- */

/* Icon should align with the text line, not the whole block */
.card-time-icon{
  grid-row: 1;              /* ONLY first row now */
  align-self: center;       /* center on the Tomorrow line */
}

/* Optional: tiny nudge if you want the icon optically perfect */
.card-time-icon img{
  position: relative;
  top: 1px;                 /* optical alignment tweak */
}

/* --- Reading card: author should NOT wrap to two lines --- */

/* If your reading card uses a meta row, force it to behave */
.reading-card .book-meta,
.reading-card .book-author-row,
.reading-card .book-author {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: nowrap;
}

/* Make sure the text area can shrink (needed for ellipsis in flex) */
.reading-card .book-author,
.reading-card .book-author-text {
  min-width: 0;
  flex: 1;
}

/* Prevent wrapping + use ellipsis */
.reading-card .book-author-text,
.reading-card .book-author span,
.reading-card .book-author {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* ================================
   Journal cards: stop date wrapping
   ================================ */

/* Target the date row + common variations */
.journal-card .card-date-row,
.journal-card .entry-date-row,
.journal-card .card-date,
.journal-card .entry-date,
.card .card-date-row,
.card .entry-date-row,
.card .card-date,
.card .entry-date {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: nowrap;     /* IMPORTANT: never wrap onto 2 lines */
  min-width: 0;          /* IMPORTANT: allows ellipsis inside flex */
}

/* Date text itself */
.journal-card .card-date span,
.journal-card .entry-date span,
.card .card-date span,
.card .entry-date span {
  white-space: nowrap;   /* keep "Jan 31, 2026" on one line */
  overflow: hidden;
  text-overflow: ellipsis;
  min-width: 0;
}

/* If your date is just text without a span */
.journal-card .card-date,
.journal-card .entry-date,
.card .card-date,
.card .entry-date {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* If thereâ€™s a little calendar icon next to the date, keep it from stretching */
.journal-card .card-date-row img,
.journal-card .entry-date-row img,
.card .card-date-row img,
.card .entry-date-row img {
  flex: 0 0 auto;
}

/* =========================================
   OVERRIDES -- Card meta rows (Reminders/Journal/Reading)
   Paste at BOTTOM of CSS
   ========================================= */

/* 1) Stop the date/author from breaking onto multiple lines (Journal + Reading)
   Also add ellipsis safety so it stays clean if space is tight. */
.card-time {
  min-width: 0; /* allows ellipsis inside flex */
}

.card-time span {
  display: inline-block;
  min-width: 0;
  max-width: 100%;
  white-space: nowrap;       /* THIS fixes the two-line date/author */
  overflow: hidden;
  text-overflow: ellipsis;
  color: var(--text-primary);
}

/* Make sure the icon itself doesn't affect baseline weirdly */
.card-time img {
  width: 16px;
  height: 16px;
  display: block;
  flex: 0 0 auto;
}

/* 2) Your ReminderCard header layout (targets your real class: card-time-row)
   - icon aligned with "Tomorrow"
   - "Tomorrow..." slightly smaller
   - extra times render UNDER the Tomorrow line
   - chips look like translucent pills */
.card-time-row {
  display: flex;
  align-items: flex-start; /* top-align icon with first line of text */
  gap: 8px;
  flex-wrap: wrap;         /* lets chips drop below */
  min-width: 0;
}

.card-time-icon {
  display: inline-flex;
  align-items: flex-start;
  justify-content: center;
  width: 16px;             /* keeps alignment consistent */
  height: 16px;
  flex: 0 0 16px;
}

.card-time-icon img {
  width: 16px;
  height: 16px;
  display: block;
}

.card-time-text {
  font-size: 16px;
  font-weight: 600;
  line-height: 0.9;
}

/* Drop the times under the Tomorrow text and align them with the text start */
.card-times-inline {
  flex-basis: 100%;
  display: flex;
  gap: 4px;
  margin-left: 24px;
}

/* Pill style for additional times */
.time-chip {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 2px 5px;
  border-radius: 999px;
  font-size: 12px;
  white-space: nowrap;
  background: rgba(255, 255, 255, 0.08);
  border: 1px solid rgba(255, 255, 255, 0.12);
  color: #f6f684;
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
}

/* --- Reading card: author line --- */
.card-author {
  display: flex;
  align-items: center;        /* baseline-safe */
  gap: 6px;

  font-size: 0.9rem;
  line-height: 1.3;           /* enough for descenders */
  color: var(--text-secondary);

  overflow: visible;          /* prevent clipping */
}

.card-author img {
  width: 14px;
  height: 14px;
  flex-shrink: 0;
  opacity: 0.85;
}

.card-author span {
  line-height: 1.3;
}

/* --- Journal Card Time --- */
.card-journal-time {
  display: flex;
  align-items: center;        /* baseline-safe */
  gap: 6px;
  font-size: 0.9rem;
  line-height: 1.3;           /* enough for descenders */
  color: var(--text-secondary);
  overflow: visible;          /* prevent clipping */
}

.card-journal-time img {
  width: 16px;
  height: 16px;
  flex-shrink: 0;
  opacity: 0.85;
}

.card-journal-time span {
  line-height: 1.3;
}

/* =========================================================
MOOD LOGGING VIEW
========================================================= */

/* Mood dropdown (custom select) */
.mood-select-group {
margin-bottom: 16px;
}

.mood-dropdown-trigger {
width: 100%;
padding: 12px 16px;
border-radius: 12px;
background: rgba(255, 255, 255, 0.07);
border: 1px solid rgba(255, 255, 255, 0.14);
color: var(â€“-text-primary);
font-size: 15px;
cursor: pointer;
display: flex;
align-items: center;
justify-content: space-between;
transition: all 0.2s;
}

.mood-dropdown-trigger:focus,
.mood-dropdown-trigger.open {
border-color: rgba(91, 141, 239, 0.60);
box-shadow: 0 0 0 3px rgba(91, 141, 239, 0.18);
background: rgba(255, 255, 255, 0.09);
}

.mood-dropdown-arrow {
font-size: 12px;
opacity: 0.6;
transition: transform 0.2s;
}

.mood-dropdown-arrow.open {
transform: rotate(180deg);
}

.mood-dropdown-list {
margin-top: 8px;
max-height: 200px;
overflow-y: auto;
border-radius: 12px;
background: rgba(25, 25, 32, 0.95);
border: 1px solid rgba(255, 255, 255, 0.14);
backdrop-filter: blur(18px);
-webkit-backdrop-filter: blur(18px);
padding: 6px;
}

.mood-dropdown-option {
display: flex;
align-items: center;
gap: 10px;
padding: 10px 12px;
border-radius: 8px;
cursor: pointer;
transition: background 0.15s;
font-size: 14px;
color: var(â€“-text-primary);
}

.mood-dropdown-option:hover {
background: rgba(255, 255, 255, 0.08);
}

.mood-dropdown-option.selected {
background: rgba(91, 141, 239, 0.20);
color: var(--accent);
font-weight: 700;
}

.mood-dropdown-check {
width: 18px;
height: 18px;
border-radius: 6px;
border: 2px solid rgba(255, 255, 255, 0.25);
display: flex;
align-items: center;
justify-content: center;
flex: 0 0 18px;
transition: all 0.15s;
}

.mood-dropdown-option.selected .mood-dropdown-check {
background: var(--accent);
border-color: var(--accent);
}

/* Selected pills (bubble style) */
.mood-pills-row {
display: flex;
flex-wrap: wrap;
gap: 8px;
margin-top: 12px;
}

.mood-pill {
display: inline-flex;
align-items: center;
gap: 6px;
padding: 6px 12px;
border-radius: 999px;
font-size: 13px;
font-weight: 600;
border: 1px solid;
animation: fadeIn 0.2s;
}

.mood-pill-mood {
background: linear-gradient(135deg, rgba(139, 125, 239, 0.25), rgba(91, 141, 239, 0.20));
color: #b4a8ff;
border-color: rgba(139, 125, 239, 0.40);
}

.mood-pill-activity {
background: linear-gradient(135deg, rgba(0, 219, 255, 0.18), rgba(0, 180, 220, 0.14));
color: #66e0ff;
border-color: rgba(0, 219, 255, 0.35);
}

.mood-pill-remove {
background: none;
border: none;
color: inherit;
opacity: 0.6;
cursor: pointer;
font-size: 14px;
padding: 0;
line-height: 1;
}

.mood-pill-remove:hover {
opacity: 1;
}

/* Mood result card (shows after logging) */
.mood-result-card {
margin: 0 16px 16px;
padding: 20px;
border-radius: 16px;
background: var(--glass-surface);
border: 1px solid var(--glass-border);
backdrop-filter: blur(var(--glass-blur)) saturate(150%);
-webkit-backdrop-filter: blur(var(--glass-blur)) saturate(150%);
box-shadow: 0 14px 40px var(--glass-shadow);
position: relative;
overflow: hidden;
animation: slideUp 0.3s;
}

.mood-result-card::before {
content: "";
position: absolute;
inset: 0;
pointer-events: none;
border-radius: inherit;
background: linear-gradient(
135deg,
rgba(255,255,255,0.18),
rgba(255,255,255,0.06) 35%,
rgba(255,255,255,0.00) 60%
);
opacity: 0.55;
mix-blend-mode: screen;
}

.mood-result-title {
font-size: 18px;
font-weight: 800;
margin-bottom: 14px;
position: relative;
z-index: 1;
}

/* Mood progress / sentiment bar */
.mood-bar-wrap {
margin-bottom: 16px;
position: relative;
z-index: 1;
}

.mood-bar-labels {
display: flex;
justify-content: space-between;
font-size: 12px;
color: var(â€“-text-secondary);
margin-bottom: 8px;
}

.mood-bar-track {
width: 100%;
height: 14px;
background: rgba(255, 255, 255, 0.08);
border: 1px solid rgba(255, 255, 255, 0.12);
border-radius: 999px;
overflow: hidden;
position: relative;
}

.mood-bar-fill {
height: 100%;
border-radius: 999px;
transition: width 0.6s ease, background 0.4s ease;
}

.mood-bar-score {
text-align: center;
margin-top: 8px;
font-size: 14px;
font-weight: 700;
color: var(--text-primary);
}

/* Mood log history cards */
.mood-log-card {
margin: 0 16px 12px;
padding: 16px;
border-radius: 14px;
background: var(--glass-surface);
border: 1px solid var(--glass-border);
backdrop-filter: blur(var(--glass-blur)) saturate(150%);
-webkit-backdrop-filter: blur(var(--glass-blur)) saturate(150%);
position: relative;
overflow: hidden;
}

.mood-log-card::before {
content: "";
position: absolute;
inset: 0;
pointer-events: none;
border-radius: inherit;
background: linear-gradient(
135deg,
rgba(255,255,255,0.18),
rgba(255,255,255,0.06) 35%,
rgba(255,255,255,0.00) 60%
);
opacity: 0.55;
mix-blend-mode: screen;
}

.mood-log-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 10px;
position: relative;
z-index: 1;
}

.mood-log-date {
font-size: 13px;
color: var(--text-secondary);
display: flex;
align-items: center;
gap: 6px;
}

.mood-log-date img {
width: 14px;
height: 14px;
opacity: 0.8;
}

.mood-log-score-badge {
padding: 4px 10px;
border-radius: 999px;
font-size: 12px;
font-weight: 700;
  border: 1px solid rgba(255, 255, 255, 0.25);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
}

.mood-log-body {
position: relative;
z-index: 1;
}

.mood-log-delete {
background: none;
border: none;
color: var(--danger);
cursor: pointer;
padding: 4px;
opacity: 0.7;
transition: opacity 0.2s;
}

.mood-log-delete:hover {
opacity: 1;
}

.horoscope-card,
.horoscope-result-card {
  margin: 0 16px 16px;
}

.horoscope-form {
  display: grid;
  gap: 10px;
}

.horoscope-result-header {
  display: flex;
  align-items: baseline;
  justify-content: space-between;
  gap: 12px;
  margin-bottom: 10px;
}

.horoscope-zodiac {
  font-weight: 900;
  letter-spacing: 0.06em;
}

.horoscope-date {
  font-size: 12px;
  opacity: 0.8;
}

.horoscope-text {
  white-space: pre-line;
  line-height: 1.55;
  opacity: 0.95;
}

/* ============================================ */
/* SPECIFIC ICON BTN IMAGES */
/* ============================================ */

/* ----------- CHECKLIST PAGE BTN --------------*/
.checklist-icon-btn {
  background: rgba(91, 141, 239, 0.15);
  border: none;
  border-radius: 8px;
  width: 32px;
  height: 32px;
  color: #5b8def;
  font-size: 20px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.checklist-icon-btn img {
  width: 18px;
  height: 18px;
  flex: 0 0 18px;
  display: block;           /* kills baseline weirdness */
  opacity: 0.9;             /* optional: makes it match your muted text */
  transform: translateY(1px); /* optical alignment (tweak 0â€“2px) */
}

/* ----------- MOOD PAGE BTN -----------------*/

.mood-icon-btn {
  background: rgba(91, 141, 239, 0.15);
  border: none;
  border-radius: 8px;
  width: 32px;
  height: 32px;
  color: #5b8def;
  font-size: 20px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.mood-icon-btn img {
  width: 18px;
  height: 18px;
  flex: 0 0 18px;
  display: block;           /* kills baseline weirdness */
  opacity: 0.9;             /* optional: makes it match your muted text */
  transform: translateY(1px); /* optical alignment (tweak 0â€“2px) */
}

/* ----------- HABITS PAGE BTN -----------------*/

.habits-icon-btn {
  background: rgba(91, 141, 239, 0.15);
  border: none;
  border-radius: 8px;
  width: 32px;
  height: 32px;
  color: #5b8def;
  font-size: 20px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.habits-icon-btn img {
  width: 18px;
  height: 18px;
  flex: 0 0 18px;
  display: block;           /* kills baseline weirdness */
  opacity: 0.9;             /* optional: makes it match your muted text */
  transform: translateY(1px); /* optical alignment (tweak 0â€“2px) */
}

/* ----------- TAGS PAGE BTN -----------------*/

.tags-icon-btn {
  background: rgba(91, 141, 239, 0.15);
  border: none;
  border-radius: 8px;
  width: 32px;
  height: 32px;
  color: #5b8def;
  font-size: 20px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.tags-icon-btn img {
  width: 18px;
  height: 18px;
  flex: 0 0 18px;
  display: block;           /* kills baseline weirdness */
  opacity: 0.9;             /* optional: makes it match your muted text */
  transform: translateY(1px); /* optical alignment (tweak 0â€“2px) */
}

/* ----------- HOROSCOPE PAGE BTN --------------*/

.horoscope-icon-btn {
  background: rgba(91, 141, 239, 0.15);
  border: none;
  border-radius: 8px;
  width: 32px;
  height: 32px;
  color: #5b8def;
  font-size: 20px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.horoscope-icon-btn img {
  width: 18px;
  height: 18px;
  flex: 0 0 18px;
  display: block;           /* kills baseline weirdness */
  opacity: 0.9;             /* optional: makes it match your muted text */
  transform: translateY(1px); /* optical alignment (tweak 0â€“2px) */
}

/* =========================================================
   EVENT PREVIEW MODAL
   ========================================================= */
.event-preview-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 14px;
  font-size: 15px;
  color: var(--text-primary);
}

.event-preview-row img {
  width: 16px;
  height: 16px;
  flex: 0 0 16px;
  opacity: 0.85;
}

.event-preview-row span {
  min-width: 0;
}

.event-preview-recurrence span {
  text-transform: capitalize;
}

.event-preview-description {
  margin-top: 8px;
  padding: 12px;
  background: rgba(139, 125, 239, 0.08);
  border-left: 3px solid #8b7def;
  border-radius: 8px;
  white-space: pre-line;
  line-height: 1.6;
  font-size: 15px;
}

/* ===============================
   Event Link Button
   =============================== */

.event-link-button {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;

  padding: 8px 18px;
  border-radius: 999px;

  font-size: 14px;
  font-weight: 600;
  letter-spacing: 0.2px;

  color: var(--text-primary);
  text-decoration: none;

  background: rgba(255, 255, 255, 0.08);
  border: 1px solid rgba(255, 255, 255, 0.18);

  backdrop-filter: blur(14px) saturate(140%);
  -webkit-backdrop-filter: blur(14px) saturate(140%);

  box-shadow:
    inset 0 1px 0 rgba(255,255,255,0.15),
    0 6px 18px rgba(0,0,0,0.25);

  transition: all 0.25s ease;
}

/* subtle purple/blue glow on hover */
.event-link-button:hover {
  background: linear-gradient(
    135deg,
    rgba(139, 125, 239, 0.25),
    rgba(91, 141, 239, 0.25)
  );

  border-color: rgba(139, 125, 239, 0.55);

  transform: translateY(-1px);
  box-shadow:
    0 8px 24px rgba(91, 141, 239, 0.25),
    inset 0 1px 0 rgba(255,255,255,0.18);
}

/* active press effect */
.event-link-button:active {
  transform: translateY(0px);
  box-shadow:
    0 4px 14px rgba(0,0,0,0.3),
    inset 0 1px 0 rgba(255,255,255,0.15);
}

/* =========================================================
   REMINDER TIME-STATUS BADGES
   ========================================================= */
.badge-due-now {
  background: rgba(255, 183, 37, 0.22);
  color: #ffb725;
  animation: badgePulse 2s ease-in-out infinite;
}

.badge-upcoming {
  background: rgba(0, 219, 255, 0.18);
  color: #00dbff;
}

@keyframes badgePulse {
  0%, 100% { opacity: 1; }
  50%      { opacity: 0.65; }
}

/* =========================================================
   PLACES AUTOCOMPLETE
   ========================================================= */
.places-autocomplete-wrap {
  position: relative;
}

.places-suggestions {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  z-index: 3000;
  max-height: 220px;
  overflow-y: auto;
  margin-top: 4px;
  border-radius: 12px;
  background: rgba(25, 25, 32, 0.96);
  border: 1px solid rgba(255, 255, 255, 0.16);
  -webkit-backdrop-filter: blur(20px) saturate(160%);
  backdrop-filter: blur(20px) saturate(160%);
  box-shadow: 0 16px 48px rgba(0, 0, 0, 0.55);
}

.places-suggestion-item {
  display: flex;
  flex-direction: column;
  gap: 2px;
  padding: 10px 14px;
  cursor: pointer;
  transition: background 0.15s;
  border-bottom: 1px solid rgba(255, 255, 255, 0.06);
}

.places-suggestion-item:last-child {
  border-bottom: none;
}

.places-suggestion-item:hover {
  background: rgba(255, 255, 255, 0.08);
}

.places-suggestion-main {
  font-size: 14px;
  font-weight: 600;
  color: var(--text-primary);
}

.places-suggestion-secondary {
  font-size: 12px;
  color: var(--text-secondary);
  line-height: 1.3;
}

.places-powered {
  padding: 6px 14px;
  font-size: 10px;
  color: var(--text-secondary);
  text-align: right;
  opacity: 0.7;
}

.places-loading-row {
  padding: 12px 14px;
  font-size: 13px;
  color: var(--text-secondary);
  text-align: center;
}

.form-help {
  margin-top: 6px;
  font-size: 12px;
  line-height: 1.35;
  color: var(--text-secondary);
}

.checkbox-row--spaced {
  margin-top: 8px;
}

.event-preview-link {
  width: 100%;
  text-align: left;
  background: transparent;
  border: none;
  padding: 0;
  cursor: pointer;
}

.event-preview-link-text {
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  display: inline-block;
  max-width: 100%;
}

/* ============== CUSTOM SNOOZE ============= */

/* ============== CUSTOM SNOOZE ============= */

/* IMPORTANT: absurdly high z-index to beat any fixed FAB/header */
.csnooze-modal-overlay{
  position: fixed;
  inset: 0;
  z-index: 2147483647;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 16px;

  /* darker overlay */
  background: rgba(0,0,0,0.70);

  /* helps iOS/webview layering sometimes */
  transform: translateZ(0);
}

/* Modal itself */
.csnooze-modal{
  width: min(420px, 100%);
  border-radius: 18px;

  /* more padding + safe area helps when keyboard pushes */
  padding: 16px;
  padding-bottom: calc(16px + env(safe-area-inset-bottom));

  /* darker "glass" */
  background: rgba(18, 10, 38, 0.88);
  backdrop-filter: blur(18px);
  -webkit-backdrop-filter: blur(18px);

  border: 1px solid rgba(255,255,255,0.14);
  box-shadow: 0 30px 90px rgba(0,0,0,0.55);

  /* keep buttons reachable on small height (keyboard open) */
  max-height: calc(100vh - 32px);
  overflow: auto;

  /* make sure modal is above anything within overlay */
  position: relative;
  z-index: 2147483647;
}

.csnooze-modal-title{
  font-size: 16px;
  font-weight: 700;
  margin-bottom: 10px;
}

.csnooze-modal-row{
  display: flex;
  gap: 10px;
}

.csnooze-modal-input{
  flex: 1;
  padding: 12px;
  border-radius: 12px;
  outline: none;

  /* slightly darker input */
  background: rgba(255,255,255,0.08);
  border: 1px solid rgba(255,255,255,0.16);
  color: inherit;
}

.csnooze-modal-select{
  width: 130px;
  padding: 12px;
  border-radius: 12px;
  outline: none;

  background: rgba(255,255,255,0.08);
  border: 1px solid rgba(255,255,255,0.16);
  color: inherit;
}

.csnooze-modal-error{
  margin-top: 10px;
  font-size: 13px;
  color: rgba(255, 170, 190, 1);
}

/* Make actions stick to bottom when modal scrolls */
.csnooze-modal-actions{
  display: flex;
  gap: 10px;
  justify-content: flex-end;
  margin-top: 14px;
}

/* Hide FAB while Custom Snooze modal is open */
.csnooze-open .fab,
.csnooze-open .fab-button,
.csnooze-open .floating-action-button {
  display: none !important;
}

.csnooze-open {
  overflow: hidden;
}

/* CARD TEXT CSS */
.card-text {
  font-size: 15px;
  line-height: 1.55;
  margin-bottom: 16px;
  color: var(--text-primary);
  white-space: pre-line;
  word-break: break-word;

  /*
    Force iOS to prefer Appleâ€™s symbol-capable fonts earlier.
    This fixes "tiny / deformed" dingbat-style glyphs like âœ¦ âœ» âœ§ etc.
  */
  font-family:
    -apple-system,
    system-ui,
    "SF Pro Text",
    "SF Pro Display",
    "Apple Symbols",
    "Segoe UI Symbol",
    "Apple Color Emoji",
    "Segoe UI Emoji",
    sans-serif;

  /* iOS/Safari: stop any automatic text scaling surprises */
  -webkit-text-size-adjust: 100%;
  text-size-adjust: 100%;
  
  font-kerning: normal;
  font-variant-ligatures: none;

  /* Donâ€™t let Safari get "clever" with symbol shaping */
  text-rendering: auto;
  -webkit-font-smoothing: antialiased;
}


.reminder-card-text {
  font-size: 15px;
  line-height: 1.5;
  margin-bottom: 16px;
  color: var(--text-primary);
  white-space: pre-line;
  word-break: break-word;
}

.reminder-text-symbol {
  font-family: 'Noto Sans Symbols 2', 'Noto Sans Symbols', sans-serif;
  display: inline-block;
  line-height: 1;
  transform: translateY(1px);
}

.reminder-inline-svg {
  display: inline-block;
  vertical-align: middle;
  transform: translateY(-1px);
}

/* =========================
   MODAL: SCROLL FIX (iOS-safe)
   ========================= */

/* ===== FULL MODAL RESET FIX ===== */

.modal-overlay {
  position: fixed;
  inset: 0;
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 16px;
  background: rgba(0,0,0,0.45);
  z-index: 2000;
}

.modal {
  width: min(500px, 92vw);
  max-height: calc(100dvh - 32px); /* TRUE mobile viewport */
  border-radius: 20px;
  padding: 24px;

  display: flex;
  flex-direction: column;

  overflow-y: auto; /* THE MODAL scrolls */
  overflow-x: hidden;

  -webkit-overflow-scrolling: touch;
}

.modal-body {
  flex: 0 0 auto; /* REMOVE flex stretching */
  min-height: auto;
  overflow: visible; /* body does NOT scroll */
  padding: 0;
}

.modal-header,
.modal-actions {
  flex-shrink: 0;
}

/* ============================
   MODAL OVERRIDES (PASTE LAST)
   File: index.html
   ============================ */

/* Give the overlay some breathing room + safe-area padding */
.modal-overlay {
  padding: 16px;
  padding-top: calc(16px + env(safe-area-inset-top, 0px));
  padding-bottom: calc(16px + env(safe-area-inset-bottom, 0px));
  box-sizing: border-box;
  align-items: center;
  justify-content: center;
}

/* Make the modal a fixed-height container and prevent inner overflow spill */
.modal {
  width: min(500px, calc(100vw - 32px));
  max-height: calc(100vh - 32px - env(safe-area-inset-top, 0px) - env(safe-area-inset-bottom, 0px));
  height: auto;

  display: flex;
  flex-direction: column;

  /* IMPORTANT: contain all children; scrolling happens in .modal-body */
  overflow: hidden;
}

/* Keep header from shrinking weirdly */
.modal-header {
  flex: 0 0 auto;
  min-height: 0;
}

/* The ONLY scrolling area */
.modal-body {
  flex: 1 1 auto;
  min-height: 0;

  overflow-y: auto !important;
  overflow-x: hidden !important;
  -webkit-overflow-scrolling: touch;
  overscroll-behavior: contain;

  padding: 16px;
  padding-bottom: calc(24px + env(safe-area-inset-bottom, 0px));
  box-sizing: border-box;
}

/* Keep action buttons visible and not clipped */
.modal-actions {
  flex: 0 0 auto;
  margin-top: 0;
  padding: 16px;
  padding-top: 12px;
  box-sizing: border-box;

  /* If there isn't enough width, wrap instead of squishing */
  flex-wrap: wrap;
}

/* Prevent any child from forcing overflow */
.modal-body * {
  max-width: 100%;
  box-sizing: border-box;
}

/* Textareas/inputs/selects should never overflow the modal */
.modal-body input,
.modal-body select,
.modal-body textarea,
.modal-body button {
  max-width: 100%;
}

/* If you use the 2-col grid rows, force them to stack on small screens */
@media (max-width: 420px) {
  .modal .form-row {
    grid-template-columns: 1fr;
  }
}

/* Fix "Remove" button breaking into two lines */
.modal .btn-danger,
.modal button.btn-danger {
  white-space: nowrap;
}

/* If your extra-times rows use .times-item, make them stack cleanly */
.modal .times-item {
  flex-direction: column;
  align-items: stretch;
}

.modal .times-item button,
.modal .times-item .btn {
  align-self: flex-end;
}

/* =========================================
   FIX: Intention textarea getting clipped
   File: index.html (your main CSS)
   Paste at the very bottom
   ========================================= */

.intention-card {
  overflow: visible; /* stop clipping the textarea */
}

/* keep your glow overlay behind everything */
.intention-card::before {
  z-index: 0;
}

/* force all real content above the overlay */
.intention-header,
.intention-input-group,
.intention-display {
  position: relative;
  z-index: 1;
}

/* make sure the textarea box model never overflows */
.intention-textarea {
  box-sizing: border-box;
  display: block;
}

/* ==============================
   HARD STOP: horizontal app drift
   (keeps Telegram safe vars)
   ============================== */

/* Document never scrolls (prevents sideways panning) */
html, body {
  width: 100%;
  height: 100%;
  overflow: hidden !important;
  overscroll-behavior: none;
  touch-action: pan-y;
  margin: 0;
}

/* App shell is the fixed viewport */
.app-shell {
  position: fixed;
  inset: 0;
  width: 100vw;
  height: 100vh;
  overflow: hidden !important;
  display: flex;
  flex-direction: column;
}

/* Only this scrolls vertically */
.app-content {
  flex: 1;
  min-height: 0;

  overflow-y: auto !important;
  overflow-x: hidden !important;

  width: 100%;
  max-width: 100%;
  box-sizing: border-box;

  -webkit-overflow-scrolling: touch;
  overscroll-behavior-y: contain;
  overscroll-behavior-x: none;

  touch-action: pan-y;

  /* âœ… KEEP YOUR SAFE VARS (full-screen + safe areas) */
  padding-top: var(--tg-safe-top, env(safe-area-inset-top, 0px));
  padding-bottom: calc(96px + var(--tg-safe-bottom, env(safe-area-inset-bottom, 0px)));
}

/* Stop any child from forcing horizontal overflow */
.app-content,
.app-content * {
  max-width: 100%;
}

img, svg, video, canvas {
  max-width: 100%;
  height: auto;
}

/* Flex overflow insurance (prevents "push width" bugs) */
.app-content * {
  min-width: 0;
}

/* =========================================
   MOOD FIXES (your actual classes)
   Also fixes the broken var(â€“-...) situation by overriding
   ========================================= */

/* Your file has var(â€“-accent) etc (bad dash). Override with correct vars. */
.mood-dropdown-option.selected .mood-dropdown-check {
  background: var(--accent) !important;
  border-color: var(--accent) !important;
}

/* Mood result card uses broken var(â€“-glass-surface) in file */
.mood-result-card {
  background: var(--glass-surface) !important;
  border: 1px solid var(--glass-border) !important;
  box-shadow: 0 14px 40px var(--glass-shadow) !important;
}

/* Mood labels */
.mood-bar-labels {
  color: var(--text-secondary) !important;
}

/* Keep mood pills from causing width wobble */
.mood-pills-row {
  max-width: 100%;
}

.mood-pill {
  max-width: 100%;
  white-space: normal;
}

/* =========================================
   SETTINGS: contain cards + form rows (safe, non-destructive)
   ========================================= */

.settings-card, .qh-box, .card {
  max-width: 100%;
  overflow: hidden; /* prevents inner content pushing the card wider */
}

/* If your settings inputs are stretching wider than the card */
.settings-card input,
.settings-card textarea,
.settings-card select,
.qh-box input,
.qh-box textarea,
.qh-box select,
.form-input {
  width: 100% !important;
  max-width: 100% !important;
  box-sizing: border-box !important;
}

/* Quiet Hours rows often push sideways because of time fields */
.qh-times, .settings-row, .form-row {
  display: flex;
  gap: 12px;
  max-width: 100%;
  overflow: hidden;
}

.qh-times > *, .settings-row > *, .form-row > * {
  min-width: 0;
  max-width: 100%;
}

/* =========================================
   READING STATUS "PILLS" (actual class used)
   ========================================= */

.card-badge {
  display: inline-flex;
  align-items: center;
  gap: 8px;

  padding: 7px 12px;
  border-radius: 999px;

  font-size: 12px;
  font-weight: 800;
  letter-spacing: 0.4px;
  line-height: 1;

  /* glassy pill look */
  background: rgba(255, 255, 255, 0.10) !important;
  border: 1px solid rgba(255, 255, 255, 0.16) !important;
  -webkit-backdrop-filter: blur(10px) saturate(150%);
  backdrop-filter: blur(10px) saturate(150%);

  /* containment */
  max-width: 100%;
  white-space: nowrap;
}

.card-badge .badge-icon {
  width: 14px;
  height: 14px;
  flex: 0 0 auto;
  opacity: 0.95;
}


/* ==========================================================
LYSTARIA -- MASTER FIX PATCH
Paste this block at the VERY END of your <style> tag,
AFTER every other rule. It overrides broken sizing,
clipping, badge inconsistency, settings layout, and
the overall "too large" feel.
========================================================== */

/* â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“
1. GLOBAL SCALE-DOWN
   Everything felt too large. Pull base font down slightly
   and tighten card padding across the board.
â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“ */
body {
  font-size: 14px;
}

.card {
  padding: 16px;
  margin: 0 12px 10px;
  border-radius: 14px;
}

.header {
  padding: 12px 14px;
  margin-bottom: 18px;
}

.header h1 {
  font-size: 24px;
}

/* â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“
2. UNIFIED BADGE SYSTEM
One consistent badge style for ALL badges everywhere:
habits, reading, reminders, journal, etc.
â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“ */
.card-badge,
.badge-once,
.badge-daily,
.badge-weekly,
.badge-monthly,
.badge-interval,
.badge-habit-daily,
.badge-habit-weekly,
.badge-habit-active,
.badge-habit-paused,
.badge-completed,
.badge-due-now,
.badge-upcoming {
  display: inline-flex !important;
  align-items: center !important;
  justify-content: center !important;
  gap: 5px !important;

  padding: 4px 10px !important;
  min-height: unset !important;
  height: auto !important;

  border-radius: 999px !important;
  font-size: 10px !important;
  font-weight: 700 !important;
  letter-spacing: 0.5px !important;
  text-transform: uppercase !important;
  line-height: 1.2 !important;
  white-space: nowrap !important;

  /* Base glass look (overridden per-type below) */
  -webkit-backdrop-filter: blur(10px) saturate(140%);
  backdrop-filter: blur(10px) saturate(140%);
}

.card-badge .badge-icon {
  width: 11px !important;
  height: 11px !important;
  flex: 0 0 11px !important;
}

/* Re-apply specific badge colors at this specificity */
.badge-once {
  background: rgba(59, 130, 246, 0.18) !important;
  color: #3b82f6 !important;
}
.badge-daily {
  background: rgba(168, 85, 247, 0.18) !important;
  color: #a855f7 !important;
}
.badge-weekly {
  background: rgba(255, 255, 255, 0.15) !important;
  color: #ffffff !important;
  border: 1px solid rgba(255, 255, 255, 0.30) !important;
}
.badge-monthly {
  background: rgba(236, 72, 153, 0.18) !important;
  color: #ec4899 !important;
}
.badge-interval {
  background: rgba(234, 179, 8, 0.22) !important;
  color: #eab308 !important;
}
.badge-habit-daily {
  background: rgba(91, 141, 239, 0.15) !important;
  color: #5b8def !important;
}
.badge-habit-weekly {
  background: rgba(233, 160, 72, 0.18) !important;
  color: #e9a048 !important;
}
.badge-habit-active {
  background: rgba(76, 175, 80, 0.15) !important;
  color: #4caf50 !important;
}
.badge-habit-paused {
  background: rgba(244, 67, 54, 0.12) !important;
  color: #f44336 !important;
}
.badge-due-now {
  background: rgba(255, 183, 37, 0.22) !important;
  color: #ffb725 !important;
}
.badge-upcoming {
  background: rgba(0, 219, 255, 0.18) !important;
  color: #00dbff !important;
}

/* Completed badge -- same size system, just with icon */
.card-badge.badge-completed {
  padding: 4px 10px !important;
  min-height: unset !important;
  gap: 5px !important;
  background: rgba(76, 175, 80, 0.15) !important;
  color: #4caf50 !important;
}

/* Habits badge column -- stack them neatly */
.habit-badges {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 4px;
}

/* â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“
3. TAGS PAGE -- FIX CLIPPING
The tag items + counts were being cut off on the right.
â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“ */
.tags-list {
  padding: 0 14px 16px;
}

.tag-item {
  padding: 12px 14px;
  border-radius: 12px;
  width: 100%;
  box-sizing: border-box;
  overflow: hidden;
}

.tag-item-name {
  font-size: 14px;
  font-weight: 700;
  min-width: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  flex: 1;
}

.tag-item-count {
  font-size: 12px;
  font-weight: 700;
  flex: 0 0 auto;
  padding-left: 8px;
}

.tags-search {
  margin: 0 14px 14px;
}

/* â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“
4. SETTINGS PAGE -- QUIET HOURS LAYOUT FIX
The checkbox label was wrapping weirdly ("Enable\nQuiet\nHours")
because the toggle container was too constrained.
â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“ */
.qh-box {
  padding: 14px;
  border-radius: 12px;
  margin-top: 14px;
}

.qh-toggle {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px 12px;
  border-radius: 10px;
  margin-bottom: 12px;
}

.qh-toggle label {
  display: flex;
  align-items: center;
  gap: 10px;
  cursor: pointer;
  user-select: none;
  font-size: 14px;
  font-weight: 600;
  white-space: nowrap; /* KEY FIX: stop "Enable Quiet Hours" from wrapping */
  flex: 1;
  min-width: 0;
}

.qh-toggle input[type="checkbox"] {
  width: 18px;
  height: 18px;
  flex: 0 0 18px;
}

/* Settings card general tightening */
.settings-card {
  padding: 16px;
  margin: 0 12px 12px;
}

.settings-title {
  font-size: 13px;
  font-weight: 800;
  margin-bottom: 8px;
}

.settings-help {
  font-size: 12px;
  line-height: 1.4;
  margin-bottom: 10px;
}

.qh-title {
  font-size: 13px;
}

.qh-sub {
  font-size: 12px;
  line-height: 1.4;
  margin-bottom: 10px;
}

/* Quiet hours time inputs -- ensure they donâ€™t overflow */
.qh-times {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  max-width: 100%;
  overflow: hidden;
  margin-bottom: 10px;
}

/* â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“
5. APP CONTENT CONTAINMENT
Prevent horizontal clipping and overflow on all views.
â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“ */
.app-content {
  padding-left: 0;
  padding-right: 0;
}

/* Safety: nothing should exceed viewport */
.view-container,
.view-container > div {
  max-width: 100%;
  overflow-x: hidden;
  box-sizing: border-box;
}

/* Cards must never push past edges */
.card,
.intention-card,
.mood-result-card,
.mood-log-card,
.horoscope-card,
.horoscope-result-card,
.event-share-card,
.settings-card,
.qh-box {
  max-width: calc(100% - 24px);
  margin-left: 12px;
  margin-right: 12px;
  box-sizing: border-box;
  overflow: hidden;
}

/* â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“
6. READING PAGE -- SMOOTHER BADGES + TIGHTER CARDS
â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“ */
/* Reading card header: title + badge on same row */
.card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 10px;
  margin-bottom: 10px;
}

/* Book title */
.card-header > div:first-child > div:first-child {
  font-size: 15px;
  font-weight: 700;
  margin-bottom: 4px;
}

/* Author row */
.card-author {
  font-size: 13px;
  gap: 5px;
}

.card-author img {
  width: 12px;
  height: 12px;
}

/* Star rating -- slightly smaller */
.star-icon {
  width: 16px !important;
  height: 16px !important;
}

.star-rating {
  gap: 6px;
}

/* Book summary text */
.book-summary {
  font-size: 13px;
  line-height: 1.45;
  margin: 8px 0 10px;
}

/* Progress bar */
.progress-wrap {
  margin-top: 10px;
  margin-bottom: 10px;
}

.progress-top {
  font-size: 12px;
  margin-bottom: 6px;
}

.progress-pct {
  font-size: 12px;
}

.progress-bar {
  height: 8px;
}

/* Reading streak card */
.streak-stat {
  padding: 10px;
  border-radius: 12px;
}

.streak-stat-label {
  font-size: 11px;
  margin-bottom: 4px;
}

.streak-stat-value {
  font-size: 20px;
}

.streak-row {
  gap: 10px;
  margin-top: 10px;
}

/* â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“
7. HABITS PAGE -- TIGHTEN UP
â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“ */
.habit-title {
  font-size: 15px;
  font-weight: 800;
  margin-bottom: 4px;
}

.habit-sub {
  font-size: 12px;
}

.habit-target {
  font-size: 12px;
  margin-top: 6px;
}

.habit-actions {
  gap: 8px;
  margin-top: 10px;
}

.habit-actions .btn {
  padding: 8px 12px;
  font-size: 12px;
  min-width: 120px;
}

/* â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“
8. MOOD PAGE -- TIGHTEN
â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“ */
.mood-dropdown-trigger {
  font-size: 14px;
  padding: 10px 14px;
}

.mood-dropdown-option {
  font-size: 13px;
  padding: 8px 10px;
}

.mood-pill {
  font-size: 12px;
  padding: 4px 10px;
}

/* â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“
9. BUTTONS -- SLIGHTLY SMALLER
â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“ */
.btn {
  padding: 8px 12px;
  font-size: 12px;
  border-radius: 10px;
}

.btn-prompt,
.btn-summary {
  padding: 8px 14px;
  font-size: 12px;
}

/* Header action buttons */
.journal-header-actions {
  gap: 6px;
}

/* Icon buttons -- consistent sizing */
.checklist-icon-btn,
.mood-icon-btn,
.habits-icon-btn,
.tags-icon-btn,
.horoscope-icon-btn {
  width: 30px;
  height: 30px;
  border-radius: 8px;
}

.checklist-icon-btn img,
.mood-icon-btn img,
.habits-icon-btn img,
.tags-icon-btn img,
.horoscope-icon-btn img {
  width: 16px;
  height: 16px;
}

.icon-btn {
  width: 34px;
  height: 34px;
  border-radius: 9px;
}

.icon-btn img {
  width: 16px;
  height: 16px;
}

/* â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“
10. MODAL -- SLIGHTLY TIGHTER
â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“ */
.modal {
  padding: 20px;
  border-radius: 18px;
}

.modal-header h2 {
  font-size: 20px;
}

.modal-body {
  padding: 12px;
}

.form-label {
  font-size: 11px;
  margin-bottom: 6px;
}

.form-input,
.form-textarea,
.form-select {
  font-size: 14px;
  padding: 10px 14px;
  border-radius: 10px;
}

.form-group {
  margin-bottom: 16px;
}

/* â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“
11. BOTTOM NAV -- SLIGHTLY TIGHTER
â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“ */
.bottom-nav {
  padding: 10px 0 calc(10px + var(--tg-safe-bottom, env(safe-area-inset-bottom)));
}

.nav-item {
  gap: 3px;
  padding: 6px;
}

.nav-item-icon img {
  width: 22px;
  height: 22px;
}

.nav-item-label {
  font-size: 10px;
}

/* â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“
12. FAB -- SLIGHTLY SMALLER
â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“ */
.fab {
  width: 50px;
  height: 50px;
  font-size: 22px;
  bottom: calc(88px + env(safe-area-inset-bottom));
}

/* â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“
13. JOURNAL -- TIGHTEN CARDS
â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“ */
.journal-preview {
  font-size: 13px;
  line-height: 1.5;
}

.tag-pill,
.tag-chip {
  font-size: 11px;
  padding: 4px 8px;
}

.tag-row {
  gap: 6px;
  margin-top: 8px;
}

/* Intention card */
.intention-card {
  padding: 16px;
  margin: 0 12px 16px;
  border-radius: 14px;
}

.intention-title {
  font-size: 14px;
}

.intention-text {
  font-size: 14px;
  padding: 10px;
}

/* â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“
14. CALENDAR -- TIGHTER
â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“ */
.calendar-header {
  padding: 12px 14px;
}

.calendar-month {
  font-size: 20px;
}

.calendar-body {
  padding: 12px;
}

.calendar-datebox-day {
  font-size: 24px;
}

.calendar-event-title {
  font-size: 14px;
}

.calendar-event-time {
  font-size: 12px;
}

.calendar-event {
  padding: 10px 14px;
  border-radius: 10px;
}

/* â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“
15. REMINDER CARDS -- TIGHTEN
â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“ */
.card-time-text {
  font-size: 14px;
}

.time-chip {
  font-size: 11px;
  padding: 2px 8px;
}

.reminder-card-text,
.card-text {
  font-size: 14px;
  line-height: 1.5;
  margin-bottom: 12px;
}

/* â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“
16. REMINDERS GREETING
â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“ */
.reminders-greeting {
  font-size: 13px;
  margin-top: 4px;
}

/* â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“
17. EMPTY STATE -- SCALE DOWN
â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“ */
.empty-state {
  padding: 40px 16px;
}

.empty-state-icon img {
  width: 48px;
  height: 48px;
}

.empty-state-text {
  font-size: 14px;
}

/* â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“
18. CHECKLIST -- TIGHTEN
â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“ */
.checklist-checkbox {
  width: 22px;
  height: 22px;
  min-width: 22px;
  border-radius: 7px;
}

.checklist-text {
  font-size: 14px;
}

.checklist-expand {
  width: 38px;
  height: 38px;
}

/* ============================================
   LYSTARIA HOTFIX PATCH v2 -- Feb 11 2026
   Fixes: mood clipping, reading tab centering,
   modal containment + internal scroll
   ============================================ */

/* --- 1. MODAL CONTAINMENT + SCROLL --- */
/* All modals: cap height, scroll inside */
.modal-overlay {
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  right: 0 !important;
  bottom: 0 !important;
  z-index: 1000 !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  padding: 16px !important;
  box-sizing: border-box !important;
}

.modal,
.modal-content,
.journal-modal,
.edit-modal,
.reminder-modal,
.event-modal,
.view-modal,
.summary-modal,
.recs-modal,
.checklist-modal,
.book-modal,
.share-modal,
.event-view-modal,
.intention-modal,
.tag-modal,
.confirm-modal,
.settings-modal,
[class*="-modal"] {
  max-height: 85vh !important;
  max-width: calc(100vw - 32px) !important;
  width: 100% !important;
  overflow-y: auto !important;
  overflow-x: hidden !important;
  box-sizing: border-box !important;
  -webkit-overflow-scrolling: touch !important;
}

/* Modal inner content shouldn't fight the scroll */
.modal-body,
.modal-inner,
.modal > div {
  overflow: visible !important;
  max-height: none !important;
}

/* --- 2. MOOD PAGE CLIPPING FIX --- */
.mood-container,
.mood-section,
.mood-log-form,
.mood-content,
[class*="mood"] {
  max-width: 100% !important;
  box-sizing: border-box !important;
  overflow-x: hidden !important;
}

.mood-log-form select,
.mood-log-form textarea,
.mood-log-form input,
.mood-container select,
.mood-container textarea,
.mood-container input {
  max-width: 100% !important;
  width: 100% !important;
  box-sizing: border-box !important;
}

.mood-log-form .form-group,
.mood-log-form label,
.mood-container .form-group {
  max-width: 100% !important;
  padding-left: 12px !important;
  padding-right: 12px !important;
  box-sizing: border-box !important;
}

/* The "Log Mood" button and note textarea */
.mood-log-form button,
.mood-container button[type="submit"],
.mood-container .btn-primary {
  max-width: calc(100% - 24px) !important;
  margin-left: 12px !important;
  margin-right: 12px !important;
  box-sizing: border-box !important;
}

/* --- 4. APP-WIDE OVERFLOW GUARD --- */
html, body, #root, #app {
  max-width: 100vw !important;
  overflow-x: hidden !important;
}

.app-container,
.page-content,
.content-area,
main,
[class*="container"] {
  max-width: 100% !important;
  overflow-x: hidden !important;
  box-sizing: border-box !important;
  padding-left: 12px !important;
  padding-right: 12px !important;
}

/* Don't double-pad things already inside containers */
.card,
[class*="card"] {
  max-width: 100% !important;
  box-sizing: border-box !important;
}
/* â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“
END OF PATCH
â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“ */

/* ==========================================================
LYSTARIA -- HARD STOP PATCH (MODALS + MOOD + READING TABS + BADGES)
Paste this block at the VERY END of your <style> tag.
========================================================== */

/* ---------- 0) APP-WIDE: KILL HORIZONTAL SCROLL (keep safe vars) ---------- */
html,
body {
  width: 100%;
  max-width: 100vw;
  overflow-x: hidden !important;
}

#app,
#root,
.app-shell,
.app-content,
.view-container {
  width: 100%;
  max-width: 100vw;
  overflow-x: hidden !important;
  box-sizing: border-box;
}

img,
svg,
canvas,
video {
  max-width: 100%;
}

/* If any child tries to exceed viewport, force containment */
.view-container * {
  max-width: 100%;
  box-sizing: border-box;
}

/* Keep your safe-area behavior, but prevent side bleed */
.app-content {
  padding-top: var(--tg-safe-top, env(safe-area-inset-top, 0px));
  padding-bottom: calc(96px + var(--tg-safe-bottom, env(safe-area-inset-bottom, 0px)));
  overflow-x: hidden !important;
}

/* ---------- 1) MODALS: FIT TO SCREEN + SCROLL TO THE TRUE BOTTOM ---------- */
/* Overlay fills viewport and centers modal, with safe padding */
.modal-overlay {
  position: fixed !important;
  inset: 0 !important;
  z-index: 2000 !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  padding: calc(12px + var(--tg-safe-top, env(safe-area-inset-top, 0px))) 12px
    calc(12px + var(--tg-safe-bottom, env(safe-area-inset-bottom, 0px))) !important;
  box-sizing: border-box !important;
  overflow: hidden !important;
}

/* The modal itself must NOT scroll; the BODY inside it scrolls */
.modal,
.modal-content,
.journal-modal,
.edit-modal,
.reminder-modal,
.event-modal,
.view-modal,
.summary-modal,
.recs-modal,
.checklist-modal,
.book-modal,
.share-modal,
.event-view-modal,
.intention-modal,
.tag-modal,
.confirm-modal,
.settings-modal,
[class*="-modal"] {
  width: 100% !important;
  max-width: 520px !important;

  /* hard fit */
  max-height: calc(
    100dvh - (24px + var(--tg-safe-top, env(safe-area-inset-top, 0px)) + var(--tg-safe-bottom, env(safe-area-inset-bottom, 0px)))
  ) !important;

  display: flex !important;
  flex-direction: column !important;

  /* IMPORTANT: modal container must clip; inner area scrolls */
  overflow: hidden !important;
  overflow-x: hidden !important;

  box-sizing: border-box !important;
}

/* Make sure flex children can actually shrink (iOS safari fix) */
.modal > *,
.modal-content > *,
[class*="-modal"] > * {
  min-height: 0 !important;
}

/* Header + actions must stay visible; body is the scroll region */
.modal-header {
  flex: 0 0 auto !important;
}

.modal-actions {
  flex: 0 0 auto !important;
}

/* The scrolling region */
.modal-body,
.modal-inner,
.modal-content-body,
.modal .modal-body,
[class*="-modal"] .modal-body {
  flex: 1 1 auto !important;
  min-height: 0 !important;
  overflow-y: auto !important;
  overflow-x: hidden !important;
  -webkit-overflow-scrolling: touch !important;
  overscroll-behavior: contain !important;
  max-height: none !important;
}

/* If any nested wrapper was forcing overflow visible, kill it */
.modal-body * ,
.modal-inner * ,
[class*="-modal"] .modal-body * {
  overflow-x: hidden;
}

/* Prevent background scroll when modal open (safe + stable) */
body.modal-open {
  overflow: hidden !important;
  position: fixed !important;
  width: 100% !important;
  height: 100% !important;
  inset: 0 !important;
}

/* ---------- 2) MOOD: TEXTAREA CUT-OFF / CONTAINMENT ---------- */
.mood-container,
.mood-section,
.mood-log-form,
.mood-content,
[class*="mood"] {
  max-width: 100% !important;
  overflow-x: hidden !important;
  box-sizing: border-box !important;
}

/* Force all form controls to stay inside */
.mood-container select,
.mood-container textarea,
.mood-container input,
.mood-log-form select,
.mood-log-form textarea,
.mood-log-form input {
  width: 100% !important;
  max-width: 100% !important;
  box-sizing: border-box !important;
}

/* The NOTE textarea specifically: make it tall enough and not clipped by parents */
.mood-container textarea,
.mood-log-form textarea {
  min-height: 140px !important;
  line-height: 1.45 !important;
  resize: vertical !important;
  overflow: auto !important;
}

/* If a parent card is clipping, allow the textarea to render fully */
.mood-container .card,
.mood-log-form .card,
.mood-container [class*="card"],
.mood-log-form [class*="card"] {
  overflow: visible !important;
}

/* ---------- 5) FIX A SYNTAX LANDMINE (smart quotes / bad dash) ---------- */
/* If you have this anywhere, this correct selector prevents a broken rule from being ignored */
.qh-toggle input[type="checkbox"] {
  width: 18px;
  height: 18px;
  flex: 0 0 18px;
}

/* Also fix any accidental "en dash" in safe var usage by overriding bottom-nav safely */
.bottom-nav {
  padding-bottom: calc(10px + var(--tg-safe-bottom, env(safe-area-inset-bottom, 0px))) !important;
}

/* ==========================================================
LYSTARIA -- HARD STOP PATCH (MODALS + READING TABS + HABIT BADGES)
Paste this block at the VERY END of your <style> tag.
========================================================== */

/* ----------------------------------------------------------
1) MODALS: SHORT + SCROLL INSIDE (header/actions stay visible)
---------------------------------------------------------- */

/* Overlay: start near top so modal never "centers tall" */
.modal-overlay {
  position: fixed !important;
  inset: 0 !important;
  z-index: 2000 !important;

  display: flex !important;
  align-items: flex-start !important;
  justify-content: center !important;

  padding-left: 16px !important;
  padding-right: 16px !important;
  padding-top: calc(16px + var(--tg-safe-top, env(safe-area-inset-top, 0px))) !important;
  padding-bottom: calc(16px + var(--tg-safe-bottom, env(safe-area-inset-bottom, 0px))) !important;

  box-sizing: border-box !important;
  overflow: hidden !important;
}

/* The modal itself: capped height, NO outer scroll */
.modal {
  width: 100% !important;
  max-width: 500px !important;

  /* make it SHORT */
  max-height: calc(100vh - 160px - var(--tg-safe-top, env(safe-area-inset-top, 0px)) - var(--tg-safe-bottom, env(safe-area-inset-bottom, 0px))) !important;

  display: flex !important;
  flex-direction: column !important;

  overflow: hidden !important; /* IMPORTANT: prevents the whole modal from scrolling */
  box-sizing: border-box !important;
}

/* Header: fixed height area */
.modal-header {
  flex: 0 0 auto !important;
  margin-bottom: 14px !important;
}

/* Body: the ONLY scrolling region */
.modal-body {
  flex: 1 1 auto !important;
  min-height: 0 !important;

  overflow-y: auto !important;
  overflow-x: hidden !important;

  -webkit-overflow-scrolling: touch !important;
  overscroll-behavior: contain !important;

  padding: 12px 12px 16px !important;
  box-sizing: border-box !important;
}

/* Actions/footer: pinned inside modal */
.modal-actions {
  flex: 0 0 auto !important;
  margin-top: 12px !important;

  position: sticky !important;
  bottom: 0 !important;

  padding-top: 12px !important;
  padding-bottom: 12px !important;

  /* subtle fade/solid base so buttons always readable */
  background: linear-gradient(
    to bottom,
    rgba(0,0,0,0),
    rgba(0,0,0,0.35) 35%,
    rgba(0,0,0,0.55)
  ) !important;

  box-sizing: border-box !important;
}

/* Kill any "modal inner fights scroll" rules from other patches */
.modal > div {
  max-height: none !important;
}

/* ================================
READING TABS -- GLASS PILL BUBBLES
Targets your actual classes:
.book-quick-actions / .book-quick-action
================================ */

/* container row */
.book-quick-actions {
  display: flex !important;
  align-items: center !important;
  gap: 10px !important;

  padding: 10px 12px !important;
  margin: 0 12px 12px !important;

  overflow-x: auto !important;
  overflow-y: hidden !important;
  -webkit-overflow-scrolling: touch !important;

  /* keep it from looking like a weird bar */
  background: transparent !important;
  border: 0 !important;
}

/* each pill */
.book-quick-action {
  display: inline-flex !important;
  align-items: center !important;
  justify-content: center !important;

  padding: 10px 16px !important;
  border-radius: 999px !important;

  font-size: 13px !important;
  font-weight: 800 !important;
  letter-spacing: 0.2px !important;
  line-height: 1 !important;
  white-space: nowrap !important;

  /* GLASS PILL LOOK */
  background: rgba(255, 255, 255, 0.08) !important;
  border: 1px solid rgba(255, 255, 255, 0.16) !important;
  box-shadow: 0 10px 26px rgba(0, 0, 0, 0.30) !important;

  -webkit-backdrop-filter: blur(12px) saturate(150%) !important;
  backdrop-filter: blur(12px) saturate(150%) !important;

  cursor: pointer !important;
  user-select: none !important;

  flex: 0 0 auto !important;
  min-width: max-content !important;
}

/* pressed/hover feel */
.book-quick-action:active {
  transform: translateY(1px) !important;
}

/* active pill */
.book-quick-action.active {
  background: rgba(139, 125, 239, 0.18) !important;
  border-color: rgba(139, 125, 239, 0.40) !important;
  box-shadow:
    0 12px 30px rgba(0, 0, 0, 0.35),
    0 0 0 3px rgba(139, 125, 239, 0.12) !important;
}

/* ----------------------------------------------------------
3) HABIT BADGES: stop shrinking/squishing, keep pill width
---------------------------------------------------------- */

.habit-badges {
  display: flex !important;
  flex-direction: column !important;
  align-items: flex-end !important;
  justify-content: flex-start !important;

  gap: 6px !important;
  min-width: max-content !important;
}

.habit-badges .card-badge,
.habit-badges .badge-once,
.habit-badges .badge-daily,
.habit-badges .badge-weekly,
.habit-badges .badge-monthly,
.habit-badges .badge-interval,
.habit-badges .badge-habit-daily,
.habit-badges .badge-habit-weekly,
.habit-badges .badge-habit-active,
.habit-badges .badge-habit-paused,
.habit-badges .badge-completed,
.habit-badges .badge-due-now,
.habit-badges .badge-upcoming {
  flex: 0 0 auto !important;
  width: auto !important;
  min-width: max-content !important;

  white-space: nowrap !important;
  line-height: 1.2 !important;
}


.load-more-container {
  display: flex;
  justify-content: center;
  padding: 16px 0;
}

.load-more-btn {
  min-width: 140px;
}

/* ==========================================================
REMINDERS TABS -- restore pill row layout for renamed classes
Fixes: vertical list, lost pill styling, spacing to first card
========================================================== */

.reminder-quick-actions {
  background: transparent !important;
  backdrop-filter: none !important;
  -webkit-backdrop-filter: none !important;
  box-shadow: none !important;
  margin-bottom: 8px;
}

/* If thereâ€™s a pseudo-element creating haze */
.reminder-quick-actions::before,
.reminder-quick-actions::after {
  display: none !important;
  content: none !important;
}

/* Individual tab pills -- remove glow */
.reminder-quick-action {
  box-shadow: none !important;
  backdrop-filter: none !important;
  -webkit-backdrop-filter: none !important;
}

/* Active tab -- keep highlight but remove glow */
.reminder-quick-action.active {
  box-shadow: none !important;
}

/* The row container */
.reminder-quick-actions {
  display: flex !important;
  flex-direction: row !important;
  align-items: center !important;
  gap: 10px !important;

  width: 100% !important;
  max-width: 100% !important;

  overflow-x: auto !important;
  overflow-y: hidden !important;
  -webkit-overflow-scrolling: touch !important;

  padding: 8px 12px !important;
  margin: 0 12px 10px !important; /* includes your "small gap" to first card */
  background: transparent !important;
  box-shadow: none !important;

  /* important: prevents wrapping into a new "row" look */
  white-space: nowrap !important;
}

/* Kill any haze pseudo-elements if something else added them */
.reminder-quick-actions::before,
.reminder-quick-actions::after {
  content: none !important;
  display: none !important;
}

/* Each tab "pill"
   Works whether your items are <div>, <button>, <a>, etc. */
.reminder-quick-action {
  display: inline-flex !important;
  align-items: center !important;
  justify-content: center !important;

  flex: 0 0 auto !important;
  white-space: nowrap !important;

  padding: 10px 16px !important;
  border-radius: 999px !important;

  /* Keep your glass pill look but remove glow */
  background: rgba(255, 255, 255, 0.10) !important;
  border: 1px solid rgba(255, 255, 255, 0.14) !important;

  box-shadow: none !important;
  backdrop-filter: none !important;
  -webkit-backdrop-filter: none !important;

  line-height: 1 !important;
  text-align: center !important;
}

/* Active pill (still a pill, just "selected") */
.reminder-quick-action.active {
  background: rgba(168, 85, 247, 0.22) !important;
  border-color: rgba(168, 85, 247, 0.35) !important;
  box-shadow: none !important;
}

/* Optional: hide the horizontal scrollbar line on iOS */
.reminder-quick-actions::-webkit-scrollbar {
  height: 0 !important;
}

/* ===== Calendar title alignment fix ===== */

.calendar-event-title {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  line-height: 1.2;
}

/* Your actual SVG class */
.calendar-event-title .calendar-inline-svg {
  display: inline-block;
  vertical-align: middle;
  position: relative;
  top: 1px; /* micro-adjust -- tweak 0px / 1px / 2px if needed */
}

/* Keep the reminder dot aligned */
.calendar-event-title .event-reminder-dot {
  align-self: center;
}
</style>
</head>

<body>
  <div id="root"></div>

  <script type="text/babel">
window.onerror = function (message, source, lineno, colno, error) {
  try {
    const msg =
      "JS ERROR:\n" +
      String(message) +
      "\n\n" +
      "Line: " + lineno + ":" + colno;
    if (window.Telegram?.WebApp?.showAlert) Telegram.WebApp.showAlert(msg);
    else alert(msg);
  } catch (e) {}
};

window.onunhandledrejection = function (event) {
  try {
    const msg =
      "PROMISE ERROR:\n" +
      String(event?.reason?.message || event?.reason || "Unknown");
    if (window.Telegram?.WebApp?.showAlert) Telegram.WebApp.showAlert(msg);
    else alert(msg);
  } catch (e) {}
};
    const { useState, useEffect, useRef } = React;
    const { DateTime } = luxon;

// Telegram WebApp guard (browser vs Telegram)
const tg = window.Telegram?.WebApp;

const isTelegram =
  !!tg &&
  typeof tg.initData === "string" &&
  tg.initData.length > 0;

if (!isTelegram) {
  const root = document.getElementById("root");
  if (root) {
    root.innerHTML = `
<div style="min-height:var(--tg-viewport-height,100vh); display:flex; align-items:center; justify-content:center; padding:24px; text-align:center; color:#fff;">
        <div style="max-width:520px;">
          <h2 style="margin-bottom:12px;">Open in Telegram</h2>
          <p style="opacity:.8; line-height:1.6;">
            This mini app must be opened inside Telegram to access
            your journal entries, reminders, and events.
          </p>
        </div>
      </div>
    `;
  }
  throw new Error("Not running inside Telegram WebApp");
}

// Initialize Telegram Web App.. Safe to init now
tg.ready();
tg.expand();

window.addEventListener("error", (e) => {
  try {
    tg?.showAlert?.(`JS Error: ${e.message}`);
  } catch {}
});

window.addEventListener("unhandledrejection", (e) => {
  try {
    tg?.showAlert?.(`Promise Error: ${String(e.reason?.message || e.reason)}`);
  } catch {}
});

// --- Telegram real viewport height fix (standalone fullscreen vs chat sheet) ---
function syncTelegramViewportHeight() {
  try {
    const h = tg.viewportHeight; // Telegram's real usable height
    if (h && Number.isFinite(h)) {
      document.documentElement.style.setProperty("--tg-viewport-height", `${h}px`);
    }
  } catch (e) {
    // ignore
  }
}

syncTelegramViewportHeight();
tg.onEvent("viewportChanged", syncTelegramViewportHeight);

// --- Telegram content safe area insets (fullscreen mode) ---
function syncSafeAreaInsets() {
  try {
    const sa = tg.safeAreaInset || {};
    const csa = tg.contentSafeAreaInset || {};

    const topInset = (sa.top || 0) + (csa.top || 0);
    const bottomInset = (sa.bottom || 0) + (csa.bottom || 0);

    document.documentElement.style.setProperty("--tg-safe-top", `${topInset}px`);
    document.documentElement.style.setProperty("--tg-safe-bottom", `${bottomInset}px`);
  } catch (e) {}
}

syncSafeAreaInsets();
tg.onEvent("safeAreaChanged", syncSafeAreaInsets);
tg.onEvent("contentSafeAreaChanged", syncSafeAreaInsets);
// ---------------------------------------------------------------------------

    // Helper function to make API calls
    // API base URL
const API_BASE = window.location.origin + '/api/miniapp';

    async function apiCall(endpoint, options = {}) {
      const response = await fetch(`${API_BASE}${endpoint}`, {
        ...options,
        headers: {
          'Content-Type': 'application/json',
          'X-Telegram-Init-Data': tg.initData,
          ...options.headers,
        },
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'Request failed');
      }

      return response.json();
    }

    // Format date/time
    function formatDateTime(date) {
      const d = new Date(date);
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const tomorrow = new Date(today);
      tomorrow.setDate(tomorrow.getDate() + 1);

      const dateStr = new Date(d.getFullYear(), d.getMonth(), d.getDate());

      let dayStr;
      if (dateStr.getTime() === today.getTime()) {
        dayStr = 'Today';
      } else if (dateStr.getTime() === tomorrow.getTime()) {
        dayStr = 'Tomorrow';
      } else {
        dayStr = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      }

      const timeStr = d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });

      return `${dayStr} at ${timeStr}`;
    }

    function formatEventTime(event) {
      const start = new Date(event.startDate);
      if (event.allDay) {
        return 'All day';
      }
      const timeStr = start.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
      if (event.endDate) {
        const end = new Date(event.endDate);
        const endTimeStr = end.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        return `${timeStr} - ${endTimeStr}`;
      }
      return timeStr;
    }
    
    function hasReminder(event) {
  return !!(event?.reminderId || event?.reminder?.nextRunAt);
}
    
    // Journal helpers
function normalizeTagsFromText(input) {
  const matches = String(input || '').match(/#[A-Za-z0-9_-]+/g) || [];
  const tags = matches
    .map(t => t.slice(1).trim())
    .filter(Boolean)
    .map(t => t.toLowerCase());
  return Array.from(new Set(tags));
}

function tagsToDisplay(tags) {
  const list = Array.isArray(tags) ? tags : [];
  if (list.length === 0) return '';
  return list.map(t => `#${t}`).join(' ');
}

function formatShortDate(date) {
  const d = new Date(date);
  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

// Book Status Badges
function badgeForStatus(status) {
  const s = String(status || "").toLowerCase();

  if (s === "finished") {
    return {
      text: "FINISHED",
      bg: "rgba(255,255,255,0.18)",
      fg: "#ffffff",
    };
  }

  if (s === "reading") {
    return {
      text: "READING",
      bg: "rgba(255,235,59,0.22)",
      fg: "#ffeb3b", // yellow
    };
  }

  if (s === "tbr") {
    return {
      text: "TBR",
      bg: "rgba(255,105,180,0.22)",
      fg: "#ff69b4", // pink
    };
  }

  if (s === "paused") {
    return {
      text: "PAUSED",
      bg: "rgba(33,150,243,0.22)",
      fg: "#2196f3", // blue
    };
  }

  if (s === "dnf") {
    return {
      text: "DNF",
      bg: "rgba(76,175,80,0.22)",
      fg: "#4caf50", // green
    };
  }

  return {
    text: "BOOK",
    bg: "rgba(255,255,255,0.08)",
    fg: "#ffffff",
  };
}

// STATUS NORMALIZER (not UI):
// Ensures all book statuses resolve to a valid enum value.
function statusLabelToValue(input) {
  const s = String(input || "").toLowerCase().trim();
  if (s === "tbr") return "tbr";
  if (s === "reading" || s === "active") return "reading";
  if (s === "finished" || s === "done") return "finished";
  if (s === "paused") return "paused";
  if (s === "dnf") return "dnf";
  return "tbr"; // fallback LAST
}

// --- Star Rating helpers (no JSX) ---
function clampRating(value, max = 5) {  // âœ… Removed 'export'
  const n = Number(value);
  const v = Number.isFinite(n) ? Math.floor(n) : 0;
  return Math.max(0, Math.min(max, v));
}

function starFillMap(value, max = 5) {  // âœ… Removed 'export'
  const v = clampRating(value, max);
  return Array.from({ length: max }, (_, i) => i + 1 <= v);
}

function nextRatingOnClick(currentValue, clickedValue, max = 5, allowClear = true) {  // âœ… Removed 'export'
  const cur = clampRating(currentValue, max);
  const clicked = clampRating(clickedValue, max);
  if (allowClear && clicked === cur) return 0;
  return clicked;
}

// =========================
// HABITS UI (matches your Habit.ts / HabitLog.ts / habits.ts API)
// =========================

function safeNum(n, fallback = 0) {
  const x = Number(n);
  return Number.isFinite(x) ? x : fallback;
}

function isSessionsUnit(unit) {
  return String(unit || "").toLowerCase() === "sessions";
}

function habitBadgeForCadence(cadence) {
  return String(cadence || "daily").toLowerCase() === "weekly"
    ? { text: "WEEKLY", className: "badge-habit-weekly" }
    : { text: "DAILY", className: "badge-habit-daily" };
}

function habitBadgeForStatus(status) {
  return String(status || "active").toLowerCase() === "paused"
    ? { text: "PAUSED", className: "badge-habit-paused" }
    : { text: "ACTIVE", className: "badge-habit-active" };
}


function debugHabitsApi(endpoint, options) {
  // what Habits THINKS it's calling
  const endpointType = typeof endpoint;
  const endpointValue =
    endpointType === "string" ? endpoint :
    (() => { try { return JSON.stringify(endpoint); } catch { return String(endpoint); } })();

  // what your helper WILL fetch
  // (this matches your helper exactly)
  const finalUrl = `${API_BASE}${endpoint}`;

  console.log("[HABITS apiCall debug]", {
    endpointType,
    endpointRaw: endpoint,
    endpointValue,
    finalUrl,
    method: options?.method || "GET",
  });

  return apiCall(endpoint, options).catch((err) => {
    console.log("[HABITS apiCall error]", {
      message: err?.message,
      endpointType,
      endpointRaw: endpoint,
      finalUrl,
    });

    // show the REAL info in Telegram so you don't need Safari inspector
    tg?.showAlert?.(
      "Habits API failed.\n\n" +
      "endpointType: " + endpointType + "\n" +
      "endpoint: " + endpointValue + "\n\n" +
      "finalUrl:\n" + finalUrl + "\n\n" +
      "error:\n" + (err?.message || String(err))
    );

    throw err;
  });
}


function dateInputValue(d, timeZone) {
  // YYYY-MM-DD in the desired timezone
  return new Intl.DateTimeFormat("en-CA", {
    timeZone: timeZone || undefined,
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
  }).format(d);
}

function timeInputValue(d, timeZone) {
  // HH:MM in the desired timezone
  const parts = new Intl.DateTimeFormat("en-GB", {
    timeZone: timeZone || undefined,
    hour: "2-digit",
    minute: "2-digit",
    hour12: false,
  }).formatToParts(d);

  const hh = parts.find(p => p.type === "hour")?.value || "09";
  const mm = parts.find(p => p.type === "minute")?.value || "00";
  return `${hh}:${mm}`;
}

// --- helpers (local) ---
function pad2(n) {
  return String(n).padStart(2, "0");
}

// Returns "YYYY-MM-DDTHH:mm" in the user's LOCAL time.
// Accepts: Date, ISO string, timestamp number.
function fmtDateTimeLocalValue(input) {
  const d = input instanceof Date ? input : new Date(input);

  if (!(d instanceof Date) || isNaN(d.getTime())) return "";

  const yyyy = d.getFullYear();
  const mm = pad2(d.getMonth() + 1);
  const dd = pad2(d.getDate());
  const hh = pad2(d.getHours());
  const min = pad2(d.getMinutes());

  // EXACT format required by iOS datetime-local:
  return `${yyyy}-${mm}-${dd}T${hh}:${min}`;
}

// Parses "YYYY-MM-DDTHH:mm" (from datetime-local) into a Date in LOCAL time.
// Returns Date or null.
function parseDateTimeLocalValue(str) {
  if (typeof str !== "string") return null;
  const s = str.trim();
  if (!s) return null;

  // Must be EXACT:
  const m = s.match(/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2})$/);
  if (!m) return null;

  const yyyy = Number(m[1]);
  const mo = Number(m[2]);   // 1-12
  const dd = Number(m[3]);   // 1-31
  const hh = Number(m[4]);   // 0-23
  const min = Number(m[5]);  // 0-59

  if (
    !Number.isFinite(yyyy) ||
    !Number.isFinite(mo) || mo < 1 || mo > 12 ||
    !Number.isFinite(dd) || dd < 1 || dd > 31 ||
    !Number.isFinite(hh) || hh < 0 || hh > 23 ||
    !Number.isFinite(min) || min < 0 || min > 59
  ) return null;

  // Construct LOCAL datetime (not UTC)
  const d = new Date(yyyy, mo - 1, dd, hh, min, 0, 0);
  if (isNaN(d.getTime())) return null;

  return d;
}

// -- Mood score helpers --
const MOOD_SCORE_MAP = {
  happy: 4.3,
  content: 3.8,
  inspired: 4.2,
  productive: 4.1,
  loved: 4.4,
  grateful: 4.4,
  optimistic: 4.0,
  confident: 4.0,
  motivated: 4.0,
  amused: 3.9,

  good: 3.6,
  okay: 3.0,
  neutral: 3.0,
  reflective: 3.2,
  distracted: 2.7,
  confused: 2.6,

  sad: 1.8,
  irritated: 2.0,
  disappointed: 1.9,
  angry: 1.7,
  cynical: 2.0,
  insecure: 1.9,
  overwhelmed: 1.6,
  stressed: 1.7,
  scared: 1.6,
  lonely: 1.7,
  discouraged: 1.8,
};

const DEFAULT_MOODS = [
  "happy",
  "content",
  "inspired",
  "productive",
  "loved",
  "grateful",
  "optimistic",
  "confident",
  "motivated",
  "amused",
  "sad",
  "irritated",
  "disappointed",
  "angry",
  "cynical",
  "insecure",
  "overwhelmed",
  "stressed",
  "scared",
  "confused",
  "reflective",
  "distracted",
  "lonely",
  "discouraged",
  "good",
  "okay",
  "neutral",
];

const DEFAULT_ACTIVITIES = [
  "friends",
  "family",
  "community",
  "dating",
  "hobby",
  "creative",
  "work",
  "education",
  "reading",

  "hygiene",
  "fitness",
  "health",
  "self-care",
  "mindfulness",

  "chores",
  "errands",
  "shopping",
  "baking",

  "pets",
  "nature",

  "journaling",
  "spirituality",
  "religion",

  "entertainment",
  "social-media",
  "tech",
];

function moodScoreAvg(moods) {
if (!moods || moods.length === 0) return 3;
const total = moods.reduce((s, m) => s + (MOOD_SCORE_MAP[m] ?? 3), 0);
return Math.round((total / moods.length) * 100) / 100;
}

function moodBarColor(score) {
  return "linear-gradient(135deg, #4dd0e1, #64b5f6, #9c7cff)";
}

function moodBarLabel(score) {
if (score >= 4.5) return "Feeling amazing!";
if (score >= 4) return "Feeling great";
if (score >= 3.5) return "Doing well";
if (score >= 3) return "Doing okay";
if (score >= 2.5) return "Could be better";
if (score >= 2) return "Feeling low";
return "Having a tough time";
}

function moodScoreBadge(score) {
  return {
    bg: "rgba(255, 255, 255, 0.14)",
    fg: "#f6f65a",
  };
}

function startOfToday() {
  const d = new Date();
  d.setHours(0, 0, 0, 0);
  return d;
}

function endOfToday() {
  const d = new Date();
  d.setHours(23, 59, 59, 999);
  return d;
}

function isToday(dateValue) {
  const d = new Date(dateValue);
  const s = startOfToday().getTime();
  const e = endOfToday().getTime();
  const t = d.getTime();
  return t >= s && t <= e;
}

// SYMBOLS HELPER FOR DECOR
function renderTextWithSymbolSpans(text) {
  const s = String(text ?? "");
  const lines = s.split("\n");

  // Match both symbol ranges AND specific mapped characters
  const allMapped = Object.keys(SYMBOL_SVG_MAP).join('');
  const symbolRe = new RegExp(`([${allMapped}\\u2600-\\u26FF\\u2700-\\u27BF])`, 'g');

  return lines.map((line, lineIdx) => {
    const parts = line.split(symbolRe);
    return (
      <React.Fragment key={`line-${lineIdx}`}>
        {parts.map((part, i) => {
          if (part.length === 1 && SYMBOL_SVG_MAP[part]) {
            return <React.Fragment key={`svg-${lineIdx}-${i}`}>{SYMBOL_SVG_MAP[part]}</React.Fragment>;
          }
          if (part.length === 1 && /[\u2600-\u26FF\u2700-\u27BF]/.test(part)) {
            return <span key={`sym-${lineIdx}-${i}`} className="reminder-text-symbol">{part}</span>;
          }
          return <React.Fragment key={`txt-${lineIdx}-${i}`}>{part}</React.Fragment>;
        })}
        {lineIdx < lines.length - 1 ? <br /> : null}
      </React.Fragment>
    );
  });
}


const SYMBOL_SVG_MAP = {
  'â™¡': (
    <img className="reminder-inline-svg" src="/icons/heart.svg" alt="â™¡" width="14" height="14" />
  ),
  'â˜†': (
  <img className="reminder-inline-svg" src="/icons/stars.svg" alt="â˜†" width="14" height="14" />
  ),
  'â˜…': (
  <img className="reminder-inline-svg" src="/icons/star.svg" alt="â˜…" width="14" height="14" />
  ),
  'âœ¦': (
  <img className="reminder-inline-svg" src="/icons/sparkle-fill.svg" alt="âœ¦" width="14" height="14" />
  ),
  'âœ§': (
  <img className="reminder-inline-svg" src="/icons/sparkle-line.svg" alt="âœ§" width="14" height="14" />
  ),
};


// MOOD Multi-select dropdown component
function MoodMultiSelect({ label, options, selected, onChange, pillClass }) {
const [open, setOpen] = useState(false);

const toggle = (val) => {
if (selected.includes(val)) {
onChange(selected.filter((v) => v !== val));
} else {
onChange([...selected, val]);
}
};

const remove = (val) => {
onChange(selected.filter((v) => v !== val));
};

return (
<div className="mood-select-group">
<label className="form-label">{label}</label>

  <div
    className={`mood-dropdown-trigger ${open ? "open" : ""}`}
    onClick={() => setOpen(!open)}
  >
    <span>
      {selected.length === 0
        ? `Select ${label.toLowerCase()}...`
        : `${selected.length} selected`}
    </span>
    <span className={`mood-dropdown-arrow ${open ? "open" : ""}`}>â–¼</span>
  </div>

  {open && (
    <div className="mood-dropdown-list">
      {options.map((opt) => {
        const isOn = selected.includes(opt);
        return (
          <div
            key={opt}
            className={`mood-dropdown-option ${isOn ? "selected" : ""}`}
            onClick={() => toggle(opt)}
          >
            <div className="mood-dropdown-check">
              {isOn && (
                <img
                  src="/icons/check.svg"
                  alt=""
                  style={{ width: 12, height: 12, opacity: 1 }}
                />
              )}
            </div>
            <span>{opt}</span>
          </div>
        );
      })}
    </div>
  )}

  {selected.length > 0 && (
    <div className="mood-pills-row">
      {selected.map((val) => (
        <span key={val} className={`mood-pill ${pillClass}`}>
          {val}
          <button
            className="mood-pill-remove"
            onClick={(e) => {
              e.stopPropagation();
              remove(val);
            }}
            type="button"
          >
            Ã—
          </button>
        </span>
      ))}
    </div>
  )}
</div>
);
}

// Result card shown after logging
function MoodResultCard({ log, onDismiss }) {
if (!log) return null;

const score = log.score ?? moodScoreAvg(log.moods || []);
const pct = Math.round(((score - 1) / 4) * 100); // 1â€“5 â†’ 0â€“100%
const barBg = moodBarColor(score);
const label = moodBarLabel(score);
const badge = moodScoreBadge(score);

return (
<div className="mood-result-card">
<div className="mood-result-title">Mood Logged</div>

  <div className="mood-bar-wrap">
    <div className="mood-bar-labels">
      <span>Low</span>
      <span>High</span>
    </div>

    <div className="mood-bar-track">
      <div
        className="mood-bar-fill"
        style={{ width: `${pct}%`, background: barBg }}
      />
    </div>

    <div className="mood-bar-score">
      {label} -- {score.toFixed(1)} / 5
    </div>
  </div>

  {Array.isArray(log.moods) && log.moods.length > 0 && (
    <div className="mood-pills-row">
      {log.moods.map((m) => (
        <span key={m} className="mood-pill mood-pill-mood">{m}</span>
      ))}
    </div>
  )}

  {Array.isArray(log.activities) && log.activities.length > 0 && (
    <div className="mood-pills-row" style={{ marginTop: 8 }}>
      {log.activities.map((a) => (
        <span key={a} className="mood-pill mood-pill-activity">{a}</span>
      ))}
    </div>
  )}

  <div className="card-actions" style={{ marginTop: 16 }}>
    <button className="btn btn-secondary" onClick={onDismiss} type="button">
      Dismiss
    </button>
  </div>
</div>
);
}

// History log card
function MoodLogHistoryCard({ log, onDelete }) {
const score = log.score ?? 3;
const badge = moodScoreBadge(score);

const created = log.createdAt ? new Date(log.createdAt) : null;
const dateStr = created
? created.toLocaleDateString("en-US", {
month: "short",
day: "numeric",
year: "numeric",
hour: "numeric",
minute: "2-digit",
})
: "";

return (
<div className="mood-log-card">
<div className="mood-log-header">
<div className="mood-log-date">
<img src="/icons/cal.svg" alt="" />
<span>{dateStr}</span>
</div>

    <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
      <span
        className="mood-log-score-badge"
        style={{ background: badge.bg, color: badge.fg }}
      >
        {score.toFixed(1)}
      </span>

      <button
        className="mood-log-delete"
        onClick={() => onDelete(log._id)}
        type="button"
      >
        <img src="/icons/trash.svg" alt="" style={{ width: 16, height: 16 }} />
      </button>
    </div>
  </div>

  <div className="mood-log-body">
    {Array.isArray(log.moods) && log.moods.length > 0 && (
      <div className="mood-pills-row">
        {log.moods.map((m) => (
          <span key={m} className="mood-pill mood-pill-mood">{m}</span>
        ))}
      </div>
    )}

    {Array.isArray(log.activities) && log.activities.length > 0 && (
      <div className="mood-pills-row" style={{ marginTop: 8 }}>
        {log.activities.map((a) => (
          <span key={a} className="mood-pill mood-pill-activity">{a}</span>
        ))}
      </div>
    )}

    {log.note && (
      <div style={{ marginTop: 10, fontSize: 14, color: "var(--text-secondary)", lineHeight: 1.5 }}>
        {log.note}
      </div>
    )}
  </div>
</div>
);
}

// MOOD SCORE BAR
function MoodScoreBar({ score }) {
  const s = typeof score === "number" ? score : 3;
  const pct = Math.round(((s - 1) / 4) * 100); // 1â€“5 â†’ 0â€“100%
  const barBg = moodBarColor(s);
  const label = moodBarLabel(s);

  return (
    <div className="mood-bar-wrap">
      <div className="mood-bar-labels">
        <span>Low</span>
        <span>High</span>
      </div>

      <div className="mood-bar-track">
        <div
          className="mood-bar-fill"
          style={{ width: `${pct}%`, background: barBg }}
        />
      </div>

      <div className="mood-bar-score">
        {label} -- {s.toFixed(1)} / 5
      </div>
    </div>
  );
}

// TODAY MOOD CARD
function MoodTodayCard({ log, onDelete }) {
  const score = typeof log?.score === "number" ? log.score : 3;

  const created = log?.createdAt ? new Date(log.createdAt) : null;
  const dateStr = created
    ? created.toLocaleDateString("en-US", {
        month: "short",
        day: "numeric",
        year: "numeric",
        hour: "numeric",
        minute: "2-digit",
      })
    : "";

  const badge = moodScoreBadge(score);

  return (
    <div className="mood-log-card">
      <div className="mood-log-header">
        <div className="mood-log-date">
          <img src="/icons/cal.svg" alt="" />
          <span>{dateStr}</span>
        </div>

        <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
          <span
            className="mood-log-score-badge"
            style={{ background: badge.bg, color: badge.fg }}
          >
            {score.toFixed(1)}
          </span>

          {onDelete && (
            <button
              className="mood-log-delete"
              onClick={() => onDelete(log._id)}
              type="button"
            >
              <img src="/icons/trash.svg" alt="" style={{ width: 16, height: 16 }} />
            </button>
          )}
        </div>
      </div>

      {/* THE BAR (this is what you want) */}
      <MoodScoreBar score={score} />

      {Array.isArray(log?.moods) && log.moods.length > 0 && (
        <div className="mood-pills-row">
          {log.moods.map((m) => (
            <span key={m} className="mood-pill mood-pill-mood">{m}</span>
          ))}
        </div>
      )}

      {Array.isArray(log?.activities) && log.activities.length > 0 && (
        <div className="mood-pills-row" style={{ marginTop: 8 }}>
          {log.activities.map((a) => (
            <span key={a} className="mood-pill mood-pill-activity">{a}</span>
          ))}
        </div>
      )}

      {log?.note && (
        <div style={{ marginTop: 10, fontSize: 14, color: "var(--text-secondary)", lineHeight: 1.5 }}>
          {log.note}
        </div>
      )}
    </div>
  );
}

// Main Mood View
function MoodView({ activeView, userDisplayName, onBack }) {
const [moods, setMoods] = useState([]);
const [activities, setActivities] = useState([]);
const [note, setNote] = useState("");
const [saving, setSaving] = useState(false);

// Result after logging
const [lastResult, setLastResult] = useState(null);

// History
const [logs, setLogs] = useState([]);
const [logsLoading, setLogsLoading] = useState(true);

// Tab: "today" | "log" | "history"
const [tab, setTab] = useState("today");

const todayLogs = Array.isArray(logs)
  ? logs.filter((l) => l?.createdAt && isToday(l.createdAt))
  : [];

useEffect(() => {
if (activeView === "mood") {
loadLogs();
}
}, [activeView]);

const loadLogs = async () => {
try {
setLogsLoading(true);
const data = await apiCall("/mood/mood?limit=30");
setLogs(Array.isArray(data?.logs) ? data.logs : []);
} catch (e) {
tg?.showAlert?.("Failed to load mood logs: " + (e?.message || String(e)));
setLogs([]);
} finally {
setLogsLoading(false);
}
};

const handleLog = async () => {
if (moods.length === 0) {
tg?.showAlert?.("Please select at least one mood");
return;
}

try {
  setSaving(true);
  const data = await apiCall("/mood/mood", {
    method: "POST",
    body: JSON.stringify({
      moods,
      activities,
      note: note.trim() || undefined,
    }),
  });

  if (data?.log) {
    setLastResult(data.log);
    // Reset form
    setMoods([]);
    setActivities([]);
    setNote("");
    // Refresh history
    loadLogs();
  }
} catch (e) {
  tg?.showAlert?.("Failed to log mood: " + (e?.message || String(e)));
} finally {
  setSaving(false);
}

};

const handleDelete = async (id) => {
try {
await apiCall(`/mood/mood/${id}`, { method: "DELETE" });
tg?.showPopup?.({ message: "Mood log deleted" });
loadLogs();
} catch (e) {
tg?.showAlert?.("Failed to delete: " + (e?.message || String(e)));
}
};

return (
<div>
<div className="header">
<div>
<h1>Mood</h1>
{(() => {
const name = (userDisplayName || "").trim();
return name ? <div className="reminders-greeting">Hello {name}</div> : null;
})()}
</div>

    <button className="btn btn-secondary" type="button" onClick={onBack}>
      Back
    </button>
  </div>

  <div className="quick-actions">
  <div
    className={`quick-action ${tab === "today" ? "active" : ""}`}
    onClick={() => setTab("today")}
  >
    Today
  </div>

  <div
    className={`quick-action ${tab === "log" ? "active" : ""}`}
    onClick={() => setTab("log")}
  >
    Log Mood
  </div>

  <div
    className={`quick-action ${tab === "history" ? "active" : ""}`}
    onClick={() => setTab("history")}
  >
    History
  </div>
</div>

  {/* Result card (shows after successful log) */}
  {lastResult && (
    <MoodResultCard
      log={lastResult}
      onDismiss={() => setLastResult(null)}
    />
  )}

  {/* LOG TAB */}
{tab === "log" && (
  <div style={{ padding: "0 16px" }}>
    <MoodMultiSelect
      label="How are you feeling?"
      options={DEFAULT_MOODS}
      selected={moods}
      onChange={setMoods}
      pillClass="mood-pill-mood"
    />

    <MoodMultiSelect
      label="What have you been doing?"
      options={DEFAULT_ACTIVITIES}
      selected={activities}
      onChange={setActivities}
      pillClass="mood-pill-activity"
    />

    <div className="form-group">
      <label className="form-label">Note (optional)</label>
      <textarea
        className="form-textarea form-textarea--sm"
        value={note}
        onChange={(e) => setNote(e.target.value)}
        placeholder="Anything else on your mind?"
        maxLength={1500}
      />
    </div>

    <button
      className="btn btn-primary"
      onClick={handleLog}
      disabled={saving || moods.length === 0}
      type="button"
      style={{ width: "100%", justifyContent: "center", padding: 14 }}
    >
      {saving ? "Logging..." : "Log Mood"}
    </button>
  </div>
)}
  
  {/* TODAY TAB */}
{tab === "today" && (
  <div>
    {logsLoading ? (
      <div className="loading">
        <div className="spinner" />
        <div>Loading todayâ€™s moods...</div>
      </div>
    ) : todayLogs.length === 0 ? (
      <div className="empty-state">
        <div className="empty-state-icon">
          <img src="/icons/star.svg" alt="" />
        </div>
        <div className="empty-state-text">
          No mood logs yet today.{"\n"}Log one and itâ€™ll show up here.
        </div>
      </div>
    ) : (
      todayLogs.map((log) => (
        <MoodTodayCard key={log._id} log={log} onDelete={handleDelete} />
      ))
    )}
  </div>
)}

  {/* HISTORY TAB */}
  {tab === "history" && (
    <div>
      {logsLoading ? (
        <div className="loading">
          <div className="spinner" />
          <div>Loading mood history...</div>
        </div>
      ) : logs.length === 0 ? (
        <div className="empty-state">
          <div className="empty-state-icon">
            <img src="/icons/bfly.svg" alt="" />
          </div>
          <div className="empty-state-text">
            No mood logs yet.{"\n"}Log your first mood!
          </div>
        </div>
      ) : (
        logs.map((log) => (
          <MoodLogHistoryCard
            key={log._id}
            log={log}
            onDelete={handleDelete}
          />
        ))
      )}
    </div>
  )}
</div>
);
}



// =========================
// HABITS UI (FIXED for iOS WebView strict input formats)
// Assumes you already have: apiCall, tg, safeNum, isSessionsUnit,
// habitBadgeForCadence, habitBadgeForStatus,
// fmtDateTimeLocalValue, parseDateTimeLocalValue
// =========================


// Habit Card
function HabitCard({ habit, onEdit, onDelete, onTogglePause, onOpenLog, onOpenLogs }) {
  const name = String(habit?.name || "").trim() || "(unnamed habit)";
  const description = String(habit?.description || "").trim();

  const cadenceBadge = habitBadgeForCadence(habit?.cadence);
  const statusBadge = habitBadgeForStatus(habit?.status);

  const targetCount = safeNum(habit?.targetCount, 1);
  const targetAmount = habit?.targetAmount === undefined ? null : safeNum(habit?.targetAmount, 0);
  const unit = String(habit?.unit || "sessions");

  const scheduleKind = String(habit?.reminderSchedule?.kind || "off");

  const scheduleSummary =
    scheduleKind === "off"
      ? "Reminders: Off"
      : scheduleKind === "times"
        ? `Reminders: Times (${(habit?.reminderSchedule?.timesOfDay || []).join(", ") || "none"})`
        : scheduleKind === "hourly"
          ? `Reminders: Every ${safeNum(habit?.reminderSchedule?.everyHours, 1)}h` +
            (habit?.reminderSchedule?.windowStart && habit?.reminderSchedule?.windowEnd
              ? ` (${habit.reminderSchedule.windowStart}â€“${habit.reminderSchedule.windowEnd})`
              : "")
          : scheduleKind === "every_x_minutes"
            ? `Reminders: Every ${safeNum(habit?.reminderSchedule?.everyMinutes, 1)}m` +
              (habit?.reminderSchedule?.windowStart && habit?.reminderSchedule?.windowEnd
                ? ` (${habit.reminderSchedule.windowStart}â€“${habit.reminderSchedule.windowEnd})`
                : "")
            : `Reminders: ${scheduleKind}`;

  const cadenceLabel = String(habit?.cadence || "daily");
  const targetLine =
    targetAmount !== null && !isSessionsUnit(unit)
      ? `Target: ${targetCount} sessions per ${cadenceLabel} -- ${targetAmount} ${unit} per session`
      : `Target: ${targetCount} sessions per ${cadenceLabel}`;

  return (
    <div className="card">
      <div className="card-header">
        <div>
          <div className="habit-title">{name}</div>
          {description ? <div className="habit-sub">{description}</div> : null}
        </div>

        <div className="habit-badges">
  <span className={`card-badge ${cadenceBadge.className}`}>{cadenceBadge.text}</span>
  <span className={`card-badge ${statusBadge.className}`}>{statusBadge.text}</span>

  {habit?.progress?.completed ? (
    <span className="card-badge badge-completed" title="Completed">
      <img
        className="badge-icon"
        src="/icons/check.svg"
        alt=""
        aria-hidden="true"
      />
      Completed
    </span>
  ) : null}
</div>
      </div>

      <div className="habit-target">{targetLine}</div>
      <div className="habit-target">{scheduleSummary}</div>

      <div className="habit-actions">
  <button
    className="btn btn-log"
    type="button"
    onClick={() => onOpenLog(habit)}
  >
    Log Session
  </button>

  <button
    className="btn btn-view"
    type="button"
    onClick={() => onOpenLogs(habit)}
  >
    View Logs
  </button>

  <button
    className="btn btn-edit"
    type="button"
    onClick={() => onEdit(habit)}
  >
    Edit
  </button>

  <button
    className="btn btn-pause"
    type="button"
    onClick={() => onTogglePause(habit)}
  >
    {String(habit?.status) === "paused" ? "Resume" : "Pause"}
  </button>

  <button
    className="btn btn-delete"
    type="button"
    onClick={() => onDelete(habit)}
  >
    Delete
  </button>
</div>
    </div>
  );
}


// Habit Editor Modal
function HabitEditorModal({ initialHabit, userTimezone, onClose, onSaved }) {
  const isEdit = !!initialHabit?._id;

  const [name, setName] = useState(isEdit ? (initialHabit.name || "") : "");
  const [description, setDescription] = useState(isEdit ? (initialHabit.description || "") : "");

  const [status, setStatus] = useState(isEdit ? (initialHabit.status || "active") : "active");
  const [cadence, setCadence] = useState(isEdit ? (initialHabit.cadence || "daily") : "daily");

  // âœ… Weekly anchor inputs (only used when cadence === "weekly" AND reminders are on)
  const [startDate, setStartDate] = useState(""); // "YYYY-MM-DD"
  const [startTime, setStartTime] = useState(""); // "HH:mm"

  const [targetCount, setTargetCount] = useState(isEdit ? String(initialHabit.targetCount ?? 1) : "1");
  const [unit, setUnit] = useState(isEdit ? (initialHabit.unit || "sessions") : "sessions");

  const [targetAmount, setTargetAmount] = useState(
    isEdit && initialHabit.targetAmount !== undefined && initialHabit.targetAmount !== null
      ? String(initialHabit.targetAmount)
      : ""
  );

  const [timezone, setTimezone] = useState(
    isEdit
      ? (initialHabit.timezone || userTimezone || "America/Chicago")
      : (userTimezone || "America/Chicago")
  );

  const [reminderKind, setReminderKind] = useState(
    isEdit ? (initialHabit.reminderSchedule?.kind || "off") : "off"
  );

  const [timesOfDay, setTimesOfDay] = useState(
    isEdit
      ? (Array.isArray(initialHabit.reminderSchedule?.timesOfDay) ? initialHabit.reminderSchedule.timesOfDay : [])
      : []
  );

  const [everyHours, setEveryHours] = useState(
    isEdit ? String(initialHabit.reminderSchedule?.everyHours ?? 2) : "2"
  );

  const [everyMinutes, setEveryMinutes] = useState(
    isEdit ? String(initialHabit.reminderSchedule?.everyMinutes ?? 45) : "45"
  );

  const [windowStart, setWindowStart] = useState(
    isEdit ? (initialHabit.reminderSchedule?.windowStart || "") : ""
  );

  const [windowEnd, setWindowEnd] = useState(
    isEdit ? (initialHabit.reminderSchedule?.windowEnd || "") : ""
  );

  const [daysOfWeek, setDaysOfWeek] = useState(
    isEdit
      ? (Array.isArray(initialHabit.reminderSchedule?.daysOfWeek) ? initialHabit.reminderSchedule.daysOfWeek : [])
      : []
  );

  const [nextReminderAt, setNextReminderAt] = useState(
    isEdit && initialHabit.nextReminderAt ? fmtDateTimeLocalValue(initialHabit.nextReminderAt) : ""
  );

  useEffect(() => {
    document.body.classList.add("modal-open");
    return () => document.body.classList.remove("modal-open");
  }, []);

  const weekdayLabels = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];

  const toggleDay = (idx) => {
    setDaysOfWeek((prev) => {
      const s = new Set(Array.isArray(prev) ? prev : []);
      if (s.has(idx)) s.delete(idx);
      else s.add(idx);
      return Array.from(s).sort((a, b) => a - b);
    });
  };

  // âœ… Prefill weekly anchor fields when editing
  useEffect(() => {
    if (isEdit && initialHabit?.startAt) {
      const d = new Date(initialHabit.startAt);
      if (!isNaN(d.getTime())) {
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const dd = String(d.getDate()).padStart(2, "0");
        const hh = String(d.getHours()).padStart(2, "0");
        const min = String(d.getMinutes()).padStart(2, "0");

        setStartDate(`${yyyy}-${mm}-${dd}`);
        setStartTime(`${hh}:${min}`);
        return;
      }
    }

    // default clear if not editing weekly or no startAt
    setStartDate("");
    setStartTime("");
  }, [isEdit, initialHabit]);

  const addTime = () => setTimesOfDay((prev) => [...(Array.isArray(prev) ? prev : []), "09:00"]);
  const updateTime = (i, v) => setTimesOfDay((prev) => prev.map((t, idx) => (idx === i ? v : t)));
  const removeTime = (i) => setTimesOfDay((prev) => prev.filter((_, idx) => idx !== i));

  const buildReminderSchedule = () => {
    const base = { kind: reminderKind };

    if (reminderKind === "times") {
      const cleaned = (timesOfDay || []).map((t) => String(t || "").trim()).filter(Boolean);
      return { ...base, timesOfDay: cleaned, daysOfWeek: daysOfWeek || [] };
    }

    if (reminderKind === "hourly") {
      return {
        ...base,
        everyHours: Math.max(1, Math.floor(Number(everyHours) || 1)),
        windowStart: windowStart ? String(windowStart).trim() : undefined,
        windowEnd: windowEnd ? String(windowEnd).trim() : undefined,
        daysOfWeek: daysOfWeek || [],
      };
    }

    if (reminderKind === "every_x_minutes") {
      return {
        ...base,
        everyMinutes: Math.max(1, Math.floor(Number(everyMinutes) || 1)),
        windowStart: windowStart ? String(windowStart).trim() : undefined,
        windowEnd: windowEnd ? String(windowEnd).trim() : undefined,
        daysOfWeek: daysOfWeek || [],
      };
    }

    return base; // off
  };

  const save = async () => {
    if (!String(name || "").trim()) {
      tg?.showAlert?.("Habit name is required.");
      return;
    }

    const tc = Number(targetCount);
    if (!Number.isFinite(tc) || tc < 1) {
      tg?.showAlert?.("targetCount must be >= 1.");
      return;
    }

    let ta = undefined;
    if (targetAmount !== "" && targetAmount !== null && targetAmount !== undefined) {
      const n = Number(targetAmount);
      if (!Number.isFinite(n) || n < 0) {
        tg?.showAlert?.("targetAmount must be >= 0.");
        return;
      }
      ta = n;
    }

    const reminderSchedule = buildReminderSchedule();

    if (reminderSchedule.kind === "times") {
      const arr = Array.isArray(reminderSchedule.timesOfDay) ? reminderSchedule.timesOfDay : [];
      if (arr.length === 0) {
        tg?.showAlert?.("timesOfDay is required for reminderSchedule kind=times.");
        return;
      }
    }

    const remindersOn = reminderKind !== "off";

    // âœ… Weekly cadence must have an anchor datetime when reminders are ON
    if (cadence === "weekly" && remindersOn) {
      if (!startDate || !startTime) {
        tg?.showAlert?.("Weekly habits require a start date and start time.");
        return;
      }
    }

    // âœ… Build ISO for startAt (weekly anchor)
    let startAtISO = undefined;

    if (cadence === "weekly" && remindersOn) {
      const isoLocal = `${startDate}T${startTime}`; // local time from inputs
      const d = new Date(isoLocal);

      if (isNaN(d.getTime())) {
        tg?.showAlert?.("Start date/time is invalid.");
        return;
      }

      startAtISO = d.toISOString();
    }

    const payload = {
      name: String(name).trim(),
      description: description ? String(description).trim() : undefined,
      status: status === "paused" ? "paused" : "active",
      cadence: cadence === "weekly" ? "weekly" : "daily",
      targetCount: Math.floor(tc),
      targetAmount: ta,
      unit,
      timezone: String(timezone || userTimezone || "America/Chicago").trim(),
      reminderSchedule,
      nextReminderAt: nextReminderAt ? parseDateTimeLocalValue(nextReminderAt)?.toISOString() : undefined,

      // âœ… weekly anchor (only sent when weekly + reminders on)
      startAt: startAtISO,
    };

    try {
      if (isEdit) {
        await apiCall(`/habits/${initialHabit._id}`, {
          method: "PUT",
          body: JSON.stringify(payload),
        });
      } else {
        await apiCall(`/habits`, {
          method: "POST",
          body: JSON.stringify(payload),
        });
      }

      tg?.showPopup?.({ message: isEdit ? "Habit updated" : "Habit created" });
      onSaved?.();
      onClose?.();
    } catch (e) {
      tg?.showAlert?.(`Failed to save habit: ${e?.message || String(e)}`);
    }
  };

  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal" onClick={(e) => e.stopPropagation()}>
        <div className="modal-header">
          <h2>{isEdit ? "Edit Habit" : "New Habit"}</h2>
          <button className="modal-close" onClick={onClose} type="button">Ã—</button>
        </div>

        <div className="modal-body">
          <div className="form-group">
            <label className="form-label">Habit Name</label>
            <input className="form-input" value={name} onChange={(e) => setName(e.target.value)} />
          </div>

          <div className="form-group">
            <label className="form-label">Description (optional)</label>
            <textarea
              className="form-textarea form-textarea--sm"
              value={description}
              onChange={(e) => setDescription(e.target.value)}
            />
          </div>

          <div className="modal-divider" />

          <div className="form-group">
            <label className="form-label">Status</label>
            <select className="form-select" value={status} onChange={(e) => setStatus(e.target.value)}>
              <option value="active">active</option>
              <option value="paused">paused</option>
            </select>
          </div>

          <div className="form-group">
            <label className="form-label">Cadence</label>
            <select className="form-select" value={cadence} onChange={(e) => setCadence(e.target.value)}>
              <option value="daily">daily</option>
              <option value="weekly">weekly</option>
            </select>
          </div>

          {cadence === "weekly" && reminderKind !== "off" ? (
            <div className="form-group">
              <label className="form-label">Weekly Start (required for weekly)</label>

              <div className="times-item">
                <input
                  type="date"
                  className="form-input"
                  value={startDate}
                  onChange={(e) => setStartDate(e.target.value)}
                />

                <input
                  type="time"
                  className="form-input"
                  value={startTime}
                  onChange={(e) => setStartTime(e.target.value)}
                />
              </div>
            </div>
          ) : null}

          <div className="form-group">
            <label className="form-label">Target Count (sessions per cadence)</label>
            <input
              type="number"
              className="form-input"
              min="1"
              value={targetCount}
              onChange={(e) => setTargetCount(e.target.value)}
            />
          </div>

          <div className="form-group">
            <label className="form-label">Unit</label>
            <select className="form-select" value={unit} onChange={(e) => setUnit(e.target.value)}>
              <option value="sessions">sessions</option>
              <option value="minutes">minutes</option>
              <option value="hours">hours</option>
              <option value="steps">steps</option>
              <option value="cups">cups</option>
              <option value="oz">oz</option>
              <option value="ml">ml</option>
              <option value="pages">pages</option>
              <option value="count">count</option>
            </select>
          </div>

          <div className="form-group">
            <label className="form-label">Target Amount (optional)</label>
            <input
              type="number"
              className="form-input"
              min="0"
              value={targetAmount}
              onChange={(e) => setTargetAmount(e.target.value)}
              placeholder={isSessionsUnit(unit) ? "Leave empty for sessions-only" : `Amount in ${unit}`}
            />
          </div>

          <div className="form-group">
            <label className="form-label">Timezone</label>
            <input className="form-input" value={timezone} onChange={(e) => setTimezone(e.target.value)} />
          </div>

          <div className="modal-divider" />

          <div className="form-group">
            <label className="form-label">Reminder Schedule Kind</label>
            <select className="form-select" value={reminderKind} onChange={(e) => setReminderKind(e.target.value)}>
              <option value="off">off</option>
              <option value="times">times</option>
              <option value="hourly">hourly</option>
              <option value="every_x_minutes">every_x_minutes</option>
            </select>
          </div>

          {reminderKind === "times" ? (
            <div className="form-group">
              <label className="form-label">Times of Day</label>

              <div className="times-list">
                {(timesOfDay || []).map((t, i) => (
                  <div className="times-item" key={i}>
                    <input
                      type="time"
                      className="form-input"
                      value={t}
                      onChange={(e) => updateTime(i, e.target.value)}
                    />
                    <button className="btn btn-danger" type="button" onClick={() => removeTime(i)}>
                      Remove
                    </button>
                  </div>
                ))}
              </div>

              <div className="times-add">
                <button className="btn btn-secondary" type="button" onClick={addTime}>
                  Add Time
                </button>
              </div>
            </div>
          ) : null}

          {reminderKind === "hourly" ? (
            <div className="form-group">
              <label className="form-label">Every Hours</label>
              <input
                type="number"
                min="1"
                className="form-input"
                value={everyHours}
                onChange={(e) => setEveryHours(e.target.value)}
              />
            </div>
          ) : null}

          {reminderKind === "every_x_minutes" ? (
            <div className="form-group">
              <label className="form-label">Every Minutes</label>
              <input
                type="number"
                min="1"
                className="form-input"
                value={everyMinutes}
                onChange={(e) => setEveryMinutes(e.target.value)}
              />
            </div>
          ) : null}

          {reminderKind === "hourly" || reminderKind === "every_x_minutes" ? (
            <div className="form-group">
              <label className="form-label">Window (optional)</label>
              <div className="times-item">
                <input
                  type="time"
                  className="form-input"
                  value={windowStart}
                  onChange={(e) => setWindowStart(e.target.value)}
                />
                <input
                  type="time"
                  className="form-input"
                  value={windowEnd}
                  onChange={(e) => setWindowEnd(e.target.value)}
                />
              </div>
            </div>
          ) : null}

          <div className="form-group">
            <label className="form-label">Days of Week (optional)</label>
            <div className="weekday-picker">
              {weekdayLabels.map((lab, idx) => {
                const active = Array.isArray(daysOfWeek) && daysOfWeek.includes(idx);
                const cls = `btn ${active ? "btn-primary" : "btn-secondary"}`;
                return (
                  <button key={idx} type="button" className={cls} onClick={() => toggleDay(idx)}>
                    {lab}
                  </button>
                );
              })}
            </div>
          </div>

          <div className="form-group">
            <label className="form-label">Next Reminder At (optional override)</label>
            <input
              type="datetime-local"
              className="form-input"
              value={nextReminderAt}
              onChange={(e) => setNextReminderAt(e.target.value)}
            />
          </div>
        </div>

        <div className="modal-actions">
          <button className="btn btn-secondary" type="button" onClick={onClose}>
            Cancel
          </button>
          <button className="btn btn-primary" type="button" onClick={save}>
            {isEdit ? "Update" : "Create"}
          </button>
        </div>
      </div>
    </div>
  );
}


// Habit Log Modal
function HabitLogModal({ habit, onClose, onCreated }) {
  const unit = String(habit?.unit || "sessions");
  const [startedAt, setStartedAt] = useState(fmtDateTimeLocalValue(new Date()));
  const [endedAt, setEndedAt] = useState("");
  const [amount, setAmount] = useState(isSessionsUnit(unit) ? "" : "");

  useEffect(() => {
    document.body.classList.add("modal-open");
    return () => document.body.classList.remove("modal-open");
  }, []);

  const save = async () => {
    const s = parseDateTimeLocalValue(startedAt);
    if (!s) {
      tg?.showAlert?.("startedAt is required and must be valid.");
      return;
    }

    const e = endedAt ? parseDateTimeLocalValue(endedAt) : null;
    if (e && e.getTime() < s.getTime()) {
      tg?.showAlert?.("endedAt cannot be before startedAt.");
      return;
    }

    let amt = undefined;
    if (amount !== "" && amount !== null && amount !== undefined) {
      const n = Number(amount);
      if (!Number.isFinite(n) || n < 0) {
        tg?.showAlert?.("amount must be >= 0.");
        return;
      }
      amt = n;
    }

    try {
      await apiCall(`/habits/${habit._id}/logs`, {
        method: "POST",
        body: JSON.stringify({
          startedAt: s.toISOString(),
          endedAt: e ? e.toISOString() : undefined,
          amount: amt,
        }),
      });

      tg?.showPopup?.({ message: "Session logged" });
      onCreated?.();
      onClose?.();
    } catch (e2) {
      tg?.showAlert?.(`Failed to log session: ${e2?.message || String(e2)}`);
    }
  };

  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal" onClick={(e) => e.stopPropagation()}>
        <div className="modal-header">
          <h2>Log Session</h2>
          <button className="modal-close" onClick={onClose} type="button">Ã—</button>
        </div>

        <div className="modal-body">
          <div className="form-group">
            <label className="form-label">Started At</label>
            <input
              type="datetime-local"
              className="form-input"
              value={startedAt}
              onChange={(e) => setStartedAt(e.target.value)}
            />
          </div>

          <div className="form-group">
            <label className="form-label">Ended At (optional)</label>
            <input
              type="datetime-local"
              className="form-input"
              value={endedAt}
              onChange={(e) => setEndedAt(e.target.value)}
            />
          </div>

          <div className="form-group">
            <label className="form-label">Amount (optional)</label>
            <input
              type="number"
              min="0"
              className="form-input"
              value={amount}
              onChange={(e) => setAmount(e.target.value)}
              placeholder={isSessionsUnit(unit) ? "Leave empty for sessions-only" : `Amount in ${unit}`}
            />
          </div>
        </div>

        <div className="modal-actions">
          <button className="btn btn-secondary" type="button" onClick={onClose}>Cancel</button>
          <button className="btn btn-primary" type="button" onClick={save}>Save Log</button>
        </div>
      </div>
    </div>
  );
}


// Habits Logs Modal
function HabitLogsModal({ habit, onClose }) {
  const [logs, setLogs] = useState([]);
  const [loading, setLoading] = useState(true);

  const [editingLog, setEditingLog] = useState(null);
  const [showEdit, setShowEdit] = useState(false);

  const load = async () => {
    try {
      setLoading(true);
      const data = await apiCall(`/habits/${habit._id}/logs?limit=50&skip=0`);
      setLogs(Array.isArray(data?.logs) ? data.logs : []);
    } catch (e) {
      tg?.showAlert?.(`Failed to load logs: ${e?.message || String(e)}`);
      setLogs([]);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    document.body.classList.add("modal-open");
    load();
    return () => document.body.classList.remove("modal-open");
  }, []);

  const del = async (log) => {
    try {
      await apiCall(`/habits/${habit._id}/logs/${log._id}`, { method: "DELETE" });
      tg?.showPopup?.({ message: "Log deleted" });
      load();
    } catch (e) {
      tg?.showAlert?.(`Failed to delete log: ${e?.message || String(e)}`);
    }
  };

  const openEdit = (log) => {
    setEditingLog(log);
    setShowEdit(true);
  };

  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal" onClick={(e) => e.stopPropagation()}>
        <div className="modal-header">
          <h2>Logs: {String(habit?.name || "")}</h2>
          <button className="modal-close" onClick={onClose} type="button">Ã—</button>
        </div>

        <div className="modal-body">
          {loading ? (
            <div className="loading">
              <div className="spinner" />
              <div>Loading logs...</div>
            </div>
          ) : logs.length === 0 ? (
            <div className="empty-state">
              <div className="empty-state-text">No logs yet.</div>
            </div>
          ) : (
            <div className="logs-list">
              {logs.map((log) => {
                const unit = String(log?.unit || habit?.unit || "sessions");
                const started = log?.startedAt ? new Date(log.startedAt) : null;
                const ended = log?.endedAt ? new Date(log.endedAt) : null;

                const amount = log?.amount === undefined || log?.amount === null
                  ? ""
                  : `${log.amount}${unit ? " " + unit : ""}`;

                const timeLine =
                  started && !isNaN(started.getTime())
                    ? `${started.toLocaleString()}${ended && !isNaN(ended.getTime()) ? ` â†’ ${ended.toLocaleString()}` : ""}`
                    : "Unknown time";

                return (
                  <div className="log-row" key={log._id}>
                    <div className="log-top">
                      <div className="log-amount">{amount || "Session"}</div>
                      <div className="log-time">{timeLine}</div>
                    </div>

                    <div className="log-actions">
                      <button className="btn btn-primary" type="button" onClick={() => openEdit(log)}>Edit</button>
                      <button className="btn btn-danger" type="button" onClick={() => del(log)}>Delete</button>
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </div>

        <div className="modal-actions">
          <button className="btn btn-secondary" type="button" onClick={onClose}>Close</button>
        </div>

        {showEdit && editingLog ? (
          <HabitLogEditModal
            habit={habit}
            log={editingLog}
            onClose={() => setShowEdit(false)}
            onSaved={load}
          />
        ) : null}
      </div>
    </div>
  );
}


// Habits Log Edit Modal
function HabitLogEditModal({ habit, log, onClose, onSaved }) {
  const unit = String(habit?.unit || "sessions");

  const [startedAt, setStartedAt] = useState(log?.startedAt ? fmtDateTimeLocalValue(log.startedAt) : fmtDateTimeLocalValue(new Date()));
  const [endedAt, setEndedAt] = useState(log?.endedAt ? fmtDateTimeLocalValue(log.endedAt) : "");
  const [amount, setAmount] = useState(log?.amount === undefined || log?.amount === null ? "" : String(log.amount));

  useEffect(() => {
    document.body.classList.add("modal-open");
    return () => document.body.classList.remove("modal-open");
  }, []);

  const save = async () => {
    const s = parseDateTimeLocalValue(startedAt);
    if (!s) {
      tg?.showAlert?.("startedAt must be valid.");
      return;
    }
    const e = endedAt ? parseDateTimeLocalValue(endedAt) : null;
    if (e && e.getTime() < s.getTime()) {
      tg?.showAlert?.("endedAt cannot be before startedAt.");
      return;
    }

    let amt = undefined;
    if (amount !== "" && amount !== null && amount !== undefined) {
      const n = Number(amount);
      if (!Number.isFinite(n) || n < 0) {
        tg?.showAlert?.("amount must be >= 0.");
        return;
      }
      amt = n;
    }

    try {
      await apiCall(`/habits/${habit._id}/logs/${log._id}`, {
        method: "PUT",
        body: JSON.stringify({
          startedAt: s.toISOString(),
          endedAt: e ? e.toISOString() : null,
          amount: amt === undefined ? "" : amt,
        }),
      });

      tg?.showPopup?.({ message: "Log updated" });
      onSaved?.();
      onClose?.();
    } catch (e2) {
      tg?.showAlert?.(`Failed to update log: ${e2?.message || String(e2)}`);
    }
  };

  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal" onClick={(e) => e.stopPropagation()}>
        <div className="modal-header">
          <h2>Edit Log</h2>
          <button className="modal-close" onClick={onClose} type="button">Ã—</button>
        </div>

        <div className="modal-body">
          <div className="form-group">
            <label className="form-label">Started At</label>
            <input
              type="datetime-local"
              className="form-input"
              value={startedAt}
              onChange={(e) => setStartedAt(e.target.value)}
            />
          </div>

          <div className="form-group">
            <label className="form-label">Ended At (optional)</label>
            <input
              type="datetime-local"
              className="form-input"
              value={endedAt}
              onChange={(e) => setEndedAt(e.target.value)}
            />
          </div>

          <div className="form-group">
            <label className="form-label">Amount (optional)</label>
            <input
              type="number"
              min="0"
              className="form-input"
              value={amount}
              onChange={(e) => setAmount(e.target.value)}
              placeholder={isSessionsUnit(unit) ? "Leave empty for sessions-only" : `Amount in ${unit}`}
            />
          </div>
        </div>

        <div className="modal-actions">
          <button className="btn btn-secondary" type="button" onClick={onClose}>Cancel</button>
          <button className="btn btn-primary" type="button" onClick={save}>Save</button>
        </div>
      </div>
    </div>
  );
}


// Habits View
function HabitsView({ activeView, userTimezone, userDisplayName, onBack }) {
  const [habits, setHabits] = useState([]);
  const [loading, setLoading] = useState(true);

  const [includePaused, setIncludePaused] = useState(false);
  const [cadenceFilter, setCadenceFilter] = useState("all");

  const [showEditor, setShowEditor] = useState(false);
  const [editingHabit, setEditingHabit] = useState(null);

  const [showLogModal, setShowLogModal] = useState(false);
  const [logHabit, setLogHabit] = useState(null);

  const [showLogsModal, setShowLogsModal] = useState(false);
  const [logsHabit, setLogsHabit] = useState(null);

  const loadHabits = async () => {
    try {
      setLoading(true);

      // IMPORTANT: keep the leading slash
      const url = `/habits${includePaused ? "?includePaused=1" : ""}`;

      // apiCall returns data (same as your books/reminders code)
      const data = await apiCall(url);

      // Your backend returns: { ok: true, habits }
      // But we don't rely on ok here; we just read habits safely.
      let list = Array.isArray(data?.habits) ? data.habits : [];

      if (cadenceFilter !== "all") {
        list = list.filter((h) => String(h?.cadence || "daily") === cadenceFilter);
      }

      setHabits(list);
    } catch (e) {
      tg?.showAlert?.(`Failed to load habits: ${e?.message || String(e)}`);
      setHabits([]);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    if (activeView === "habits") loadHabits();
  }, [activeView, includePaused, cadenceFilter]);

  const createHabit = () => {
    setEditingHabit(null);
    setShowEditor(true);
  };

  const editHabit = (h) => {
    setEditingHabit(h);
    setShowEditor(true);
  };

  const delHabit = async (h) => {
    try {
      await apiCall(`/habits/${h._id}`, { method: "DELETE" });
      tg?.showPopup?.({ message: "Habit deleted" });
      loadHabits();
    } catch (e) {
      tg?.showAlert?.(`Failed to delete habit: ${e?.message || String(e)}`);
    }
  };

  const togglePause = async (h) => {
    try {
      const next = String(h.status) === "paused" ? "active" : "paused";
      await apiCall(`/habits/${h._id}`, {
        method: "PUT",
        body: JSON.stringify({ status: next }),
      });
      tg?.showPopup?.({ message: next === "paused" ? "Paused" : "Resumed" });
      loadHabits();
    } catch (e) {
      tg?.showAlert?.(`Failed to update habit: ${e?.message || String(e)}`);
    }
  };

  const openLog = (h) => {
    setLogHabit(h);
    setShowLogModal(true);
  };

  const openLogs = (h) => {
    setLogsHabit(h);
    setShowLogsModal(true);
  };

  return (
    <div>
      <div className="header">
        <div>
          <h1>Habits</h1>
          {(() => {
            const name = (userDisplayName || "").trim();
            return name ? <div className="reminders-greeting">Hello {name}</div> : null;
          })()}
        </div>

        <div className="habits-header-actions">
          <button className="btn btn-secondary" type="button" onClick={onBack}>
            Back
          </button>
          <button className="btn btn-primary" type="button" onClick={createHabit}>
            New
          </button>
        </div>
      </div>

      <div className="quick-actions">
        <div
          className={`quick-action ${cadenceFilter === "all" ? "active" : ""}`}
          onClick={() => setCadenceFilter("all")}
        >
          All
        </div>
        <div
          className={`quick-action ${cadenceFilter === "daily" ? "active" : ""}`}
          onClick={() => setCadenceFilter("daily")}
        >
          Daily
        </div>
        <div
          className={`quick-action ${cadenceFilter === "weekly" ? "active" : ""}`}
          onClick={() => setCadenceFilter("weekly")}
        >
          Weekly
        </div>

        <div
          className={`quick-action ${includePaused ? "active" : ""}`}
          onClick={() => setIncludePaused((v) => !v)}
          style={{ marginLeft: "auto" }}
        >
          Include Paused
        </div>
      </div>

      {loading ? (
        <div className="loading">
          <div className="spinner" />
          <div>Loading habits...</div>
        </div>
      ) : habits.length === 0 ? (
        <div className="empty-state">
          <div className="empty-state-text">No habits yet. Tap New.</div>
          <div className="empty-state-icon">
            <img src="/icons/habits.svg" alt="" />
          </div>
        </div>
      ) : (
        habits.map((h) => (
          <HabitCard
            key={h._id}
            habit={h}
            onEdit={editHabit}
            onDelete={delHabit}
            onTogglePause={togglePause}
            onOpenLog={openLog}
            onOpenLogs={openLogs}
          />
        ))
      )}

      <button className="is-hidden" data-create-habit="1" onClick={createHabit} />

      {showEditor ? (
        <HabitEditorModal
          initialHabit={editingHabit}
          userTimezone={userTimezone}
          onClose={() => setShowEditor(false)}
          onSaved={loadHabits}
        />
      ) : null}

      {showLogModal && logHabit ? (
        <HabitLogModal
          habit={logHabit}
          onClose={() => setShowLogModal(false)}
          onCreated={loadHabits}
        />
      ) : null}

      {showLogsModal && logsHabit ? (
        <HabitLogsModal habit={logsHabit} onClose={() => setShowLogsModal(false)} />
      ) : null}
    </div>
  );
}

// =========================
// CHECKLIST COMPONENTS
// =========================

// Checklist Card
function ChecklistCard({ item, onToggle, onEdit, onDelete }) {
  const [expanded, setExpanded] = useState(false);

  const handleToggle = (e) => {
    e.stopPropagation();
    onToggle(item);
  };

  return (
    <div className="card checklist-item">
      <div className="checklist-item-row">
        <button
          className={`checklist-checkbox ${item.done ? "done" : ""}`}
          onClick={handleToggle}
          type="button"
        >
          <img src="/icons/check.svg" alt="" />
        </button>

        <div className={`checklist-text ${item.done ? "done" : ""}`}>
          {item.text || "(empty)"}
        </div>

        <button
          className="checklist-expand"
          type="button"
          onClick={(e) => {
            e.stopPropagation();
            setExpanded((v) => !v);
          }}
        >
          <img src="/icons/more.svg" alt="" />
        </button>
      </div>

      {expanded && (
        <div className="card-actions" style={{ marginTop: 12 }}>
          <button
            className="btn btn-primary"
            type="button"
            onClick={() => onEdit(item)}
          >
            <img src="/icons/pencil.svg" alt="" />
            Edit
          </button>

          <button
            className="btn btn-danger"
            type="button"
            onClick={() => onDelete(item)}
          >
            <img src="/icons/trash.svg" alt="" />
          </button>
        </div>
      )}
    </div>
  );
}

// Checklist Modal
function ChecklistModal({ item, onClose, onSave }) {
const [text, setText] = useState(item && item.text ? item.text : '');

  useEffect(() => {
    document.body.classList.add('modal-open');
    return () => document.body.classList.remove('modal-open');
  }, []);

  const handleSave = async () => {
    if (!text.trim()) {
      tg.showAlert('Please enter some text');
      return;
    }

    await onSave({ text: text.trim() });
  };

  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal" onClick={e => e.stopPropagation()}>
        <div className="modal-header">
          <h2>{item ? 'Edit Item' : 'New Item'}</h2>
          <button className="modal-close" type="button" onClick={onClose}>Ã—</button>
        </div>

        <div className="modal-body">
          <div className="form-group">
            <label className="form-label">Text</label>
            <textarea
              className="form-textarea form-textarea--sm"
              value={text}
              onChange={e => setText(e.target.value)}
              placeholder="What do you need to do?"
              autoFocus
            />
          </div>
        </div>

        <div className="modal-actions">
          <button className="btn btn-secondary" type="button" onClick={onClose}>
  Cancel
</button>
<button className="btn btn-primary" type="button" onClick={handleSave}>
  {item ? 'Update' : 'Create'}
</button>
        </div>
      </div>
    </div>
  );
}

// Checklist View
function ChecklistView({ activeView, userDisplayName, onBack }) {
const [items, setItems] = useState([]);
const [loading, setLoading] = useState(true);
const [showModal, setShowModal] = useState(false);
const [editingItem, setEditingItem] = useState(null);
const [filter, setFilter] = useState('active');

  useEffect(() => {
    if (activeView === 'checklist') {
      loadItems();
    }
  }, [activeView]);

  const loadItems = async () => {
    try {
      setLoading(true);
      const data = await apiCall("/checklist");

// Accept a few possible shapes safely:
const list =
  Array.isArray(data?.items) ? data.items :
  Array.isArray(data?.checklist) ? data.checklist :
  Array.isArray(data?.data?.items) ? data.data.items :
  [];

setItems(list);
    } catch (error) {
      tg.showAlert('Failed to load checklist: ' + error.message);
    } finally {
      setLoading(false);
    }
  };

  const handleCreate = () => {
    setEditingItem(null);
    setShowModal(true);
  };

  const handleEdit = (item) => {
    setEditingItem(item);
    setShowModal(true);
  };

  const handleSave = async (data) => {
    try {
      if (editingItem) {
        await apiCall(`/checklist/${editingItem._id}`, {
          method: 'PUT',
          body: JSON.stringify(data),
        });
        tg.showPopup({ message: 'Item updated' });
      } else {
        await apiCall('/checklist', {
          method: 'POST',
          body: JSON.stringify(data),
        });
        tg.showPopup({ message: 'Item created' });
      }
      setShowModal(false);
      loadItems();
    } catch (error) {
      tg.showAlert('Failed to save: ' + error.message);
    }
  };

  const handleToggle = async (item) => {
    try {
      await apiCall(`/checklist/${item._id}/toggle`, {
        method: 'POST',
      });
      loadItems();
    } catch (error) {
      tg.showAlert('Failed to toggle: ' + error.message);
    }
  };

const handleDelete = async (item) => {
  try {
    const id = typeof item === "string" ? item : item?._id;
    if (!id) return;

    await apiCall(`/checklist/${id}`, { method: "DELETE" });

    tg.showPopup({ message: "Item deleted" });
    loadItems();
  } catch (error) {
    tg.showAlert("Failed to delete: " + (error?.message || String(error)));
  }
};

  const safeItems = Array.isArray(items) ? items : [];

const filteredItems = safeItems
  .filter(Boolean) // removes null/undefined elements if backend ever sends them
  .filter((item) => {
    if (filter === "active") return !item.done;
    if (filter === "done") return !!item.done;
    return true;
  });

  return (
    <div>
      <div className="header">
        <div>
          <h1>Checklist</h1>
          {(() => {
            const name = (userDisplayName || '').trim();
            return name ? <div className="reminders-greeting">Hello {name}</div> : null;
          })()}
        </div>

        <button className="btn btn-secondary"  type="button" onClick={onBack}>
          Back
        </button>
      </div>

      <div className="quick-actions">
        <div
          className={`quick-action ${filter === 'all' ? 'active' : ''}`}
          onClick={() => setFilter('all')}
        >
          All
        </div>
        <div
          className={`quick-action ${filter === 'active' ? 'active' : ''}`}
          onClick={() => setFilter('active')}
        >
          Active
        </div>
        <div
          className={`quick-action ${filter === 'done' ? 'active' : ''}`}
          onClick={() => setFilter('done')}
        >
          Done
        </div>
      </div>

      {loading ? (
        <div className="loading">
          <div className="spinner" />
          <div>Loading checklist...</div>
        </div>
      ) : filteredItems.length === 0 ? (
        <div className="empty-state">
          <div className="empty-state-icon">
            <img src="/icons/check.svg" alt="" />
          </div>
          <div className="empty-state-text">
  {filter === 'all' ? (
    <>
      <div>No items yet.</div>
      <div>Tap + to create one!</div>
    </>
  ) : (
    `No ${filter} items.`
  )}
</div>
        </div>
      ) : (
        filteredItems.map(item => (
          <ChecklistCard
            key={item._id}
            item={item}
            onToggle={handleToggle}
            onEdit={handleEdit}
            onDelete={handleDelete}
          />
        ))
      )}

      <button
        className="is-hidden"
        data-create-checklist="1"
        onClick={handleCreate}
      />

      {showModal && (
        <ChecklistModal
          item={editingItem}
          onClose={() => setShowModal(false)}
          onSave={handleSave}
        />
      )}
    </div>
  );
}


// Book Card Component
function BookCard({ book, onEdit, onDelete, onRate }) {
  const [expanded, setExpanded] = React.useState(false);

  const title = book.title?.trim() ? book.title.trim() : "(untitled)";
  const author = book.author?.trim() ? book.author.trim() : "";
  const badge = badgeForStatus(book.status);

  const isReading = String(book.status || "").toLowerCase() === "reading";

  const totalPages =
    typeof book.totalPages === "number" && Number.isFinite(book.totalPages)
      ? book.totalPages
      : null;

  const currentPage =
    typeof book.currentPage === "number" && Number.isFinite(book.currentPage)
      ? book.currentPage
      : null;

  const hasProgress = isReading && totalPages && totalPages > 0;

  const safeCurrent = hasProgress
    ? Math.min(Math.max(currentPage || 0, 0), totalPages)
    : 0;

  const pct = hasProgress ? Math.round((safeCurrent / totalPages) * 100) : null;

  // â­ rating (0â€“5) - DEFINE IT HERE AT COMPONENT LEVEL
  const rating = Math.max(0, Math.min(5, Number(book?.rating || 0)));

  async function patchRating(nextRating) {
    const id = String(book?.id || book?._id || "").trim();
    if (!id) {
      console.log("âŒ patchRating: missing book id", { book });
      return null;
    }

    const r = Math.max(0, Math.min(5, Number(nextRating || 0))); // renamed to 'r' to avoid conflict

    console.log("ðŸ“¡ PATCH rating payload", { id, rating: r });

    const data = await apiCall(`/books/${id}/rating`, {
      method: "PATCH",
      body: JSON.stringify({ rating: r }),
    });

    console.log("âœ… PATCH response", data);

    return data?.book || null;
  }

  const setRating = async (n) => {
    const next = n === rating ? 0 : n;
    console.log("â­ setRating click", { n, current: rating, next });

    try {
      const updatedBook = await patchRating(next);

      if (!updatedBook) {
        console.log("âš ï¸ No updatedBook returned from patchRating");
        return;
      }

      console.log("âœ… Updated book rating (server)", {
        id: updatedBook.id || updatedBook._id,
        rating: updatedBook.rating,
      });

      // Call parent AFTER server confirms
      if (onRate) {
        onRate(updatedBook, Number(updatedBook.rating || 0));
      }
    } catch (err) {
      console.error("âŒ setRating error", err);
      // Show user-friendly error
      if (window.Telegram?.WebApp?.showAlert) {
        window.Telegram.WebApp.showAlert("Failed to update rating: " + (err.message || "Unknown error"));
      }
    }
  };

  return (
    <div className="card" onClick={() => setExpanded(!expanded)}>
      <div className="card-header">
        <div>
          <div style={{ fontSize: 16, fontWeight: 700, marginBottom: 6 }}>
            {title}
          </div>

          {author && (
            <div className="card-author">
              <img src="/icons/user.svg" alt="" />
              <span>{author}</span>
            </div>
          )}

          {/* â­ Rating */}
          <div className="book-rating-row" onClick={(e) => e.stopPropagation()}>
            <div className="star-rating">
              {[1, 2, 3, 4, 5].map((n) => (
                <button
                  key={n}
                  type="button"
                  className={`star-btn ${n <= rating ? "is-on" : ""}`}
                  onClick={() => setRating(n)}
                  title={`${n} star${n === 1 ? "" : "s"}`}
                >
                  <img
                    src="/icons/star.svg"
                    alt=""
                    aria-hidden="true"
                    className="star-icon"
                  />
                </button>
              ))}
            </div>
          </div>
        </div>

        <span className="card-badge" style={{ background: badge.bg, color: badge.fg }}>
          {String(book.status || "").toLowerCase() === "finished" && (
            <img src="/icons/check.svg" alt="" className="badge-icon" />
          )}
          {badge.text}
        </span>
      </div>

      {book.shortSummary && <div className="book-summary">{book.shortSummary}</div>}

      {hasProgress && (
        <div className="progress-wrap" onClick={(e) => e.stopPropagation()}>
          <div className="progress-top">
            <div>
              {safeCurrent} / {totalPages} pages
            </div>
            <div className="progress-pct">{pct}%</div>
          </div>

          <div className="progress-bar" aria-label="Reading progress">
            <div className="progress-fill" style={{ width: `${pct}%` }} />
          </div>
        </div>
      )}

      {expanded && (
        <div className="card-actions" onClick={(e) => e.stopPropagation()}>
          <button className="btn btn-primary" onClick={() => onEdit(book)}>
            <img src="/icons/pencil.svg" alt="" />
            Edit
          </button>

          <button className="btn btn-danger" onClick={() => onDelete(book._id)}>
            <img src="/icons/trash.svg" alt="" />
          </button>
        </div>
      )}
    </div>
  );
}


// Book Create & Edit Modal
function BookModal({ book, onClose, onSave, onDelete }) {
  const isEdit = !!book?._id;

  const [title, setTitle] = useState(book?.title || "");
  const [author, setAuthor] = useState(book?.author || "");
  const [status, setStatus] = useState(book?.status || "tbr");
  const [shortSummary, setShortSummary] = useState(book?.shortSummary || "");

  // New: progress fields (optional)
  const [totalPages, setTotalPages] = useState(
    typeof book?.totalPages === "number" ? String(book.totalPages) : ""
  );
  const [currentPage, setCurrentPage] = useState(
    typeof book?.currentPage === "number" ? String(book.currentPage) : ""
  );

  const isReading = String(status || "").toLowerCase() === "reading";
  

  useEffect(() => {
    document.body.classList.add("modal-open");
    return () => document.body.classList.remove("modal-open");
  }, []);

  // If user changes away from reading, clear progress (keeps UI consistent)
  useEffect(() => {
    if (!isReading) {
      setTotalPages("");
      setCurrentPage("");
    }
  }, [isReading]);

  const handleSave = async () => {
    if (!title.trim()) {
      tg.showAlert("Please enter a title");
      return;
    }

    // Build payload
    const payload = {
      title: title.trim(),
      author: author.trim(),
      status: statusLabelToValue(status),
    };
    
       // Add Summary
        if (shortSummary.trim()) {
  payload.shortSummary = shortSummary.trim();
}

    // Only include progress if reading
    if (isReading) {
      const tp = totalPages === "" ? null : Number(totalPages);
      const cp = currentPage === "" ? null : Number(currentPage);

      if (tp !== null && (!Number.isFinite(tp) || tp < 1)) {
        tg.showAlert("Total pages must be a positive number.");
        return;
      }

      if (cp !== null && (!Number.isFinite(cp) || cp < 0)) {
        tg.showAlert("Current page must be 0 or more.");
        return;
      }

      // Clamp if both provided
      let safeTp = tp;
      let safeCp = cp;

      if (safeTp !== null && safeTp > 0 && safeCp !== null) {
        safeCp = Math.min(Math.max(safeCp, 0), safeTp);
      }

      payload.totalPages = safeTp;
      payload.currentPage = safeCp;
    }

    await onSave(payload);
  };

  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal" onClick={(e) => e.stopPropagation()}>
        <div className="modal-header">
          <h2>{isEdit ? "Edit Book" : "New Book"}</h2>
          <button className="modal-close" onClick={onClose}>Ã—</button>
        </div>

        <div className="modal-body">
          <div className="form-group">
            <label className="form-label">Title</label>
            <input
              className="form-input"
              value={title}
              onChange={(e) => setTitle(e.target.value)}
              placeholder="Book title..."
            />
          </div>

          <div className="form-group">
            <label className="form-label">Author (optional)</label>
            <input
              className="form-input"
              value={author}
              onChange={(e) => setAuthor(e.target.value)}
              placeholder="Author name..."
            />
          </div>
          
          <div className="form-group">
  <label className="form-label">Short Summary (optional)</label>
  <textarea
    className="form-textarea form-textarea--sm"
    value={shortSummary}
    onChange={(e) => setShortSummary(e.target.value)}
    placeholder="One or two short sentences about this bookâ€¦"
    maxLength={1500}
  />
</div>

          <div className="form-group">
            <label className="form-label">Status</label>
            <select
              className="form-select"
              value={status}
              onChange={(e) => setStatus(e.target.value)}
            >
              <option value="tbr">TBR</option>
              <option value="reading">Reading/Active</option>
              <option value="paused">Paused</option>
              <option value="dnf">DNF</option>
              <option value="finished">Finished</option>
            </select>
          </div>

          {isReading && (
            <div className="form-row">
              <div className="form-group">
                <label className="form-label">Total Pages</label>
                <input
                  type="number"
                  className="form-input"
                  value={totalPages}
                  min="1"
                  onChange={(e) => setTotalPages(e.target.value)}
                  placeholder="e.g. 384"
                />
              </div>

              <div className="form-group">
                <label className="form-label">Current Page</label>
                <input
                  type="number"
                  className="form-input"
                  value={currentPage}
                  min="0"
                  onChange={(e) => setCurrentPage(e.target.value)}
                  placeholder="e.g. 120"
                />
              </div>
            </div>
          )}
        </div>

        <div className="modal-actions">
          {isEdit ? (
            <button className="btn btn-danger" onClick={() => onDelete(book._id)}>
              Delete
            </button>
          ) : (
            <button className="btn btn-secondary" onClick={onClose}>
              Cancel
            </button>
          )}

          <button className="btn btn-primary" onClick={handleSave}>
            {isEdit ? "Update" : "Create"}
          </button>
        </div>
      </div>
    </div>
  );
}

// Book Summary Modal
function SummaryModal({ onClose, title, author, loading, summary, source, error, onSearchAgain }) {
  useEffect(() => {
    document.body.classList.add("modal-open");
    return () => document.body.classList.remove("modal-open");
  }, []);

  const headerTitle = "Summary";

  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal" onClick={(e) => e.stopPropagation()}>
        <div className="modal-header">
          <h2>{headerTitle}</h2>
          <button className="modal-close" onClick={onClose}>Ã—</button>
        </div>

        <div className="modal-body">
          <div style={{ marginBottom: 12, opacity: 0.85, lineHeight: 1.4 }}>
            <div style={{ fontWeight: 700 }}>{title || "Untitled"}</div>
            {author ? <div style={{ color: "var(--text-secondary)" }}>{author}</div> : null}
          </div>

          {loading ? (
            <div className="loading">
              <div className="spinner" />
              <div>Searchingâ€¦</div>
            </div>
          ) : error ? (
            <div className="empty-state-text">{error}</div>
          ) : summary ? (
            <div style={{ whiteSpace: "pre-line", lineHeight: 1.6, fontSize: 15 }}>
              {summary}
              {source ? (
                <div style={{ marginTop: 14, fontSize: 12, color: "var(--text-secondary)" }}>
                  Source: {source}
                </div>
              ) : null}
            </div>
          ) : (
            <div className="empty-state-text">No summary to show.</div>
          )}
        </div>

        <div className="modal-actions">
          <button className="btn btn-secondary" onClick={onClose}>
            Close
          </button>

          <button className="btn btn-primary" onClick={onSearchAgain} disabled={loading}>
            Search Again
          </button>
        </div>
      </div>
    </div>
  );
}

// READING STREAKS CARD
function ReadingStreakCard({ streak, loading, onCheckIn }) {
  const current = streak?.currentStreak ?? 0;
  const best = streak?.bestStreak ?? 0;
  const checked = !!streak?.checkedInToday;

  return (
    <div className="card" onClick={(e) => e.stopPropagation()} style={{ cursor: "default" }}>
      <div className="card-header">
        <div>
          <div style={{ fontSize: 16, fontWeight: 800, marginBottom: 6 }}>
            Reading Streak
          </div>
          <div className="card-time">
            <img src="/icons/cal.svg" alt="" />
            <span>{checked ? "Checked in today" : "Not checked in today"}</span>
          </div>
        </div>

        <span
          className="card-badge"
          style={{
            background: checked ? "rgba(76,175,80,0.15)" : "rgba(255,152,0,0.15)",
            color: checked ? "#4caf50" : "#ff9800",
          }}
        >
          {checked ? "ACTIVE" : "PENDING"}
        </span>
      </div>

      <div className="streak-row">
        <div className="streak-stat">
          <div className="streak-stat-label">Current</div>
          <div className="streak-stat-value">{current}</div>
        </div>

        <div className="streak-stat">
          <div className="streak-stat-label">Best</div>
          <div className="streak-stat-value">{best}</div>
        </div>
      </div>

      <div className="streak-actions">
        <button
          className="btn btn-success"
          type="button"
          onClick={onCheckIn}
          disabled={loading || checked}
        >
          <img src="/icons/check.svg" alt="" />
          {checked ? "Checked In" : loading ? "Savingâ€¦" : "Check In"}
        </button>
      </div>
    </div>
  );
}

// Recommendations Modal
function RecsModal({ genre, recs, loading, error, onClose, onSelectGenre }) {
  useEffect(() => {
    document.body.classList.add("modal-open");
    return () => document.body.classList.remove("modal-open");
  }, []);

  const genres = ["Fantasy", "Romance", "Thriller", "Mystery", "Horror", "Historical Fiction", "Sci-Fi", "YA"];

  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal" onClick={(e) => e.stopPropagation()}>
        <div className="modal-header">
          <h2>Recommendations</h2>
          <button className="modal-close" onClick={onClose} type="button">Ã—</button>
        </div>

        <div className="modal-body">
          <div className="form-group">
            <label className="form-label">Genre</label>
            
            <div className="card-actions" style={{ marginBottom: 12 }}>
              {genres.map((g) => (
                <button
                  key={g}
                  type="button"
                  className={`btn ${g === genre ? "btn-primary" : "btn-secondary"}`}
                  onClick={() => onSelectGenre(g)}
                >
                  {g}
                </button>
              ))}
            </div>
          </div>

          {loading && (
            <div className="loading">
              <div className="spinner" />
              <div>Loading recommendationsâ€¦</div>
            </div>
          )}

          {!loading && error && <div className="error-text">{error}</div>}

          {!loading && !error && recs.length === 0 && (
            <div className="empty-state-text">No recommendations found.</div>
          )}

          {!loading && !error && recs.length > 0 && (
            <div className="recs-list">
              {recs.map((r, idx) => (
                <div key={idx} className="rec-card">
                  <div className="rec-title">{r.title}</div>
                  {r.author && <div className="rec-author">{r.author}</div>}
                  <div className="rec-summary">{r.summary}</div>
                </div>
              ))}
            </div>
          )}
        </div>

        <div className="modal-actions">
  <button className="btn btn-secondary" onClick={onClose} type="button">
    Close
  </button>
  
  <button 
    className="btn btn-primary" 
    onClick={() => onSelectGenre(genre)} 
    disabled={loading}
    type="button"
  >
    {loading ? "Loading..." : "Get Recommendations"}
  </button>
</div>
      </div>
    </div>
  );
}


// Reading View
function ReadingView({ activeView }) {
  const [books, setBooks] = useState([]);
  const [loading, setLoading] = useState(true);

  const [filter, setFilter] = useState("all"); // all | tbr | reading | finished

  const [showBookModal, setShowBookModal] = useState(false);
  const [editingBook, setEditingBook] = useState(null);

  const [summaryOpen, setSummaryOpen] = useState(false);
  const [summaryLoading, setSummaryLoading] = useState(false);
  const [summaryText, setSummaryText] = useState("");
  const [summarySource, setSummarySource] = useState("");
  const [summaryError, setSummaryError] = useState("");
  const [summaryTitle, setSummaryTitle] = useState("");
  const [summaryAuthor, setSummaryAuthor] = useState("");
  
    // ---- Recommendations (Recs) modal ----
  const [recsOpen, setRecsOpen] = useState(false);
  const [recsGenre, setRecsGenre] = useState("Fantasy");
  const [recsLoading, setRecsLoading] = useState(false);
  const [recsError, setRecsError] = useState("");
  const [recs, setRecs] = useState([]);
  
  const [streak, setStreak] = useState(null);
const [streakLoading, setStreakLoading] = useState(false);

const loadRecs = React.useCallback(async (genre) => {
  try {
    setRecsLoading(true);
    setRecsError("");
    setRecs([]);

    const data = await apiCall(`/books/recs`, {
      method: "POST",
      body: JSON.stringify({ genre }),
    });

    setRecs(Array.isArray(data?.recs) ? data.recs : []);
  } catch (error) {
    setRecsError(error?.message || "Failed to load recommendations.");
  } finally {
    setRecsLoading(false);
  }
}, []); // empty deps because it only uses parameters and setters


   // âœ… ADD THIS HANDLER
  const handleRating = (book, newRating) => {
    // Update local state optimistically
    setBooks(prev => prev.map(b => 
      b._id === book._id ? { ...b, rating: newRating } : b
    ));
  };

  useEffect(() => {
  if (activeView === "reading") {
    loadBooks();
    loadStreak();
  }
}, [activeView, filter]);


const loadStreak = async () => {
  try {
    setStreakLoading(true);
    const data = await apiCall(`/books/streak`);
    setStreak(data?.streak || null);
  } catch (error) {
    // silent-ish; streak card can just not show if needed
    setStreak(null);
  } finally {
    setStreakLoading(false);
  }
};

const handleCheckIn = async (e) => {
  if (e) e.stopPropagation();
  try {
    setStreakLoading(true);
    const data = await apiCall(`/books/streak/checkin`, {
      method: "POST",
      body: JSON.stringify({}),
    });
    setStreak(data?.streak || null);
    tg.showPopup({ message: "Checked in" });
  } catch (error) {
    tg.showAlert("Failed to check in: " + error.message);
  } finally {
    setStreakLoading(false);
  }
};

const loadBooks = async () => {
  try {
    setLoading(true);
    const data = await apiCall(`/books?status=${encodeURIComponent(filter)}`);
    
    // âœ… ADD THIS DEBUG
    console.log("ðŸ“š Loaded books:", data.books);
    if (data.books && data.books.length > 0) {
      console.log("ðŸ“š First book structure:", {
        id: data.books[0].id,
        _id: data.books[0]._id,
        rating: data.books[0].rating,
      });
    }
    
    setBooks(Array.isArray(data.books) ? data.books : []);
  } catch (error) {
    tg.showAlert("Failed to load books: " + error.message);
  } finally {
    setLoading(false);
  }
};

  const handleCreate = () => {
    setEditingBook(null);
    setShowBookModal(true);
  };

  const handleEdit = (book) => {
    setEditingBook(book);
    setShowBookModal(true);
  };

  const handleSave = async (payload) => {
    try {
      if (editingBook?._id) {
        await apiCall(`/books/${editingBook._id}`, {
          method: "PUT",
          body: JSON.stringify(payload),
        });
        tg.showAlert("Book updated!");
      } else {
        await apiCall(`/books`, {
          method: "POST",
          body: JSON.stringify(payload),
        });
        tg.showAlert("Book added!");
      }

      setShowBookModal(false);
      loadBooks();
    } catch (error) {
      tg.showAlert("Failed to save: " + error.message);
    }
  };

  const handleDelete = async (id) => {
    try {
      await apiCall(`/books/${id}`, { method: "DELETE" });
      tg.showPopup({ message: "Book deleted" });
      loadBooks();
    } catch (error) {
      tg.showAlert("Failed to delete: " + error.message);
    }
  };

  const promptSummarySearch = async () => {
    const t = window.prompt("Book title:");
    if (!t || !t.trim()) return;

    const a = window.prompt("Author (optional):") || "";

    await runSummarySearch(t.trim(), a.trim());
  };

  const runSummarySearch = async (title, author) => {
    try {
      setSummaryTitle(title);
      setSummaryAuthor(author);

      setSummaryOpen(true);
      setSummaryLoading(true);
      setSummaryText("");
      setSummarySource("");
      setSummaryError("");

      const data = await apiCall(`/books/summary`, {
        method: "POST",
        body: JSON.stringify({ title, author }),
      });

      setSummaryText(String(data.summary || ""));
      setSummarySource(String(data.source || ""));
    } catch (error) {
      setSummaryError(error.message || "No summary found.");
    } finally {
      setSummaryLoading(false);
    }
  };

  return (
    <div>
      <div className="header">
        <h1>Reading</h1>

        <div className="journal-header-actions">
          <button className="btn btn-prompt" type="button" onClick={promptSummarySearch}>
            Summary
          </button>
         <button className="btn btn-secondary" type="button" onClick={() => setRecsOpen(true)}>
  Recs
</button>
      </div>
        </div>
      
      <ReadingStreakCard
  streak={streak}
  loading={streakLoading}
  onCheckIn={handleCheckIn}
/>

      <div className="book-quick-actions">
        <div
          className={`book-quick-action ${filter === "all" ? "active" : ""}`}
          onClick={() => setFilter("all")}
        >
          All
        </div>
        <div
          className={`book-quick-action ${filter === "tbr" ? "active" : ""}`}
          onClick={() => setFilter("tbr")}
        >
          TBR
        </div>
        <div
          className={`book-quick-action ${filter === "reading" ? "active" : ""}`}
          onClick={() => setFilter("reading")}
        >
          Reading
        </div>
        <div
          className={`book-quick-action ${filter === "finished" ? "active" : ""}`}
          onClick={() => setFilter("finished")}
        >
          Finished
        </div>
        <div
          className={`book-quick-action ${filter === "paused" ? "active" : ""}`}
          onClick={() => setFilter("paused")}
        >
          Paused
        </div>
        <div
          className={`book-quick-action ${filter === "dnf" ? "active" : ""}`}
          onClick={() => setFilter("dnf")}
        >
          DNF
        </div>
      </div>

      {loading ? (
        <div className="loading">
          <div className="spinner" />
          <div>Loading books...</div>
        </div>
      ) : books.length === 0 ? (
        <div className="empty-state">
          <div className="empty-state-icon">
            <img src="/icons/book.svg" alt="" />
          </div>
          <div className="empty-state-text">
            No books yet.
            {"\n"}Tap + to add one.
          </div>
        </div>
      ) : (
        books.map((book) => (
          <BookCard key={book._id} book={book} onEdit={handleEdit} onDelete={handleDelete} onRate={handleRating} />
        ))
      )}

      {/* Hidden FAB hook */}
      <button
        className="is-hidden"
        data-create-book="1"
        onClick={handleCreate}
      />

      {showBookModal && (
        <BookModal
          book={editingBook}
          onClose={() => setShowBookModal(false)}
          onSave={handleSave}
          onDelete={handleDelete}
        />
      )}

      {summaryOpen && (
        <SummaryModal
          onClose={() => setSummaryOpen(false)}
          title={summaryTitle}
          author={summaryAuthor}
          loading={summaryLoading}
          summary={summaryText}
          source={summarySource}
          error={summaryError}
          onSearchAgain={promptSummarySearch}
        />
      )}
      
      {recsOpen && (
  <RecsModal
    genre={recsGenre}
    recs={recs}
    loading={recsLoading}
    error={recsError}
    onClose={() => setRecsOpen(false)}
    onSelectGenre={(g) => {
      setRecsGenre(g);
      loadRecs(g);
    }}
  />
)}
    </div>
  );
}

// Journal Card Component
function JournalCard({ entry, onView, onEdit, onDelete, onTagSelect }) {
  const [expanded, setExpanded] = useState(false);

  const title = entry.title?.trim() ? entry.title.trim() : '(untitled)';
  const tags = Array.isArray(entry.tags) ? entry.tags : [];
  const body = entry.body || '';

  const preview = body.length > 260 ? body.slice(0, 260) + 'â€¦' : body;

  return (
<div className="card" onClick={() => onView(entry)}>
      <div className="card-header">
        <div>
          <div style={{ fontSize: 16, fontWeight: 700, marginBottom: 6 }}>
            {title}
          </div>
          <div className="card-journal-time">
  <img src="/icons/cal.svg" alt="" />
  <span>{formatShortDate(entry.createdAt)}</span>
</div>
        </div>

        <span className="card-badge" style={{ background: 'rgba(139,125,239,0.15)', color: '#8b7def' }}>
          journal
        </span>
      </div>

      <div className="journal-preview">{preview}</div>

      {tags.length > 0 && (
  <div className="tag-row">
    {tags.map((t) => (
      <button
        key={t}
        type="button"
        className="tag-pill"
        onClick={(e) => {
          e.stopPropagation();               // donâ€™t open the entry viewer
          if (onTagSelect) onTagSelect(t);   // filter by tag
        }}
      >
        #{t}
      </button>
    ))}
  </div>
)}

      {expanded && (
        <div className="card-actions" onClick={e => e.stopPropagation()} style={{ marginTop: 14 }}>
          <button className="btn btn-primary" onClick={() => onEdit(entry)}>
  <img src="/icons/pencil.svg" alt="" />
  Edit
</button>
          <button className="btn btn-danger" onClick={() => onDelete(entry._id)}>
  <img src="/icons/trash.svg" alt="" />
</button>
        </div>
      )}
    </div>
  );
}

// Journal Modal (Create/Edit)
function JournalModal({ entry, onClose, onSave, onDelete }) {
  const [title, setTitle] = useState(entry?.title || '');
  const [tagsText, setTagsText] = useState(tagsToDisplay(entry?.tags || []));
  const [body, setBody] = useState(entry?.body || '');

  const isEdit = !!entry?._id;
  
  useEffect(() => {
    document.body.classList.add('modal-open');
    return () => {
      document.body.classList.remove('modal-open');
    };
  }, []);

  const handleSave = async () => {
    if (!body.trim()) {
      tg.showAlert('Please enter a journal body');
      return;
    }

    const tags = normalizeTagsFromText(tagsText);

    await onSave({
      title: title.trim(),
      body,
      tags
    });
  };

  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal" onClick={e => e.stopPropagation()}>
        <div className="modal-header">
          <h2>{isEdit ? 'Edit Entry' : 'New Entry'}</h2>
          <button className="modal-close" onClick={onClose}>Ã—</button>
        </div>

        <div className="modal-body">
          <div className="form-group">
            <label className="form-label">Title (optional)</label>
            <input
              type="text"
              className="form-input"
              value={title}
              onChange={e => setTitle(e.target.value)}
              placeholder="Title..."
            />
          </div>

          <div className="form-group">
            <label className="form-label">Tags</label>
            <input
              type="text"
              className="form-input"
              value={tagsText}
              onChange={e => setTagsText(e.target.value)}
              placeholder="#tag-1 #tag-2"
            />
          </div>

          <div className="form-group">
            <label className="form-label">Body</label>
            <textarea
              className="form-textarea"
              value={body}
              onChange={e => setBody(e.target.value)}
              placeholder="Write your entry..."
            />
          </div>
        </div>

        <div className="modal-actions">
          {isEdit ? (
            <button className="btn btn-danger" onClick={() => onDelete(entry._id)}>
              Delete
            </button>
          ) : (
            <button className="btn btn-secondary" onClick={onClose}>
              Cancel
            </button>
          )}

          <button className="btn btn-primary" onClick={handleSave}>
            {isEdit ? 'Update' : 'Create'}
          </button>
        </div>
      </div>
    </div>
  );
}

// TAGS VIEW 
function JournalTagsView({ onBack, onPickTag }) {
  const [loading, setLoading] = useState(true);
  const [tags, setTags] = useState([]);
  const [query, setQuery] = useState("");

  useEffect(() => {
    (async () => {
      try {
        setLoading(true);
        const data = await apiCall("/journal/tags");
        setTags(Array.isArray(data.tags) ? data.tags : []);
      } catch (e) {
        tg.showAlert("Failed to load tags: " + (e.message || "Unknown error"));
        setTags([]);
      } finally {
        setLoading(false);
      }
    })();
  }, []);

  const filtered = tags.filter((t) => {
    const name = String(t?.name || "");
    if (!query.trim()) return true;
    return name.includes(query.trim().toLowerCase());
  });

  return (
    <div>
      <div className="header">
        <h1>Tags</h1>

        <div className="journal-header-actions">
          <button className="btn btn-secondary" type="button" onClick={onBack}>
            Back
          </button>
        </div>
      </div>

      <div className="tags-search">
        <input
          className="form-input"
          value={query}
          onChange={(e) => setQuery(e.target.value)}
          placeholder="Search tagsâ€¦"
        />
      </div>

      {loading ? (
        <div className="loading">
          <div className="spinner" />
          <div>Loading tags...</div>
        </div>
      ) : filtered.length === 0 ? (
        <div className="empty-state">
          <div className="empty-state-icon">
            <img src="/icons/tag.svg" alt="" />
          </div>
          <div className="empty-state-text">
            No tags found.
          </div>
        </div>
      ) : (
        <div className="tags-list">
          {filtered.map((t) => (
            <div
              key={t.name}
              className="tag-item"
              onClick={() => onPickTag(String(t.name || ""))}
            >
              <div className="tag-item-name">#{t.name}</div>
              <div className="tag-item-count">{t.count}</div>
            </div>
          ))}
        </div>
      )}
    </div>
  );
}

// =========================
// DAILY INTENTION CARD COMPONENT
// =========================

function DailyIntentionCard({ activeView }) {
  const [intention, setIntention] = useState("");
  const [input, setInput] = useState("");
  const [editing, setEditing] = useState(false);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);

useEffect(() => {
  loadIntention();
}, []);

  const loadIntention = async () => {
    try {
      setLoading(true);
      const data = await apiCall("/intentions/intention");
      
      if (data?.intention) {
        setIntention(data.intention);
      } else {
        setIntention("");
      }
    } catch (e) {
      setIntention("");
    } finally {
      setLoading(false);
    }
  };

  const saveIntention = async () => {
    const text = input.trim();
    if (!text) {
      tg?.showAlert?.("Please enter an intention");
      return;
    }

    try {
      setSaving(true);
      await apiCall("/intentions/intention", {
        method: "POST",
        body: JSON.stringify({ intention: text }),
      });
      
      tg?.showAlert?.("API finished");

      setIntention(text);
      setInput("");
      setEditing(false); 
      tg?.showAlert?.("Intention set");
    } catch (e) {
      tg?.showAlert?.("Failed to save: " + (e?.message || "Unknown error"));
    } finally {
      setSaving(false);
    }
  };

  const clearIntention = async () => {
    try {
      setSaving(true);
      await apiCall("/intentions/intention", {
        method: "DELETE",
      });

      setIntention("");
      setInput("");
      setEditing(false);
      tg?.showAlert?.("Intention cleared");
    } catch (e) {
      tg?.showAlert?.("Failed to clear: " + (e?.message || "Unknown error"));
    } finally {
      setSaving(false);
    }
  };

  const startEdit = () => {
    setInput(intention);
    setEditing(true);
  };

  const cancelEdit = () => {
    setInput("");
    setEditing(false);
  };

  return (
    <div className="intention-card">
      {loading ? (
        <div className="loading" style={{ padding: "12px 0" }}>
          <div className="spinner" />
          <div>Loading intention...</div>
        </div>
      ) : !intention || editing ? (
        <div>
          <div className="intention-header">
            <img src="/icons/star.svg" alt="" />
            <div className="intention-title">Daily Intention</div>
          </div>

          <div className="intention-input-group">
            <textarea
              className="intention-textarea"
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder="What's your intention for today?"
              disabled={saving}
              autoFocus
            />

            <div className="card-actions">
              <button
                className="btn btn-primary"
                onClick={saveIntention}
                disabled={saving || !input.trim()}
                type="button"
              >
                {saving ? "Saving..." : "Set Intention"}
              </button>

              {editing && (
                <button
                  className="btn btn-secondary"
                  onClick={cancelEdit}
                  disabled={saving}
                  type="button"
                >
                  Cancel
                </button>
              )}
            </div>
          </div>
        </div>
      ) : (
        <div>
          <div className="intention-header">
            <img src="/icons/star.svg" alt="" />
            <div className="intention-title">Today's Intention</div>
          </div>

          <div className="intention-display">
            <div className="intention-text">{intention}</div>

            <div className="intention-meta">
              <div className="intention-date">
                <img src="/icons/cal.svg" alt="" />
                <span>Set today</span>
              </div>

              <div className="intention-actions">
                <button
                  className="intention-edit-btn"
                  onClick={startEdit}
                  type="button"
                >
                  Edit
                </button>

                <button
                  className="intention-clear-btn"
                  onClick={clearIntention}
                  disabled={saving}
                  type="button"
                >
                  {saving ? "Clearing..." : "Clear"}
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// HOROSCOPE VIEW
function HoroscopeView({ onBack, activeView }) {
  const ZODIAC = [
  "aries","taurus","gemini","cancer","leo","virgo", "libra","scorpio","sagittarius","capricorn","aquarius","pisces"
  ];

  const [zodiac, setZodiac] = useState("aries");
  const [loading, setLoading] = useState(false);
  const [result, setResult] = useState(null);

  // Reset when navigating away and back
  useEffect(() => {
    if (activeView !== "horoscope") {
      setResult(null);
      setLoading(false);
    }
  }, [activeView]);

  const fetchHoroscope = async () => {
    try {
      setLoading(true);
      setResult(null);

      const data = await apiCall(`/horoscope/horoscope?zodiac=${encodeURIComponent(zodiac)}`);
      setResult(data?.horoscope || null);
    } catch (e) {
      tg.showAlert("Failed to fetch horoscope: " + (e?.message || "Unknown error"));
    } finally {
      setLoading(false);
    }
  };

  const clearResult = () => {
    setResult(null);
  };

  return (
    <div>
      <div className="header">
        <h1>Horoscope</h1>
        <div className="journal-header-actions">
          <button className="btn btn-secondary" type="button" onClick={onBack}>
            Back
          </button>
        </div>
      </div>

      <div className="card horoscope-card">
        <div className="horoscope-form">
          <label className="form-label">Choose your zodiac</label>

          <select
            className="form-input"
            value={zodiac}
            onChange={(e) => setZodiac(e.target.value)}
          >
            {ZODIAC.map((z) => (
              <option key={z} value={z}>
                {z[0].toUpperCase() + z.slice(1)}
              </option>
            ))}
          </select>

          <div className="card-actions">
            <button
              className="btn btn-primary"
              type="button"
              onClick={fetchHoroscope}
              disabled={loading}
            >
              {loading ? "Loading..." : "Get Horoscope"}
            </button>

            {result && (
              <button
                className="btn btn-secondary"
                type="button"
                onClick={clearResult}
              >
                Clear
              </button>
            )}
          </div>
        </div>
      </div>

      {(loading || result) && (
        <div className="card horoscope-result-card">
          {loading ? (
            <div className="loading">
              <div className="spinner" />
              <div>Fetching your stars...</div>
            </div>
          ) : (
            <>
              <div className="horoscope-result-header">
                <div className="horoscope-zodiac">
                  {String(result.zodiac || zodiac).toUpperCase()}
                </div>
                <div className="horoscope-date">{result.date || ""}</div>
              </div>

              <div className="horoscope-text">
                {result.horoscope || ""}
              </div>
            </>
          )}
        </div>
      )}

      {!loading && !result && (
        <div className="card horoscope-result-card">
          <div className="empty-state-text">
            Pick a zodiac sign and tap "Get Horoscope".
          </div>
        </div>
      )}
    </div>
  );
}


// Journals View
function JournalsView({ activeView, tagFilter, onOpenTags, onClearTag, onTagSelect, onOpenHoroscope }) {
  const [entries, setEntries] = useState([]);
  const [loading, setLoading] = useState(true);
  const [showModal, setShowModal] = useState(false);
  const [editingEntry, setEditingEntry] = useState(null);
  const [loadingMore, setLoadingMore] = useState(false);
const [cursor, setCursor] = useState(null); // ISO string (createdAt of last)
const [hasMore, setHasMore] = useState(true);

const [viewerEntry, setViewerEntry] = useState(null); // for read-only modal

const [promptModalOpen, setPromptModalOpen] = useState(false);
const [dailyPrompt, setDailyPrompt] = useState("");
const [promptRemaining, setPromptRemaining] = useState(null);
const [promptLoading, setPromptLoading] = useState(false);

const PAGE_SIZE = 10;

useEffect(() => {
  if (activeView === "journal") {
    loadFirstPage();
  }
}, [activeView, tagFilter]);

const loadFirstPage = async () => {
  try {
    setLoading(true);

    // reset pagination state
    setEntries([]);
    setCursor(null);
    setHasMore(true);

const tagParam = tagFilter ? `&tag=${encodeURIComponent(tagFilter)}` : "";
const data = await apiCall(`/journal?limit=${PAGE_SIZE}${tagParam}`);
    const list = data.entries || [];

    setEntries(list);

    if (list.length < PAGE_SIZE) {
      setHasMore(false);
      setCursor(null);
    } else {
      const last = list[list.length - 1];
      setCursor(last?.createdAt || null);
    }
  } catch (error) {
    tg.showAlert("Failed to load journal: " + error.message);
  } finally {
    setLoading(false);
  }
};

const loadMore = async () => {
  // guard rails
  if (activeView !== "journal") return;
  if (!hasMore) return;
  if (loadingMore) return;
  if (!cursor) return;

  try {
    setLoadingMore(true);

const tagParam = tagFilter ? `&tag=${encodeURIComponent(tagFilter)}` : "";
const data = await apiCall(
  `/journal?limit=${PAGE_SIZE}&before=${encodeURIComponent(cursor)}${tagParam}`
);
    const list = data.entries || [];

    // append (do NOT overwrite)
    setEntries((prev) => [...prev, ...list]);

    if (list.length < PAGE_SIZE) {
      setHasMore(false);
      setCursor(null);
    } else {
      const last = list[list.length - 1];
      setCursor(last?.createdAt || null);
    }
  } catch (error) {
    tg.showAlert("Failed to load more: " + error.message);
  } finally {
    setLoadingMore(false);
  }
};

  const handleCreate = () => {
    setEditingEntry(null);
    setShowModal(true);
  };

  const handleEdit = (entry) => {
    setEditingEntry(entry);
    setShowModal(true);
  };

  const handleSave = async (payload) => {
    try {
      if (editingEntry?._id) {
        await apiCall(`/journal/${editingEntry._id}`, {
          method: 'PUT',
          body: JSON.stringify(payload),
        });
        tg.showAlert('Entry updated!');
      } else {
        await apiCall(`/journal`, {
          method: 'POST',
          body: JSON.stringify(payload),
        });
        tg.showAlert('Entry created!');
      }
      setShowModal(false);
      loadFirstPage();
    } catch (error) {
      tg.showAlert('Failed to save: ' + error.message);
    }
  };

  const handleDelete = async (id) => {
    try {
      await apiCall(`/journal/${id}`, { method: 'DELETE' });
      tg.showPopup({ message: 'Entry deleted' });
      loadFirstPage();
    } catch (error) {
      tg.showAlert('Failed to delete: ' + error.message);
    }
  };
  
const handleGeneratePrompt = async () => {
  try {
    setPromptLoading(true);
    setDailyPrompt("");

    const data = await apiCall(`/journal/prompt`, {
      method: "POST",
      body: JSON.stringify({}),
    });

    setDailyPrompt(data.prompt || "");
    setPromptRemaining(
      typeof data.remaining === "number" ? data.remaining : null
    );
  } catch (error) {
    const msg = error?.message || "Failed to generate prompt";
    tg.showAlert(msg);
  } finally {
    setPromptLoading(false);
  }
};

  return (
    <div>
      <div className="header">
  <h1>Journal</h1>

  <div className="journal-header-actions">
    <button
      className="tags-icon-btn"
      type="button"
      onClick={() => onOpenTags && onOpenTags()}
      aria-label="Tags"
      title="Tags"
    >
      <img src="/icons/tag.svg" alt="" />
    </button>

  <button
    className="horoscope-icon-btn"
    type="button"
    onClick={() => onOpenHoroscope && onOpenHoroscope()}
    aria-label="Horoscope"
    title="Horoscope"
  >
    <img src="/icons/planet.svg" alt="" />
  </button>

    <button
      className="btn btn-prompt"
      type="button"
      onClick={() => {
        setPromptModalOpen(true);
        handleGeneratePrompt();
      }}
    >
      Prompt
    </button>
  </div>
</div>
      
      {tagFilter ? (
  <div className="journal-filter-bar">
    <div className="journal-filter-left">
      <img src="/icons/tag.svg" alt="" />
      <div className="journal-filter-text">Filtered by #{tagFilter}</div>
    </div>

    <button className="journal-filter-clear" type="button" onClick={onClearTag}>
      Clear
    </button>
  </div>
) : null}

    <DailyIntentionCard />

      {loading ? (
        <div className="loading">
          <div className="spinner" />
          <div>Loading journal...</div>
        </div>
      ) : entries.length === 0 ? (
        <div className="empty-state">
          <div className="empty-state-icon">
  <img src="/icons/edit.svg" alt="" />
</div>
          <div className="empty-state-text">
            No journal entries yet.
            {"\n"}Tap + to create one.
          </div>
        </div>
      ) : (
        <>
          {entries.map((entry) => (
  <JournalCard
    key={entry._id}
    entry={entry}
    onView={(e) => setViewerEntry(e)}
    onEdit={handleEdit}
    onDelete={handleDelete}
    onTagSelect={onTagSelect}
  />
))}

          {hasMore && (
            <div className="load-more-container">
              <button
                className="btn btn-secondary load-more-btn"
                onClick={loadMore}
                disabled={loadingMore}
              >
                {loadingMore ? "Loadingâ€¦" : "Load more"}
              </button>
            </div>
          )}
        </>
      )}

{viewerEntry && (
  <JournalPreviewModal
    entry={viewerEntry}
    onClose={() => setViewerEntry(null)}
    onEdit={(entry) => {
      setViewerEntry(null);
      setEditingEntry(entry);
      setShowModal(true);
    }}
    onDelete={handleDelete}
    onTagSelect={onTagSelect}
  />
)}

<button
  className="is-hidden"
  data-create-journal="1"
  onClick={() => {
    setViewerEntry(null);      // optional but nice: closes preview if open
    setEditingEntry(null);
    setShowModal(true);
  }}
/>

      {showModal && (
        <JournalModal
          entry={editingEntry}
          onClose={() => setShowModal(false)}
          onSave={handleSave}
          onDelete={handleDelete}
        />
      )}
      
      {promptModalOpen && (
  <PromptModal 
    onClose={() => setPromptModalOpen(false)}
    onGenerate={handleGeneratePrompt}
    prompt={dailyPrompt}
    remaining={promptRemaining}
    loading={promptLoading}
  />
)}
      
    </div>
  );
}

// Journal Preview Modal
function JournalPreviewModal({ entry, onClose, onEdit, onDelete, onTagSelect }) {
  if (!entry) return null;
  
  useEffect(() => {
    document.body.classList.add('modal-open');
    return () => {
      document.body.classList.remove('modal-open');
    };
  }, []);

  const created = entry.createdAt ? new Date(entry.createdAt) : null;
  const dateStr = created
    ? created.toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" })
    : "";

  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal" onClick={(e) => e.stopPropagation()}>
        <div className="modal-header">
          <h2>{entry.title?.trim() ? entry.title : "Journal Entry"}</h2>
          <button className="modal-close" onClick={onClose}>Ã—</button>
        </div>

        <div className="modal-body">
          {dateStr && (
            <div className="card-time" style={{ marginBottom: 12 }}>
  <img src="/icons/cal.svg" alt="" />
  <span>{dateStr}</span>
</div>
          )}

          <div style={{ whiteSpace: "pre-line", lineHeight: 1.6, fontSize: 15 }}>
            {entry.body}
          </div>

          {Array.isArray(entry.tags) && entry.tags.length > 0 && (
  <div className="tag-row">
    {entry.tags.map((t) => (
      <button
        key={t}
        type="button"
        className="tag-pill"
        onClick={(e) => {
          e.stopPropagation();              // keep modal click behavior clean
          if (onTagSelect) onTagSelect(t);  // apply filter
          onClose();                        // optional: close the preview after selecting a tag
        }}
      >
        #{t}
      </button>
    ))}
  </div>
)}
        </div>

        <div className="modal-actions journal-preview-actions">
  <button className="btn btn-primary" onClick={() => onEdit(entry)}>
    Edit
  </button>

  <button className="btn btn-secondary" onClick={onClose}>
    Close
  </button>

  <button
    className="btn btn-danger"
    type="button"
    onClick={() => {
      if (!entry?._id) return;
      onDelete(entry._id);
      onClose(); // close the preview modal immediately after delete
    }}
  >
    Delete
  </button>
</div>
      </div>
    </div>
  );
}

// Prompt Modal
function PromptModal({ onClose, onGenerate, prompt, remaining, loading }) {
  useEffect(() => {
    document.body.classList.add('modal-open');
    return () => {
      document.body.classList.remove('modal-open');
    };
  }, []);

  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal" onClick={(e) => e.stopPropagation()}>
        <div className="modal-header">
          <h2>Prompt</h2>
          <button
            className="modal-close"
            onClick={onClose}
            type="button"
          >
            Ã—
          </button>
        </div>

        <div className="modal-body">
          {loading ? (
            <div className="loading">
              <div className="spinner" />
              <div>Generatingâ€¦</div>
            </div>
          ) : prompt ? (
            <>
              <div className="journal-prompt-text">{prompt}</div>

              {typeof remaining === "number" && (
                <div className="journal-prompt-meta">
                  Remaining today: {remaining}
                </div>
              )}
            </>
          ) : (
            <div className="empty-state-text">Tap Prompt to generate.</div>
          )}
        </div>

        <div className="modal-actions">
          <button
            className="btn btn-secondary"
            onClick={onClose}
            type="button"
          >
            Close
          </button>

          <button
            className="btn btn-primary"
            onClick={onGenerate}
            disabled={loading}
            type="button"
          >
            Generate Again
          </button>
        </div>
      </div>
    </div>
  );
}

    // Reminder Card Component
    function ReminderCard({ reminder, onEdit, onSnooze, onDone, onDelete }) {
      const [expanded, setExpanded] = useState(false);
      
      const [customOpen, setCustomOpen] = useState(false);
const [customValue, setCustomValue] = useState("");
const [customUnit, setCustomUnit] = useState("minutes"); // "minutes" | "hours" | "days"
const [customError, setCustomError] = useState("");


function openCustomSnooze() {
  document.body.classList.add("csnooze-open");
  setCustomOpen(true);
}

function closeCustomSnooze() {
  document.body.classList.remove("csnooze-open");
  setCustomOpen(false);
}

function unitToMinutes(unit) {
  if (unit === "hours") return 60;
  if (unit === "days") return 1440;
  return 1; // minutes
}

function unitLabel(unit, value) {
  const v = Number(value);
  if (unit === "hours") return `${v} hour${v === 1 ? "" : "s"}`;
  if (unit === "days") return `${v} day${v === 1 ? "" : "s"}`;
  return `${v} minute${v === 1 ? "" : "s"}`;
}

function submitCustomSnooze() {
  const raw = String(customValue).trim();
  if (!raw) {
    setCustomError("Enter a number.");
    return;
  }

  const n = Number(raw);

  if (!Number.isFinite(n) || n <= 0) {
    setCustomError("Must be a number greater than 0.");
    return;
  }

  // Optional guardrails (tweak as you like)
  if (n > 365 && customUnit === "days") {
    setCustomError("Please keep it under 365 days.");
    return;
  }
  if (n > 24 * 365 && customUnit === "hours") {
    setCustomError("Please keep it under 8760 hours.");
    return;
  }
  if (n > 60 * 24 * 365 && customUnit === "minutes") {
    setCustomError("Please keep it under 525600 minutes.");
    return;
  }

  const minutes = Math.round(n * unitToMinutes(customUnit));
  const label = unitLabel(customUnit, Math.round(n));

  // IMPORTANT: stopPropagation already handled by card-actions wrapper,
  // but modal lives outside actions area, so keep the card from collapsing.
  onSnooze(reminder._id, minutes, label);
  closeCustomSnooze();
}

      const getBadgeClass = () => {
        const kind = reminder.schedule?.kind || 'once';
        return `card-badge badge-${kind}`;
      };
      
      const getBadgeLabel = () => {
  const s = reminder.schedule;
  if (!s || !s.kind) return "once";

  if (s.kind === "daily") {
    const iv = Number(s.interval || 1);
    return iv === 1 ? "daily" : "custom";
  }

  return s.kind;
};

const getAllTimes = () => {
  const s = reminder.schedule;
  if (!s) return [];

  const raw =
    Array.isArray(s.timesOfDay) && s.timesOfDay.length
      ? s.timesOfDay
      : s.timeOfDay
        ? [s.timeOfDay]
        : [];

  // keep only valid "HH:mm", unique, sorted
  return Array.from(
    new Set(
      raw
        .map((t) => String(t || "").trim())
        .filter((t) => /^\d{2}:\d{2}$/.test(t))
    )
  ).sort();
};

function formatTime12h(hhmm) {
  if (!hhmm || !hhmm.includes(":")) return hhmm;

  const [hRaw, mRaw] = hhmm.split(":");
  let h = Number(hRaw);
  const m = mRaw;

  if (!Number.isFinite(h)) return hhmm;

  const suffix = h >= 12 ? "PM" : "AM";
  h = h % 12 || 12;

  return `${h}:${m} ${suffix}`;
}

      const getStatusBadge = () => {
  const st = reminder.displayStatus || reminder.status;
  const nextRun = reminder.nextRunAt ? new Date(reminder.nextRunAt) : null;
  const now = new Date();

  if (st === "sent") {
    return { label: "DUE NOW", className: "badge-due-now" };
  }

  if (st === "scheduled" && nextRun) {
    const msUntil = nextRun.getTime() - now.getTime();

    if (msUntil > 0 && msUntil <= 24 * 60 * 60 * 1000) {
      return { label: "UPCOMING", className: "badge-upcoming" };
    }
  }

  return null;
};

      const statusBadge = getStatusBadge();

      return (
  <div className="card" onClick={() => setExpanded(!expanded)}>
    <div className="card-header">
      <div className="card-time-row">
        <span className="card-time-icon">
          <img src="/icons/alarm.svg" alt="" />
        </span>

        <span className="card-time-text">{formatDateTime(reminder.nextRunAt)}</span>

        {["daily", "weekly", "monthly", "yearly"].includes(reminder.schedule?.kind) && (
          <div className="card-times-inline">
            {getAllTimes().map((t) => (
              <span key={t} className="time-chip">
                {formatTime12h(t)}
              </span>
            ))}
          </div>
        )}
      </div>

      <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'flex-end', gap: '6px' }}>
        <span className={getBadgeClass()}>
          {getBadgeLabel()}
        </span>

        {statusBadge && (
          <span className={`card-badge ${statusBadge.className}`}>
            {statusBadge.label}
          </span>
        )}
      </div>
    </div>

    <div className="reminder-card-text">
  {renderTextWithSymbolSpans(reminder.text)}
</div>

    {expanded && (
      <div className="card-actions" onClick={e => e.stopPropagation()}>
        <button className="btn btn-primary" onClick={() => onEdit(reminder)}>
          <img src="/icons/pencil.svg" alt="" />
          Edit
        </button>

        <button className="btn btn-secondary" onClick={() => onSnooze(reminder._id, 15)}>
          <img src="/icons/alarm.svg" alt="" />
          15m
        </button>

        <button className="btn btn-secondary" onClick={() => onSnooze(reminder._id, 60)}>
          <img src="/icons/alarm.svg" alt="" />
          1h
        </button>

        {/* âœ… ADD THIS BUTTON */}
        <button className="btn btn-secondary" onClick={openCustomSnooze}>
          <img src="/icons/alarm.svg" alt="" />
          Custom
        </button>

        <button className="btn btn-primary" onClick={() => onDone(reminder._id)}>
          <img src="/icons/check.svg" alt="" />
          Done
        </button>

        <button className="btn btn-danger" onClick={() => onDelete(reminder._id)}>
          <img src="/icons/trash.svg" alt="" />
        </button>
      </div>
    )}

    {/* âœ…âœ…âœ… THIS IS THE EXACT PLACE TO ADD #4 (RENDER THE MODAL) */}
    {customOpen && (
      <div className="csnooze-modal-overlay" onClick={closeCustomSnooze}>
        <div className="csnooze-modal" onClick={(e) => e.stopPropagation()} role="dialog" aria-modal="true">
          <div className="csnooze-modal-title">Custom Snooze</div>

          <div className="csnooze-modal-row">
            <input
              className="csnooze-modal-input"
              inputMode="numeric"
              placeholder="Amount"
              value={customValue}
              onChange={(e) => {
                setCustomValue(e.target.value);
                setCustomError("");
              }}
              onKeyDown={(e) => {
                if (e.key === "Enter") submitCustomSnooze();
                if (e.key === "Escape") closeCustomSnooze();
              }}
            />

            <select
              className="csnooze-modal-select"
              value={customUnit}
              onChange={(e) => {
                setCustomUnit(e.target.value);
                setCustomError("");
              }}
            >
              <option value="minutes">Minutes</option>
              <option value="hours">Hours</option>
              <option value="days">Days</option>
            </select>
          </div>

          {customError && <div className="csnooze-modal-error">{customError}</div>}

          <div className="csnooze-modal-actions">
            <button className="btn btn-secondary" onClick={closeCustomSnooze} type="button">
              Cancel
            </button>
            <button className="btn btn-primary" onClick={submitCustomSnooze} type="button">
              Snooze
            </button>
          </div>
        </div>
      </div>
    )}
    {/* âœ…âœ…âœ… END MODAL */}
  </div>
 );
}
    
    
   // Extra Reminder Times  
    function ExtraTimesSection({ scheduleKind, timesOfDay, setTimesOfDay }) {
  if (!["daily", "weekly", "monthly", "yearly"].includes(scheduleKind)) return null;

  const safeTimes = Array.isArray(timesOfDay) ? timesOfDay : [];

  const setAt = (idx, v) => {
    setTimesOfDay((prev) => {
      const arr = Array.isArray(prev) ? [...prev] : [];
      arr[idx] = v;

      const cleaned = arr
        .map((x) => String(x || "").trim())
        .filter((x) => /^\d{2}:\d{2}$/.test(x));

      return Array.from(new Set(cleaned)).sort();
    });
  };

  const removeAt = (idx) => {
    setTimesOfDay((prev) => {
      const arr = Array.isArray(prev) ? prev : [];
      return arr.filter((_, i) => i !== idx);
    });
  };

  const addOne = () => {
    setTimesOfDay((prev) => {
      const arr = Array.isArray(prev) ? prev : [];
      return Array.from(new Set([...arr, "09:00"])).sort();
    });
  };

  return (
    <div className="form-group">
      <label className="form-label">Extra times</label>

      <div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
        {safeTimes.map((t, idx) => (
          <div key={idx} style={{ display: "flex", gap: 8, alignItems: "center" }}>
            <input
              type="time"
              className="form-input"
              value={t}
              onChange={(e) => setAt(idx, e.target.value)}
            />
            <button type="button" className="btn btn-danger" onClick={() => removeAt(idx)}>
              Remove
            </button>
          </div>
        ))}

        <button type="button" className="btn btn-secondary" onClick={addOne}>
          Add time
        </button>
      </div>

      <div style={{ color: "var(--text-secondary)", fontSize: 12, lineHeight: 1.35 }}>
        These are additional fire times for the same reminder on its scheduled days.
      </div>
    </div>
  );
}

// Reminder Modal
function ReminderModal({ reminder, onClose, onSave, userTimezone }) {
  const [text, setText] = React.useState(reminder?.text || "");
  const [date, setDate] = React.useState("");
  const [time, setTime] = React.useState("");
  const [timesOfDay, setTimesOfDay] = React.useState([]); // ["09:00","14:30"]

  const [scheduleKind, setScheduleKind] = React.useState(reminder?.schedule?.kind || "once");
  // NEW: daily interval (every N days)
const [dailyIntervalStr, setDailyIntervalStr] = React.useState("");
  const [intervalMinutes, setIntervalMinutes] = React.useState(
    reminder?.schedule?.intervalMinutes || 30
  );

  // Weekly day picker state (Sun=0..Sat=6)
  const [weeklyDays, setWeeklyDays] = React.useState([]);

  // Monthly day-of-month (1..31)
  const [monthlyDay, setMonthlyDay] = React.useState(1);
  
    // NEW: yearly picker state
  const [yearlyMonth, setYearlyMonth] = React.useState(1); // 1..12
  const [yearlyDay, setYearlyDay] = React.useState(1);     // 1..31

  React.useEffect(() => {
    document.body.classList.add("modal-open");
    return () => document.body.classList.remove("modal-open");
  }, []);

  React.useEffect(() => {
    if (reminder) {
      const d = new Date(reminder.nextRunAt);
setDate(dateInputValue(d, userTimezone));
setTime(timeInputValue(d, userTimezone));
const sched = reminder?.schedule;
const initialTimes =
  Array.isArray(sched?.timesOfDay) && sched.timesOfDay.length
    ? sched.timesOfDay
    : sched?.timeOfDay
      ? [sched.timeOfDay]
      : [timeInputValue(new Date(reminder.nextRunAt), userTimezone)];

setTimesOfDay(Array.from(new Set(initialTimes.map(String))).sort());

      const k = reminder?.schedule?.kind || "once";
      setScheduleKind(k);
      
      // Daily interval
if (k === "daily") {
  const iv = reminder?.schedule?.interval;
  setDailyIntervalStr(
    iv === undefined || iv === null ? "" : String(iv)
  );
} else {
  setDailyIntervalStr("");
}

      // Interval
      if (k === "interval") {
        const mins = Number(reminder?.schedule?.intervalMinutes ?? 30);
        setIntervalMinutes(Number.isFinite(mins) && mins > 0 ? mins : 30);
      }

      // Weekly
      if (k === "weekly") {
        const days = reminder?.schedule?.daysOfWeek;
        if (Array.isArray(days) && days.length) {
          setWeeklyDays(
            days
              .map((n) => Number(n))
              .filter((n) => Number.isFinite(n) && n >= 0 && n <= 6)
          );
        } else {
          setWeeklyDays([d.getDay()]);
        }
      } else {
        // keep weeklyDays sensible if user switches to weekly
        setWeeklyDays([d.getDay()]);
      }

      // Monthly (use schedule.dayOfMonth if present, else default to chosen date's day)
      if (k === "monthly") {
        const dom = Number(reminder?.schedule?.dayOfMonth);
        const fallbackDom = d.getDate();
        const normalized = Number.isFinite(dom) && dom >= 1 && dom <= 31 ? dom : fallbackDom;
        setMonthlyDay(normalized);
      } else {
        // keep monthlyDay sensible if user switches to monthly
        setMonthlyDay(d.getDate());
      }
      
            // Prefill yearly anchors (fallback to nextRunAt month/day)
      if (sched?.kind === "yearly") {
        const m = Number(sched.anchorMonth);
        const day = Number(sched.anchorDay);

        setYearlyMonth(Number.isFinite(m) && m >= 1 && m <= 12 ? m : (d.getMonth() + 1));
        setYearlyDay(Number.isFinite(day) && day >= 1 && day <= 31 ? day : d.getDate());
      } else {
        // if not yearly, still set sane defaults from the chosen date
        setYearlyMonth(d.getMonth() + 1);
        setYearlyDay(d.getDate());
      }
    } else {
      // Creating a new reminder
      const now = new Date();
      setDate(now.toISOString().split("T")[0]);
      setTime("09:00");
      setTimesOfDay(["09:00"]);
      setScheduleKind("once");
      setDailyIntervalStr("");
      setIntervalMinutes(30);
      setWeeklyDays([now.getDay()]);
      setMonthlyDay(now.getDate());
      setYearlyMonth(now.getMonth() + 1);
      setYearlyDay(now.getDate());
    }
  }, [reminder]);

  const weekdayLabels = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];

  const toggleWeekday = (idx) => {
    setWeeklyDays((prev) => {
      const set = new Set(Array.isArray(prev) ? prev : []);
      if (set.has(idx)) set.delete(idx);
      else set.add(idx);
      return Array.from(set).sort((a, b) => a - b);
    });
  };
  
  const handleKindChange = (k) => {
  try {
    setScheduleKind(k);

    const zone = userTimezone || "America/Chicago";
const safeDate = date || luxon.DateTime.now().setZone(zone).toISODate(); // "YYYY-MM-DD"


    if (k === "daily") {
      setDailyIntervalStr((prev) => {
        const raw = String(prev ?? "").trim();
        if (raw === "") return "";
        const n = Number(raw);
        return Number.isFinite(n) && n >= 1 ? String(Math.trunc(n)) : "";
      });
      return;
    }

    if (k === "weekly") {
      const chosenWeekday = DateTime.fromISO(safeDate, { zone }).weekday % 7;
      setWeeklyDays((prev) => {
        const arr = Array.isArray(prev)
          ? prev.map(Number).filter((n) => Number.isFinite(n) && n >= 0 && n <= 6)
          : [];
        return arr.length ? arr : [chosenWeekday];
      });
      return;
    }

    if (k === "monthly") {
      const fallbackDom = DateTime.fromISO(safeDate, { zone }).day;
      setMonthlyDay((prev) => {
        const n = Number(prev);
        return Number.isFinite(n) && n >= 1 && n <= 31 ? Math.trunc(n) : fallbackDom;
      });
      return;
    }

    if (k === "yearly") {
      const dt = DateTime.fromISO(safeDate, { zone });
      setYearlyMonth((prev) => {
        const n = Number(prev);
        return Number.isFinite(n) && n >= 1 && n <= 12 ? Math.trunc(n) : dt.month;
      });
      setYearlyDay((prev) => {
        const n = Number(prev);
        return Number.isFinite(n) && n >= 1 && n <= 31 ? Math.trunc(n) : dt.day;
      });
      return;
    }
  } catch (err) {
    tg.showAlert(
      "KIND CHANGE CRASH:\n" +
      (err?.message || String(err)) +
      (err?.stack ? "\n\n" + err.stack : "")
    );
  }
};

const handleSave = async () => {
  if (!text.trim()) {
    tg.showAlert("Please enter a message");
    return;
  }

  const zone = userTimezone || "America/Chicago";

  // Build a UTC ISO timestamp from the chosen local date+time.
  // Schedule determines repeats after the first run.
  const nextRunAt = DateTime.fromISO(`${date}T${time}`, { zone }).toUTC().toISO();
  
  const cleanedTimes = Array.from(
  new Set((timesOfDay || [])
    .map(t => String(t || "").trim())
    .filter(t => /^\d{2}:\d{2}$/.test(t))
  )
).sort();

if (["daily","weekly","monthly","yearly"].includes(scheduleKind) && cleanedTimes.length === 0) {
  tg.showAlert("Please add at least one time.");
  return;
}

  let schedule;

  if (scheduleKind === "once") {
    schedule = { kind: "once" };

} else if (scheduleKind === "daily") {
  const raw = String(dailyIntervalStr ?? "").trim();

  // allow blank in UI; treat blank as 1 when saving
  const iv = raw === "" ? 1 : Number(raw);

  if (!Number.isFinite(iv) || iv < 1) {
    tg.showAlert("Daily interval must be at least 1 day.");
    return;
  }

  schedule = {
    kind: "daily",
    timesOfDay: cleanedTimes,
    timeOfDay: cleanedTimes[0],
    interval: Math.trunc(iv),
  };

  } else if (scheduleKind === "weekly") {
const chosenWeekday = DateTime.fromISO(date, { zone }).weekday % 7; // 0..6 (Sun=0)
    const days = Array.isArray(weeklyDays)
      ? weeklyDays
          .map((n) => Number(n))
          .filter((n) => Number.isFinite(n) && n >= 0 && n <= 6)
      : [];

    schedule = {
      kind: "weekly",
      timesOfDay: cleanedTimes,
      timeOfDay: cleanedTimes[0],
      daysOfWeek: days.length ? Array.from(new Set(days)) : [chosenWeekday],
    };

  } else if (scheduleKind === "monthly") {
    // If user leaves it blank or invalid, default to day-of-month from chosen date.
const fallbackDom = DateTime.fromISO(date, { zone }).day;
    const dom = Number(monthlyDay);

    const normalizedDom =
      Number.isFinite(dom) && dom >= 1 && dom <= 31 ? Math.trunc(dom) : fallbackDom;

    schedule = {
      kind: "monthly",
      timesOfDay: cleanedTimes,
      timeOfDay: cleanedTimes[0],
      dayOfMonth: normalizedDom, // matches your API
    };

  } else if (scheduleKind === "yearly") {
    const m = Number(yearlyMonth);
    const day = Number(yearlyDay);

    if (!Number.isFinite(m) || m < 1 || m > 12) {
      tg.showAlert("Please choose a valid month.");
      return;
    }
    if (!Number.isFinite(day) || day < 1 || day > 31) {
      tg.showAlert("Please choose a valid day (1-31).");
      return;
    }

    schedule = {
      kind: "yearly",
      timesOfDay: cleanedTimes,
      timeOfDay: cleanedTimes[0],
      anchorMonth: m,
      anchorDay: day,
    };

  } else if (scheduleKind === "interval") {
    const mins = Number(intervalMinutes);
    if (!Number.isFinite(mins) || mins <= 0) {
      tg.showAlert("Please enter a valid interval in minutes.");
      return;
    }
    schedule = { kind: "interval", intervalMinutes: Math.trunc(mins) };

  } else {
    // safety fallback (should never happen)
    schedule = { kind: "once" };
  }

  await onSave({
    text,
    nextRunAt,
    schedule,
    timezone: zone,
  });
};

  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal" onClick={(e) => e.stopPropagation()}>
        <div className="modal-header">
          <h2>{reminder ? "Edit Reminder" : "New Reminder"}</h2>
          <button className="modal-close" onClick={onClose} type="button">
            Ã—
          </button>
        </div>

        <div className="modal-body">
          <div className="form-group">
            <label className="form-label">Message</label>
            <textarea
              className="form-textarea"
              value={text}
              onChange={(e) => setText(e.target.value)}
              placeholder="What do you want to be reminded about?"
            />
          </div>

          <div className="form-row">
            <div className="form-group">
              <label className="form-label">Date</label>
              <input
                type="date"
                className="form-input"
                value={date}
                onChange={(e) => setDate(e.target.value)}
              />
            </div>

            <div className="form-group">
              <label className="form-label">Time</label>
              <input
                type="time"
                className="form-input"
                value={time}
                onChange={(e) => setTime(e.target.value)}
              />
            </div>
          </div>
          

          <div className="form-group">
            <label className="form-label">Repeat</label>
            <select
              className="form-select"
              value={scheduleKind}
              onChange={(e) => handleKindChange(e.target.value)}
            >
              <option value="once">Once</option>
              <option value="daily">Daily</option>
              <option value="weekly">Weekly</option>
              <option value="monthly">Monthly</option>
                           <option value="yearly">Yearly</option>
              <option value="interval">Custom Interval</option>
            </select>
          </div>
          
          <ExtraTimesSection
  scheduleKind={scheduleKind}
  timesOfDay={timesOfDay}
  setTimesOfDay={setTimesOfDay}
/>
          
          {scheduleKind === "daily" && (
  <div className="form-group">
    <label className="form-label">Repeat every</label>

    <div style={{ display: "flex", gap: 8, alignItems: "center" }}>
      <input
  type="number"
  className="form-input"
  min="1"
  placeholder="e.g. 28"
  value={dailyIntervalStr}
  onChange={(e) => setDailyIntervalStr(e.target.value)}
/>
      <span style={{ color: "var(--text-secondary)" }}>days</span>
    </div>

    <div style={{ color: "var(--text-secondary)", fontSize: 12, lineHeight: 1.35 }}>
      Set to 1 for daily, or higher for custom spacing (e.g. every 28 days).
    </div>
  </div>
)}

          {scheduleKind === "weekly" && (
            <div className="form-group">
              <label className="form-label">Days of week</label>

              <div className="card-actions" style={{ marginBottom: 6 }}>
                {weekdayLabels.map((label, idx) => {
                  const active = Array.isArray(weeklyDays) && weeklyDays.includes(idx);
                  const className = `btn ${active ? "btn-primary" : "btn-secondary"}`;

                  return (
                    <button
                      key={idx}
                      type="button"
                      className={className}
                      onClick={() => toggleWeekday(idx)}
                    >
                      {label}
                    </button>
                  );
                })}
              </div>

              <div style={{ color: "var(--text-secondary)", fontSize: 12, lineHeight: 1.35 }}>
                If you select none, it defaults to the weekday of the chosen date.
              </div>
            </div>
          )}

          {scheduleKind === "monthly" && (
            <div className="form-group">
              <label className="form-label">Day of month (1â€“31)</label>
              <input
                type="number"
                className="form-input"
                min="1"
                max="31"
                value={monthlyDay}
                onChange={(e) => setMonthlyDay(Number(e.target.value))}
              />
              <div style={{ color: "var(--text-secondary)", fontSize: 12, lineHeight: 1.35 }}>
                If a month doesn&apos;t have that day (e.g. 31 in February), your backend should run
                it on the last day of that month.
              </div>
            </div>
          )}
          
          {scheduleKind === "yearly" && (
            <div className="form-group">
              <label className="form-label">Yearly date</label>

              <div className="form-row">
                <div className="form-group">
                  <label className="form-label">Month</label>
                  <select
                    className="form-select"
                    value={yearlyMonth}
                    onChange={(e) => setYearlyMonth(Number(e.target.value))}
                  >
                    <option value={1}>January</option>
                    <option value={2}>February</option>
                    <option value={3}>March</option>
                    <option value={4}>April</option>
                    <option value={5}>May</option>
                    <option value={6}>June</option>
                    <option value={7}>July</option>
                    <option value={8}>August</option>
                    <option value={9}>September</option>
                    <option value={10}>October</option>
                    <option value={11}>November</option>
                    <option value={12}>December</option>
                  </select>
                </div>

                <div className="form-group">
                  <label className="form-label">Day</label>
                  <input
                    type="number"
                    className="form-input"
                    value={yearlyDay}
                    onChange={(e) => setYearlyDay(Number(e.target.value))}
                    min="1"
                    max="31"
                  />
                </div>
              </div>

              <div style={{ color: "var(--text-secondary)", fontSize: 12, lineHeight: 1.35 }}>
                If the chosen month doesnâ€™t have that day (like Feb 30), it will run on the last day of that month.
              </div>
            </div>
          )}

          {scheduleKind === "interval" && (
            <div className="form-group">
              <label className="form-label">Interval (minutes)</label>
              <input
                type="number"
                className="form-input"
                value={intervalMinutes}
                onChange={(e) => setIntervalMinutes(Number(e.target.value))}
                min="1"
              />
            </div>
          )}
        </div>

        <div className="modal-actions">
          <button className="btn btn-secondary" onClick={onClose} type="button">
            Cancel
          </button>
          <button className="btn btn-primary" onClick={handleSave} type="button">
            {reminder ? "Update" : "Create"}
          </button>
        </div>
      </div>
    </div>
  );
}

// =========================
// PLACES AUTOCOMPLETE COMPONENT
// =========================
function PlacesAutocomplete({ value, onChange, onPlaceSelect, enabled }) {
  const [query, setQuery] = useState(value || "");
  const [suggestions, setSuggestions] = useState([]);
  const [loading, setLoading] = useState(false);
  const [showDropdown, setShowDropdown] = useState(false);
  const [sessionToken] = useState(() =>
    typeof crypto !== "undefined" && crypto.randomUUID
      ? crypto.randomUUID()
      : String(Date.now())
  );
    const [userLoc, setUserLoc] = useState(null);

  useEffect(() => {
    if (enabled && navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (pos) => setUserLoc({ lat: pos.coords.latitude, lng: pos.coords.longitude }),
        () => {} // silent fail, backend uses default
      );
    }
  }, [enabled]);
  const debounceRef = useRef(null);
  const wrapRef = useRef(null);

  useEffect(() => {
    setQuery(value || "");
  }, [value]);

  useEffect(() => {
    const handler = (e) => {
      if (wrapRef.current && !wrapRef.current.contains(e.target)) {
        setShowDropdown(false);
      }
    };
    document.addEventListener("mousedown", handler);
    document.addEventListener("touchstart", handler);
    return () => {
      document.removeEventListener("mousedown", handler);
      document.removeEventListener("touchstart", handler);
    };
  }, []);

  const fetchSuggestions = async (input) => {
    if (!input || input.length < 2) {
      setSuggestions([]);
      setShowDropdown(false);
      return;
    }

    try {
      setLoading(true);
      const data = await apiCall("/places/autocomplete", {
        method: "POST",
                body: JSON.stringify({
          input,
          sessionToken,
          ...(userLoc ? { lat: userLoc.lat, lng: userLoc.lng, radius: 50000 } : {}),
        }),
      });
      const list = Array.isArray(data?.suggestions) ? data.suggestions : [];
      setSuggestions(list);
      setShowDropdown(list.length > 0);
    } catch (e) {
      setSuggestions([]);
      setShowDropdown(false);
    } finally {
      setLoading(false);
    }
  };

  const handleInput = (e) => {
    const val = e.target.value;
    setQuery(val);
    onChange(val);

    if (!enabled) return;

    if (debounceRef.current) clearTimeout(debounceRef.current);
    debounceRef.current = setTimeout(() => fetchSuggestions(val), 350);
  };

  const handleSelect = async (suggestion) => {
    setShowDropdown(false);
    setQuery(suggestion.text || suggestion.mainText || "");
    onChange(suggestion.text || suggestion.mainText || "");

    if (!suggestion.placeId) return;

    try {
      const data = await apiCall("/places/details", {
        method: "POST",
        body: JSON.stringify({ placeId: suggestion.placeId, sessionToken }),
      });

      if (data?.place) {
        const displayStr = data.place.address || data.place.name || suggestion.text;
        setQuery(displayStr);
        onChange(displayStr);

        if (onPlaceSelect) {
          onPlaceSelect({
            placeId: data.place.placeId,
            name: data.place.name,
            address: data.place.address,
            lat: data.place.lat,
            lng: data.place.lng,
          });
        }
      }
    } catch (e) {
      // Silent fail on detail fetch; user still has the text
    }
  };

  if (!enabled) {
    return (
      <input
        type="text"
        className="form-input"
        value={query}
        onChange={(e) => {
          setQuery(e.target.value);
          onChange(e.target.value);
        }}
        placeholder="Add location"
      />
    );
  }

  return (
    <div className="places-autocomplete-wrap" ref={wrapRef}>
      <input
        type="text"
        className="form-input"
        value={query}
        onChange={handleInput}
        onFocus={() => {
          if (suggestions.length > 0) setShowDropdown(true);
        }}
        placeholder="Search for a place..."
        autoComplete="off"
      />

      {showDropdown && (
        <div className="places-suggestions">
          {loading && <div className="places-loading-row">Searching...</div>}

          {suggestions.map((s, idx) => (
            <div
              key={s.placeId || idx}
              className="places-suggestion-item"
              onClick={() => handleSelect(s)}
            >
              <div className="places-suggestion-main">
                {s.mainText || s.text}
              </div>
              {s.secondaryText && (
                <div className="places-suggestion-secondary">
                  {s.secondaryText}
                </div>
              )}
            </div>
          ))}

          <div className="places-powered">Powered by Google</div>
        </div>
      )}
    </div>
  );
}


// Event Modal
function EventModal({ event, selectedDate, userTimezone, onClose, onSave }) {
  const [title, setTitle] = useState(event?.title || '');
  const [description, setDescription] = useState(event?.description || '');
  const [date, setDate] = useState('');
  const [time, setTime] = useState('');
  const [endTime, setEndTime] = useState('');
  const [allDay, setAllDay] = useState(event?.allDay || false);
const [meetingUrl, setMeetingUrl] = useState(event?.meetingUrl || "");
  const [location, setLocation] = useState(event?.location || '');
  
  // EVENT SHARE STATE
  const [shareModalOpen, setShareModalOpen] = useState(false);
const [shareToken, setShareToken] = useState("");
const [shareLoading, setShareLoading] = useState(false);

  // Places autocomplete state
  const [placesEnabled, setPlacesEnabled] = useState(false);
  const [locationPlaceId, setLocationPlaceId] = useState(event?.locationPlaceId || null);
  const [locationCoords, setLocationCoords] = useState(event?.locationCoords || null);


  // Reminder UI state (default OFF)
  const [reminderEnabled, setReminderEnabled] = useState(false);
  const [reminderMode, setReminderMode] = useState('at_event');
  const [offsetMinutes, setOffsetMinutes] = useState(10);
  const [customReminderDate, setCustomReminderDate] = useState('');
  const [customReminderTime, setCustomReminderTime] = useState('');

  // =============================
  // NEW: Recurrence UI state
  // =============================
  const [repeatEnabled, setRepeatEnabled] = useState(false);
  const [repeatFreq, setRepeatFreq] = useState('weekly'); // daily | weekly | monthly | yearly
  const [repeatInterval, setRepeatInterval] = useState(1); // every X
  const [repeatWeekdays, setRepeatWeekdays] = useState([]); // [0..6] Sun..Sat (only for weekly)
  const [repeatEndKind, setRepeatEndKind] = useState('never'); // never | until | count
  const [repeatUntilDate, setRepeatUntilDate] = useState(''); // YYYY-MM-DD
  const [repeatCount, setRepeatCount] = useState(10); // occurrences
  const [weekdaysTouched, setWeekdaysTouched] = useState(false);
  
      const createShareCode = async () => {
  if (!event?._id) return;

  try {
    setShareLoading(true);
    setShareToken("");

    // âœ… Adjust this path if your backend uses a different route
    const data = await apiCall("/eventShare/create", {
      method: "POST",
      body: JSON.stringify({ eventId: event._id }),
    });

    const token = String(data?.token || data?.code || "");
    if (!token) {
      tg.showAlert("No token returned from server.");
      return;
    }

    setShareToken(token);
    setShareModalOpen(true);
  } catch (e) {
    tg.showAlert("Failed to create share code: " + (e?.message || "Unknown error"));
  } finally {
    setShareLoading(false);
  }
};

  useEffect(() => {
    document.body.classList.add('modal-open');
    return () => {
      document.body.classList.remove('modal-open');
    };
  }, []);

useEffect(() => {
  // -----------------------------
  // Base event fields
  // -----------------------------
  if (event) {
    const d = new Date(event.startDate);
    setDate(dateInputValue(d, userTimezone));
    setTime(timeInputValue(d, userTimezone));
    setAllDay(!!event.allDay);

    // NEW: meeting url
    setMeetingUrl(event.meetingUrl || '');

    setLocation(event.location || '');
    setLocationPlaceId(event.locationPlaceId || null);
    setLocationCoords(event.locationCoords || null);
    setPlacesEnabled(!!(event.locationPlaceId));
    setDescription(event.description || '');
    setTitle(event.title || '');

    if (event.endDate) {
      const e = new Date(event.endDate);
      setEndTime(e.toTimeString().slice(0, 5));
    } else {
      setEndTime('');
    }
  } else if (selectedDate) {
    setDate(dateInputValue(selectedDate, userTimezone));
    setTime('09:00');
    setEndTime('10:00');
    setAllDay(false);

    // NEW: meeting url
    setMeetingUrl('');

    setLocation('');
    setLocationPlaceId(null);
    setLocationCoords(null);
    setPlacesEnabled(false);
    setDescription('');
    setTitle('');
  } else {
    const now = new Date();
    setDate(now.toISOString().split('T')[0]);
    setTime('09:00');
    setEndTime('10:00');
    setAllDay(false);

    // NEW: meeting url
    setMeetingUrl('');

    setLocation('');
    setLocationPlaceId(null);
    setLocationCoords(null);
    setPlacesEnabled(false);
    setDescription('');
    setTitle('');
  }

    // -----------------------------
    // Reminder defaults + prefill
    // -----------------------------
    setReminderEnabled(false);
    setReminderMode('at_event');
    setOffsetMinutes(10);

    {
      const now = new Date();
      setCustomReminderDate(now.toISOString().split('T')[0]);
      setCustomReminderTime('09:00');
    }

    if (event && (event.reminder?.nextRunAt || event.reminderId)) {
  setReminderEnabled(true);

  // If backend only gives reminderId (no nextRunAt),
  // we can't calculate offset/custom accurately.
  if (!event.reminder?.nextRunAt) {
    setReminderMode('at_event');
  } else {
    const rNext = new Date(event.reminder.nextRunAt);
    const eStart = new Date(event.startDate);

    const diffMs = eStart.getTime() - rNext.getTime();
    const diffMinutes = Math.round(diffMs / 60000);

    if (Math.abs(diffMinutes) <= 1) {
      setReminderMode('at_event');
    } else if (diffMinutes > 0) {
      setReminderMode('offset');
      setOffsetMinutes(Math.max(1, diffMinutes));
    } else {
      setReminderMode('custom');
      setCustomReminderDate(rNext.toISOString().split('T')[0]);
      setCustomReminderTime(rNext.toTimeString().slice(0, 5));
    }
  }
}

    // -----------------------------
    // NEW: Recurrence defaults + prefill
    // -----------------------------
    setRepeatEnabled(false);
    setRepeatFreq('weekly');
    setRepeatInterval(1);
    setRepeatWeekdays([]);
    setRepeatEndKind('never');
    setRepeatUntilDate('');
    setRepeatCount(10);

    if (event && event.recurrence && event.recurrence.freq) {
      const r = event.recurrence;

      setRepeatEnabled(true);
      setRepeatFreq(String(r.freq || 'weekly'));
      setRepeatInterval("1");
const intervalStr =
  r.interval === undefined || r.interval === null
    ? "1"
    : String(Math.max(1, Number(r.interval)));
setRepeatInterval(intervalStr);

      if (Array.isArray(r.byWeekday)) {
        setRepeatWeekdays(
          r.byWeekday
            .map(n => Number(n))
            .filter(n => Number.isFinite(n) && n >= 0 && n <= 6)
        );
      }

      if (r.end && r.end.kind) {
        setRepeatEndKind(String(r.end.kind));

        if (r.end.kind === 'until' && r.end.until) {
          const until = new Date(r.end.until);
          if (!isNaN(until.getTime())) {
            setRepeatUntilDate(until.toISOString().split('T')[0]);
          }
        }

        if (r.end.kind === 'count' && typeof r.end.count === 'number') {
          setRepeatCount(Math.max(1, Number(r.end.count)));
        }
      }
    }
}, [event, selectedDate]);
  
  useEffect(() => {
  if (
    !repeatEnabled ||
    String(repeatFreq || 'weekly') !== 'weekly' ||
    weekdaysTouched ||
    !date
  ) {
    return;
  }

  const wd = new Date(date + 'T00:00:00').getDay();
  setRepeatWeekdays([wd]);
}, [date, repeatEnabled, repeatFreq]);

  const handleSave = async () => {
    if (!title.trim()) {
      tg.showAlert('Please enter a title');
      return;
    }


const zone = userTimezone || "America/Chicago";

// Build start in USER timezone, then convert to UTC ISO
const startISO = allDay
  ? DateTime.fromISO(date, { zone }).startOf("day").toUTC().toISO()
  : DateTime.fromISO(`${date}T${time}`, { zone }).toUTC().toISO();

// Build end in USER timezone, then convert to UTC ISO
const endISO =
  endTime && !allDay
    ? DateTime.fromISO(`${date}T${endTime}`, { zone }).toUTC().toISO()
    : null;

    // -----------------------------
    // Reminder payload
    // -----------------------------
    let reminderPayload = { enabled: false };

    if (reminderEnabled) {
      if (allDay && reminderMode !== 'custom') {
        tg.showAlert('For all-day events, please use Custom reminder time.');
        return;
      }

      if (reminderMode === 'at_event') {
        reminderPayload = { enabled: true, mode: 'at_event' };
      } else if (reminderMode === 'offset') {
        reminderPayload = { enabled: true, mode: 'offset', offsetMinutes };
      } else {
        if (!customReminderDate || !customReminderTime) {
          tg.showAlert('Please choose a custom reminder date and time.');
          return;
        }
const customISO = DateTime
  .fromISO(`${customReminderDate}T${customReminderTime}`, { zone })
  .toUTC()
  .toISO();

reminderPayload = {
  enabled: true,
  mode: 'custom',
  customDateTime: customISO,
};
      }
    }

    // -----------------------------
    // NEW: Recurrence payload
    // -----------------------------
    let recurrence = null;

    if (repeatEnabled) {
      const freq = String(repeatFreq || 'weekly');
const rawInterval = Number(String(repeatInterval).trim());
const interval = Number.isFinite(rawInterval) && rawInterval >= 1 ? Math.trunc(rawInterval) : 1;

      let byWeekday = undefined;
      if (freq === 'weekly') {
        const list = Array.isArray(repeatWeekdays)
          ? repeatWeekdays.map(n => Number(n)).filter(n => n >= 0 && n <= 6)
          : [];

const startWeekday = DateTime.fromISO(date, { zone }).weekday % 7; // 0..6

if (list.length === 0) {
  byWeekday = [startWeekday];
} else {
  byWeekday = Array.from(new Set(list));
}
      }

let end = { kind: "never" };

if (repeatEndKind === "until") {
  if (!repeatUntilDate) {
    tg.showAlert('Choose an "until" date for repeating events.');
    return;
  }

  const untilISO = DateTime
    .fromISO(repeatUntilDate, { zone })
    .endOf("day")
    .toUTC()
    .toISO();

  end = { kind: "until", until: untilISO };
}

if (repeatEndKind === "count") {
  const c = Math.max(1, Number(repeatCount || 1));
  end = { kind: "count", count: c };
}

      recurrence = {
        freq,
        interval,
        ...(byWeekday ? { byWeekday } : {}),
        end,
      };
    }

await onSave({
  title,
  description,
  startDate: startISO,
  endDate: endISO || undefined,
  allDay,

  meetingUrl: meetingUrl ? String(meetingUrl).trim() : "",

  location,
  locationPlaceId: locationPlaceId || null,
  locationCoords: locationCoords || null,

  reminder: reminderPayload,
  recurrence,
});
  };

  const ReminderModeButton = ({ value, label }) => {
    const active = reminderMode === value;
    const className = `btn ${active ? 'btn-primary' : 'btn-secondary'}`;
    return (
      <button
        type="button"
        className={className}
        onClick={() => setReminderMode(value)}
      >
        {label}
      </button>
    );
  };

  const OffsetButton = ({ minutes }) => {
    const active = offsetMinutes === minutes;
    const className = `btn ${active ? 'btn-primary' : 'btn-secondary'}`;
    return (
      <button
        type="button"
        className={className}
        onClick={() => setOffsetMinutes(minutes)}
      >
        {minutes}m
      </button>
    );
  };

  // =============================
  // NEW: Repeat UI helpers
  // =============================
  const weekdayLabels = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

const toggleWeekday = (idx) => {
  setWeekdaysTouched(true);
  setRepeatWeekdays((prev) => {
    const set = new Set(Array.isArray(prev) ? prev : []);
    if (set.has(idx)) set.delete(idx);
    else set.add(idx);
    return Array.from(set).sort((a, b) => a - b);
  });
};

  const WeekdayButton = ({ idx }) => {
    const active = Array.isArray(repeatWeekdays) && repeatWeekdays.includes(idx);
    const className = `btn ${active ? 'btn-primary' : 'btn-secondary'}`;
    return (
      <button
        type="button"
        className={className}
        onClick={() => toggleWeekday(idx)}
      >
        {weekdayLabels[idx]}
      </button>
    );
  };

  const EndKindButton = ({ value, label }) => {
    const active = repeatEndKind === value;
    const className = `btn ${active ? 'btn-primary' : 'btn-secondary'}`;
    return (
      <button
        type="button"
        className={className}
        onClick={() => setRepeatEndKind(value)}
      >
        {label}
      </button>
    );
  };

  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal" onClick={e => e.stopPropagation()}>
      
      {shareModalOpen && (
  <ShareCodeModal
    token={shareToken}
    onClose={() => setShareModalOpen(false)}
  />
)}
        <div className="modal-header">
          <h2>{event ? 'Edit Event' : 'New Event'}</h2>
          <button className="modal-close" onClick={onClose}>Ã—</button>
        </div>

        <div className="modal-body">
          <div className="form-group">
            <label className="form-label">Title</label>
            <input
              type="text"
              className="form-input"
              value={title}
              onChange={e => setTitle(e.target.value)}
              placeholder="Event title"
            />
          </div>

          <div className="form-group">
            <label className="form-label">Description</label>
            <textarea
              className="form-textarea form-textarea--sm"
              value={description}
              onChange={e => setDescription(e.target.value)}
              placeholder="Add details..."
            />
          </div>

          <div className="form-group">
            <label className="form-label">Date</label>
            <input
  type="date"
  className="form-input"
  value={date}
  onChange={(e) => setDate(e.target.value)}
/>
          </div>

          <div className="form-group">
            <label className="checkbox-row">
              <input
                type="checkbox"
                checked={allDay}
                onChange={e => setAllDay(e.target.checked)}
              />
              <span>All day event</span>
            </label>
          </div>

          {!allDay && (
            <div className="form-row">
              <div className="form-group">
                <label className="form-label">Start Time</label>
                <input
                  type="time"
                  className="form-input"
                  value={time}
                  onChange={e => setTime(e.target.value)}
                />
              </div>
              <div className="form-group">
                <label className="form-label">End Time</label>
                <input
                  type="time"
                  className="form-input"
                  value={endTime}
                  onChange={e => setEndTime(e.target.value)}
                />
              </div>
            </div>
          )}

<div className="form-group">
  <label className="form-label">URL</label>
  <input
    type="url"
    className="form-input"
    value={meetingUrl}
    onChange={(e) => setMeetingUrl(e.target.value)}
    placeholder="https://zoom.us/... or https://meet.google.com/..."
    inputMode="url"
    autoCapitalize="none"
    autoCorrect="off"
    spellCheck={false}
  />
  <div className="form-help">
    Optional. Add a link for an online meeting.
  </div>
</div>

<div className="form-group">
  <label className="form-label">Location</label>
  <PlacesAutocomplete
    value={location}
    onChange={(val) => {
      setLocation(val);
      if (!placesEnabled) {
        setLocationPlaceId(null);
        setLocationCoords(null);
      }
    }}
    onPlaceSelect={(place) => {
      setLocationPlaceId(place.placeId || null);
      setLocationCoords(
        place.lat != null && place.lng != null
          ? { lat: place.lat, lng: place.lng }
          : null
      );
    }}
    enabled={placesEnabled}
  />

  <label className="checkbox-row checkbox-row--spaced">
    <input
      type="checkbox"
      checked={placesEnabled}
      onChange={(e) => {
        setPlacesEnabled(e.target.checked);
        if (!e.target.checked) {
          setLocationPlaceId(null);
          setLocationCoords(null);
        }
      }}
    />
    <span>Search Google Places</span>
  </label>
</div>

          {/* =============================
              Reminder section (existing)
             ============================= */}
          <div className="form-group">
            <label className="form-label">Reminder</label>

            <label className="checkbox-row" style={{ marginBottom: 12 }}>
              <input
                type="checkbox"
                checked={reminderEnabled}
                onChange={e => setReminderEnabled(e.target.checked)}
              />
              <span>Enable reminder</span>
            </label>

            {reminderEnabled && (
              <div>
                <div className="card-actions" style={{ marginBottom: 12 }}>
                  <ReminderModeButton value="at_event" label="At event time" />
                  <ReminderModeButton value="offset" label="Before event" />
                  <ReminderModeButton value="custom" label="Custom time" />
                </div>

                {reminderMode === 'offset' && (
                  <div className="card-actions" style={{ marginBottom: 12 }}>
                    <OffsetButton minutes={5} />
                    <OffsetButton minutes={10} />
                    <OffsetButton minutes={15} />
                    <OffsetButton minutes={30} />
                    <OffsetButton minutes={60} />
                  </div>
                )}

                {reminderMode === 'custom' && (
                  <div className="form-row">
                    <div className="form-group">
                      <label className="form-label">Reminder Date</label>
                      <input
                        type="date"
                        className="form-input"
                        value={customReminderDate}
                        onChange={e => setCustomReminderDate(e.target.value)}
                      />
                    </div>
                    <div className="form-group">
                      <label className="form-label">Reminder Time</label>
                      <input
                        type="time"
                        className="form-input"
                        value={customReminderTime}
                        onChange={e => setCustomReminderTime(e.target.value)}
                      />
                    </div>
                  </div>
                )}

                {allDay && reminderMode !== 'custom' && (
                  <div style={{ color: 'var(--text-secondary)', fontSize: 13, lineHeight: 1.4 }}>
                    For all-day events, use Custom reminder time.
                  </div>
                )}
              </div>
            )}
          </div>

          {/* =============================
              NEW: Repeat section
             ============================= */}
          <div className="form-group">
            <label className="form-label">Repeat</label>

            <label className="checkbox-row" style={{ marginBottom: 12 }}>
              <input
                type="checkbox"
                checked={repeatEnabled}
                onChange={e => setRepeatEnabled(e.target.checked)}
              />
              <span>Repeat event</span>
            </label>

            {repeatEnabled && (
              <div>
                <div className="form-row">
                  <div className="form-group">
                    <label className="form-label">Frequency</label>
                    <select
                      className="form-select"
                      value={repeatFreq}
                      onChange={(e) => {
                        const v = e.target.value;
                        setRepeatFreq(v);

                        // If they switch away from weekly, clear weekday selection
                        if (v !== 'weekly') {
                          setRepeatWeekdays([]);
                        }
                      }}
                    >
                      <option value="daily">Daily</option>
                      <option value="weekly">Weekly</option>
                      <option value="monthly">Monthly</option>
                      <option value="yearly">Yearly</option>
                    </select>
                  </div>

                  <div className="form-group">
                    <label className="form-label">Every</label>
                    <input
  type="number"
  className="form-input"
  min="1"
  step="1"
  value={repeatInterval}
  onChange={(e) => setRepeatInterval(e.target.value)}
  placeholder="1"
/>
                    <div style={{ color: 'var(--text-secondary)', fontSize: 12, marginTop: 6, lineHeight: 1.35 }}>
                      {repeatFreq === 'daily' ? 'days' :
                       repeatFreq === 'weekly' ? 'weeks' :
                       repeatFreq === 'monthly' ? 'months' : 'years'}
                    </div>
                  </div>
                </div>

                {repeatFreq === 'weekly' && (
                  <div className="form-group">
                    <label className="form-label">On</label>
                    <div className="card-actions" style={{ marginBottom: 6 }}>
                      {weekdayLabels.map((_, idx) => (
                        <WeekdayButton key={idx} idx={idx} />
                      ))}
                    </div>
                    <div style={{ color: 'var(--text-secondary)', fontSize: 12, lineHeight: 1.35 }}>
                      If you select none, it defaults to the eventâ€™s start weekday.
                    </div>
                  </div>
                )}

                <div className="form-group">
                  <label className="form-label">Ends</label>

                  <div className="card-actions" style={{ marginBottom: 12 }}>
                    <EndKindButton value="never" label="Never" />
                    <EndKindButton value="until" label="Until date" />
                    <EndKindButton value="count" label="After N" />
                  </div>

                  {repeatEndKind === 'until' && (
                    <div className="form-group">
                      <label className="form-label">Until</label>
                      <input
                        type="date"
                        className="form-input"
                        value={repeatUntilDate}
                        onChange={(e) => setRepeatUntilDate(e.target.value)}
                      />
                    </div>
                  )}

                  {repeatEndKind === 'count' && (
                    <div className="form-group">
                      <label className="form-label">Occurrences</label>
                      <input
                        type="number"
                        className="form-input"
                        min="1"
                        value={repeatCount}
                        onChange={(e) => setRepeatCount(Math.max(1, Number(e.target.value || 1)))}
                      />
                    </div>
                  )}

                  <div style={{ color: 'var(--text-secondary)', fontSize: 12, lineHeight: 1.35 }}>
                    Your backend still needs to store and expand recurrence for it to appear on the calendar.
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>

        <div className="modal-actions">
  <button className="btn btn-secondary" onClick={onClose} type="button">
    Cancel
  </button>

  {event?._id && (
    <button
      className="btn btn-secondary"
      onClick={createShareCode}
      type="button"
      disabled={shareLoading}
    >
      {shareLoading ? "Sharingâ€¦" : "Share"}
    </button>
  )}

  <button className="btn btn-primary" onClick={handleSave} type="button">
    {event ? "Update" : "Create"}
  </button>
</div>
      </div>
    </div>
  );
}


    // Event Preview Modal (read-only detail view)
    function EventPreviewModal({ event, onClose, onEdit, onDelete }) {
      useEffect(() => {
        document.body.classList.add('modal-open');
        return () => document.body.classList.remove('modal-open');
      }, []);

      if (!event) return null;

      const title = (event.title || event.text || event.name || "(untitled event)").trim();
      const startDate = event.startDate ? new Date(event.startDate) : null;

      const dateStr = startDate
        ? startDate.toLocaleDateString("en-US", { weekday: "long", month: "long", day: "numeric", year: "numeric" })
        : "";

      const timeStr = event.allDay
        ? "All day"
        : formatEventTime(event);

      const hasRem = hasReminder(event);
      
      const openMeetingUrl = () => {
  const url = String(event.meetingUrl || "").trim();
  if (!url) return;

  // Prefer Telegram WebApp openLink if available
  if (typeof tg !== "undefined" && tg?.openLink) {
    tg.openLink(url);
    return;
  }

  window.open(url, "_blank", "noopener,noreferrer");
};

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal" onClick={(e) => e.stopPropagation()}>
            <div className="modal-header">
              <h2>{title}</h2>
              <button className="modal-close" onClick={onClose} type="button">Ã—</button>
            </div>

            <div className="modal-body">
              {dateStr && (
                <div className="event-preview-row">
                  <img src="/icons/cal.svg" alt="" />
                  <span>{dateStr}</span>
                </div>
              )}

              {timeStr && (
                <div className="event-preview-row">
                  <img src="/icons/alarm.svg" alt="" />
                  <span>{timeStr}</span>
                </div>
              )}

              {event.meetingUrl && (
  <div className="event-preview-row">
    <img src="/icons/url.svg" alt="" />
    <button
      type="button"
      className="event-link-button"
      onClick={() => tg.openLink(event.meetingUrl)}
    >
      Join meeting
    </button>
    </div>
)}

{event.location && (
  <div className="event-preview-row">
    <img src="/icons/location.svg" alt="" />
    <span>{event.location}</span>
  </div>
)}

              {hasRem && (
                <div className="event-preview-row">
                  <img src="/icons/bell.svg" alt="" />
                  <span>Reminder set</span>
                </div>
              )}

              {event.recurrence && event.recurrence.freq && (
                <div className="event-preview-row event-preview-recurrence">
                  <img src="/icons/calendar.svg" alt="" />
                  <span>
                    Repeats {event.recurrence.freq}
                    {event.recurrence.interval && event.recurrence.interval > 1
                      ? ` every ${event.recurrence.interval}`
                      : ""}
                  </span>
                </div>
              )}

              {event.description && (
                <div className="event-preview-description">
                  {event.description}
                </div>
              )}
            </div>

            <div className="modal-actions journal-preview-actions">
              <button className="btn btn-primary" onClick={() => onEdit(event)} type="button">
                <img src="/icons/pencil.svg" alt="" />
                Edit
              </button>

              <button className="btn btn-secondary" onClick={onClose} type="button">
                Close
              </button>

              <button
                className="btn btn-danger"
                type="button"
                onClick={() => {
                  if (!event?._id) return;
                  onDelete(event._id);
                  onClose();
                }}
              >
                <img src="/icons/trash.svg" alt="" />
                Delete
              </button>
            </div>
          </div>
        </div>
      );
    }


    // Calendar View - Day List Style
function CalendarView({ onOpenSettings, userTimezone, onOpenEventShare }) {
      const [currentMonth, setCurrentMonth] = useState(new Date());
      const [events, setEvents] = useState([]);
      const [loading, setLoading] = useState(true);
      const [showEventModal, setShowEventModal] = useState(false);
      const [editingEvent, setEditingEvent] = useState(null);
      const [selectedDate, setSelectedDate] = useState(null);
            const [previewEvent, setPreviewEvent] = useState(null);
      const createEventRefs = useRef({});

      useEffect(() => {
        loadEvents();
      }, [currentMonth]);

      const loadEvents = async () => {
        try {
          setLoading(true);
          const startOfMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
const endExclusive = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1);

const data = await apiCall(
  `/calendar/events?startDate=${startOfMonth.toISOString()}&endDate=${endExclusive.toISOString()}`
);
          setEvents(data.events);
        } catch (error) {
          tg.showAlert('Failed to load events: ' + error.message);
        } finally {
          setLoading(false);
        }
      };

      const getDaysInMonth = () => {
        const year = currentMonth.getFullYear();
        const month = currentMonth.getMonth();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        const days = [];
        for (let i = 1; i <= daysInMonth; i++) {
          days.push(new Date(year, month, i));
        }

        return days;
      };

      const getEventsForDate = (date) => {
  const dayStart = new Date(date.getFullYear(), date.getMonth(), date.getDate(), 0, 0, 0);
  const dayEnd = new Date(date.getFullYear(), date.getMonth(), date.getDate() + 1, 0, 0, 0);

  return events.filter((event) => {
    const start = new Date(event.startDate);
    const end = event.endDate ? new Date(event.endDate) : null;

    // No end date = treat as instant event on start time
    if (!end || isNaN(end.getTime())) {
      return start >= dayStart && start < dayEnd;
    }

    // Overlap test: event intersects [dayStart, dayEnd)
    return start < dayEnd && end > dayStart;
  });
};

      const isToday = (date) => {
        const today = new Date();
        return date.toDateString() === today.toDateString();
      };

      const handlePrevMonth = () => {
        setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1));
      };

      const handleNextMonth = () => {
        setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1));
      };

      const handleCreateEvent = (date) => {
        setSelectedDate(date);
        setEditingEvent(null);
        setShowEventModal(true);
      };

      const handleEditEvent = (event) => {
        setEditingEvent(event);
        setSelectedDate(null);
        setShowEventModal(true);
      };

      const handleSaveEvent = async (data) => {
        try {
          if (editingEvent) {
            await apiCall(`/calendar/events/${editingEvent._id}`, {
              method: 'PUT',
              body: JSON.stringify(data),
            });
            tg.showAlert('Event updated!');
          } else {
            await apiCall('/calendar/events', {
              method: 'POST',
              body: JSON.stringify(data),
            });
            tg.showAlert('Event created!');
          }
          setShowEventModal(false);
          setSelectedDate(null);
          loadEvents();
        } catch (error) {
          tg.showAlert('Failed to save: ' + error.message);
        }
      };

      const handleDeleteEvent = async (eventId, e) => {
        e.stopPropagation();
        try {
          await apiCall(`/calendar/events/${eventId}`, {
            method: 'DELETE',
          });
          tg.showPopup({ message: 'Event deleted' });
          loadEvents();
        } catch (error) {
          tg.showAlert('Failed to delete: ' + error.message);
        }
      };

      const monthName = currentMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
      const days = getDaysInMonth();
      
      // Symbol â†’ SVG map (Calendar specific)
const CALENDAR_SYMBOL_SVG_MAP = {
  'â™¡': (
    <img
      className="calendar-inline-svg"
      src="/icons/heart.svg"
      alt="â™¡"
      width="14"
      height="14"
    />
  ),
  'âœ¦': (
    <img
      className="calendar-inline-svg"
      src="/icons/sparkle-fill.svg"
      alt="âœ¦"
      width="14"
      height="14"
    />
  ),
  // Add more symbols here as needed
  'âœ§': (
  <img
    className="calendar-inline-svg"
    src="/icons/sparkle-line.svg"
    alt="âœ§"
    width="14"
    height="14"
  />
  ),
  'â˜†': (
  <img
    className="calendar-inline-svg"
    src="/icons/stars.svg"
    alt="â˜†"
    width="14"
    height="14"
  />
  ),
  'â˜…': (
  <img
    className="calendar-inline-svg"
    src="/icons/star.svg"
    alt="â˜…"
    width="14"
    height="14"
  />
  ),
};

// Render function
function renderCalendarInlineSymbols(text) {
  if (!text) return null;

  const symbolRegex = new RegExp(
    `(${Object.keys(CALENDAR_SYMBOL_SVG_MAP)
      .map(s => s.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"))
      .join("|")})`,
    "g"
  );

  return text.split(symbolRegex).map((part, index) => {
    if (CALENDAR_SYMBOL_SVG_MAP[part]) {
      return (
        <span key={index} className="calendar-inline-wrapper">
          {CALENDAR_SYMBOL_SVG_MAP[part]}
        </span>
      );
    }

    return <span key={index}>{part}</span>;
  });
}

      return (
        <div>
          <div className="calendar-header">
  <div className="calendar-month">
    <button className="calendar-nav-btn" onClick={handlePrevMonth}>â€¹</button>
    <span>{monthName}</span>
    <button className="calendar-nav-btn" onClick={handleNextMonth}>â€º</button>
  </div>

  <div className="calendar-header-right">
  <button
    className="icon-btn"
    type="button"
    onClick={() => onOpenEventShare && onOpenEventShare()}
    aria-label="Join shared event"
    title="Join shared event"
  >
    <img src="/icons/link.svg" alt="" />
  </button>

  <button
    className="icon-btn"
    type="button"
    onClick={() => onOpenSettings && onOpenSettings()}
  >
    <img src="/icons/cog.svg" alt="" />
  </button>
</div>
</div>

          {loading ? (
            <div className="loading">
              <div className="spinner" />
              <div>Loading calendar...</div>
            </div>
          ) : (
            <div className="calendar-body">
              {days.map(date => {
                const dayEvents = getEventsForDate(date);
                const dateIsToday = isToday(date);

                return (
                  <div key={date.toISOString()} className="calendar-day">
                    <div className="calendar-day-row">
                      {/* Date box */}
                      <div className="calendar-datebox">
                        <div className={`calendar-datebox-day ${dateIsToday ? 'is-today' : ''}`}>
                          {date.getDate()}
                        </div>
                        <div className="calendar-datebox-dow">
                          {date.toLocaleDateString('en-US', { weekday: 'short' })}
                        </div>
                      </div>

                      {/* Events container */}
                      <div className="calendar-events">
                        {dayEvents.length === 0 ? (
                          <div className="calendar-no-events">
                            <span>No events</span>
                            <button
  ref={el => createEventRefs.current[date.toISOString()] = el}
  onClick={() => handleCreateEvent(date)}
  className="calendar-add-icon-btn"
>
  <img src="/icons/plus.svg" alt="" />
</button>
                          </div>
                        ) : (
                          <div>
                            {dayEvents.map(event => (
                                                            <div
                                key={event._id}
                                onClick={() => setPreviewEvent(event)}
                                className="calendar-event"
                              >
                                <div className="calendar-event-top">
                                  <div className="calendar-event-main">
                                    {event.allDay && (
                                      <div className="calendar-event-allday">
                                        â— All day
                                      </div>
                                    )}
                                    <div className="calendar-event-title">
  {renderCalendarInlineSymbols(
    event.title || event.text || event.name || "(untitled)"
  )}
  {hasReminder(event) && (
    <span className="event-reminder-dot" />
  )}
</div>
                                    {!event.allDay && (
                                      <div className="calendar-event-time">
                                        {formatEventTime(event)}
                                      </div>
                                    )}
                                    {event.location && (
                                      <div className="calendar-event-location">
  <img src="/icons/location.svg" alt="" />
  {event.location}
</div>
                                    )}
                                  </div>
                                  <button
  onClick={(e) => handleDeleteEvent(event._id, e)}
  className="calendar-event-delete"
>
  <img src="/icons/trash.svg" alt="" />
</button>
                                </div>
                              </div>
                            ))}
                            <button
                              ref={el => createEventRefs.current[date.toISOString()] = el}
                              onClick={() => handleCreateEvent(date)}
                              className="calendar-add-event"
                            >
                              + Add event
                            </button>
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          )}
<button
  className="is-hidden"
  data-create-event="1"
  onClick={() => handleCreateEvent(new Date())}
/>

          {previewEvent && !showEventModal && (
            <EventPreviewModal
              event={previewEvent}
              onClose={() => setPreviewEvent(null)}
              onEdit={(ev) => {
                setPreviewEvent(null);
                handleEditEvent(ev);
              }}
              onDelete={(id) => {
                setPreviewEvent(null);
                handleDeleteEvent(id, { stopPropagation: () => {} });
              }}
            />
          )}

          {showEventModal && (
            <EventModal
  event={editingEvent}
  selectedDate={selectedDate}
  userTimezone={userTimezone}
  onClose={() => {
    setShowEventModal(false);
    setSelectedDate(null);
  }}
  onSave={handleSaveEvent}
/>
          )}
        </div>
      );
    }

// Reminders View
function RemindersView({ activeView, userTimezone, userDisplayName, onOpenHabits, goTo }) {
  const [reminders, setReminders] = useState([]);
  const [loading, setLoading] = useState(true);
  const [showHistory, setShowHistory] = useState(false);
  const [showModal, setShowModal] = useState(false);
  const [editingReminder, setEditingReminder] = useState(null);
  const [filter, setFilter] = useState('all');
  const createReminderRef = useRef(null);

  // â”€â”€ Pagination state â”€â”€
  const [skip, setSkip] = useState(0);
  const [total, setTotal] = useState(0);
  const [loadingMore, setLoadingMore] = useState(false);
  const PAGE_SIZE = 8;

  useEffect(() => {
    if (activeView === "reminders") {
      loadReminders();
    }
  }, [showHistory, activeView, filter]);

  const loadReminders = async (append = false) => {
    try {
      if (append) {
        setLoadingMore(true);
      } else {
        setLoading(true);
        setSkip(0);
      }

      const currentSkip = append ? skip : 0;
      const data = await apiCall(
        `/reminders?includeHistory=${showHistory}&limit=${PAGE_SIZE}&skip=${currentSkip}&kind=${filter}`
      );

      if (append) {
        setReminders(prev => [...prev, ...data.reminders]);
      } else {
        setReminders(data.reminders);
      }

      setTotal(data.total || 0);
      setSkip(currentSkip + data.reminders.length);
    } catch (error) {
      tg.showAlert('Failed to load reminders: ' + error.message);
    } finally {
      setLoading(false);
      setLoadingMore(false);
    }
  };

  const loadMore = () => {
    loadReminders(true);
  };

  const handleCreate = () => {
    setEditingReminder(null);
    setShowModal(true);
  };

  const handleEdit = (reminder) => {
    setEditingReminder(reminder);
    setShowModal(true);
  };

  const handleSave = async (data) => {
    try {
      if (editingReminder) {
        await apiCall(`/reminders/${editingReminder._id}`, {
          method: 'PUT',
          body: JSON.stringify(data),
        });
        tg.showAlert('Reminder updated!');
      } else {
        await apiCall('/reminders', {
          method: 'POST',
          body: JSON.stringify(data),
        });
        tg.showAlert('Reminder created!');
      }
      setShowModal(false);
      loadReminders();
    } catch (error) {
      tg.showAlert('Failed to save: ' + error.message);
    }
  };

  const handleSnooze = async (id, minutes) => {
    try {
      await apiCall(`/reminders/${id}/snooze`, {
        method: 'POST',
        body: JSON.stringify({ minutes }),
      });
      tg.showPopup({ message: `Snoozed for ${minutes} minutes` });
      loadReminders();
    } catch (error) {
      tg.showAlert('Failed to snooze: ' + error.message);
    }
  };

  const handleDone = async (id) => {
    try {
      await apiCall(`/reminders/${id}/done`, {
        method: 'POST',
      });
      tg.showPopup({ message: 'Marked as done!' });
      loadReminders();
    } catch (error) {
      tg.showAlert('Failed to mark as done: ' + error.message);
    }
  };

  const handleDelete = async (id) => {
    try {
      await apiCall(`/reminders/${id}`, {
        method: 'DELETE',
      });
      tg.showPopup({ message: 'Reminder deleted' });
      loadReminders();
    } catch (error) {
      tg.showAlert('Failed to delete: ' + error.message);
    }
  };

  // No more client-side filtering -- server handles it now
  const filteredReminders = reminders;

  return (
    <div>
      <div className="header">
        <div>
          <h1>Reminders</h1>

          {(() => {
            const name = (userDisplayName || "").trim();
            return name ? <div className="reminders-greeting">Hello {name}</div> : null;
          })()}
        </div>

        <div className="header-actions">
          {/* CHECKLIST ICON BUTTON */}
          <button
            type="button"
            className="icon-btn"
            aria-label="Checklist"
            title="Checklist"
            onClick={() => goTo('checklist')}
          >
            <img src="/icons/check.svg" alt="" />
          </button>

          {/* HABITS ICON BUTTON */}
          <button
            type="button"
            className="icon-btn"
            aria-label="Habits"
            title="Habits"
            onClick={onOpenHabits}
          >
            <img src="/icons/plus.svg" alt="" />
          </button>
    
    {/* MOOD ICON BUTTON */}
        <button
      type="button"
       className="mood-icon-btn"
       aria-label="Mood"
       title="Mood"
       onClick={() => goTo('mood')}
     >
      <img src="/icons/bfly.svg" alt="" />
     </button>

          {/* HISTORY TOGGLE */}
          <div className="toggle" onClick={() => setShowHistory(!showHistory)}>
            <span>History</span>
            <div className={`toggle-switch ${showHistory ? 'active' : ''}`} />
          </div>
        </div>
      </div>

      <div className="reminder-quick-actions">
        <div
          className={`reminder-quick-action ${filter === 'all' ? 'active' : ''}`}
          onClick={() => setFilter('all')}
        >
          All
        </div>
        <div
          className={`reminder-quick-action ${filter === 'once' ? 'active' : ''}`}
          onClick={() => setFilter('once')}
        >
          Once
        </div>
        <div
          className={`reminder-quick-action ${filter === 'daily' ? 'active' : ''}`}
          onClick={() => setFilter('daily')}
        >
          Daily
        </div>
        <div
          className={`reminder-quick-action ${filter === 'weekly' ? 'active' : ''}`}
          onClick={() => setFilter('weekly')}
        >
          Weekly
        </div>
        <div
          className={`reminder-quick-action ${filter === 'monthly' ? 'active' : ''}`}
          onClick={() => setFilter('monthly')}
        >
          Monthly
        </div>
        <div
          className={`reminder-quick-action ${filter === 'yearly' ? 'active' : ''}`}
          onClick={() => setFilter('yearly')}
        >
          Yearly
        </div>
        <div
          className={`reminder-quick-action ${filter === 'interval' ? 'active' : ''}`}
          onClick={() => setFilter('interval')}
        >
          Interval
        </div>
      </div>

      {loading ? (
        <div className="loading">
          <div className="spinner" />
          <div>Loading reminders...</div>
        </div>
      ) : filteredReminders.length === 0 ? (
        <div className="empty-state">
          <div className="empty-state-icon">
            <img src="/icons/journal.svg" alt="" />
          </div>
          <div className="empty-state-text">
            {filter === 'all'
              ? 'No reminders yet.\nTap the + button to create one!'
              : `No ${filter} reminders.`}
          </div>
        </div>
      ) : (
        <>
          {filteredReminders.map(r => (
            <ReminderCard
              key={r._id}
              reminder={r}
              onEdit={handleEdit}
              onSnooze={handleSnooze}
              onDone={handleDone}
              onDelete={handleDelete}
              userTimezone={userTimezone}
            />
          ))}

          {/* Load More button */}
          {filteredReminders.length < total && (
            <div className="load-more-container">
              <button
                className="btn btn-secondary load-more-btn"
                onClick={loadMore}
                disabled={loadingMore}
              >
                {loadingMore ? "Loading..." : "Load more"}
              </button>
            </div>
          )}
        </>
      )}

      <button
        className="is-hidden"
        ref={createReminderRef}
        data-create-reminder="1"
        onClick={handleCreate}
      />

      {showModal && (
        <ReminderModal
          reminder={editingReminder}
          onClose={() => setShowModal(false)}
          onSave={handleSave}
          userTimezone={userTimezone}
        />
      )}
    </div>
  );
}

    
    // SETTINGS VIEW
function SettingsView({ onBack }) {
  const [loading, setLoading] = useState(true);
  const [timezone, setTimezone] = useState("America/Chicago");
  const [displayName, setDisplayName] = useState("");
  const [saving, setSaving] = useState(false);

// quiet hours state
const [qhEnabled, setQhEnabled] = useState(false);
const [qhStart, setQhStart] = useState("23:00");
const [qhEnd, setQhEnd] = useState("08:00");

  useEffect(() => {
    document.body.classList.remove("modal-open"); // safety
  }, []);

  useEffect(() => {
    (async () => {
      try {
        setLoading(true);
const data = await apiCall(`/settings`);

if (data?.settings?.timezone) setTimezone(String(data.settings.timezone));
if (data?.settings?.displayName !== undefined) {
  setDisplayName(String(data.settings.displayName || ""));
}

const qh = data?.settings?.quietHours;
if (qh) {
  setQhEnabled(!!qh.enabled);
  setQhStart(String(qh.start || "23:00"));
  setQhEnd(String(qh.end || "08:00"));
}
      } catch (e) {
        tg.showAlert("Failed to load settings: " + (e.message || "Unknown error"));
      } finally {
        setLoading(false);
      }
    })();
  }, []);

  const save = async () => {
    try {
      setSaving(true);
      await apiCall(`/settings`, {
        method: "PUT",
body: JSON.stringify({
  timezone,
  displayName,
  quietHours: {
    enabled: qhEnabled,
    start: qhStart,
    end: qhEnd,
  },
}),
      });
      tg.showPopup({ message: "Settings saved" });
    } catch (e) {
      tg.showAlert("Failed to save: " + (e.message || "Unknown error"));
    } finally {
      setSaving(false);
    }
  };

return (
  <div>
    <div className="header">
      <h1>Settings</h1>

      <div className="journal-header-actions">
        <button className="btn btn-secondary" type="button" onClick={onBack}>
          Back
        </button>
      </div>
    </div>

    {loading ? (
      <div className="loading">
        <div className="spinner" />
        <div>Loading settings...</div>
      </div>
    ) : (
      <div
        className="card settings-card"
        onClick={(e) => e.stopPropagation()}
      >
        {/* -------------------
            TIMEZONE SECTION
           ------------------- */}
        <div className="settings-title">Timezone</div>

        <div className="settings-help">
          Use an IANA timezone like <b>Asia/Jakarta</b>. Offsets like <b>+7</b>{" "}
          can be mapped by the bot command too, but the stored value should be
          IANA.
        </div>

        <input
          className="form-input"
          value={timezone}
          onChange={(e) => setTimezone(e.target.value)}
          placeholder="e.g. Asia/Jakarta"
        />

        <div className="settings-actions">
          <button
            className="btn btn-primary btn-sm"
            type="button"
            onClick={save}
            disabled={saving}
          >
            {saving ? "Saving..." : "Save Timezone"}
          </button>
        </div>
        
        {/* -------------------
    DISPLAY NAME SECTION
   ------------------- */}
<div style={{ marginTop: 18 }}>
  <div className="settings-title">Display Name</div>

  <div className="settings-help">
    Optional name shown in the mini app. Leave blank to use your Telegram name.
  </div>

  <input
    className="form-input"
    value={displayName}
    onChange={(e) => setDisplayName(e.target.value)}
    placeholder="e.g. Asteria"
    maxLength={48}
  />

  <div className="settings-actions">
    <button
      className="btn btn-primary btn-sm"
      type="button"
      onClick={save}
      disabled={saving}
    >
      {saving ? "Saving..." : "Save Display Name"}
    </button>
  </div>
</div>

        {/* -------------------
            QUIET HOURS SECTION
           ------------------- */}
        <div className="qh-box">
          <div className="qh-title">Quiet Hours</div>

          <div className="qh-sub">
            If enabled, reminders that would deliver during this window can be
            delayed until quiet hours end.
          </div>

          <div className="qh-toggle">
            <label>
              <input
                type="checkbox"
                checked={qhEnabled}
                onChange={(e) => setQhEnabled(e.target.checked)}
              />
              <span>Enable Quiet Hours</span>
            </label>
          </div>

          <div className={`qh-times ${qhEnabled ? "" : "qh-disabled"}`}>
            <div className="form-group">
              <label className="form-label">Start</label>
              <input
                type="time"
                className="form-input"
                value={qhStart}
                onChange={(e) => setQhStart(e.target.value)}
              />
            </div>

            <div className="form-group">
              <label className="form-label">End</label>
              <input
                type="time"
                className="form-input"
                value={qhEnd}
                onChange={(e) => setQhEnd(e.target.value)}
              />
            </div>
          </div>

          <div className="qh-actions">
            <button
              className="btn btn-primary btn-sm"
              type="button"
              onClick={save}
              disabled={saving}
            >
              {saving ? "Saving..." : "Save Quiet Hours"}
            </button>
          </div>
        </div>
      </div>
    )}
  </div>
);
}

// Event Share View
function EventShareView({ onBack }) {
  const [token, setToken] = useState("");
  const [event, setEvent] = useState(null);

  // Join/Joined toggle
  const [mode, setMode] = useState("join"); // "join" | "joined"

  // RSVP state (only meaningful when an event is selected)
  const [rsvp, setRsvp] = useState(""); // "going" | "maybe" | "declined"
  const [rsvpLoading, setRsvpLoading] = useState(false);

  // Joined events list
  const [joinedItems, setJoinedItems] = useState([]); // [{ event, rsvp, joinedAt }]
  const [joinedLoading, setJoinedLoading] = useState(false);

  // status state should carry a "kind"
  const [status, setStatus] = useState("");
  const [statusKind, setStatusKind] = useState("info"); // "info" | "success" | "error"

  const [loading, setLoading] = useState(false);

  // Safe formatting wrapper so the view never blows up
  const safeEventTime = (ev) => {
    try {
      if (!ev?.startDate) return "";
      return formatEventTime(ev);
    } catch {
      return "";
    }
  };

  const reset = () => {
    setToken("");
    setEvent(null);
    setRsvp("");
    setStatus("");
    setStatusKind("info");
    setLoading(false);
    setRsvpLoading(false);
    // Keep mode as-is; user might be browsing Joined.
  };

  // Load joined events when switching to Joined mode
  const loadJoined = async () => {
    try {
      setJoinedLoading(true);
      const data = await apiCall("/eventShare/joined/list");
      const items = Array.isArray(data?.items) ? data.items : [];
      setJoinedItems(items);
    } catch (e) {
      setJoinedItems([]);
      setStatusKind("error");
      setStatus(e?.message || "Failed to load joined events.");
    } finally {
      setJoinedLoading(false);
    }
  };

  useEffect(() => {
    if (mode === "joined") {
      loadJoined();
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [mode]);

  const join = async () => {
    const code = token.trim();
    if (!code) return;

    try {
      setLoading(true);
      setStatus("");
      setStatusKind("info");

      const data = await apiCall("/eventShare/join", {
        method: "POST",
        body: JSON.stringify({ token: code }),
      });

      // Be defensive about the shape coming back
      const joinedEvent = data?.event || null;

      if (!joinedEvent) {
        setEvent(null);
        setStatusKind("error");
        setStatus("Joined, but the server did not return an event payload.");
        return;
      }

      setEvent(joinedEvent);

      // If your join route returns rsvp, capture it; otherwise default.
      setRsvp(String(data?.rsvp || "going"));

      setStatusKind("success");
      setStatus("Joined event successfully.");
    } catch (e) {
      setEvent(null);
      setStatusKind("error");
      setStatus(e?.message || "Invalid or expired code.");
    } finally {
      setLoading(false);
    }
  };

  const updateRsvp = async (next) => {
    if (!event?.id) return;

    try {
      setRsvpLoading(true);
      setStatus("");
      setStatusKind("info");

      await apiCall(`/eventShare/${event.id}/rsvp`, {
        method: "POST",
        body: JSON.stringify({ rsvp: next }),
      });

      setRsvp(next);
      setStatusKind("success");
      setStatus("RSVP updated.");
    } catch (e) {
      setStatusKind("error");
      setStatus(e?.message || "Failed to update RSVP.");
    } finally {
      setRsvpLoading(false);
    }
  };

  // Helper: when you click an item in Joined list, open it in the detail view
  const openFromJoined = (item) => {
    const ev = item?.event || null;
    if (!ev) return;
    setEvent(ev);
    setRsvp(String(item?.rsvp || "going"));
    setMode("join"); // reuse the detail card on the Join tab
    setStatus("");
    setStatusKind("info");
  };

  return (
    <div className="event-share-wrap">
      <div className="header">
        <h1>Shared Event</h1>

        <div className="journal-header-actions">
          <button className="btn btn-secondary" onClick={onBack} type="button">
            Back
          </button>
        </div>
      </div>

      {/* Mode Toggle (always visible) */}
      <div className="event-share-actions" style={{ marginBottom: 12 }}>
        <button
          className={`btn ${mode === "join" ? "btn-primary" : "btn-secondary"}`}
          onClick={() => {
            setMode("join");
            setStatus("");
            setStatusKind("info");
          }}
          type="button"
        >
          Join
        </button>

        <button
          className={`btn ${mode === "joined" ? "btn-primary" : "btn-secondary"}`}
          onClick={() => {
            setMode("joined");
            setEvent(null); // hide detail card while browsing list
            setStatus("");
            setStatusKind("info");
          }}
          type="button"
        >
          Joined
        </button>
      </div>

      {/* JOIN MODE */}
      {mode === "join" && !event && (
        <div className="event-share-card">
          <label className="form-label">Enter Share Code</label>
          <input
            className="form-input event-share-input"
            value={token}
            onChange={(e) => setToken(e.target.value)}
            placeholder="Paste event codeâ€¦"
            autoCapitalize="none"
            autoCorrect="off"
            spellCheck={false}
          />

          <div className="event-share-actions">
            <button
              className="btn btn-primary"
              onClick={join}
              disabled={loading || !token.trim()}
              type="button"
            >
              {loading ? "Joiningâ€¦" : "Join Event"}
            </button>

            <button
              className="btn btn-secondary"
              onClick={reset}
              disabled={loading && !status}
              type="button"
            >
              Clear
            </button>
          </div>

          {loading && (
            <div className="loading" style={{ padding: "18px 0 0" }}>
              <div className="spinner" />
              <div>Checking codeâ€¦</div>
            </div>
          )}

          {!loading && status && (
            <div className={`event-share-status ${statusKind}`}>
              {status}
            </div>
          )}
        </div>
      )}

      {/* EVENT DETAIL (Join mode) */}
      {mode === "join" && event && (
        <div className="event-share-card">
          <div className="event-share-title">{event.title || "(untitled event)"}</div>

          {safeEventTime(event) && (
            <div className="event-share-meta">{safeEventTime(event)}</div>
          )}

          {event.description && (
            <div className="event-share-desc">{event.description}</div>
          )}

          {event.location && (
            <div className="event-share-meta">
              <img
                src="/icons/location.svg"
                alt=""
                style={{
                  width: 14,
                  height: 14,
                  verticalAlign: "-0.12em",
                  marginRight: 8,
                  opacity: 0.85,
                }}
              />
              {event.location}
            </div>
          )}

          <div className="event-share-status success">Youâ€™ve joined this event.</div>

          {/* RSVP BUTTONS */}
          <div className="event-share-actions" style={{ marginTop: 12 }}>
            <button
              className={`btn ${rsvp === "going" ? "btn-success" : "btn-secondary"}`}
              type="button"
              disabled={rsvpLoading}
              onClick={() => updateRsvp("going")}
            >
              Going
            </button>

            <button
              className={`btn ${rsvp === "maybe" ? "btn-primary" : "btn-secondary"}`}
              type="button"
              disabled={rsvpLoading}
              onClick={() => updateRsvp("maybe")}
            >
              Maybe
            </button>

            <button
              className={`btn ${rsvp === "declined" ? "btn-danger" : "btn-secondary"}`}
              type="button"
              disabled={rsvpLoading}
              onClick={() => updateRsvp("declined")}
            >
              Not going
            </button>
          </div>

          {/* RSVP status feedback */}
          {!rsvpLoading && status && (
            <div className={`event-share-status ${statusKind}`} style={{ marginTop: 12 }}>
              {status}
            </div>
          )}

          <div className="event-share-actions" style={{ marginTop: 12 }}>
            <button className="btn btn-secondary" onClick={reset} type="button">
              Join another
            </button>
          </div>
        </div>
      )}

      {/* JOINED MODE (LIST) */}
      {mode === "joined" && (
        <div className="event-share-card">
          <div className="event-share-title">Joined events</div>

          {joinedLoading && (
            <div className="loading" style={{ padding: "18px 0 0" }}>
              <div className="spinner" />
              <div>Loading joined eventsâ€¦</div>
            </div>
          )}

          {!joinedLoading && joinedItems.length === 0 && (
            <div className="event-share-desc" style={{ marginTop: 10 }}>
              No joined events yet.
            </div>
          )}

          {!joinedLoading && joinedItems.length > 0 && (
            <div style={{ marginTop: 12, display: "grid", gap: 10 }}>
              {joinedItems.map((it) => (
                <button
                  key={it.event?.id || Math.random()}
                  type="button"
                  className="btn btn-secondary"
                  style={{ textAlign: "left", padding: 12, width: "100%" }}
                  onClick={() => openFromJoined(it)}
                >
                  <div style={{ fontWeight: 800, marginBottom: 6 }}>
                    {it.event?.title || "(untitled event)"}
                  </div>
                  <div style={{ opacity: 0.9, fontSize: 13 }}>
                    {safeEventTime(it.event)}
                  </div>
                  <div style={{ opacity: 0.85, fontSize: 13, marginTop: 6 }}>
                    RSVP: {it.rsvp || "going"}
                  </div>
                </button>
              ))}
            </div>
          )}

          {!joinedLoading && (
            <div className="event-share-actions" style={{ marginTop: 12 }}>
              <button className="btn btn-secondary" onClick={loadJoined} type="button">
                Refresh
              </button>
            </div>
          )}
        </div>
      )}
    </div>
  );
}

// SHARE CODE MODAL
function ShareCodeModal({ onClose, token }) {
  useEffect(() => {
    document.body.classList.add("modal-open");
    return () => document.body.classList.remove("modal-open");
  }, []);

  const copy = async () => {
    try {
      if (!token) return;

      // Prefer clipboard
      if (navigator.clipboard?.writeText) {
        await navigator.clipboard.writeText(token);
      } else {
        // Fallback for older WebViews
        const ta = document.createElement("textarea");
        ta.value = token;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
      }

      tg.showPopup({ message: "Share code copied" });
    } catch (e) {
      tg.showAlert("Could not copy. Please press and hold to copy.");
    }
  };

  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal" onClick={(e) => e.stopPropagation()}>
        <div className="modal-header">
          <h2>Share Code</h2>
          <button className="modal-close" onClick={onClose} type="button">Ã—</button>
        </div>

        <div className="modal-body">
          <div className="share-code-box">
            <div className="share-code-label">Code</div>
            <div className="share-code-token">{token || ""}</div>
            <div className="share-code-help">
              Send this code to someone. They can open the Calendar and tap the link icon to join.
            </div>
          </div>
        </div>

        <div className="modal-actions">
          <button className="btn btn-secondary" onClick={onClose} type="button">
            Close
          </button>
          <button className="btn btn-primary" onClick={copy} type="button" disabled={!token}>
            Copy
          </button>
        </div>
      </div>
    </div>
  );
}

    // Main App Component
function App() {
  // --------------------
  // VIEW STATE
  // --------------------
  const [activeView, setActiveView] = useState("reminders");
  const [previousView, setPreviousView] = useState("reminders");
  const [journalTagFilter, setJournalTagFilter] = useState("");

  // --------------------
  // USER SETTINGS STATE (NEW)
  // --------------------
  const [userTimezone, setUserTimezone] = useState("America/Chicago");
  
  // ---------------------
  // DISPLAY NAME STATE
  // ---------------------
  const [userDisplayName, setUserDisplayName] = useState("");


  // --------------------
  // LOAD USER SETTINGS (NEW)
  // --------------------
  useEffect(() => {
    (async () => {
      try {
        const data = await apiCall("/settings");
        if (data?.settings?.timezone) {
  setUserTimezone(String(data.settings.timezone));
}

if (data?.settings?.displayName !== undefined) {
  setUserDisplayName(String(data.settings.displayName || ""));
}
      } catch (e) {
        // intentionally silent â€“ app still works with default
      }
    })();
  }, []);

  // --------------------
  // NAVIGATION HELPERS
  // --------------------
  function goTo(view) {
    setPreviousView(activeView);
    setActiveView(view);
  }

  function goBack() {
    setActiveView(previousView || "reminders");
  }
  
  function openHabitsFromReminders() {
  goTo("habits");
}

function openHoroscope() {
  goTo("horoscope");
}
  
  function openJournalTag(tag) {
  const clean = String(tag || "").trim().toLowerCase().replace(/^#/, "");
  if (!clean) return;
  setJournalTagFilter(clean);
  setPreviousView(activeView);
  setActiveView("journal");
}

function clearJournalTag() {
  setJournalTagFilter("");
}

      const remindersViewRef = useRef(null);
      const calendarViewRef = useRef(null);

const handleFabClick = () => {
if (activeView === 'reminders') {
  const btn = document.querySelector('[data-create-reminder="1"]');
  if (btn) btn.click();
}

else if (activeView === 'habits') {
  const btn =
document.querySelector('[data-create-habit="1"]');
  if (btn) btn.click();
} 

else if (activeView === 'checklist') {
    const btn = document.querySelector('[data-create-checklist="1"]');
    if (btn) btn.click();
}

else if (activeView === 'calendar') {
  const btn = document.querySelector('[data-create-event="1"]');
  if (btn) btn.click();
}

  else if (activeView === 'journal') {
    const btn = document.querySelector('[data-create-journal="1"]');
    if (btn) btn.click();
  }
  else if (activeView === 'reading') {
  const btn = document.querySelector('[data-create-book="1"]');
  if (btn) btn.click();
}
};

return (
  <div className="app-shell">
    <div className="app-content">
      <div
        className={`view-container ${activeView === 'reminders' ? 'active' : ''}`}
        data-view="reminders"
      >
        <RemindersView
  activeView={activeView}
  userTimezone={userTimezone}
  userDisplayName={userDisplayName}
  onOpenHabits={openHabitsFromReminders}
  goTo={goTo}
/>

      </div>
      
      <div
  className={`view-container ${activeView === 'habits' ? 'active' : ''}`}
  data-view="habits"
>
  <HabitsView
    activeView={activeView}
    userTimezone={userTimezone}
    userDisplayName={userDisplayName}
    onBack={goBack}
  />
</div>

   <div
     className={`view-container ${activeView === 'mood' ? 'active' : ''}`}
     data-view="mood"
   >
     <MoodView
       activeView={activeView}
       userDisplayName={userDisplayName}
       onBack={goBack}
     />
   </div>

<div
  className={`view-container ${activeView === 'checklist' ? 'active' : ''}`}
  data-view="checklist"
>
  <ChecklistView
    activeView={activeView}
    userDisplayName={userDisplayName}
    onBack={goBack}
  />
</div>

      <div
        className={`view-container ${activeView === 'calendar' ? 'active' : ''}`}
        data-view="calendar"
      >
        <CalendarView
  onOpenSettings={() => goTo("settings")}
  onOpenEventShare={() => goTo("event_share")}
  userTimezone={userTimezone}
/>
      </div>
      
      <div
  className={`view-container ${activeView === 'event_share' ? 'active' : ''}`}
  data-view="event_share"
>
  <EventShareView onBack={goBack} />
</div>

      <div
        className={`view-container ${activeView === 'journal' ? 'active' : ''}`}
        data-view="journal"
      >
        <JournalsView
  activeView={activeView}
  tagFilter={journalTagFilter}
  onOpenTags={() => goTo("journal_tags")}
  onClearTag={() => setJournalTagFilter("")}
  onTagSelect={openJournalTag}
  onOpenHoroscope={openHoroscope}
/>
      </div>
      
      <div
  className={`view-container ${activeView === 'journal_tags' ? 'active' : ''}`}
  data-view="journal_tags"
>
  <JournalTagsView
    onBack={goBack}
    onPickTag={(tag) => {
      setJournalTagFilter(tag);
      goTo("journal");
    }}
  />
</div>

    <div
  className={`view-container ${activeView === 'horoscope' ? 'active' : ''}`}
  data-view="horoscope"
>
  <HoroscopeView onBack={goBack} activeView={activeView} />
</div>
      
      <div
  className={`view-container ${activeView === 'reading' ? 'active' : ''}`}
  data-view="reading"
>
  <ReadingView activeView={activeView} />
</div>

<div
  className={`view-container ${activeView === 'settings' ? 'active' : ''}`}
  data-view="settings"
>
  <SettingsView onBack={goBack} />
</div>
    </div>

    <button className="fab" onClick={handleFabClick}>
      +
    </button>

    <div className="bottom-nav">
  <button
    className={`nav-item ${activeView === 'reminders' ? 'active' : ''}`}
    onClick={() => goTo('reminders')}
  >
    <div className="nav-item-icon"><img src="/icons/bell.svg" alt="" /></div>
    <div className="nav-item-label">Reminders</div>
  </button>

  <button
    className={`nav-item ${activeView === 'calendar' ? 'active' : ''}`}
    onClick={() => goTo('calendar')}
  >
    <div className="nav-item-icon"><img src="/icons/calendar.svg" alt="" /></div>
    <div className="nav-item-label">Calendar</div>
  </button>

  <button
    className={`nav-item ${activeView === 'journal' ? 'active' : ''}`}
    onClick={() => goTo('journal')}
  >
    <div className="nav-item-icon"><img src="/icons/page.svg" alt="" /></div>
    <div className="nav-item-label">Journal</div>
  </button>

  <button
    className={`nav-item ${activeView === 'reading' ? 'active' : ''}`}
    onClick={() => goTo('reading')}
  >
    <div className="nav-item-icon"><img src="/icons/book.svg" alt="" /></div>
    <div className="nav-item-label">Reading</div>
  </button>
</div>
  </div>
);
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
