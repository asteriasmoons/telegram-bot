<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reminder Manager</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    body {
      font-family: -apple-system, system-ui, Segoe UI, Roboto, Arial, sans-serif;
      margin: 16px;
      background: #0b0b0f;
      color: #f3f3f7;
    }

    h1 {
      margin: 0 0 6px 0;
      font-size: 26px;
    }

    .muted {
      color: #a8a8bf;
      font-size: 13px;
    }

    .card {
      border: 1px solid #2a2a34;
      background: #12121a;
      border-radius: 14px;
      padding: 14px;
      margin: 12px 0;
    }

    .row {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
    }

    .btn {
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #3a3a46;
      background: #1a1a24;
      color: #f3f3f7;
      font-size: 14px;
    }

    .btn:disabled {
      opacity: 0.6;
    }

    .pill {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #2a2a34;
      color: #cfcfe6;
      font-size: 12px;
    }

    .list {
      margin-top: 10px;
    }

    .rem-card {
      padding: 12px;
    }

    .rem-title {
      font-size: 15px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .rem-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 10px;
    }

    .rem-text {
      white-space: pre-wrap;
      word-break: break-word;
      line-height: 1.35;
      font-size: 14px;
    }

    .empty {
      border: 1px dashed #2a2a34;
      color: #a8a8bf;
      border-radius: 14px;
      padding: 14px;
      margin: 12px 0;
    }
  </style>
</head>

<body>
  <h1>Reminder Manager</h1>
  <div class="muted">Your scheduled reminders.</div>

  <!-- Status -->
  <div class="card">
    <div class="row">
      <div>
        <div style="font-weight:700;">Status</div>
        <div id="status" class="muted">Connecting…</div>
      </div>
      <button id="authBtn" class="btn">Authenticate</button>
    </div>
  </div>

  <!-- Reminders -->
  <div class="card">
    <div class="row" style="align-items:flex-start;">
      <div>
        <div style="font-weight:700;">Your reminders</div>
        <div id="sub" class="muted">Authenticate to load your reminders.</div>
      </div>
      <button id="reloadBtn" class="btn" disabled>Reload</button>
    </div>

    <div id="list" class="list"></div>
  </div>

<script>
  const tg = window.Telegram?.WebApp ?? null;

  const statusEl = document.getElementById("status");
  const subEl = document.getElementById("sub");
  const listEl = document.getElementById("list");
  const authBtn = document.getElementById("authBtn");
  const reloadBtn = document.getElementById("reloadBtn");

  let jwtToken = null;

  function setStatus(text) {
    statusEl.textContent = text;
  }

  function escapeHtml(str) {
    return String(str)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function fmtWhen(iso) {
    if (!iso) return "No time set";
    const d = new Date(iso);
    return d.toLocaleString(undefined, {
      weekday: "short",
      month: "short",
      day: "numeric",
      hour: "2-digit",
      minute: "2-digit"
    });
  }

  function fmtFrequency(schedule) {
    if (!schedule) return "Once";
    if (schedule.kind === "daily") return "Daily";
    if (schedule.kind === "weekly") return "Weekly";
    if (schedule.kind === "interval") return `Every ${schedule.intervalMinutes} min`;
    return "Once";
  }

  function renderEmpty(text) {
    listEl.innerHTML = `<div class="empty">${escapeHtml(text)}</div>`;
  }

  function renderReminders(reminders) {
    if (!reminders.length) {
      renderEmpty("No scheduled reminders found.");
      return;
    }

    listEl.innerHTML = reminders.map(r => {
      const title = r.text?.split("\n")[0] || "Reminder";
      return `
        <div class="card rem-card">
          <div class="rem-title">${escapeHtml(title)}</div>
          <div class="rem-meta">
            <span class="pill">${fmtWhen(r.nextRunAt)}</span>
            <span class="pill">${fmtFrequency(r.schedule)}</span>
            <span class="pill">${escapeHtml(r.status)}</span>
            <span class="pill">${escapeHtml(r.timezone)}</span>
          </div>
          <div class="rem-text">${escapeHtml(r.text)}</div>
        </div>
      `;
    }).join("");
  }

  async function authenticate() {
    const res = await fetch("/miniapp/auth", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ initData: tg.initData })
    });

    const data = await res.json();
    if (!res.ok || !data.token) throw new Error("Auth failed");
    return data.token;
  }

  async function loadReminders() {
    const res = await fetch("/api/reminders", {
      headers: { Authorization: "Bearer " + jwtToken }
    });

    const data = await res.json();
    if (!res.ok || !data.ok) throw new Error("Load failed");
    return data.reminders;
  }

  async function load() {
    subEl.textContent = "Loading…";
    reloadBtn.disabled = true;

    try {
      const reminders = await loadReminders();
      renderReminders(reminders);
      subEl.textContent = `Loaded ${reminders.length} reminder(s).`;
    } catch {
      renderEmpty("Could not load reminders.");
      subEl.textContent = "Load failed.";
    } finally {
      reloadBtn.disabled = false;
    }
  }

  // Initial state
  if (!tg) {
    setStatus("Open this from Telegram.");
  } else {
    tg.ready();
    setStatus("Connected to Telegram.");
  }

  authBtn.addEventListener("click", async () => {
    authBtn.disabled = true;
    try {
      jwtToken = await authenticate();
      setStatus("Authenticated.");
      reloadBtn.disabled = false;
      await load();
    } catch {
      setStatus("Connected to Telegram.");
      renderEmpty("Authentication failed. Try again.");
    } finally {
      authBtn.disabled = false;
    }
  });

  reloadBtn.addEventListener("click", load);

  renderEmpty("Authenticate to load your reminders.");
</script>
</body>
</html>