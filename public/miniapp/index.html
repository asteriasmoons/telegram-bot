<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Lystaria</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/luxon@3/build/global/luxon.min.js"></script>

  <!-- Paste your FULL CSS here (the styles block we separated out) -->
  <style>
    * {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

:root {
  --bg-color: #0a0a0a;
  --card-bg: #1a1a1a;
  --text-primary: #ffffff;
  --text-secondary: #888888;
  --accent: #5b8def;
  --accent-hover: #4a7bd8;
  --success: #4caf50;
  --danger: #f44336;
  --warning: #ff9800;
  --border: rgba(255,255,255,0.16);
  --shadow: rgba(0, 0, 0, 0.3);
  
  /* Telegram viewport height (will be set by JS) */
  --tg-viewport-height: 100vh;
  --gradient-blue: linear-gradient(135deg, #5b8def 0%, #8b7def 100%);
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
  background: var(--bg-color);
  color: var(--text-primary);
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
}

html, body {
  height: 100%;
}

body {
  overflow: hidden; /* prevent the page from trying to scroll the whole viewport */
}

#root {
  height: 100%;
  min-height: 0; /* important: don't force viewport height */
  padding-bottom: calc(96px + env(safe-area-inset-bottom));
}

.app-shell {
  height: 100%;
  display: flex;
  flex-direction: column;
}

.app-content {
  flex: 1;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding-bottom: calc(96px + env(safe-area-inset-bottom));
}

/* Bottom Navigation */
.bottom-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: var(--card-bg);
  border-top: 1px solid var(--border);
  display: flex;
  justify-content: space-around;
  padding: 12px 0 calc(12px + env(safe-area-inset-bottom));
  z-index: 1000;
}

.nav-item {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  cursor: pointer;
  padding: 8px;
  color: var(--text-secondary);
  transition: all 0.2s;
  border: none;
  background: none;
}

.nav-item.active {
  color: var(--accent);
}

.nav-item-icon {
  font-size: 24px;
}

.nav-item-label {
  font-size: 11px;
  font-weight: 600;
}

/* View Container */
.view-container {
  display: none;
  animation: fadeIn 0.3s;
}

.view-container.active {
  display: block;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

/* Header */
.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
  padding: 16px;
  padding-bottom: 16px;
  border-bottom: 1px solid var(--border);
}

.header h1 {
  font-size: 28px;
  font-weight: 700;
  background: linear-gradient(135deg, #e019d4 0%, #8000fe 50%, #00dbff 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.toggle {
  display: flex;
  gap: 8px;
  align-items: center;
  font-size: 14px;
  color: var(--text-secondary);
  cursor: pointer;
  user-select: none;
}

.toggle-switch {
  width: 44px;
  height: 24px;
  background: var(--border);
  border-radius: 12px;
  position: relative;
  transition: background 0.2s;
}

.toggle-switch.active {
  background: var(--accent);
}

.toggle-switch::after {
  content: '';
  position: absolute;
  width: 18px;
  height: 18px;
  background: white;
  border-radius: 50%;
  top: 3px;
  left: 3px;
  transition: left 0.2s;
}

.toggle-switch.active::after {
  left: 23px;
}

/* Cards */
.card {
  background: var(--card-bg);
  border-radius: 16px;
  padding: 20px;
  margin: 0 16px 12px;
  border: 1px solid var(--border);
  transition: all 0.2s;
  cursor: pointer;
}

.card:hover {
  border-color: var(--accent);
  transform: translateY(-2px);
  box-shadow: 0 8px 16px var(--shadow);
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 12px;
}

.card-time {
  font-size: 13px;
  color: var(--text-secondary);
  display: flex;
  align-items: center;
  gap: 6px;
}

.card-badge {
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
}

/* ONCE -- Blue */
.badge-once {
  background: rgba(59, 130, 246, 0.18);
  color: #3b82f6;
}

/* DAILY -- Purple */
.badge-daily {
  background: rgba(168, 85, 247, 0.18);
  color: #a855f7;
}

/* WEEKLY -- White */
.badge-weekly {
  background: rgba(255, 255, 255, 0.25);
  color: #ffffff;
  border: 1px solid rgba(255, 255, 255, 0.35);
}

/* MONTHLY -- Pink */
.badge-monthly {
  background: rgba(236, 72, 153, 0.18);
  color: #ec4899;
}

/* INTERVAL -- Yellow */
.badge-interval {
  background: rgba(234, 179, 8, 0.22); /* slightly higher alpha for readability */
  color: #eab308;
}

.card-text {
  font-size: 15px;
  line-height: 1.5;
  margin-bottom: 16px;
  color: var(--text-primary);
  white-space: pre-line;
  word-break: break-word;
}

.card-actions {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

/* =========================
   HABITS VIEW (matches Habit.ts + HabitLog.ts)
   ========================= */

.habits-header-actions {
  display: flex;
  align-items: center;
  gap: 10px;
}

.habit-title {
  font-size: 16px;
  font-weight: 800;
  margin-bottom: 6px;
}

.habit-sub {
  color: var(--text-secondary);
  font-size: 13px;
  line-height: 1.35;
}

.habit-meta-row {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
  margin-top: 10px;
}

.badge-habit-daily {
  background: rgba(91, 141, 239, 0.15);
  color: #5b8def;
}
.badge-habit-weekly {
  background: rgba(233, 160, 72, 0.18);
  color: #e9a048;
}
.badge-habit-active {
  background: rgba(76, 175, 80, 0.15);
  color: #4caf50;
}
.badge-habit-paused {
  background: rgba(244, 67, 54, 0.12);
  color: #f44336;
}

.habit-target {
  margin-top: 10px;
  color: var(--text-secondary);
  font-size: 13px;
}

.habit-actions {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-top: 12px;
}

.habit-actions .btn {
  flex: 1;
  justify-content: center;
  min-width: 140px;
}

/* Times list inside modal */
.times-list {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.times-item {
  display: flex;
  gap: 10px;
  align-items: center;
}

.times-item input[type="time"] {
  flex: 1;
}

.times-item .btn {
  width: auto;
  min-width: unset;
  flex: 0;
}

/* Logs list */
.logs-list {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.log-row {
  display: flex;
  flex-direction: column;
  gap: 8px;
  padding: 12px;
  border-radius: 14px;
  background: rgba(255, 255, 255, 0.06);
  border: 1px solid rgba(255, 255, 255, 0.08);
}

.log-top {
  display: flex;
  justify-content: space-between;
  gap: 10px;
  flex-wrap: wrap;
  align-items: baseline;
}

.log-amount {
  font-weight: 800;
  color: var(--text-primary);
}

.log-time {
  color: var(--text-secondary);
  font-size: 12px;
}

.log-actions {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.log-actions .btn {
  flex: 1;
  justify-content: center;
  min-width: 120px;
}

.form-help {
  color: var(--text-secondary);
  font-size: 12px;
  line-height: 1.35;
  margin-top: 8px;
}

.modal-divider {
  height: 1px;
  background: rgba(255, 255, 255, 0.08);
  margin: 14px 0;
}

/* -------- Reading Progress -------- */
.progress-wrap {
  margin-top: 14px;
  margin-bottom: 14px;
}

.progress-top {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  gap: 12px;
  margin-bottom: 8px;
  color: var(--text-secondary);
  font-size: 13px;
}

.progress-pct {
  color: var(--text-primary);
  font-weight: 700;
  font-size: 13px;
}

.progress-bar {
  width: 100%;
  height: 10px;
  background: rgba(255, 255, 255, 0.08);
  border: 1px solid var(--border);
  border-radius: 999px;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  width: 0%;
  background: linear-gradient(135deg, #5b8def 0%, #8b7def 100%);
  border-radius: 999px;
  transition: width 0.2s ease;
}

.book-summary {
  font-size: 13.5px;
  line-height: 1.45;
  color: var(--text-secondary);
  margin: 10px 0 12px;
  display: -webkit-box;
  -webkit-line-clamp: 4;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

/* Buttons */
.btn {
  padding: 8px 16px;
  border-radius: 8px;
  border: none;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 6px;
}

.btn-primary {
  background: var(--accent);
  color: white;
}

.btn-primary:hover {
  background: var(--accent-hover);
}

.btn-success {
  background: var(--success);
  color: white;
}

.btn-danger {
  background: var(--danger);
  color: white;
}

.btn-secondary {
  background: rgba(255, 255, 255, 0.1);
  color: var(--text-primary);
}

.btn-secondary:hover {
  background: rgba(255, 255, 255, 0.15);
}

.btn:active {
  transform: scale(0.95);
}

/* -------- Reading Streak Card -------- */
.streak-row {
  display: flex;
  gap: 12px;
  margin-top: 12px;
  flex-wrap: wrap;
}

.streak-stat {
  flex: 1;
  min-width: 140px;
  padding: 12px;
  border-radius: 14px;
  background: rgba(255, 255, 255, 0.04);
  border: 1px solid var(--border);
}

.streak-stat-label {
  font-size: 12px;
  color: var(--text-secondary);
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.4px;
  margin-bottom: 6px;
}

.streak-stat-value {
  font-size: 22px;
  font-weight: 800;
  color: var(--text-primary);
}

.streak-actions {
  margin-top: 14px;
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

/* --- Badge icon support (Reading books status badge) --- */
.card-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
}

/* Only affects icons inside the badge */
.card-badge .badge-icon {
  width: 12px;
  height: 12px;
  object-fit: contain;
  opacity: 0.95;
  vertical-align: -0.12em;
}

/* -------- Reading Streak Button (ONLY) -------- */
.streak-actions .btn.btn-success {
  background: var(--gradient-blue);
  color: #fff;
  border: 1px solid rgba(91, 141, 239, 0.45);
  box-shadow: 0 6px 16px rgba(91, 141, 239, 0.22);
}

.streak-actions .btn.btn-success:hover {
  filter: brightness(1.08);
}

.streak-actions .btn.btn-success:active {
  transform: scale(0.96);
  filter: brightness(0.95);
}

/* Disabled (when checked in or loading) */
.streak-actions .btn.btn-success:disabled {
  opacity: 0.55;
  cursor: not-allowed;
  filter: none;
  transform: none;
  box-shadow: none;
}

/* FAB */
.fab {
  position: fixed;
  bottom: calc(96px + env(safe-area-inset-bottom));
  right: 24px;
  width: 56px;
  height: 56px;
  border-radius: 50%;
  background: linear-gradient(135deg, #5b8def 0%, #8b7def 100%);
  border: none;
  color: white;
  font-size: 24px;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(91, 141, 239, 0.4);
  transition: all 0.2s;
  z-index: 999;
}

.fab:hover {
  transform: scale(1.1);
  box-shadow: 0 6px 20px rgba(91, 141, 239, 0.6);
}

.fab:active {
  transform: scale(0.95);
}

/* Modal */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 2000;
  animation: fadeIn 0.2s;
}

.modal {
  background: var(--card-bg);
  border-radius: 20px;
  padding: 24px;
  width: 90%;
  max-width: 500px;
  max-height: 80vh;
  overflow-y: auto;
  border: 1px solid var(--border);
  animation: slideUp 0.3s;
  display: flex;
  flex-direction: column;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
  flex-shrink: 0;
}

.modal-body {
  flex: 1;
  overflow-y: auto;
  min-height: 0;
}

/* Prevent background scroll when modal is open */
/* Prevent background scroll when modal is open */
body.modal-open {
  overflow: hidden !important;
  position: fixed !important;
  width: 100% !important;
  height: 100% !important;
  top: 0;
  left: 0;
}

body.modal-open .app-content {
  overflow: hidden !important;
}



.modal-actions {
  display: flex;
  gap: 12px;
  margin-top: 24px;
  flex-shrink: 0;
}


@keyframes slideUp {
  from {
    transform: translateY(100px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

.modal-header h2 {
  font-size: 24px;
  font-weight: 700;
}

.modal-close {
  background: none;
  border: none;
  color: var(--text-secondary);
  font-size: 24px;
  cursor: pointer;
  padding: 0;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: all 0.2s;
}

.modal-close:hover {
  background: rgba(255, 255, 255, 0.1);
}

/* Forms */
.form-group {
  margin-bottom: 20px;
}

.form-label {
  display: block;
  font-size: 13px;
  font-weight: 600;
  color: var(--text-secondary);
  margin-bottom: 8px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.form-input,
.form-textarea {
  width: 100%;
  padding: 12px 16px;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid var(--border);
  border-radius: 12px;
  color: var(--text-primary);
  font-size: 15px;
  transition: all 0.2s;
}

.form-input:focus,
.form-textarea:focus {
  outline: none;
  border-color: var(--accent);
  background: rgba(255, 255, 255, 0.08);
}

.form-textarea {
  resize: vertical;
  min-height: 100px;
  font-family: inherit;
}

.form-textarea.form-textarea--sm {
  min-height: 80px;
}

.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

.form-select {
  width: 100%;
  padding: 12px 16px;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid var(--border);
  border-radius: 12px;
  color: var(--text-primary);
  font-size: 15px;
  cursor: pointer;
  transition: all 0.2s;
}

.form-select:focus {
  outline: none;
  border-color: var(--accent);
  background: rgba(255, 255, 255, 0.08);
}

.modal-actions .btn {
  flex: 1;
  justify-content: center;
  padding: 12px;
}

/* ---- iOS time/date input normalization ---- */
input[type="time"].form-input,
input[type="date"].form-input {
  -webkit-appearance: none;
  appearance: none;
  height: 44px;          /* forces consistent vertical alignment */
  line-height: 44px;
  padding-top: 0;
  padding-bottom: 0;
}

/* Center the displayed value inside iOS time/date controls */
input[type="time"].form-input::-webkit-date-and-time-value,
input[type="date"].form-input::-webkit-date-and-time-value {
  height: 44px;
  line-height: 44px;
}

/* Optional: reduces weird internal offsets on some iOS versions */
input[type="time"].form-input::-webkit-datetime-edit,
input[type="date"].form-input::-webkit-datetime-edit {
  padding: 0;
}

/* Checkbox row (moved from inline styles) */
.checkbox-row {
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
}

/* Empty state */
.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--text-secondary);
}

.empty-state-icon {
  font-size: 64px;
  margin-bottom: 16px;
  opacity: 0.3;
}

.empty-state-text {
  font-size: 16px;
  line-height: 1.6;
}

/* Loading */
.loading {
  text-align: center;
  padding: 40px;
  color: var(--text-secondary);
}

.spinner {
  width: 40px;
  height: 40px;
  border: 3px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin: 0 auto 16px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.reminders-greeting {
  margin-top: 6px;
  font-size: 14px;
  opacity: 0.75;
  letter-spacing: 0.2px;
}

/* Quick actions */
.quick-actions {
  display: flex;
  gap: 8px;
  margin: 0 16px 24px;
  overflow-x: auto;
  padding-bottom: 8px;
}

.quick-action {
  padding: 10px 20px;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid var(--border);
  border-radius: 20px;
  color: var(--text-primary);
  font-size: 13px;
  font-weight: 600;
  white-space: nowrap;
  cursor: pointer;
  transition: all 0.2s;
}

.quick-action:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: var(--accent);
}

.quick-action.active {
  background: var(--accent);
  border-color: var(--accent);
}

/* Calendar Header */
.calendar-header {
  padding: 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid var(--border);
}

.calendar-month {
  font-size: 24px;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 12px;
}

.calendar-nav-btn {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid var(--border);
  border-radius: 8px;
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  color: var(--text-primary);
  font-size: 18px;
  transition: all 0.2s;
}

.calendar-nav-btn:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: var(--accent);
}

/* -------- Calendar View (moved from inline styles) -------- */

.calendar-body {
  padding: 16px;
}

.calendar-day {
  margin-bottom: 16px;
}

.calendar-day-row {
  display: flex;
  align-items: flex-start;
  gap: 16px;
}

.calendar-datebox {
  min-width: 60px;
  text-align: center;
}

.calendar-datebox-day {
  font-size: 28px;
  font-weight: 700;
  color: #fff;
  line-height: 1;
}

.calendar-datebox-day.is-today {
  color: #5b8def;
}

.calendar-datebox-dow {
  font-size: 12px;
  color: #888;
  text-transform: uppercase;
  margin-top: 4px;
}

.calendar-events {
  flex: 1;
}

.calendar-no-events {
  background: var(--card-bg);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 16px;
  color: var(--text-secondary);
  font-size: 14px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.calendar-add-icon-btn {
  background: rgba(91, 141, 239, 0.15);
  border: none;
  border-radius: 8px;
  width: 32px;
  height: 32px;
  color: #5b8def;
  font-size: 20px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.calendar-event {
  background: var(--card-bg);
  border: 1px solid var(--border);
  border-left: 4px solid #5b8def;
  border-radius: 12px;
  padding: 12px 16px;
  margin-bottom: 8px;
  cursor: pointer;
  transition: all 0.2s;
}

.calendar-event:hover {
  background: rgba(255, 255, 255, 0.05);
}

.calendar-event-top {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
}

.calendar-event-main {
  flex: 1;
}

.calendar-event-allday {
  display: inline-flex;
  align-items: center;
  background: rgba(76, 175, 80, 0.15);
  color: #4caf50;
  font-size: 11px;
  font-weight: 600;
  padding: 2px 8px;
  border-radius: 6px;
  margin-bottom: 4px;
}

.calendar-event-title {
  font-size: 15px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 4px;
}

.calendar-event-time {
  font-size: 13px;
  color: var(--text-secondary);
}

.calendar-event-location {
  font-size: 13px;
  color: var(--text-secondary);
  margin-top: 2px;
}

.calendar-event-delete {
  background: none;
  border: none;
  color: var(--danger);
  font-size: 18px;
  cursor: pointer;
  padding: 4px;
}

.calendar-add-event {
  background: rgba(255, 255, 255, 0.05);
  border: 1px dashed var(--border);
  border-radius: 12px;
  width: 100%;
  padding: 12px;
  color: var(--text-secondary);
  font-size: 14px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.event-reminder-dot {
  display: inline-block;
  width: 8px;
  height: 8px;
  border-radius: 999px;
  background: var(--warning);
  margin-left: 8px;
  transform: translateY(-1px);
  opacity: 0.9;
}

.calendar-header-right {
  display: flex;
  align-items: center;
  gap: 10px;
}

.icon-btn {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid var(--border);
  border-radius: 10px;
  width: 38px;
  height: 38px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s;
}

.icon-btn:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: var(--accent);
}

.icon-btn img {
  width: 18px;
  height: 18px;
  opacity: 0.9;
}

/* =========================
   EVENT SHARE VIEW
   ========================= */

.event-share-wrap {
  padding: 16px;
}

.event-share-card {
  background: var(--card-bg);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 20px;
}

.event-share-title {
  font-size: 22px;
  font-weight: 800;
  margin-bottom: 6px;
}

.event-share-meta {
  font-size: 13px;
  color: var(--text-secondary);
  margin-bottom: 14px;
}

.event-share-desc {
  font-size: 15px;
  line-height: 1.6;
  margin-bottom: 16px;
}

.event-share-actions {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-top: 16px;
}

.event-share-input {
  width: 100%;
  margin-bottom: 12px;
}

.event-share-status {
  margin-top: 14px;
  font-size: 14px;
  color: var(--text-secondary);
}

.event-share-status.success {
  color: var(--success);
}

.event-share-status.error {
  color: var(--danger);
}

.event-share-actions .btn {
  flex: 1;
  justify-content: center;
}

/* =========================
   SHARE CODE MODAL
   ========================= */

.share-code-box {
  padding: 14px;
  border-radius: 14px;
  background: rgba(255, 255, 255, 0.04);
  border: 1px solid var(--border);
}

.share-code-label {
  font-size: 12px;
  color: var(--text-secondary);
  font-weight: 800;
  text-transform: uppercase;
  letter-spacing: 0.4px;
  margin-bottom: 8px;
}

.share-code-token {
  width: 100%;
  padding: 12px 14px;
  border-radius: 12px;
  border: 1px solid var(--border);
  background: rgba(0,0,0,0.35);
  color: var(--text-primary);
  font-size: 15px;
  font-weight: 800;
  letter-spacing: 0.4px;
  word-break: break-all;
  user-select: text;
}

.share-code-help {
  margin-top: 10px;
  color: var(--text-secondary);
  font-size: 13px;
  line-height: 1.45;
}

/* Utility */
.is-hidden {
  display: none !important;
}

/* -------- Journal View -------- */

.journal-header-actions {
  display: flex;
  align-items: center;
  gap: 8px;
}

.tag-row {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-top: 10px;
}

.tag-pill {
  display: inline-flex;
  align-items: center;
  padding: 6px 10px;
  border-radius: 999px;
  font-size: 12px;
  font-weight: 600;

  background: linear-gradient(135deg, #8b7def 0%, #5b8def 100%);
  color: white;
  border: 1px solid rgba(91, 141, 239, 0.45);

  /* optional: makes them pop slightly like the UI accent */
  box-shadow: 0 4px 10px rgba(91, 141, 239, 0.18);
}

.journal-preview {
  font-size: 14px;
  line-height: 1.5;
  color: var(--text-primary);
  white-space: pre-line;
  word-break: break-word;
  opacity: 0.95;
}

/* Journal */
.journal-body-preview {
  display: -webkit-box;
  -webkit-line-clamp: 4; /* preview lines */
  -webkit-box-orient: vertical;
  overflow: hidden;
  white-space: pre-line;
}

/* Journal preview modal actions */
.journal-preview-actions {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.journal-preview-actions .btn {
  width: 100%;
  justify-content: center;
}

.tag-chip {
  display: inline-flex;
  align-items: center;
  padding: 6px 10px;
  border-radius: 999px;
  font-size: 12px;
  font-weight: 600;

  background: linear-gradient(135deg, #8b7def 0%, #5b8def 100%);
  color: white;
  border: 1px solid rgba(91, 141, 239, 0.45);

  margin-right: 8px;
  margin-top: 8px;

  box-shadow: 0 4px 10px rgba(91, 141, 239, 0.18);
}

.load-more-container {
  margin: 16px;
}

.btn-prompt {
  background: linear-gradient(135deg, #8b7def 0%, #5b8def 100%);
  color: white;
}

.btn-prompt:hover {
  filter: brightness(1.08);
}

.btn-prompt:active {
  transform: scale(0.96);
}

.load-more-btn {
  width: 100%;
  justify-content: center;
  padding: 12px;
}

/* -------- Journal Tags View -------- */

.tags-search {
  margin: 0 16px 16px;
}

.tags-list {
  display: flex;
  flex-direction: column;
  gap: 10px;
  padding: 0 16px 16px;
}

.tag-item {
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  padding: 14px 16px;
  border-radius: 14px;
  border: 1px solid var(--border);
  background: var(--card-bg);
  cursor: pointer;
  transition: all 0.2s;
}

.tag-item:hover {
  border-color: var(--accent);
  background: rgba(255, 255, 255, 0.04);
}

.tag-item-name {
  font-weight: 800;
}

.tag-item-count {
  color: var(--text-secondary);
  font-size: 13px;
  font-weight: 700;
}

.journal-filter-bar {
  margin: 0 16px 14px;
  padding: 10px 12px;
  border-radius: 14px;
  border: 1px solid var(--border);
  background: rgba(255,255,255,0.04);
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
}

.journal-filter-left {
  display: flex;
  align-items: center;
  gap: 10px;
  min-width: 0;
}

.journal-filter-left img {
  width: 16px;
  height: 16px;
  opacity: 0.9;
}

.journal-filter-text {
  font-size: 13px;
  color: var(--text-primary);
  font-weight: 700;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.journal-filter-clear {
  padding: 8px 10px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: rgba(255,255,255,0.06);
  color: var(--text-primary);
  font-size: 12px;
  font-weight: 800;
  cursor: pointer;
}

.journal-filter-clear:hover {
  border-color: var(--accent);
}

/* ---------------- Icon System (SVG icons replacing emojis) ---------------- */

/* Global sanity */
img {
  max-width: 100%;
  height: auto;
}

/* Inline icon sizing + alignment */
.card-time img,
.btn img,
.nav-item-icon img,
.empty-state-icon img,
.calendar-add-icon-btn img,
.calendar-event-location img,
.calendar-event-delete img {
  display: inline-block;
  width: 1em;
  height: 1em;
  vertical-align: -0.12em;
  object-fit: contain;
}

/* --- Card time (date / time rows) --- */
.card-time {
  gap: 8px;
}
.card-time img {
  width: 16px;
  height: 16px;
  opacity: 0.9;
}

/* --- Buttons with icons --- */
.btn img {
  width: 16px;
  height: 16px;
}

/* --- Bottom navigation icons --- */
.nav-item-icon {
  font-size: 0; /* removes emoji-era baseline spacing */
  line-height: 0;
}
.nav-item-icon img {
  width: 24px;
  height: 24px;
  opacity: 0.9;
}

.nav-item.active .nav-item-icon img {
  opacity: 1;
}

/* --- Empty states --- */
.empty-state-icon img {
  width: 64px;
  height: 64px;
  opacity: 0.3;
}

/* --- Calendar --- */
.calendar-add-icon-btn img {
  width: 18px;
  height: 18px;
}

.calendar-event-location {
  display: flex;
  align-items: center;
  gap: 8px;
}
.calendar-event-location img {
  width: 14px;
  height: 14px;
  opacity: 0.85;
}

.calendar-event-delete img {
  width: 18px;
  height: 18px;
}

/* =========================
   SETTINGS VIEW POLISH
   ========================= */

/* Settings should not feel like tappable reminder cards */
.settings-card {
  cursor: default !important;
  transform: none !important;
}
.settings-card:hover {
  border-color: var(--border) !important;
  box-shadow: none !important;
  transform: none !important;
}

/* Section titles inside settings */
.settings-title {
  font-size: 14px;
  font-weight: 800;
  margin-bottom: 10px;
  letter-spacing: 0.2px;
}

.settings-help {
  color: var(--text-secondary);
  font-size: 13px;
  line-height: 1.45;
  margin-bottom: 12px;
}

/* Save row aligns nicely and doesn't float */
.settings-actions {
  margin-top: 12px;
  display: flex;
  gap: 10px;
}

/* Quiet Hours container (avoid "card inside card" look) */
.qh-box {
  margin-top: 14px;
  padding: 16px;
  border-radius: 14px;
  background: rgba(255, 255, 255, 0.04);
  border: 1px solid var(--border);
}

/* Quiet Hours header text */
.qh-title {
  font-size: 14px;
  font-weight: 800;
  margin-bottom: 8px;
}

.qh-sub {
  color: var(--text-secondary);
  font-size: 13px;
  line-height: 1.45;
  margin-bottom: 12px;
}

/* Toggle row for quiet hours */
.qh-toggle {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  padding: 10px 12px;
  border: 1px solid var(--border);
  border-radius: 12px;
  background: rgba(255, 255, 255, 0.03);
  margin-bottom: 12px;
}

.qh-toggle label {
  display: flex;
  align-items: center;
  gap: 10px;
  cursor: pointer;
  user-select: none;
  color: var(--text-primary);
  font-weight: 600;
}

/* Make checkbox not look tiny/off-center */
.qh-toggle input[type="checkbox"] {
  width: 18px;
  height: 18px;
}

/* Two time inputs, clean and aligned */
.qh-times {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-bottom: 12px;
}

/* Label styling for Start/End */
.qh-times .form-label {
  margin-bottom: 6px;
}

/* Disable times visually if quiet hours off */
.qh-disabled {
  opacity: 0.55;
  pointer-events: none;
}

/* Quiet hours save button row */
.qh-actions {
  display: flex;
  justify-content: flex-start;
  gap: 10px;
}

/* Optional: smaller save button in settings so it doesn’t look chunky */
.btn.btn-sm {
  padding: 10px 14px;
  font-size: 13px;
  border-radius: 10px;
}

/* =========================================================
   FULL GLASS COMMIT PATCH (paste at VERY END of your CSS)
   ========================================================= */

/* 0) Glass tokens (override your base tokens cleanly) */
:root {
  /* Base backdrop */
  --bg-color: #07070a;

  /* Replace harsh borders with glass borders */
  --border: rgba(255, 255, 255, 0.12);

  /* Glass surface tokens */
  --glass-surface: rgba(255, 255, 255, 0.06);
  --glass-surface-2: rgba(255, 255, 255, 0.09);
  --glass-border: rgba(255, 255, 255, 0.14);
  --glass-border-strong: rgba(255, 255, 255, 0.22);

  /* Shadows + highlights */
  --glass-shadow: rgba(0, 0, 0, 0.45);
  --glass-highlight: rgba(255, 255, 255, 0.16);

  /* Blur */
  --glass-blur: 18px;

  /* Optional: keep your card-bg but make it "not used" visually */
  --card-bg: rgba(255, 255, 255, 0.06);
}

/* 1) Ambient aurora background (makes glass read as glass) */
body {
  background: var(--bg-color);
  position: relative;
}

body::before {
  content: "";
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: -2;
  background:
    radial-gradient(650px 450px at 12% 10%, rgba(91, 141, 239, 0.24), transparent 60%),
    radial-gradient(600px 480px at 88% 18%, rgba(139, 125, 239, 0.20), transparent 62%),
    radial-gradient(720px 540px at 50% 92%, rgba(224, 25, 212, 0.12), transparent 60%),
    radial-gradient(720px 520px at 40% 70%, rgba(0, 219, 255, 0.10), transparent 62%);
  filter: blur(2px);
  opacity: 0.9;
}

/* Subtle grain (optional but makes glass premium) */
body::after {
  content: "";
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: -1;
  opacity: 0.05;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='140' height='140'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='140' height='140' filter='url(%23n)' opacity='0.35'/%3E%3C/svg%3E");
}

/* 2) Core glass "surface" mixin (applied via selectors below) */
@supports ((-webkit-backdrop-filter: blur(1px)) or (backdrop-filter: blur(1px))) {
  .card,
  .bottom-nav,
  .header,
  .modal,
  .quick-action,
  .form-input,
  .form-textarea,
  .form-select,
  .calendar-event,
  .calendar-no-events,
  .calendar-add-event,
  .tag-item,
  .journal-filter-bar,
  .qh-box,
  .share-code-box,
  .event-share-card,
  .log-row,
  .streak-stat,
  .settings-card {
    background: var(--glass-surface) !important;
    border: 1px solid var(--glass-border) !important;
    -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(150%);
    backdrop-filter: blur(var(--glass-blur)) saturate(150%);
    box-shadow: 0 14px 40px var(--glass-shadow);
  }

  /* stronger surfaces */
  .modal {
    background: rgba(25, 25, 32, 0.58) !important;
    border-color: rgba(255, 255, 255, 0.18) !important;
    box-shadow: 0 22px 70px rgba(0,0,0,0.65);
  }

  .bottom-nav {
    background: rgba(20, 20, 26, 0.55) !important;
    border-top: 1px solid rgba(255,255,255,0.10) !important;
    -webkit-backdrop-filter: blur(calc(var(--glass-blur) + 8px)) saturate(160%);
    backdrop-filter: blur(calc(var(--glass-blur) + 8px)) saturate(160%);
    box-shadow: 0 -10px 30px rgba(0,0,0,0.35);
  }

  .header {
    background: rgba(10, 10, 14, 0.45) !important;
    border-bottom: none;
    box-shadow: 0 10px 28px rgba(0,0,0,0.22);
  }

  /* 3) Glass edge shine (helps it read as glass) */
  .card,
  .modal,
  .calendar-event,
  .calendar-no-events,
  .calendar-add-event,
  .tag-item,
  .journal-filter-bar,
  .qh-box,
  .share-code-box,
  .event-share-card,
  .log-row,
  .streak-stat {
    position: relative;
    overflow: hidden;
  }

  .card::before,
  .modal::before,
  .calendar-event::before,
  .calendar-no-events::before,
  .calendar-add-event::before,
  .tag-item::before,
  .journal-filter-bar::before,
  .qh-box::before,
  .share-code-box::before,
  .event-share-card::before,
  .log-row::before,
  .streak-stat::before {
    content: "";
    position: absolute;
    inset: 0;
    pointer-events: none;
    border-radius: inherit;
    background: linear-gradient(
      135deg,
      rgba(255,255,255,0.18),
      rgba(255,255,255,0.06) 35%,
      rgba(255,255,255,0.00) 60%
    );
    opacity: 0.55;
    mix-blend-mode: screen;
  }

  /* 4) Hover glow on glass */
  .card:hover,
  .tag-item:hover,
  .calendar-event:hover {
    border-color: rgba(91, 141, 239, 0.40) !important;
    box-shadow: 0 18px 54px rgba(0,0,0,0.52);
  }

  /* 5) Inputs: glass fields */
  .form-input,
  .form-textarea,
  .form-select {
    background: rgba(255, 255, 255, 0.07) !important;
    border-color: rgba(255,255,255,0.14) !important;
    box-shadow: inset 0 1px 0 rgba(255,255,255,0.10);
  }

  .form-input:focus,
  .form-textarea:focus,
  .form-select:focus {
    border-color: rgba(91, 141, 239, 0.60) !important;
    box-shadow: 0 0 0 3px rgba(91, 141, 239, 0.18), inset 0 1px 0 rgba(255,255,255,0.12);
    background: rgba(255, 255, 255, 0.09) !important;
  }

  /* 6) Buttons: subtle gloss (don’t ruin your gradients) */
  .btn {
    box-shadow: inset 0 1px 0 rgba(255,255,255,0.12);
  }

  .btn-secondary {
    background: rgba(255,255,255,0.08) !important;
    border: 1px solid rgba(255,255,255,0.12) !important;
    -webkit-backdrop-filter: blur(12px) saturate(150%);
    backdrop-filter: blur(12px) saturate(150%);
  }

  .btn-secondary:hover {
    background: rgba(255,255,255,0.11) !important;
    border-color: rgba(91, 141, 239, 0.35) !important;
  }

  /* 7) Badges: glass border (what you asked for) */
  .card-badge,
  .badge-habit-daily,
  .badge-habit-weekly,
  .badge-habit-active,
  .badge-habit-paused,
  .badge-once,
  .badge-daily,
  .badge-weekly,
  .badge-monthly,
  .badge-interval {
    border: 1px solid rgba(255,255,255,0.14) !important;
    -webkit-backdrop-filter: blur(10px) saturate(150%);
    backdrop-filter: blur(10px) saturate(150%);
  }

  /* 8) Modal overlay: slightly glass */
  .modal-overlay {
    background: rgba(0,0,0,0.55) !important;
    -webkit-backdrop-filter: blur(8px);
    backdrop-filter: blur(8px);
  }

  /* 9) FAB: glossier */
  .fab {
    box-shadow:
      0 10px 30px rgba(91, 141, 239, 0.38),
      inset 0 1px 0 rgba(255,255,255,0.22);
  }
}

/* 10) Fallback if backdrop-filter unsupported */
@supports not ((-webkit-backdrop-filter: blur(1px)) or (backdrop-filter: blur(1px))) {
  .card,
  .bottom-nav,
  .header,
  .modal,
  .calendar-event,
  .calendar-no-events,
  .calendar-add-event,
  .tag-item,
  .journal-filter-bar,
  .qh-box,
  .share-code-box,
  .event-share-card,
  .log-row,
  .streak-stat {
    background: rgba(20, 20, 26, 0.92) !important;
    border: 1px solid rgba(255, 255, 255, 0.10) !important;
  }
}

// BUTTON BASE
.btn {
  border: none;
  border-radius: 12px;
  padding: 10px 14px;
  font-weight: 500;
  cursor: pointer;
  transition: transform 0.15s ease, filter 0.15s ease, box-shadow 0.15s ease;
}

.btn:hover {
  transform: translateY(-1px);
}


/* =========================
   FIXES ONLY -- DO NOT STYLE
   ========================= */

/* 1) REMOVE boxed background behind Habits header */
.header {
  background: transparent !important;
  -webkit-backdrop-filter: none !important;
  backdrop-filter: none !important;
  box-shadow: none !important;
}

/* Keep a subtle separator only */
.header {
  border-bottom: 1px solid var(--glass-border);
}

/* 2) STOP badge overlap -- force proper stacking */
.card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 12px;
}

/* Right-side badge container */
.badge-stack {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 6px;
}

/* Make badges behave like pills, not floaty ghosts */
.card-badge {
  position: static !important;
  line-height: 1;
  white-space: nowrap;
}

/* =========================
   HABIT ACTION BUTTON LOCK
   ========================= */

.habit-actions button.btn {
  background: none !important;
}

/* Log Session -- PURPLE */
.habit-actions button.btn-log {
  background: linear-gradient(135deg, #8000fe, #8000fe) !important;
  color: #ffffff !important;
  border: none !important;
  box-shadow: 0 8px 22px rgba(123, 108, 255, 0.45) !important;
}

/* Edit -- TEAL */
.habit-actions button.btn-edit {
  background: linear-gradient(135deg, #00dbff, #00dbff) !important;
  color: #062b2a !important;
  border: none !important;
  box-shadow: 0 8px 22px rgba(47, 212, 201, 0.45) !important;
}

/* Delete -- PINK */
.habit-actions button.btn-delete {
  background: linear-gradient(135deg, #e019d4, #e019d4) !important;
  color: #ffffff !important;
  border: none !important;
  box-shadow: 0 8px 22px rgba(255, 102, 179, 0.45) !important;
}

/* View / Pause -- neutral glass */
.habit-actions button.btn-view,
.habit-actions button.btn-pause {
  background: rgba(255, 255, 255, 0.12) !important;
  color: rgba(255, 255, 255, 0.95) !important;
  border: 1px solid rgba(255, 255, 255, 0.18) !important;
}
  </style>
</head>

<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;
    const { DateTime } = luxon;

// Telegram WebApp guard (browser vs Telegram)
const tg = window.Telegram?.WebApp;

const isTelegram =
  !!tg &&
  typeof tg.initData === "string" &&
  tg.initData.length > 0;

if (!isTelegram) {
  const root = document.getElementById("root");
  if (root) {
    root.innerHTML = `
<div style="min-height:var(--tg-viewport-height,100vh); display:flex; align-items:center; justify-content:center; padding:24px; text-align:center; color:#fff;">
        <div style="max-width:520px;">
          <h2 style="margin-bottom:12px;">Open in Telegram</h2>
          <p style="opacity:.8; line-height:1.6;">
            This mini app must be opened inside Telegram to access
            your journal entries, reminders, and events.
          </p>
        </div>
      </div>
    `;
  }
  throw new Error("Not running inside Telegram WebApp");
}

// Initialize Telegram Web App.. Safe to init now
tg.ready();
tg.expand();

// ===== CRASH OVERLAY (PASTE AT TOP OF SCRIPT) =====
(function () {
  function show(msg) {
    try {
      let el = document.getElementById("__crash_overlay__");
      if (!el) {
        el = document.createElement("pre");
        el.id = "__crash_overlay__";
        el.style.position = "fixed";
        el.style.left = "0";
        el.style.right = "0";
        el.style.top = "0";
        el.style.bottom = "0";
        el.style.padding = "12px";
        el.style.margin = "0";
        el.style.background = "#0b0b0f";
        el.style.color = "#ffb3c7";
        el.style.fontSize = "12px";
        el.style.whiteSpace = "pre-wrap";
        el.style.zIndex = "999999";
        el.style.overflow = "auto";
        document.body.appendChild(el);
      }
      el.textContent = String(msg);
    } catch {}
  }

  window.addEventListener("error", (e) => {
    show("JS ERROR:\n" + (e?.error?.stack || e?.message || String(e)));
  });

  window.addEventListener("unhandledrejection", (e) => {
    const r = e?.reason;
    show("UNHANDLED PROMISE REJECTION:\n" + (r?.stack || r?.message || String(r)));
  });
})();

// --- Telegram real viewport height fix (standalone fullscreen vs chat sheet) ---
function syncTelegramViewportHeight() {
  try {
    const h = tg.viewportHeight; // Telegram's real usable height
    if (h && Number.isFinite(h)) {
      document.documentElement.style.setProperty("--tg-viewport-height", `${h}px`);
    }
  } catch (e) {
    // ignore
  }
}

syncTelegramViewportHeight();
tg.onEvent("viewportChanged", syncTelegramViewportHeight);
// ---------------------------------------------------------------------------

    // Helper function to make API calls
    // API base URL
const API_BASE = window.location.origin + '/api/miniapp';

    async function apiCall(endpoint, options = {}) {
      const response = await fetch(`${API_BASE}${endpoint}`, {
        ...options,
        headers: {
          'Content-Type': 'application/json',
          'X-Telegram-Init-Data': tg.initData,
          ...options.headers,
        },
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'Request failed');
      }

      return response.json();
    }

    // Format date/time
    function formatDateTime(date) {
      const d = new Date(date);
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const tomorrow = new Date(today);
      tomorrow.setDate(tomorrow.getDate() + 1);

      const dateStr = new Date(d.getFullYear(), d.getMonth(), d.getDate());

      let dayStr;
      if (dateStr.getTime() === today.getTime()) {
        dayStr = 'Today';
      } else if (dateStr.getTime() === tomorrow.getTime()) {
        dayStr = 'Tomorrow';
      } else {
        dayStr = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      }

      const timeStr = d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });

      return `${dayStr} at ${timeStr}`;
    }

    function formatEventTime(event) {
      const start = new Date(event.startDate);
      if (event.allDay) {
        return 'All day';
      }
      const timeStr = start.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
      if (event.endDate) {
        const end = new Date(event.endDate);
        const endTimeStr = end.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        return `${timeStr} - ${endTimeStr}`;
      }
      return timeStr;
    }
    
    function hasReminder(event) {
  return !!(event?.reminderId || event?.reminder?.nextRunAt);
}
    
    // Journal helpers
function normalizeTagsFromText(input) {
  const matches = String(input || '').match(/#[A-Za-z0-9_-]+/g) || [];
  const tags = matches
    .map(t => t.slice(1).trim())
    .filter(Boolean)
    .map(t => t.toLowerCase());
  return Array.from(new Set(tags));
}

function tagsToDisplay(tags) {
  const list = Array.isArray(tags) ? tags : [];
  if (list.length === 0) return '';
  return list.map(t => `#${t}`).join(' ');
}

function formatShortDate(date) {
  const d = new Date(date);
  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

function badgeForStatus(status) {
  const s = String(status || "").toLowerCase();
  if (s === "tbr") return { text: "TBR", bg: "rgba(255,152,0,0.15)", fg: "#ff9800" };
  if (s === "reading") return { text: "READING", bg: "rgba(76,175,80,0.15)", fg: "#4caf50" };
  if (s === "finished") return { text: "FINISHED", bg: "rgba(91,141,239,0.15)", fg: "#5b8def" };
  return { text: "BOOK", bg: "rgba(255,255,255,0.08)", fg: "#ffffff" };
}

function statusLabelToValue(input) {
  const s = String(input || "").toLowerCase().trim();
  if (s === "tbr") return "tbr";
  if (s === "reading" || s === "active") return "reading";
  if (s === "finished" || s === "done") return "finished";
  return "tbr";
}


// =========================
// HABITS UI (matches your Habit.ts / HabitLog.ts / habits.ts API)
// =========================

function safeNum(n, fallback = 0) {
  const x = Number(n);
  return Number.isFinite(x) ? x : fallback;
}

function isSessionsUnit(unit) {
  return String(unit || "").toLowerCase() === "sessions";
}

function habitBadgeForCadence(cadence) {
  return String(cadence || "daily").toLowerCase() === "weekly"
    ? { text: "WEEKLY", className: "badge-habit-weekly" }
    : { text: "DAILY", className: "badge-habit-daily" };
}

function habitBadgeForStatus(status) {
  return String(status || "active").toLowerCase() === "paused"
    ? { text: "PAUSED", className: "badge-habit-paused" }
    : { text: "ACTIVE", className: "badge-habit-active" };
}


function debugHabitsApi(endpoint, options) {
  // what Habits THINKS it's calling
  const endpointType = typeof endpoint;
  const endpointValue =
    endpointType === "string" ? endpoint :
    (() => { try { return JSON.stringify(endpoint); } catch { return String(endpoint); } })();

  // what your helper WILL fetch
  // (this matches your helper exactly)
  const finalUrl = `${API_BASE}${endpoint}`;

  console.log("[HABITS apiCall debug]", {
    endpointType,
    endpointRaw: endpoint,
    endpointValue,
    finalUrl,
    method: options?.method || "GET",
  });

  return apiCall(endpoint, options).catch((err) => {
    console.log("[HABITS apiCall error]", {
      message: err?.message,
      endpointType,
      endpointRaw: endpoint,
      finalUrl,
    });

    // show the REAL info in Telegram so you don't need Safari inspector
    tg?.showAlert?.(
      "Habits API failed.\n\n" +
      "endpointType: " + endpointType + "\n" +
      "endpoint: " + endpointValue + "\n\n" +
      "finalUrl:\n" + finalUrl + "\n\n" +
      "error:\n" + (err?.message || String(err))
    );

    throw err;
  });
}

// =========================
// HABITS UI (FIXED for iOS WebView strict input formats)
// Assumes you already have: apiCall, tg, safeNum, isSessionsUnit,
// habitBadgeForCadence, habitBadgeForStatus,
// fmtDateTimeLocalValue, parseDateTimeLocalValue
// =========================

// --- helpers (local) ---
function pad2(n) {
  return String(n).padStart(2, "0");
}

// Returns "YYYY-MM-DDTHH:mm" in the user's LOCAL time.
// Accepts: Date, ISO string, timestamp number.
function fmtDateTimeLocalValue(input) {
  const d = input instanceof Date ? input : new Date(input);

  if (!(d instanceof Date) || isNaN(d.getTime())) return "";

  const yyyy = d.getFullYear();
  const mm = pad2(d.getMonth() + 1);
  const dd = pad2(d.getDate());
  const hh = pad2(d.getHours());
  const min = pad2(d.getMinutes());

  // EXACT format required by iOS datetime-local:
  return `${yyyy}-${mm}-${dd}T${hh}:${min}`;
}

// Parses "YYYY-MM-DDTHH:mm" (from datetime-local) into a Date in LOCAL time.
// Returns Date or null.
function parseDateTimeLocalValue(str) {
  if (typeof str !== "string") return null;
  const s = str.trim();
  if (!s) return null;

  // Must be EXACT:
  const m = s.match(/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2})$/);
  if (!m) return null;

  const yyyy = Number(m[1]);
  const mo = Number(m[2]);   // 1-12
  const dd = Number(m[3]);   // 1-31
  const hh = Number(m[4]);   // 0-23
  const min = Number(m[5]);  // 0-59

  if (
    !Number.isFinite(yyyy) ||
    !Number.isFinite(mo) || mo < 1 || mo > 12 ||
    !Number.isFinite(dd) || dd < 1 || dd > 31 ||
    !Number.isFinite(hh) || hh < 0 || hh > 23 ||
    !Number.isFinite(min) || min < 0 || min > 59
  ) return null;

  // Construct LOCAL datetime (not UTC)
  const d = new Date(yyyy, mo - 1, dd, hh, min, 0, 0);
  if (isNaN(d.getTime())) return null;

  return d;
}

// Habit Card
function HabitCard({ habit, onEdit, onDelete, onTogglePause, onOpenLog, onOpenLogs }) {
  const name = String(habit?.name || "").trim() || "(unnamed habit)";
  const description = String(habit?.description || "").trim();

  const cadenceBadge = habitBadgeForCadence(habit?.cadence);
  const statusBadge = habitBadgeForStatus(habit?.status);

  const targetCount = safeNum(habit?.targetCount, 1);
  const targetAmount = habit?.targetAmount === undefined ? null : safeNum(habit?.targetAmount, 0);
  const unit = String(habit?.unit || "sessions");

  const scheduleKind = String(habit?.reminderSchedule?.kind || "off");

  const scheduleSummary =
    scheduleKind === "off"
      ? "Reminders: Off"
      : scheduleKind === "times"
        ? `Reminders: Times (${(habit?.reminderSchedule?.timesOfDay || []).join(", ") || "none"})`
        : scheduleKind === "hourly"
          ? `Reminders: Every ${safeNum(habit?.reminderSchedule?.everyHours, 1)}h` +
            (habit?.reminderSchedule?.windowStart && habit?.reminderSchedule?.windowEnd
              ? ` (${habit.reminderSchedule.windowStart}–${habit.reminderSchedule.windowEnd})`
              : "")
          : scheduleKind === "every_x_minutes"
            ? `Reminders: Every ${safeNum(habit?.reminderSchedule?.everyMinutes, 1)}m` +
              (habit?.reminderSchedule?.windowStart && habit?.reminderSchedule?.windowEnd
                ? ` (${habit.reminderSchedule.windowStart}–${habit.reminderSchedule.windowEnd})`
                : "")
            : `Reminders: ${scheduleKind}`;

  const cadenceLabel = String(habit?.cadence || "daily");
  const targetLine =
    targetAmount !== null && !isSessionsUnit(unit)
      ? `Target: ${targetCount} sessions per ${cadenceLabel} -- ${targetAmount} ${unit} per session`
      : `Target: ${targetCount} sessions per ${cadenceLabel}`;

  return (
    <div className="card">
      <div className="card-header">
        <div>
          <div className="habit-title">{name}</div>
          {description ? <div className="habit-sub">{description}</div> : null}
        </div>

        <div className="habit-badges">
          <span className={`card-badge ${cadenceBadge.className}`}>{cadenceBadge.text}</span>
          <span className={`card-badge ${statusBadge.className}`}>{statusBadge.text}</span>
        </div>
      </div>

      <div className="habit-target">{targetLine}</div>
      <div className="habit-target">{scheduleSummary}</div>

      <div className="habit-actions">
  <button
    className="btn btn-log"
    type="button"
    onClick={() => onOpenLog(habit)}
  >
    Log Session
  </button>

  <button
    className="btn btn-view"
    type="button"
    onClick={() => onOpenLogs(habit)}
  >
    View Logs
  </button>

  <button
    className="btn btn-edit"
    type="button"
    onClick={() => onEdit(habit)}
  >
    Edit
  </button>

  <button
    className="btn btn-pause"
    type="button"
    onClick={() => onTogglePause(habit)}
  >
    {String(habit?.status) === "paused" ? "Resume" : "Pause"}
  </button>

  <button
    className="btn btn-delete"
    type="button"
    onClick={() => onDelete(habit)}
  >
    Delete
  </button>
</div>
    </div>
  );
}


// Habit Editor Modal
function HabitEditorModal({ initialHabit, userTimezone, onClose, onSaved }) {
  const isEdit = !!initialHabit?._id;

  const [name, setName] = useState(isEdit ? (initialHabit.name || "") : "");
  const [description, setDescription] = useState(isEdit ? (initialHabit.description || "") : "");

  const [status, setStatus] = useState(isEdit ? (initialHabit.status || "active") : "active");
  const [cadence, setCadence] = useState(isEdit ? (initialHabit.cadence || "daily") : "daily");

  // ✅ Weekly anchor inputs (only used when cadence === "weekly" AND reminders are on)
  const [startDate, setStartDate] = useState(""); // "YYYY-MM-DD"
  const [startTime, setStartTime] = useState(""); // "HH:mm"

  const [targetCount, setTargetCount] = useState(isEdit ? String(initialHabit.targetCount ?? 1) : "1");
  const [unit, setUnit] = useState(isEdit ? (initialHabit.unit || "sessions") : "sessions");

  const [targetAmount, setTargetAmount] = useState(
    isEdit && initialHabit.targetAmount !== undefined && initialHabit.targetAmount !== null
      ? String(initialHabit.targetAmount)
      : ""
  );

  const [timezone, setTimezone] = useState(
    isEdit
      ? (initialHabit.timezone || userTimezone || "America/Chicago")
      : (userTimezone || "America/Chicago")
  );

  const [reminderKind, setReminderKind] = useState(
    isEdit ? (initialHabit.reminderSchedule?.kind || "off") : "off"
  );

  const [timesOfDay, setTimesOfDay] = useState(
    isEdit
      ? (Array.isArray(initialHabit.reminderSchedule?.timesOfDay) ? initialHabit.reminderSchedule.timesOfDay : [])
      : []
  );

  const [everyHours, setEveryHours] = useState(
    isEdit ? String(initialHabit.reminderSchedule?.everyHours ?? 2) : "2"
  );

  const [everyMinutes, setEveryMinutes] = useState(
    isEdit ? String(initialHabit.reminderSchedule?.everyMinutes ?? 45) : "45"
  );

  const [windowStart, setWindowStart] = useState(
    isEdit ? (initialHabit.reminderSchedule?.windowStart || "") : ""
  );

  const [windowEnd, setWindowEnd] = useState(
    isEdit ? (initialHabit.reminderSchedule?.windowEnd || "") : ""
  );

  const [daysOfWeek, setDaysOfWeek] = useState(
    isEdit
      ? (Array.isArray(initialHabit.reminderSchedule?.daysOfWeek) ? initialHabit.reminderSchedule.daysOfWeek : [])
      : []
  );

  const [nextReminderAt, setNextReminderAt] = useState(
    isEdit && initialHabit.nextReminderAt ? fmtDateTimeLocalValue(initialHabit.nextReminderAt) : ""
  );

  useEffect(() => {
    document.body.classList.add("modal-open");
    return () => document.body.classList.remove("modal-open");
  }, []);

  const weekdayLabels = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];

  const toggleDay = (idx) => {
    setDaysOfWeek((prev) => {
      const s = new Set(Array.isArray(prev) ? prev : []);
      if (s.has(idx)) s.delete(idx);
      else s.add(idx);
      return Array.from(s).sort((a, b) => a - b);
    });
  };

  // ✅ Prefill weekly anchor fields when editing
  useEffect(() => {
    if (isEdit && initialHabit?.startAt) {
      const d = new Date(initialHabit.startAt);
      if (!isNaN(d.getTime())) {
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const dd = String(d.getDate()).padStart(2, "0");
        const hh = String(d.getHours()).padStart(2, "0");
        const min = String(d.getMinutes()).padStart(2, "0");

        setStartDate(`${yyyy}-${mm}-${dd}`);
        setStartTime(`${hh}:${min}`);
        return;
      }
    }

    // default clear if not editing weekly or no startAt
    setStartDate("");
    setStartTime("");
  }, [isEdit, initialHabit]);

  const addTime = () => setTimesOfDay((prev) => [...(Array.isArray(prev) ? prev : []), "09:00"]);
  const updateTime = (i, v) => setTimesOfDay((prev) => prev.map((t, idx) => (idx === i ? v : t)));
  const removeTime = (i) => setTimesOfDay((prev) => prev.filter((_, idx) => idx !== i));

  const buildReminderSchedule = () => {
    const base = { kind: reminderKind };

    if (reminderKind === "times") {
      const cleaned = (timesOfDay || []).map((t) => String(t || "").trim()).filter(Boolean);
      return { ...base, timesOfDay: cleaned, daysOfWeek: daysOfWeek || [] };
    }

    if (reminderKind === "hourly") {
      return {
        ...base,
        everyHours: Math.max(1, Math.floor(Number(everyHours) || 1)),
        windowStart: windowStart ? String(windowStart).trim() : undefined,
        windowEnd: windowEnd ? String(windowEnd).trim() : undefined,
        daysOfWeek: daysOfWeek || [],
      };
    }

    if (reminderKind === "every_x_minutes") {
      return {
        ...base,
        everyMinutes: Math.max(1, Math.floor(Number(everyMinutes) || 1)),
        windowStart: windowStart ? String(windowStart).trim() : undefined,
        windowEnd: windowEnd ? String(windowEnd).trim() : undefined,
        daysOfWeek: daysOfWeek || [],
      };
    }

    return base; // off
  };

  const save = async () => {
    if (!String(name || "").trim()) {
      tg?.showAlert?.("Habit name is required.");
      return;
    }

    const tc = Number(targetCount);
    if (!Number.isFinite(tc) || tc < 1) {
      tg?.showAlert?.("targetCount must be >= 1.");
      return;
    }

    let ta = undefined;
    if (targetAmount !== "" && targetAmount !== null && targetAmount !== undefined) {
      const n = Number(targetAmount);
      if (!Number.isFinite(n) || n < 0) {
        tg?.showAlert?.("targetAmount must be >= 0.");
        return;
      }
      ta = n;
    }

    const reminderSchedule = buildReminderSchedule();

    if (reminderSchedule.kind === "times") {
      const arr = Array.isArray(reminderSchedule.timesOfDay) ? reminderSchedule.timesOfDay : [];
      if (arr.length === 0) {
        tg?.showAlert?.("timesOfDay is required for reminderSchedule kind=times.");
        return;
      }
    }

    const remindersOn = reminderKind !== "off";

    // ✅ Weekly cadence must have an anchor datetime when reminders are ON
    if (cadence === "weekly" && remindersOn) {
      if (!startDate || !startTime) {
        tg?.showAlert?.("Weekly habits require a start date and start time.");
        return;
      }
    }

    // ✅ Build ISO for startAt (weekly anchor)
    let startAtISO = undefined;

    if (cadence === "weekly" && remindersOn) {
      const isoLocal = `${startDate}T${startTime}`; // local time from inputs
      const d = new Date(isoLocal);

      if (isNaN(d.getTime())) {
        tg?.showAlert?.("Start date/time is invalid.");
        return;
      }

      startAtISO = d.toISOString();
    }

    const payload = {
      name: String(name).trim(),
      description: description ? String(description).trim() : undefined,
      status: status === "paused" ? "paused" : "active",
      cadence: cadence === "weekly" ? "weekly" : "daily",
      targetCount: Math.floor(tc),
      targetAmount: ta,
      unit,
      timezone: String(timezone || userTimezone || "America/Chicago").trim(),
      reminderSchedule,
      nextReminderAt: nextReminderAt ? parseDateTimeLocalValue(nextReminderAt)?.toISOString() : undefined,

      // ✅ weekly anchor (only sent when weekly + reminders on)
      startAt: startAtISO,
    };

    try {
      if (isEdit) {
        await apiCall(`/habits/${initialHabit._id}`, {
          method: "PUT",
          body: JSON.stringify(payload),
        });
      } else {
        await apiCall(`/habits`, {
          method: "POST",
          body: JSON.stringify(payload),
        });
      }

      tg?.showPopup?.({ message: isEdit ? "Habit updated" : "Habit created" });
      onSaved?.();
      onClose?.();
    } catch (e) {
      tg?.showAlert?.(`Failed to save habit: ${e?.message || String(e)}`);
    }
  };

  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal" onClick={(e) => e.stopPropagation()}>
        <div className="modal-header">
          <h2>{isEdit ? "Edit Habit" : "New Habit"}</h2>
          <button className="modal-close" onClick={onClose} type="button">×</button>
        </div>

        <div className="modal-body">
          <div className="form-group">
            <label className="form-label">Habit Name</label>
            <input className="form-input" value={name} onChange={(e) => setName(e.target.value)} />
          </div>

          <div className="form-group">
            <label className="form-label">Description (optional)</label>
            <textarea
              className="form-textarea form-textarea--sm"
              value={description}
              onChange={(e) => setDescription(e.target.value)}
            />
          </div>

          <div className="modal-divider" />

          <div className="form-group">
            <label className="form-label">Status</label>
            <select className="form-select" value={status} onChange={(e) => setStatus(e.target.value)}>
              <option value="active">active</option>
              <option value="paused">paused</option>
            </select>
          </div>

          <div className="form-group">
            <label className="form-label">Cadence</label>
            <select className="form-select" value={cadence} onChange={(e) => setCadence(e.target.value)}>
              <option value="daily">daily</option>
              <option value="weekly">weekly</option>
            </select>
          </div>

          {cadence === "weekly" && reminderKind !== "off" ? (
            <div className="form-group">
              <label className="form-label">Weekly Start (required for weekly)</label>

              <div className="times-item">
                <input
                  type="date"
                  className="form-input"
                  value={startDate}
                  onChange={(e) => setStartDate(e.target.value)}
                />

                <input
                  type="time"
                  className="form-input"
                  value={startTime}
                  onChange={(e) => setStartTime(e.target.value)}
                />
              </div>
            </div>
          ) : null}

          <div className="form-group">
            <label className="form-label">Target Count (sessions per cadence)</label>
            <input
              type="number"
              className="form-input"
              min="1"
              value={targetCount}
              onChange={(e) => setTargetCount(e.target.value)}
            />
          </div>

          <div className="form-group">
            <label className="form-label">Unit</label>
            <select className="form-select" value={unit} onChange={(e) => setUnit(e.target.value)}>
              <option value="sessions">sessions</option>
              <option value="minutes">minutes</option>
              <option value="hours">hours</option>
              <option value="steps">steps</option>
              <option value="cups">cups</option>
              <option value="oz">oz</option>
              <option value="ml">ml</option>
              <option value="pages">pages</option>
              <option value="count">count</option>
            </select>
          </div>

          <div className="form-group">
            <label className="form-label">Target Amount (optional)</label>
            <input
              type="number"
              className="form-input"
              min="0"
              value={targetAmount}
              onChange={(e) => setTargetAmount(e.target.value)}
              placeholder={isSessionsUnit(unit) ? "Leave empty for sessions-only" : `Amount in ${unit}`}
            />
          </div>

          <div className="form-group">
            <label className="form-label">Timezone</label>
            <input className="form-input" value={timezone} onChange={(e) => setTimezone(e.target.value)} />
          </div>

          <div className="modal-divider" />

          <div className="form-group">
            <label className="form-label">Reminder Schedule Kind</label>
            <select className="form-select" value={reminderKind} onChange={(e) => setReminderKind(e.target.value)}>
              <option value="off">off</option>
              <option value="times">times</option>
              <option value="hourly">hourly</option>
              <option value="every_x_minutes">every_x_minutes</option>
            </select>
          </div>

          {reminderKind === "times" ? (
            <div className="form-group">
              <label className="form-label">Times of Day</label>

              <div className="times-list">
                {(timesOfDay || []).map((t, i) => (
                  <div className="times-item" key={i}>
                    <input
                      type="time"
                      className="form-input"
                      value={t}
                      onChange={(e) => updateTime(i, e.target.value)}
                    />
                    <button className="btn btn-danger" type="button" onClick={() => removeTime(i)}>
                      Remove
                    </button>
                  </div>
                ))}
              </div>

              <div className="times-add">
                <button className="btn btn-secondary" type="button" onClick={addTime}>
                  Add Time
                </button>
              </div>
            </div>
          ) : null}

          {reminderKind === "hourly" ? (
            <div className="form-group">
              <label className="form-label">Every Hours</label>
              <input
                type="number"
                min="1"
                className="form-input"
                value={everyHours}
                onChange={(e) => setEveryHours(e.target.value)}
              />
            </div>
          ) : null}

          {reminderKind === "every_x_minutes" ? (
            <div className="form-group">
              <label className="form-label">Every Minutes</label>
              <input
                type="number"
                min="1"
                className="form-input"
                value={everyMinutes}
                onChange={(e) => setEveryMinutes(e.target.value)}
              />
            </div>
          ) : null}

          {reminderKind === "hourly" || reminderKind === "every_x_minutes" ? (
            <div className="form-group">
              <label className="form-label">Window (optional)</label>
              <div className="times-item">
                <input
                  type="time"
                  className="form-input"
                  value={windowStart}
                  onChange={(e) => setWindowStart(e.target.value)}
                />
                <input
                  type="time"
                  className="form-input"
                  value={windowEnd}
                  onChange={(e) => setWindowEnd(e.target.value)}
                />
              </div>
            </div>
          ) : null}

          <div className="form-group">
            <label className="form-label">Days of Week (optional)</label>
            <div className="weekday-picker">
              {weekdayLabels.map((lab, idx) => {
                const active = Array.isArray(daysOfWeek) && daysOfWeek.includes(idx);
                const cls = `btn ${active ? "btn-primary" : "btn-secondary"}`;
                return (
                  <button key={idx} type="button" className={cls} onClick={() => toggleDay(idx)}>
                    {lab}
                  </button>
                );
              })}
            </div>
          </div>

          <div className="form-group">
            <label className="form-label">Next Reminder At (optional override)</label>
            <input
              type="datetime-local"
              className="form-input"
              value={nextReminderAt}
              onChange={(e) => setNextReminderAt(e.target.value)}
            />
          </div>
        </div>

        <div className="modal-actions">
          <button className="btn btn-secondary" type="button" onClick={onClose}>
            Cancel
          </button>
          <button className="btn btn-primary" type="button" onClick={save}>
            {isEdit ? "Update" : "Create"}
          </button>
        </div>
      </div>
    </div>
  );
}


// Habit Log Modal
function HabitLogModal({ habit, onClose, onCreated }) {
  const unit = String(habit?.unit || "sessions");
  const [startedAt, setStartedAt] = useState(fmtDateTimeLocalValue(new Date()));
  const [endedAt, setEndedAt] = useState("");
  const [amount, setAmount] = useState(isSessionsUnit(unit) ? "" : "");

  useEffect(() => {
    document.body.classList.add("modal-open");
    return () => document.body.classList.remove("modal-open");
  }, []);

  const save = async () => {
    const s = parseDateTimeLocalValue(startedAt);
    if (!s) {
      tg?.showAlert?.("startedAt is required and must be valid.");
      return;
    }

    const e = endedAt ? parseDateTimeLocalValue(endedAt) : null;
    if (e && e.getTime() < s.getTime()) {
      tg?.showAlert?.("endedAt cannot be before startedAt.");
      return;
    }

    let amt = undefined;
    if (amount !== "" && amount !== null && amount !== undefined) {
      const n = Number(amount);
      if (!Number.isFinite(n) || n < 0) {
        tg?.showAlert?.("amount must be >= 0.");
        return;
      }
      amt = n;
    }

    try {
      await apiCall(`/habits/${habit._id}/logs`, {
        method: "POST",
        body: JSON.stringify({
          startedAt: s.toISOString(),
          endedAt: e ? e.toISOString() : undefined,
          amount: amt,
        }),
      });

      tg?.showPopup?.({ message: "Session logged" });
      onCreated?.();
      onClose?.();
    } catch (e2) {
      tg?.showAlert?.(`Failed to log session: ${e2?.message || String(e2)}`);
    }
  };

  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal" onClick={(e) => e.stopPropagation()}>
        <div className="modal-header">
          <h2>Log Session</h2>
          <button className="modal-close" onClick={onClose} type="button">×</button>
        </div>

        <div className="modal-body">
          <div className="form-group">
            <label className="form-label">Started At</label>
            <input
              type="datetime-local"
              className="form-input"
              value={startedAt}
              onChange={(e) => setStartedAt(e.target.value)}
            />
          </div>

          <div className="form-group">
            <label className="form-label">Ended At (optional)</label>
            <input
              type="datetime-local"
              className="form-input"
              value={endedAt}
              onChange={(e) => setEndedAt(e.target.value)}
            />
          </div>

          <div className="form-group">
            <label className="form-label">Amount (optional)</label>
            <input
              type="number"
              min="0"
              className="form-input"
              value={amount}
              onChange={(e) => setAmount(e.target.value)}
              placeholder={isSessionsUnit(unit) ? "Leave empty for sessions-only" : `Amount in ${unit}`}
            />
          </div>
        </div>

        <div className="modal-actions">
          <button className="btn btn-secondary" type="button" onClick={onClose}>Cancel</button>
          <button className="btn btn-primary" type="button" onClick={save}>Save Log</button>
        </div>
      </div>
    </div>
  );
}


// Habits Logs Modal
function HabitLogsModal({ habit, onClose }) {
  const [logs, setLogs] = useState([]);
  const [loading, setLoading] = useState(true);

  const [editingLog, setEditingLog] = useState(null);
  const [showEdit, setShowEdit] = useState(false);

  const load = async () => {
    try {
      setLoading(true);
      const data = await apiCall(`/habits/${habit._id}/logs?limit=50&skip=0`);
      setLogs(Array.isArray(data?.logs) ? data.logs : []);
    } catch (e) {
      tg?.showAlert?.(`Failed to load logs: ${e?.message || String(e)}`);
      setLogs([]);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    document.body.classList.add("modal-open");
    load();
    return () => document.body.classList.remove("modal-open");
  }, []);

  const del = async (log) => {
    try {
      await apiCall(`/habits/${habit._id}/logs/${log._id}`, { method: "DELETE" });
      tg?.showPopup?.({ message: "Log deleted" });
      load();
    } catch (e) {
      tg?.showAlert?.(`Failed to delete log: ${e?.message || String(e)}`);
    }
  };

  const openEdit = (log) => {
    setEditingLog(log);
    setShowEdit(true);
  };

  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal" onClick={(e) => e.stopPropagation()}>
        <div className="modal-header">
          <h2>Logs: {String(habit?.name || "")}</h2>
          <button className="modal-close" onClick={onClose} type="button">×</button>
        </div>

        <div className="modal-body">
          {loading ? (
            <div className="loading">
              <div className="spinner" />
              <div>Loading logs...</div>
            </div>
          ) : logs.length === 0 ? (
            <div className="empty-state">
              <div className="empty-state-text">No logs yet.</div>
            </div>
          ) : (
            <div className="logs-list">
              {logs.map((log) => {
                const unit = String(log?.unit || habit?.unit || "sessions");
                const started = log?.startedAt ? new Date(log.startedAt) : null;
                const ended = log?.endedAt ? new Date(log.endedAt) : null;

                const amount = log?.amount === undefined || log?.amount === null
                  ? ""
                  : `${log.amount}${unit ? " " + unit : ""}`;

                const timeLine =
                  started && !isNaN(started.getTime())
                    ? `${started.toLocaleString()}${ended && !isNaN(ended.getTime()) ? ` → ${ended.toLocaleString()}` : ""}`
                    : "Unknown time";

                return (
                  <div className="log-row" key={log._id}>
                    <div className="log-top">
                      <div className="log-amount">{amount || "Session"}</div>
                      <div className="log-time">{timeLine}</div>
                    </div>

                    <div className="log-actions">
                      <button className="btn btn-primary" type="button" onClick={() => openEdit(log)}>Edit</button>
                      <button className="btn btn-danger" type="button" onClick={() => del(log)}>Delete</button>
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </div>

        <div className="modal-actions">
          <button className="btn btn-secondary" type="button" onClick={onClose}>Close</button>
        </div>

        {showEdit && editingLog ? (
          <HabitLogEditModal
            habit={habit}
            log={editingLog}
            onClose={() => setShowEdit(false)}
            onSaved={load}
          />
        ) : null}
      </div>
    </div>
  );
}


// Habits Log Edit Modal
function HabitLogEditModal({ habit, log, onClose, onSaved }) {
  const unit = String(habit?.unit || "sessions");

  const [startedAt, setStartedAt] = useState(log?.startedAt ? fmtDateTimeLocalValue(log.startedAt) : fmtDateTimeLocalValue(new Date()));
  const [endedAt, setEndedAt] = useState(log?.endedAt ? fmtDateTimeLocalValue(log.endedAt) : "");
  const [amount, setAmount] = useState(log?.amount === undefined || log?.amount === null ? "" : String(log.amount));

  useEffect(() => {
    document.body.classList.add("modal-open");
    return () => document.body.classList.remove("modal-open");
  }, []);

  const save = async () => {
    const s = parseDateTimeLocalValue(startedAt);
    if (!s) {
      tg?.showAlert?.("startedAt must be valid.");
      return;
    }
    const e = endedAt ? parseDateTimeLocalValue(endedAt) : null;
    if (e && e.getTime() < s.getTime()) {
      tg?.showAlert?.("endedAt cannot be before startedAt.");
      return;
    }

    let amt = undefined;
    if (amount !== "" && amount !== null && amount !== undefined) {
      const n = Number(amount);
      if (!Number.isFinite(n) || n < 0) {
        tg?.showAlert?.("amount must be >= 0.");
        return;
      }
      amt = n;
    }

    try {
      await apiCall(`/habits/${habit._id}/logs/${log._id}`, {
        method: "PUT",
        body: JSON.stringify({
          startedAt: s.toISOString(),
          endedAt: e ? e.toISOString() : null,
          amount: amt === undefined ? "" : amt,
        }),
      });

      tg?.showPopup?.({ message: "Log updated" });
      onSaved?.();
      onClose?.();
    } catch (e2) {
      tg?.showAlert?.(`Failed to update log: ${e2?.message || String(e2)}`);
    }
  };

  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal" onClick={(e) => e.stopPropagation()}>
        <div className="modal-header">
          <h2>Edit Log</h2>
          <button className="modal-close" onClick={onClose} type="button">×</button>
        </div>

        <div className="modal-body">
          <div className="form-group">
            <label className="form-label">Started At</label>
            <input
              type="datetime-local"
              className="form-input"
              value={startedAt}
              onChange={(e) => setStartedAt(e.target.value)}
            />
          </div>

          <div className="form-group">
            <label className="form-label">Ended At (optional)</label>
            <input
              type="datetime-local"
              className="form-input"
              value={endedAt}
              onChange={(e) => setEndedAt(e.target.value)}
            />
          </div>

          <div className="form-group">
            <label className="form-label">Amount (optional)</label>
            <input
              type="number"
              min="0"
              className="form-input"
              value={amount}
              onChange={(e) => setAmount(e.target.value)}
              placeholder={isSessionsUnit(unit) ? "Leave empty for sessions-only" : `Amount in ${unit}`}
            />
          </div>
        </div>

        <div className="modal-actions">
          <button className="btn btn-secondary" type="button" onClick={onClose}>Cancel</button>
          <button className="btn btn-primary" type="button" onClick={save}>Save</button>
        </div>
      </div>
    </div>
  );
}


// Habits View
function HabitsView({ activeView, userTimezone, userDisplayName, onBack }) {
  const [habits, setHabits] = useState([]);
  const [loading, setLoading] = useState(true);

  const [includePaused, setIncludePaused] = useState(false);
  const [cadenceFilter, setCadenceFilter] = useState("all");

  const [showEditor, setShowEditor] = useState(false);
  const [editingHabit, setEditingHabit] = useState(null);

  const [showLogModal, setShowLogModal] = useState(false);
  const [logHabit, setLogHabit] = useState(null);

  const [showLogsModal, setShowLogsModal] = useState(false);
  const [logsHabit, setLogsHabit] = useState(null);

  const loadHabits = async () => {
    try {
      setLoading(true);

      // IMPORTANT: keep the leading slash
      const url = `/habits${includePaused ? "?includePaused=1" : ""}`;

      // apiCall returns data (same as your books/reminders code)
      const data = await apiCall(url);

      // Your backend returns: { ok: true, habits }
      // But we don't rely on ok here; we just read habits safely.
      let list = Array.isArray(data?.habits) ? data.habits : [];

      if (cadenceFilter !== "all") {
        list = list.filter((h) => String(h?.cadence || "daily") === cadenceFilter);
      }

      setHabits(list);
    } catch (e) {
      tg?.showAlert?.(`Failed to load habits: ${e?.message || String(e)}`);
      setHabits([]);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    if (activeView === "habits") loadHabits();
  }, [activeView, includePaused, cadenceFilter]);

  const createHabit = () => {
    setEditingHabit(null);
    setShowEditor(true);
  };

  const editHabit = (h) => {
    setEditingHabit(h);
    setShowEditor(true);
  };

  const delHabit = async (h) => {
    try {
      await apiCall(`/habits/${h._id}`, { method: "DELETE" });
      tg?.showPopup?.({ message: "Habit deleted" });
      loadHabits();
    } catch (e) {
      tg?.showAlert?.(`Failed to delete habit: ${e?.message || String(e)}`);
    }
  };

  const togglePause = async (h) => {
    try {
      const next = String(h.status) === "paused" ? "active" : "paused";
      await apiCall(`/habits/${h._id}`, {
        method: "PUT",
        body: JSON.stringify({ status: next }),
      });
      tg?.showPopup?.({ message: next === "paused" ? "Paused" : "Resumed" });
      loadHabits();
    } catch (e) {
      tg?.showAlert?.(`Failed to update habit: ${e?.message || String(e)}`);
    }
  };

  const openLog = (h) => {
    setLogHabit(h);
    setShowLogModal(true);
  };

  const openLogs = (h) => {
    setLogsHabit(h);
    setShowLogsModal(true);
  };

  return (
    <div>
      <div className="header">
        <div>
          <h1>Habits</h1>
          {(() => {
            const name = (userDisplayName || "").trim();
            return name ? <div className="reminders-greeting">Hello {name}</div> : null;
          })()}
        </div>

        <div className="habits-header-actions">
          <button className="btn btn-secondary" type="button" onClick={onBack}>
            Back
          </button>
          <button className="btn btn-primary" type="button" onClick={createHabit}>
            New
          </button>
        </div>
      </div>

      <div className="quick-actions">
        <div
          className={`quick-action ${cadenceFilter === "all" ? "active" : ""}`}
          onClick={() => setCadenceFilter("all")}
        >
          All
        </div>
        <div
          className={`quick-action ${cadenceFilter === "daily" ? "active" : ""}`}
          onClick={() => setCadenceFilter("daily")}
        >
          Daily
        </div>
        <div
          className={`quick-action ${cadenceFilter === "weekly" ? "active" : ""}`}
          onClick={() => setCadenceFilter("weekly")}
        >
          Weekly
        </div>

        <div
          className={`quick-action ${includePaused ? "active" : ""}`}
          onClick={() => setIncludePaused((v) => !v)}
          style={{ marginLeft: "auto" }}
        >
          Include Paused
        </div>
      </div>

      {loading ? (
        <div className="loading">
          <div className="spinner" />
          <div>Loading habits...</div>
        </div>
      ) : habits.length === 0 ? (
        <div className="empty-state">
          <div className="empty-state-text">No habits yet. Tap New.</div>
          <div className="empty-state-icon">
            <img src="/icons/habits.svg" alt="" />
          </div>
        </div>
      ) : (
        habits.map((h) => (
          <HabitCard
            key={h._id}
            habit={h}
            onEdit={editHabit}
            onDelete={delHabit}
            onTogglePause={togglePause}
            onOpenLog={openLog}
            onOpenLogs={openLogs}
          />
        ))
      )}

      <button className="is-hidden" data-create-habit="1" onClick={createHabit} />

      {showEditor ? (
        <HabitEditorModal
          initialHabit={editingHabit}
          userTimezone={userTimezone}
          onClose={() => setShowEditor(false)}
          onSaved={loadHabits}
        />
      ) : null}

      {showLogModal && logHabit ? (
        <HabitLogModal
          habit={logHabit}
          onClose={() => setShowLogModal(false)}
          onCreated={loadHabits}
        />
      ) : null}

      {showLogsModal && logsHabit ? (
        <HabitLogsModal habit={logsHabit} onClose={() => setShowLogsModal(false)} />
      ) : null}
    </div>
  );
}


// Book Card Component
function BookCard({ book, onEdit, onDelete }) {
  const [expanded, setExpanded] = useState(false);

  const title = book.title?.trim() ? book.title.trim() : "(untitled)";
  const author = book.author?.trim() ? book.author.trim() : "";
  const badge = badgeForStatus(book.status);

  const isReading = String(book.status || "").toLowerCase() === "reading";

  const totalPages =
    typeof book.totalPages === "number" && Number.isFinite(book.totalPages)
      ? book.totalPages
      : null;

  const currentPage =
    typeof book.currentPage === "number" && Number.isFinite(book.currentPage)
      ? book.currentPage
      : null;

  const hasProgress = isReading && totalPages && totalPages > 0;

  const safeCurrent = hasProgress
    ? Math.min(Math.max(currentPage || 0, 0), totalPages)
    : 0;

  const pct = hasProgress ? Math.round((safeCurrent / totalPages) * 100) : null;

  return (
    <div className="card" onClick={() => setExpanded(!expanded)}>
      <div className="card-header">
        <div>
          <div style={{ fontSize: 16, fontWeight: 700, marginBottom: 6 }}>
            {title}
          </div>

          {author && (
            <div className="card-time">
              <img src="/icons/user.svg" alt="" />
              <span>{author}</span>
            </div>
          )}
        </div>
   
        <span className="card-badge" style={{ background: badge.bg, color: badge.fg }}>
  {String(book.status || "").toLowerCase() === "finished" && (
    <img src="/icons/check.svg" alt="" className="badge-icon" />
  )}
  {badge.text}
</span>

      </div>
      
      {book.shortSummary && (
  <div className="book-summary">
    {book.shortSummary}
  </div>
)}

      {hasProgress && (
        <div className="progress-wrap" onClick={(e) => e.stopPropagation()}>
          <div className="progress-top">
            <div>
              {safeCurrent} / {totalPages} pages
            </div>
            <div className="progress-pct">{pct}%</div>
          </div>

          <div className="progress-bar" aria-label="Reading progress">
            <div className="progress-fill" style={{ width: `${pct}%` }} />
          </div>
        </div>
      )}

      {expanded && (
        <div className="card-actions" onClick={(e) => e.stopPropagation()}>
          <button className="btn btn-primary" onClick={() => onEdit(book)}>
            <img src="/icons/pencil.svg" alt="" />
            Edit
          </button>

          <button className="btn btn-danger" onClick={() => onDelete(book._id)}>
            <img src="/icons/trash.svg" alt="" />
          </button>
        </div>
      )}
    </div>
  );
}

// Book Create & Edit Modal
function BookModal({ book, onClose, onSave, onDelete }) {
  const isEdit = !!book?._id;

  const [title, setTitle] = useState(book?.title || "");
  const [author, setAuthor] = useState(book?.author || "");
  const [status, setStatus] = useState(book?.status || "tbr");
  const [shortSummary, setShortSummary] = useState(book?.shortSummary || "");

  // New: progress fields (optional)
  const [totalPages, setTotalPages] = useState(
    typeof book?.totalPages === "number" ? String(book.totalPages) : ""
  );
  const [currentPage, setCurrentPage] = useState(
    typeof book?.currentPage === "number" ? String(book.currentPage) : ""
  );

  const isReading = String(status || "").toLowerCase() === "reading";

  useEffect(() => {
    document.body.classList.add("modal-open");
    return () => document.body.classList.remove("modal-open");
  }, []);

  // If user changes away from reading, clear progress (keeps UI consistent)
  useEffect(() => {
    if (!isReading) {
      setTotalPages("");
      setCurrentPage("");
    }
  }, [isReading]);

  const handleSave = async () => {
    if (!title.trim()) {
      tg.showAlert("Please enter a title");
      return;
    }

    // Build payload
    const payload = {
      title: title.trim(),
      author: author.trim(),
      status: statusLabelToValue(status),
    };
    
       // Add Summary
        if (shortSummary.trim()) {
  payload.shortSummary = shortSummary.trim();
}

    // Only include progress if reading
    if (isReading) {
      const tp = totalPages === "" ? null : Number(totalPages);
      const cp = currentPage === "" ? null : Number(currentPage);

      if (tp !== null && (!Number.isFinite(tp) || tp < 1)) {
        tg.showAlert("Total pages must be a positive number.");
        return;
      }

      if (cp !== null && (!Number.isFinite(cp) || cp < 0)) {
        tg.showAlert("Current page must be 0 or more.");
        return;
      }

      // Clamp if both provided
      let safeTp = tp;
      let safeCp = cp;

      if (safeTp !== null && safeTp > 0 && safeCp !== null) {
        safeCp = Math.min(Math.max(safeCp, 0), safeTp);
      }

      payload.totalPages = safeTp;
      payload.currentPage = safeCp;
    }

    await onSave(payload);
  };

  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal" onClick={(e) => e.stopPropagation()}>
        <div className="modal-header">
          <h2>{isEdit ? "Edit Book" : "New Book"}</h2>
          <button className="modal-close" onClick={onClose}>×</button>
        </div>

        <div className="modal-body">
          <div className="form-group">
            <label className="form-label">Title</label>
            <input
              className="form-input"
              value={title}
              onChange={(e) => setTitle(e.target.value)}
              placeholder="Book title..."
            />
          </div>

          <div className="form-group">
            <label className="form-label">Author (optional)</label>
            <input
              className="form-input"
              value={author}
              onChange={(e) => setAuthor(e.target.value)}
              placeholder="Author name..."
            />
          </div>
          
          <div className="form-group">
  <label className="form-label">Short Summary (optional)</label>
  <textarea
    className="form-textarea form-textarea--sm"
    value={shortSummary}
    onChange={(e) => setShortSummary(e.target.value)}
    placeholder="One or two short sentences about this book…"
    maxLength={180}
  />
</div>

          <div className="form-group">
            <label className="form-label">Status</label>
            <select
              className="form-select"
              value={status}
              onChange={(e) => setStatus(e.target.value)}
            >
              <option value="tbr">TBR</option>
              <option value="reading">Reading/Active</option>
              <option value="finished">Finished</option>
            </select>
          </div>

          {isReading && (
            <div className="form-row">
              <div className="form-group">
                <label className="form-label">Total Pages</label>
                <input
                  type="number"
                  className="form-input"
                  value={totalPages}
                  min="1"
                  onChange={(e) => setTotalPages(e.target.value)}
                  placeholder="e.g. 384"
                />
              </div>

              <div className="form-group">
                <label className="form-label">Current Page</label>
                <input
                  type="number"
                  className="form-input"
                  value={currentPage}
                  min="0"
                  onChange={(e) => setCurrentPage(e.target.value)}
                  placeholder="e.g. 120"
                />
              </div>
            </div>
          )}
        </div>

        <div className="modal-actions">
          {isEdit ? (
            <button className="btn btn-danger" onClick={() => onDelete(book._id)}>
              Delete
            </button>
          ) : (
            <button className="btn btn-secondary" onClick={onClose}>
              Cancel
            </button>
          )}

          <button className="btn btn-primary" onClick={handleSave}>
            {isEdit ? "Update" : "Create"}
          </button>
        </div>
      </div>
    </div>
  );
}

// Book Summary Modal
function SummaryModal({ onClose, title, author, loading, summary, source, error, onSearchAgain }) {
  useEffect(() => {
    document.body.classList.add("modal-open");
    return () => document.body.classList.remove("modal-open");
  }, []);

  const headerTitle = "Summary";

  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal" onClick={(e) => e.stopPropagation()}>
        <div className="modal-header">
          <h2>{headerTitle}</h2>
          <button className="modal-close" onClick={onClose}>×</button>
        </div>

        <div className="modal-body">
          <div style={{ marginBottom: 12, opacity: 0.85, lineHeight: 1.4 }}>
            <div style={{ fontWeight: 700 }}>{title || "Untitled"}</div>
            {author ? <div style={{ color: "var(--text-secondary)" }}>{author}</div> : null}
          </div>

          {loading ? (
            <div className="loading">
              <div className="spinner" />
              <div>Searching…</div>
            </div>
          ) : error ? (
            <div className="empty-state-text">{error}</div>
          ) : summary ? (
            <div style={{ whiteSpace: "pre-line", lineHeight: 1.6, fontSize: 15 }}>
              {summary}
              {source ? (
                <div style={{ marginTop: 14, fontSize: 12, color: "var(--text-secondary)" }}>
                  Source: {source}
                </div>
              ) : null}
            </div>
          ) : (
            <div className="empty-state-text">No summary to show.</div>
          )}
        </div>

        <div className="modal-actions">
          <button className="btn btn-secondary" onClick={onClose}>
            Close
          </button>

          <button className="btn btn-primary" onClick={onSearchAgain} disabled={loading}>
            Search Again
          </button>
        </div>
      </div>
    </div>
  );
}

// READING STREAKS CARD
function ReadingStreakCard({ streak, loading, onCheckIn }) {
  const current = streak?.currentStreak ?? 0;
  const best = streak?.bestStreak ?? 0;
  const checked = !!streak?.checkedInToday;

  return (
    <div className="card" onClick={(e) => e.stopPropagation()} style={{ cursor: "default" }}>
      <div className="card-header">
        <div>
          <div style={{ fontSize: 16, fontWeight: 800, marginBottom: 6 }}>
            Reading Streak
          </div>
          <div className="card-time">
            <img src="/icons/cal.svg" alt="" />
            <span>{checked ? "Checked in today" : "Not checked in today"}</span>
          </div>
        </div>

        <span
          className="card-badge"
          style={{
            background: checked ? "rgba(76,175,80,0.15)" : "rgba(255,152,0,0.15)",
            color: checked ? "#4caf50" : "#ff9800",
          }}
        >
          {checked ? "ACTIVE" : "PENDING"}
        </span>
      </div>

      <div className="streak-row">
        <div className="streak-stat">
          <div className="streak-stat-label">Current</div>
          <div className="streak-stat-value">{current}</div>
        </div>

        <div className="streak-stat">
          <div className="streak-stat-label">Best</div>
          <div className="streak-stat-value">{best}</div>
        </div>
      </div>

      <div className="streak-actions">
        <button
          className="btn btn-success"
          type="button"
          onClick={onCheckIn}
          disabled={loading || checked}
        >
          <img src="/icons/check.svg" alt="" />
          {checked ? "Checked In" : loading ? "Saving…" : "Check In"}
        </button>
      </div>
    </div>
  );
}

// Reading View
function ReadingView({ activeView }) {
  const [books, setBooks] = useState([]);
  const [loading, setLoading] = useState(true);

  const [filter, setFilter] = useState("all"); // all | tbr | reading | finished

  const [showBookModal, setShowBookModal] = useState(false);
  const [editingBook, setEditingBook] = useState(null);

  const [summaryOpen, setSummaryOpen] = useState(false);
  const [summaryLoading, setSummaryLoading] = useState(false);
  const [summaryText, setSummaryText] = useState("");
  const [summarySource, setSummarySource] = useState("");
  const [summaryError, setSummaryError] = useState("");
  const [summaryTitle, setSummaryTitle] = useState("");
  const [summaryAuthor, setSummaryAuthor] = useState("");
  
  const [streak, setStreak] = useState(null);
const [streakLoading, setStreakLoading] = useState(false);

  useEffect(() => {
  if (activeView === "reading") {
    loadBooks();
    loadStreak();
  }
}, [activeView, filter]);

const loadStreak = async () => {
  try {
    setStreakLoading(true);
    const data = await apiCall(`/books/streak`);
    setStreak(data?.streak || null);
  } catch (error) {
    // silent-ish; streak card can just not show if needed
    setStreak(null);
  } finally {
    setStreakLoading(false);
  }
};

const handleCheckIn = async (e) => {
  if (e) e.stopPropagation();
  try {
    setStreakLoading(true);
    const data = await apiCall(`/books/streak/checkin`, {
      method: "POST",
      body: JSON.stringify({}),
    });
    setStreak(data?.streak || null);
    tg.showPopup({ message: "Checked in" });
  } catch (error) {
    tg.showAlert("Failed to check in: " + error.message);
  } finally {
    setStreakLoading(false);
  }
};

  const loadBooks = async () => {
    try {
      setLoading(true);
      const data = await apiCall(`/books?status=${encodeURIComponent(filter)}`);
      setBooks(Array.isArray(data.books) ? data.books : []);
    } catch (error) {
      tg.showAlert("Failed to load books: " + error.message);
    } finally {
      setLoading(false);
    }
  };

  const handleCreate = () => {
    setEditingBook(null);
    setShowBookModal(true);
  };

  const handleEdit = (book) => {
    setEditingBook(book);
    setShowBookModal(true);
  };

  const handleSave = async (payload) => {
    try {
      if (editingBook?._id) {
        await apiCall(`/books/${editingBook._id}`, {
          method: "PUT",
          body: JSON.stringify(payload),
        });
        tg.showAlert("Book updated!");
      } else {
        await apiCall(`/books`, {
          method: "POST",
          body: JSON.stringify(payload),
        });
        tg.showAlert("Book added!");
      }

      setShowBookModal(false);
      loadBooks();
    } catch (error) {
      tg.showAlert("Failed to save: " + error.message);
    }
  };

  const handleDelete = async (id) => {
    try {
      await apiCall(`/books/${id}`, { method: "DELETE" });
      tg.showPopup({ message: "Book deleted" });
      loadBooks();
    } catch (error) {
      tg.showAlert("Failed to delete: " + error.message);
    }
  };

  const promptSummarySearch = async () => {
    const t = window.prompt("Book title:");
    if (!t || !t.trim()) return;

    const a = window.prompt("Author (optional):") || "";

    await runSummarySearch(t.trim(), a.trim());
  };

  const runSummarySearch = async (title, author) => {
    try {
      setSummaryTitle(title);
      setSummaryAuthor(author);

      setSummaryOpen(true);
      setSummaryLoading(true);
      setSummaryText("");
      setSummarySource("");
      setSummaryError("");

      const data = await apiCall(`/books/summary`, {
        method: "POST",
        body: JSON.stringify({ title, author }),
      });

      setSummaryText(String(data.summary || ""));
      setSummarySource(String(data.source || ""));
    } catch (error) {
      setSummaryError(error.message || "No summary found.");
    } finally {
      setSummaryLoading(false);
    }
  };

  return (
    <div>
      <div className="header">
        <h1>Reading</h1>

        <div className="journal-header-actions">
          <button className="btn btn-prompt" type="button" onClick={promptSummarySearch}>
            Summary
          </button>
        </div>
      </div>
      
      <ReadingStreakCard
  streak={streak}
  loading={streakLoading}
  onCheckIn={handleCheckIn}
/>

      <div className="quick-actions">
        <div
          className={`quick-action ${filter === "all" ? "active" : ""}`}
          onClick={() => setFilter("all")}
        >
          All
        </div>
        <div
          className={`quick-action ${filter === "tbr" ? "active" : ""}`}
          onClick={() => setFilter("tbr")}
        >
          TBR
        </div>
        <div
          className={`quick-action ${filter === "reading" ? "active" : ""}`}
          onClick={() => setFilter("reading")}
        >
          Reading
        </div>
        <div
          className={`quick-action ${filter === "finished" ? "active" : ""}`}
          onClick={() => setFilter("finished")}
        >
          Finished
        </div>
      </div>

      {loading ? (
        <div className="loading">
          <div className="spinner" />
          <div>Loading books...</div>
        </div>
      ) : books.length === 0 ? (
        <div className="empty-state">
          <div className="empty-state-icon">
            <img src="/icons/book.svg" alt="" />
          </div>
          <div className="empty-state-text">
            No books yet.
            {"\n"}Tap + to add one.
          </div>
        </div>
      ) : (
        books.map((book) => (
          <BookCard key={book._id} book={book} onEdit={handleEdit} onDelete={handleDelete} />
        ))
      )}

      {/* Hidden FAB hook */}
      <button
        className="is-hidden"
        data-create-book="1"
        onClick={handleCreate}
      />

      {showBookModal && (
        <BookModal
          book={editingBook}
          onClose={() => setShowBookModal(false)}
          onSave={handleSave}
          onDelete={handleDelete}
        />
      )}

      {summaryOpen && (
        <SummaryModal
          onClose={() => setSummaryOpen(false)}
          title={summaryTitle}
          author={summaryAuthor}
          loading={summaryLoading}
          summary={summaryText}
          source={summarySource}
          error={summaryError}
          onSearchAgain={promptSummarySearch}
        />
      )}
    </div>
  );
}

// Journal Card Component
function JournalCard({ entry, onView, onEdit, onDelete, onTagSelect }) {
  const [expanded, setExpanded] = useState(false);

  const title = entry.title?.trim() ? entry.title.trim() : '(untitled)';
  const tags = Array.isArray(entry.tags) ? entry.tags : [];
  const body = entry.body || '';

  const preview = body.length > 260 ? body.slice(0, 260) + '…' : body;

  return (
<div className="card" onClick={() => onView(entry)}>
      <div className="card-header">
        <div>
          <div style={{ fontSize: 16, fontWeight: 700, marginBottom: 6 }}>
            {title}
          </div>
          <div className="card-time">
  <img src="/icons/cal.svg" alt="" />
  <span>{formatShortDate(entry.createdAt)}</span>
</div>
        </div>

        <span className="card-badge" style={{ background: 'rgba(139,125,239,0.15)', color: '#8b7def' }}>
          journal
        </span>
      </div>

      <div className="journal-preview">{preview}</div>

      {tags.length > 0 && (
  <div className="tag-row">
    {tags.map((t) => (
      <button
        key={t}
        type="button"
        className="tag-pill"
        onClick={(e) => {
          e.stopPropagation();               // don’t open the entry viewer
          if (onTagSelect) onTagSelect(t);   // filter by tag
        }}
      >
        #{t}
      </button>
    ))}
  </div>
)}

      {expanded && (
        <div className="card-actions" onClick={e => e.stopPropagation()} style={{ marginTop: 14 }}>
          <button className="btn btn-primary" onClick={() => onEdit(entry)}>
  <img src="/icons/pencil.svg" alt="" />
  Edit
</button>
          <button className="btn btn-danger" onClick={() => onDelete(entry._id)}>
  <img src="/icons/trash.svg" alt="" />
</button>
        </div>
      )}
    </div>
  );
}

// Journal Modal (Create/Edit)
function JournalModal({ entry, onClose, onSave, onDelete }) {
  const [title, setTitle] = useState(entry?.title || '');
  const [tagsText, setTagsText] = useState(tagsToDisplay(entry?.tags || []));
  const [body, setBody] = useState(entry?.body || '');

  const isEdit = !!entry?._id;
  
  useEffect(() => {
    document.body.classList.add('modal-open');
    return () => {
      document.body.classList.remove('modal-open');
    };
  }, []);

  const handleSave = async () => {
    if (!body.trim()) {
      tg.showAlert('Please enter a journal body');
      return;
    }

    const tags = normalizeTagsFromText(tagsText);

    await onSave({
      title: title.trim(),
      body,
      tags
    });
  };

  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal" onClick={e => e.stopPropagation()}>
        <div className="modal-header">
          <h2>{isEdit ? 'Edit Entry' : 'New Entry'}</h2>
          <button className="modal-close" onClick={onClose}>×</button>
        </div>

        <div className="modal-body">
          <div className="form-group">
            <label className="form-label">Title (optional)</label>
            <input
              type="text"
              className="form-input"
              value={title}
              onChange={e => setTitle(e.target.value)}
              placeholder="Title..."
            />
          </div>

          <div className="form-group">
            <label className="form-label">Tags</label>
            <input
              type="text"
              className="form-input"
              value={tagsText}
              onChange={e => setTagsText(e.target.value)}
              placeholder="#tag-1 #tag-2"
            />
          </div>

          <div className="form-group">
            <label className="form-label">Body</label>
            <textarea
              className="form-textarea"
              value={body}
              onChange={e => setBody(e.target.value)}
              placeholder="Write your entry..."
            />
          </div>
        </div>

        <div className="modal-actions">
          {isEdit ? (
            <button className="btn btn-danger" onClick={() => onDelete(entry._id)}>
              Delete
            </button>
          ) : (
            <button className="btn btn-secondary" onClick={onClose}>
              Cancel
            </button>
          )}

          <button className="btn btn-primary" onClick={handleSave}>
            {isEdit ? 'Update' : 'Create'}
          </button>
        </div>
      </div>
    </div>
  );
}

// TAGS VIEW 
function JournalTagsView({ onBack, onPickTag }) {
  const [loading, setLoading] = useState(true);
  const [tags, setTags] = useState([]);
  const [query, setQuery] = useState("");

  useEffect(() => {
    (async () => {
      try {
        setLoading(true);
        const data = await apiCall("/journal/tags");
        setTags(Array.isArray(data.tags) ? data.tags : []);
      } catch (e) {
        tg.showAlert("Failed to load tags: " + (e.message || "Unknown error"));
        setTags([]);
      } finally {
        setLoading(false);
      }
    })();
  }, []);

  const filtered = tags.filter((t) => {
    const name = String(t?.name || "");
    if (!query.trim()) return true;
    return name.includes(query.trim().toLowerCase());
  });

  return (
    <div>
      <div className="header">
        <h1>Tags</h1>

        <div className="journal-header-actions">
          <button className="btn btn-secondary" type="button" onClick={onBack}>
            Back
          </button>
        </div>
      </div>

      <div className="tags-search">
        <input
          className="form-input"
          value={query}
          onChange={(e) => setQuery(e.target.value)}
          placeholder="Search tags…"
        />
      </div>

      {loading ? (
        <div className="loading">
          <div className="spinner" />
          <div>Loading tags...</div>
        </div>
      ) : filtered.length === 0 ? (
        <div className="empty-state">
          <div className="empty-state-icon">
            <img src="/icons/tag.svg" alt="" />
          </div>
          <div className="empty-state-text">
            No tags found.
          </div>
        </div>
      ) : (
        <div className="tags-list">
          {filtered.map((t) => (
            <div
              key={t.name}
              className="tag-item"
              onClick={() => onPickTag(String(t.name || ""))}
            >
              <div className="tag-item-name">#{t.name}</div>
              <div className="tag-item-count">{t.count}</div>
            </div>
          ))}
        </div>
      )}
    </div>
  );
}


// Journals View
function JournalsView({ activeView, tagFilter, onOpenTags, onClearTag, onTagSelect }) {
  const [entries, setEntries] = useState([]);
  const [loading, setLoading] = useState(true);
  const [showModal, setShowModal] = useState(false);
  const [editingEntry, setEditingEntry] = useState(null);
  const [loadingMore, setLoadingMore] = useState(false);
const [cursor, setCursor] = useState(null); // ISO string (createdAt of last)
const [hasMore, setHasMore] = useState(true);

const [viewerEntry, setViewerEntry] = useState(null); // for read-only modal

const [promptModalOpen, setPromptModalOpen] = useState(false);
const [dailyPrompt, setDailyPrompt] = useState("");
const [promptRemaining, setPromptRemaining] = useState(null);
const [promptLoading, setPromptLoading] = useState(false);

const PAGE_SIZE = 10;

useEffect(() => {
  if (activeView === "journal") {
    loadFirstPage();
  }
}, [activeView, tagFilter]);

const loadFirstPage = async () => {
  try {
    setLoading(true);

    // reset pagination state
    setEntries([]);
    setCursor(null);
    setHasMore(true);

const tagParam = tagFilter ? `&tag=${encodeURIComponent(tagFilter)}` : "";
const data = await apiCall(`/journal?limit=${PAGE_SIZE}${tagParam}`);
    const list = data.entries || [];

    setEntries(list);

    if (list.length < PAGE_SIZE) {
      setHasMore(false);
      setCursor(null);
    } else {
      const last = list[list.length - 1];
      setCursor(last?.createdAt || null);
    }
  } catch (error) {
    tg.showAlert("Failed to load journal: " + error.message);
  } finally {
    setLoading(false);
  }
};

const loadMore = async () => {
  // guard rails
  if (activeView !== "journal") return;
  if (!hasMore) return;
  if (loadingMore) return;
  if (!cursor) return;

  try {
    setLoadingMore(true);

const tagParam = tagFilter ? `&tag=${encodeURIComponent(tagFilter)}` : "";
const data = await apiCall(
  `/journal?limit=${PAGE_SIZE}&before=${encodeURIComponent(cursor)}${tagParam}`
);
    const list = data.entries || [];

    // append (do NOT overwrite)
    setEntries((prev) => [...prev, ...list]);

    if (list.length < PAGE_SIZE) {
      setHasMore(false);
      setCursor(null);
    } else {
      const last = list[list.length - 1];
      setCursor(last?.createdAt || null);
    }
  } catch (error) {
    tg.showAlert("Failed to load more: " + error.message);
  } finally {
    setLoadingMore(false);
  }
};

  const handleCreate = () => {
    setEditingEntry(null);
    setShowModal(true);
  };

  const handleEdit = (entry) => {
    setEditingEntry(entry);
    setShowModal(true);
  };

  const handleSave = async (payload) => {
    try {
      if (editingEntry?._id) {
        await apiCall(`/journal/${editingEntry._id}`, {
          method: 'PUT',
          body: JSON.stringify(payload),
        });
        tg.showAlert('Entry updated!');
      } else {
        await apiCall(`/journal`, {
          method: 'POST',
          body: JSON.stringify(payload),
        });
        tg.showAlert('Entry created!');
      }
      setShowModal(false);
      loadFirstPage();
    } catch (error) {
      tg.showAlert('Failed to save: ' + error.message);
    }
  };

  const handleDelete = async (id) => {
    try {
      await apiCall(`/journal/${id}`, { method: 'DELETE' });
      tg.showPopup({ message: 'Entry deleted' });
      loadFirstPage();
    } catch (error) {
      tg.showAlert('Failed to delete: ' + error.message);
    }
  };
  
const handleGeneratePrompt = async () => {
  try {
    setPromptLoading(true);
    setDailyPrompt("");

    const data = await apiCall(`/journal/prompt`, {
      method: "POST",
      body: JSON.stringify({}),
    });

    setDailyPrompt(data.prompt || "");
    setPromptRemaining(
      typeof data.remaining === "number" ? data.remaining : null
    );
  } catch (error) {
    const msg = error?.message || "Failed to generate prompt";
    tg.showAlert(msg);
  } finally {
    setPromptLoading(false);
  }
};

  return (
    <div>
      <div className="header">
  <h1>Journal</h1>

  <div className="journal-header-actions">
    <button
      className="icon-btn"
      type="button"
      onClick={() => onOpenTags && onOpenTags()}
      aria-label="Tags"
      title="Tags"
    >
      <img src="/icons/tag.svg" alt="" />
    </button>

    <button
      className="btn btn-prompt"
      type="button"
      onClick={() => {
        setPromptModalOpen(true);
        handleGeneratePrompt();
      }}
    >
      Prompt
    </button>
  </div>
</div>
      
      {tagFilter ? (
  <div className="journal-filter-bar">
    <div className="journal-filter-left">
      <img src="/icons/tag.svg" alt="" />
      <div className="journal-filter-text">Filtered by #{tagFilter}</div>
    </div>

    <button className="journal-filter-clear" type="button" onClick={onClearTag}>
      Clear
    </button>
  </div>
) : null}

      {loading ? (
        <div className="loading">
          <div className="spinner" />
          <div>Loading journal...</div>
        </div>
      ) : entries.length === 0 ? (
        <div className="empty-state">
          <div className="empty-state-icon">
  <img src="/icons/edit.svg" alt="" />
</div>
          <div className="empty-state-text">
            No journal entries yet.
            {"\n"}Tap + to create one.
          </div>
        </div>
      ) : (
        <>
          {entries.map((entry) => (
  <JournalCard
    key={entry._id}
    entry={entry}
    onView={(e) => setViewerEntry(e)}
    onEdit={handleEdit}
    onDelete={handleDelete}
    onTagSelect={onTagSelect}
  />
))}

          {hasMore && (
            <div className="load-more-container">
              <button
                className="btn btn-secondary load-more-btn"
                onClick={loadMore}
                disabled={loadingMore}
              >
                {loadingMore ? "Loading…" : "Load more"}
              </button>
            </div>
          )}
        </>
      )}

{viewerEntry && (
  <JournalPreviewModal
    entry={viewerEntry}
    onClose={() => setViewerEntry(null)}
    onEdit={(entry) => {
      setViewerEntry(null);
      setEditingEntry(entry);
      setShowModal(true);
    }}
    onDelete={handleDelete}
    onTagSelect={onTagSelect}
  />
)}

<button
  className="is-hidden"
  data-create-journal="1"
  onClick={() => {
    setViewerEntry(null);      // optional but nice: closes preview if open
    setEditingEntry(null);
    setShowModal(true);
  }}
/>

      {showModal && (
        <JournalModal
          entry={editingEntry}
          onClose={() => setShowModal(false)}
          onSave={handleSave}
          onDelete={handleDelete}
        />
      )}
      
      {promptModalOpen && (
  <PromptModal 
    onClose={() => setPromptModalOpen(false)}
    onGenerate={handleGeneratePrompt}
    prompt={dailyPrompt}
    remaining={promptRemaining}
    loading={promptLoading}
  />
)}
      
    </div>
  );
}

// Journal Preview Modal
function JournalPreviewModal({ entry, onClose, onEdit, onDelete, onTagSelect }) {
  if (!entry) return null;
  
  useEffect(() => {
    document.body.classList.add('modal-open');
    return () => {
      document.body.classList.remove('modal-open');
    };
  }, []);

  const created = entry.createdAt ? new Date(entry.createdAt) : null;
  const dateStr = created
    ? created.toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" })
    : "";

  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal" onClick={(e) => e.stopPropagation()}>
        <div className="modal-header">
          <h2>{entry.title?.trim() ? entry.title : "Journal Entry"}</h2>
          <button className="modal-close" onClick={onClose}>×</button>
        </div>

        <div className="modal-body">
          {dateStr && (
            <div className="card-time" style={{ marginBottom: 12 }}>
  <img src="/icons/cal.svg" alt="" />
  <span>{dateStr}</span>
</div>
          )}

          <div style={{ whiteSpace: "pre-line", lineHeight: 1.6, fontSize: 15 }}>
            {entry.body}
          </div>

          {Array.isArray(entry.tags) && entry.tags.length > 0 && (
  <div className="tag-row">
    {entry.tags.map((t) => (
      <button
        key={t}
        type="button"
        className="tag-pill"
        onClick={(e) => {
          e.stopPropagation();              // keep modal click behavior clean
          if (onTagSelect) onTagSelect(t);  // apply filter
          onClose();                        // optional: close the preview after selecting a tag
        }}
      >
        #{t}
      </button>
    ))}
  </div>
)}
        </div>

        <div className="modal-actions journal-preview-actions">
  <button className="btn btn-primary" onClick={() => onEdit(entry)}>
    Edit
  </button>

  <button className="btn btn-secondary" onClick={onClose}>
    Close
  </button>

  <button
    className="btn btn-danger"
    type="button"
    onClick={() => {
      if (!entry?._id) return;
      onDelete(entry._id);
      onClose(); // close the preview modal immediately after delete
    }}
  >
    Delete
  </button>
</div>
      </div>
    </div>
  );
}

// Prompt Modal
function PromptModal({ onClose, onGenerate, prompt, remaining, loading }) {
  useEffect(() => {
    document.body.classList.add('modal-open');
    return () => {
      document.body.classList.remove('modal-open');
    };
  }, []);

  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal" onClick={(e) => e.stopPropagation()}>
        <div className="modal-header">
          <h2>Prompt</h2>
          <button
            className="modal-close"
            onClick={onClose}
            type="button"
          >
            ×
          </button>
        </div>

        <div className="modal-body">
          {loading ? (
            <div className="loading">
              <div className="spinner" />
              <div>Generating…</div>
            </div>
          ) : prompt ? (
            <>
              <div className="journal-prompt-text">{prompt}</div>

              {typeof remaining === "number" && (
                <div className="journal-prompt-meta">
                  Remaining today: {remaining}
                </div>
              )}
            </>
          ) : (
            <div className="empty-state-text">Tap Prompt to generate.</div>
          )}
        </div>

        <div className="modal-actions">
          <button
            className="btn btn-secondary"
            onClick={onClose}
            type="button"
          >
            Close
          </button>

          <button
            className="btn btn-primary"
            onClick={onGenerate}
            disabled={loading}
            type="button"
          >
            Generate Again
          </button>
        </div>
      </div>
    </div>
  );
}

    // Reminder Card Component
    function ReminderCard({ reminder, onEdit, onSnooze, onDone, onDelete }) {
      const [expanded, setExpanded] = useState(false);

      const getBadgeClass = () => {
        const kind = reminder.schedule?.kind || 'once';
        return `card-badge badge-${kind}`;
      };

      return (
        <div className="card" onClick={() => setExpanded(!expanded)}>
          <div className="card-header">
            <div className="card-time">
  <img src="/icons/alarm.svg" alt="" />
  <span>{formatDateTime(reminder.nextRunAt)}</span>
</div>
            <span className={getBadgeClass()}>
              {reminder.schedule?.kind || 'once'}
            </span>
          </div>

          <div className="card-text">{reminder.text}</div>

          {expanded && (
            <div className="card-actions" onClick={e => e.stopPropagation()}>
              <button className="btn btn-primary" onClick={() => onEdit(reminder)}>
  <img src="/icons/pencil.svg" alt="" />
  Edit
</button>
              <button className="btn btn-secondary" onClick={() => onSnooze(reminder._id, 15)}>
  <img src="/icons/alarm.svg" alt="" />
  15m
</button>
              <button className="btn btn-secondary" onClick={() => onSnooze(reminder._id, 60)}>
  <img src="/icons/alarm.svg" alt="" />
  1h
</button>
              <button className="btn btn-success" onClick={() => onDone(reminder._id)}>
  <img src="/icons/check.svg" alt="" />
  Done
</button>
              <button className="btn btn-danger" onClick={() => onDelete(reminder._id)}>
  <img src="/icons/trash.svg" alt="" />
</button>
            </div>
          )}
        </div>
      );
    }

// Reminder Modal
function ReminderModal({ reminder, onClose, onSave, userTimezone }) {
  const [text, setText] = React.useState(reminder?.text || "");
  const [date, setDate] = React.useState("");
  const [time, setTime] = React.useState("");

  const [scheduleKind, setScheduleKind] = React.useState(reminder?.schedule?.kind || "once");
  const [intervalMinutes, setIntervalMinutes] = React.useState(
    reminder?.schedule?.intervalMinutes || 30
  );

  // Weekly day picker state (Sun=0..Sat=6)
  const [weeklyDays, setWeeklyDays] = React.useState([]);

  // Monthly day-of-month (1..31)
  const [monthlyDay, setMonthlyDay] = React.useState(1);
  
    // NEW: yearly picker state
  const [yearlyMonth, setYearlyMonth] = React.useState(1); // 1..12
  const [yearlyDay, setYearlyDay] = React.useState(1);     // 1..31

  React.useEffect(() => {
    document.body.classList.add("modal-open");
    return () => document.body.classList.remove("modal-open");
  }, []);

  React.useEffect(() => {
    if (reminder) {
      const d = new Date(reminder.nextRunAt);
      setDate(d.toISOString().split("T")[0]);
      setTime(d.toTimeString().slice(0, 5));

      const k = reminder?.schedule?.kind || "once";
      setScheduleKind(k);

      // Interval
      if (k === "interval") {
        const mins = Number(reminder?.schedule?.intervalMinutes ?? 30);
        setIntervalMinutes(Number.isFinite(mins) && mins > 0 ? mins : 30);
      }

      // Weekly
      if (k === "weekly") {
        const days = reminder?.schedule?.daysOfWeek;
        if (Array.isArray(days) && days.length) {
          setWeeklyDays(
            days
              .map((n) => Number(n))
              .filter((n) => Number.isFinite(n) && n >= 0 && n <= 6)
          );
        } else {
          setWeeklyDays([d.getDay()]);
        }
      } else {
        // keep weeklyDays sensible if user switches to weekly
        setWeeklyDays([d.getDay()]);
      }

      // Monthly (use schedule.dayOfMonth if present, else default to chosen date's day)
      if (k === "monthly") {
        const dom = Number(reminder?.schedule?.dayOfMonth);
        const fallbackDom = d.getDate();
        const normalized = Number.isFinite(dom) && dom >= 1 && dom <= 31 ? dom : fallbackDom;
        setMonthlyDay(normalized);
      } else {
        // keep monthlyDay sensible if user switches to monthly
        setMonthlyDay(d.getDate());
      }
      
            // Prefill yearly anchors (fallback to nextRunAt month/day)
      const sched = reminder?.schedule;
      if (sched?.kind === "yearly") {
        const m = Number(sched.anchorMonth);
        const day = Number(sched.anchorDay);

        setYearlyMonth(Number.isFinite(m) && m >= 1 && m <= 12 ? m : (d.getMonth() + 1));
        setYearlyDay(Number.isFinite(day) && day >= 1 && day <= 31 ? day : d.getDate());
      } else {
        // if not yearly, still set sane defaults from the chosen date
        setYearlyMonth(d.getMonth() + 1);
        setYearlyDay(d.getDate());
      }
    } else {
      // Creating a new reminder
      const now = new Date();
      setDate(now.toISOString().split("T")[0]);
      setTime("09:00");
      setScheduleKind("once");
      setIntervalMinutes(30);
      setWeeklyDays([now.getDay()]);
      setMonthlyDay(now.getDate());
      setYearlyMonth(now.getMonth() + 1);
      setYearlyDay(now.getDate());
    }
  }, [reminder]);

  const weekdayLabels = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];

  const toggleWeekday = (idx) => {
    setWeeklyDays((prev) => {
      const set = new Set(Array.isArray(prev) ? prev : []);
      if (set.has(idx)) set.delete(idx);
      else set.add(idx);
      return Array.from(set).sort((a, b) => a - b);
    });
  };

const handleSave = async () => {
  if (!text.trim()) {
    tg.showAlert("Please enter a message");
    return;
  }

  const zone = userTimezone || "America/Chicago";

  // Build a UTC ISO timestamp from the chosen local date+time.
  // Schedule determines repeats after the first run.
  const nextRunAt = DateTime.fromISO(`${date}T${time}`, { zone }).toUTC().toISO();

  let schedule;

  if (scheduleKind === "once") {
    schedule = { kind: "once" };

  } else if (scheduleKind === "daily") {
    schedule = { kind: "daily", timeOfDay: time };

  } else if (scheduleKind === "weekly") {
    const chosenWeekday = new Date(`${date}T00:00:00`).getDay(); // 0..6
    const days = Array.isArray(weeklyDays)
      ? weeklyDays
          .map((n) => Number(n))
          .filter((n) => Number.isFinite(n) && n >= 0 && n <= 6)
      : [];

    schedule = {
      kind: "weekly",
      timeOfDay: time,
      daysOfWeek: days.length ? Array.from(new Set(days)) : [chosenWeekday],
    };

  } else if (scheduleKind === "monthly") {
    // If user leaves it blank or invalid, default to day-of-month from chosen date.
    const fallbackDom = new Date(`${date}T00:00:00`).getDate();
    const dom = Number(monthlyDay);

    const normalizedDom =
      Number.isFinite(dom) && dom >= 1 && dom <= 31 ? Math.trunc(dom) : fallbackDom;

    schedule = {
      kind: "monthly",
      timeOfDay: time,
      dayOfMonth: normalizedDom, // matches your API
    };

  } else if (scheduleKind === "yearly") {
    const m = Number(yearlyMonth);
    const day = Number(yearlyDay);

    if (!Number.isFinite(m) || m < 1 || m > 12) {
      tg.showAlert("Please choose a valid month.");
      return;
    }
    if (!Number.isFinite(day) || day < 1 || day > 31) {
      tg.showAlert("Please choose a valid day (1-31).");
      return;
    }

    schedule = {
      kind: "yearly",
      timeOfDay: time,
      anchorMonth: m,
      anchorDay: day,
    };

  } else if (scheduleKind === "interval") {
    const mins = Number(intervalMinutes);
    if (!Number.isFinite(mins) || mins <= 0) {
      tg.showAlert("Please enter a valid interval in minutes.");
      return;
    }
    schedule = { kind: "interval", intervalMinutes: Math.trunc(mins) };

  } else {
    // safety fallback (should never happen)
    schedule = { kind: "once" };
  }

  await onSave({
    text,
    nextRunAt,
    schedule,
    timezone: zone,
  });
};

  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal" onClick={(e) => e.stopPropagation()}>
        <div className="modal-header">
          <h2>{reminder ? "Edit Reminder" : "New Reminder"}</h2>
          <button className="modal-close" onClick={onClose} type="button">
            ×
          </button>
        </div>

        <div className="modal-body">
          <div className="form-group">
            <label className="form-label">Message</label>
            <textarea
              className="form-textarea"
              value={text}
              onChange={(e) => setText(e.target.value)}
              placeholder="What do you want to be reminded about?"
            />
          </div>

          <div className="form-row">
            <div className="form-group">
              <label className="form-label">Date</label>
              <input
                type="date"
                className="form-input"
                value={date}
                onChange={(e) => setDate(e.target.value)}
              />
            </div>

            <div className="form-group">
              <label className="form-label">Time</label>
              <input
                type="time"
                className="form-input"
                value={time}
                onChange={(e) => setTime(e.target.value)}
              />
            </div>
          </div>

          <div className="form-group">
            <label className="form-label">Repeat</label>
            <select
              className="form-select"
              value={scheduleKind}
              onChange={(e) => setScheduleKind(e.target.value)}
            >
              <option value="once">Once</option>
              <option value="daily">Daily</option>
              <option value="weekly">Weekly</option>
              <option value="monthly">Monthly</option>
                           <option value="yearly">Yearly</option>
              <option value="interval">Custom Interval</option>
            </select>
          </div>

          {scheduleKind === "weekly" && (
            <div className="form-group">
              <label className="form-label">Days of week</label>

              <div className="card-actions" style={{ marginBottom: 6 }}>
                {weekdayLabels.map((label, idx) => {
                  const active = Array.isArray(weeklyDays) && weeklyDays.includes(idx);
                  const className = `btn ${active ? "btn-primary" : "btn-secondary"}`;

                  return (
                    <button
                      key={idx}
                      type="button"
                      className={className}
                      onClick={() => toggleWeekday(idx)}
                    >
                      {label}
                    </button>
                  );
                })}
              </div>

              <div style={{ color: "var(--text-secondary)", fontSize: 12, lineHeight: 1.35 }}>
                If you select none, it defaults to the weekday of the chosen date.
              </div>
            </div>
          )}

          {scheduleKind === "monthly" && (
            <div className="form-group">
              <label className="form-label">Day of month (1–31)</label>
              <input
                type="number"
                className="form-input"
                min="1"
                max="31"
                value={monthlyDay}
                onChange={(e) => setMonthlyDay(Number(e.target.value))}
              />
              <div style={{ color: "var(--text-secondary)", fontSize: 12, lineHeight: 1.35 }}>
                If a month doesn&apos;t have that day (e.g. 31 in February), your backend should run
                it on the last day of that month.
              </div>
            </div>
          )}
          
          {scheduleKind === "yearly" && (
            <div className="form-group">
              <label className="form-label">Yearly date</label>

              <div className="form-row">
                <div className="form-group">
                  <label className="form-label">Month</label>
                  <select
                    className="form-select"
                    value={yearlyMonth}
                    onChange={(e) => setYearlyMonth(Number(e.target.value))}
                  >
                    <option value={1}>January</option>
                    <option value={2}>February</option>
                    <option value={3}>March</option>
                    <option value={4}>April</option>
                    <option value={5}>May</option>
                    <option value={6}>June</option>
                    <option value={7}>July</option>
                    <option value={8}>August</option>
                    <option value={9}>September</option>
                    <option value={10}>October</option>
                    <option value={11}>November</option>
                    <option value={12}>December</option>
                  </select>
                </div>

                <div className="form-group">
                  <label className="form-label">Day</label>
                  <input
                    type="number"
                    className="form-input"
                    value={yearlyDay}
                    onChange={(e) => setYearlyDay(Number(e.target.value))}
                    min="1"
                    max="31"
                  />
                </div>
              </div>

              <div style={{ color: "var(--text-secondary)", fontSize: 12, lineHeight: 1.35 }}>
                If the chosen month doesn’t have that day (like Feb 30), it will run on the last day of that month.
              </div>
            </div>
          )}

          {scheduleKind === "interval" && (
            <div className="form-group">
              <label className="form-label">Interval (minutes)</label>
              <input
                type="number"
                className="form-input"
                value={intervalMinutes}
                onChange={(e) => setIntervalMinutes(Number(e.target.value))}
                min="1"
              />
            </div>
          )}
        </div>

        <div className="modal-actions">
          <button className="btn btn-secondary" onClick={onClose} type="button">
            Cancel
          </button>
          <button className="btn btn-primary" onClick={handleSave} type="button">
            {reminder ? "Update" : "Create"}
          </button>
        </div>
      </div>
    </div>
  );
}



// Event Modal
function EventModal({ event, selectedDate, userTimezone, onClose, onSave }) {
  const [title, setTitle] = useState(event?.title || '');
  const [description, setDescription] = useState(event?.description || '');
  const [date, setDate] = useState('');
  const [time, setTime] = useState('');
  const [endTime, setEndTime] = useState('');
  const [allDay, setAllDay] = useState(event?.allDay || false);
  const [location, setLocation] = useState(event?.location || '');
  
  // EVENT SHARE STATE
  const [shareModalOpen, setShareModalOpen] = useState(false);
const [shareToken, setShareToken] = useState("");
const [shareLoading, setShareLoading] = useState(false);

  // Reminder UI state (default OFF)
  const [reminderEnabled, setReminderEnabled] = useState(false);
  const [reminderMode, setReminderMode] = useState('at_event');
  const [offsetMinutes, setOffsetMinutes] = useState(10);
  const [customReminderDate, setCustomReminderDate] = useState('');
  const [customReminderTime, setCustomReminderTime] = useState('');

  // =============================
  // NEW: Recurrence UI state
  // =============================
  const [repeatEnabled, setRepeatEnabled] = useState(false);
  const [repeatFreq, setRepeatFreq] = useState('weekly'); // daily | weekly | monthly | yearly
  const [repeatInterval, setRepeatInterval] = useState(1); // every X
  const [repeatWeekdays, setRepeatWeekdays] = useState([]); // [0..6] Sun..Sat (only for weekly)
  const [repeatEndKind, setRepeatEndKind] = useState('never'); // never | until | count
  const [repeatUntilDate, setRepeatUntilDate] = useState(''); // YYYY-MM-DD
  const [repeatCount, setRepeatCount] = useState(10); // occurrences
  
      const createShareCode = async () => {
  if (!event?._id) return;

  try {
    setShareLoading(true);
    setShareToken("");

    // ✅ Adjust this path if your backend uses a different route
    const data = await apiCall("/eventShare/create", {
      method: "POST",
      body: JSON.stringify({ eventId: event._id }),
    });

    const token = String(data?.token || data?.code || "");
    if (!token) {
      tg.showAlert("No token returned from server.");
      return;
    }

    setShareToken(token);
    setShareModalOpen(true);
  } catch (e) {
    tg.showAlert("Failed to create share code: " + (e?.message || "Unknown error"));
  } finally {
    setShareLoading(false);
  }
};

  useEffect(() => {
    document.body.classList.add('modal-open');
    return () => {
      document.body.classList.remove('modal-open');
    };
  }, []);

  useEffect(() => {
    // -----------------------------
    // Base event fields
    // -----------------------------
    if (event) {
      const d = new Date(event.startDate);
      setDate(d.toISOString().split('T')[0]);
      setTime(d.toTimeString().slice(0, 5));
      setAllDay(!!event.allDay);
      setLocation(event.location || '');
      setDescription(event.description || '');
      setTitle(event.title || '');

      if (event.endDate) {
        const e = new Date(event.endDate);
        setEndTime(e.toTimeString().slice(0, 5));
      } else {
        setEndTime('');
      }
    } else if (selectedDate) {
      setDate(selectedDate.toISOString().split('T')[0]);
      setTime('09:00');
      setEndTime('10:00');
      setAllDay(false);
      setLocation('');
      setDescription('');
      setTitle('');
    } else {
      const now = new Date();
      setDate(now.toISOString().split('T')[0]);
      setTime('09:00');
      setEndTime('10:00');
      setAllDay(false);
      setLocation('');
      setDescription('');
      setTitle('');
    }

    // -----------------------------
    // Reminder defaults + prefill
    // -----------------------------
    setReminderEnabled(false);
    setReminderMode('at_event');
    setOffsetMinutes(10);

    {
      const now = new Date();
      setCustomReminderDate(now.toISOString().split('T')[0]);
      setCustomReminderTime('09:00');
    }

    if (event && (event.reminder?.nextRunAt || event.reminderId)) {
  setReminderEnabled(true);

  // If backend only gives reminderId (no nextRunAt),
  // we can't calculate offset/custom accurately.
  if (!event.reminder?.nextRunAt) {
    setReminderMode('at_event');
  } else {
    const rNext = new Date(event.reminder.nextRunAt);
    const eStart = new Date(event.startDate);

    const diffMs = eStart.getTime() - rNext.getTime();
    const diffMinutes = Math.round(diffMs / 60000);

    if (Math.abs(diffMinutes) <= 1) {
      setReminderMode('at_event');
    } else if (diffMinutes > 0) {
      setReminderMode('offset');
      setOffsetMinutes(Math.max(1, diffMinutes));
    } else {
      setReminderMode('custom');
      setCustomReminderDate(rNext.toISOString().split('T')[0]);
      setCustomReminderTime(rNext.toTimeString().slice(0, 5));
    }
  }
}

    // -----------------------------
    // NEW: Recurrence defaults + prefill
    // -----------------------------
    setRepeatEnabled(false);
    setRepeatFreq('weekly');
    setRepeatInterval(1);
    setRepeatWeekdays([]);
    setRepeatEndKind('never');
    setRepeatUntilDate('');
    setRepeatCount(10);

    if (event && event.recurrence && event.recurrence.freq) {
      const r = event.recurrence;

      setRepeatEnabled(true);
      setRepeatFreq(String(r.freq || 'weekly'));
      setRepeatInterval("1");
const intervalStr =
  r.interval === undefined || r.interval === null
    ? "1"
    : String(Math.max(1, Number(r.interval)));
setRepeatInterval(intervalStr);

      if (Array.isArray(r.byWeekday)) {
        setRepeatWeekdays(
          r.byWeekday
            .map(n => Number(n))
            .filter(n => Number.isFinite(n) && n >= 0 && n <= 6)
        );
      }

      if (r.end && r.end.kind) {
        setRepeatEndKind(String(r.end.kind));

        if (r.end.kind === 'until' && r.end.until) {
          const until = new Date(r.end.until);
          if (!isNaN(until.getTime())) {
            setRepeatUntilDate(until.toISOString().split('T')[0]);
          }
        }

        if (r.end.kind === 'count' && typeof r.end.count === 'number') {
          setRepeatCount(Math.max(1, Number(r.end.count)));
        }
      }
    }
  }, [event, selectedDate]);

  const handleSave = async () => {
    if (!title.trim()) {
      tg.showAlert('Please enter a title');
      return;
    }


const zone = userTimezone || "America/Chicago";

// Build start in USER timezone, then convert to UTC ISO
const startISO = allDay
  ? DateTime.fromISO(date, { zone }).startOf("day").toUTC().toISO()
  : DateTime.fromISO(`${date}T${time}`, { zone }).toUTC().toISO();

// Build end in USER timezone, then convert to UTC ISO
const endISO =
  endTime && !allDay
    ? DateTime.fromISO(`${date}T${endTime}`, { zone }).toUTC().toISO()
    : null;

    // -----------------------------
    // Reminder payload
    // -----------------------------
    let reminderPayload = { enabled: false };

    if (reminderEnabled) {
      if (allDay && reminderMode !== 'custom') {
        tg.showAlert('For all-day events, please use Custom reminder time.');
        return;
      }

      if (reminderMode === 'at_event') {
        reminderPayload = { enabled: true, mode: 'at_event' };
      } else if (reminderMode === 'offset') {
        reminderPayload = { enabled: true, mode: 'offset', offsetMinutes };
      } else {
        if (!customReminderDate || !customReminderTime) {
          tg.showAlert('Please choose a custom reminder date and time.');
          return;
        }
const customISO = DateTime
  .fromISO(`${customReminderDate}T${customReminderTime}`, { zone })
  .toUTC()
  .toISO();

reminderPayload = {
  enabled: true,
  mode: 'custom',
  customDateTime: customISO,
};
      }
    }

    // -----------------------------
    // NEW: Recurrence payload
    // -----------------------------
    let recurrence = null;

    if (repeatEnabled) {
      const freq = String(repeatFreq || 'weekly');
const rawInterval = Number(String(repeatInterval).trim());
const interval = Number.isFinite(rawInterval) && rawInterval >= 1 ? Math.trunc(rawInterval) : 1;

      let byWeekday = undefined;
      if (freq === 'weekly') {
        const list = Array.isArray(repeatWeekdays)
          ? repeatWeekdays.map(n => Number(n)).filter(n => n >= 0 && n <= 6)
          : [];

const startWeekday = new Date(date + "T00:00:00").getDay(); // 0..6

if (list.length === 0) {
  byWeekday = [startWeekday];
} else {
  byWeekday = Array.from(new Set(list));
}
      }

let end = { kind: "never" };

if (repeatEndKind === "until") {
  if (!repeatUntilDate) {
    tg.showAlert('Choose an "until" date for repeating events.');
    return;
  }

  const untilISO = DateTime
    .fromISO(repeatUntilDate, { zone })
    .endOf("day")
    .toUTC()
    .toISO();

  end = { kind: "until", until: untilISO };
}

if (repeatEndKind === "count") {
  const c = Math.max(1, Number(repeatCount || 1));
  end = { kind: "count", count: c };
}

      recurrence = {
        freq,
        interval,
        ...(byWeekday ? { byWeekday } : {}),
        end,
      };
    }

    await onSave({
      title,
      description,
      startDate: startISO,
endDate: endISO || undefined,
      allDay,
      location,
      reminder: reminderPayload,
      recurrence,
    });
  };

  const ReminderModeButton = ({ value, label }) => {
    const active = reminderMode === value;
    const className = `btn ${active ? 'btn-primary' : 'btn-secondary'}`;
    return (
      <button
        type="button"
        className={className}
        onClick={() => setReminderMode(value)}
      >
        {label}
      </button>
    );
  };

  const OffsetButton = ({ minutes }) => {
    const active = offsetMinutes === minutes;
    const className = `btn ${active ? 'btn-primary' : 'btn-secondary'}`;
    return (
      <button
        type="button"
        className={className}
        onClick={() => setOffsetMinutes(minutes)}
      >
        {minutes}m
      </button>
    );
  };

  // =============================
  // NEW: Repeat UI helpers
  // =============================
  const weekdayLabels = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

  const toggleWeekday = (idx) => {
    setRepeatWeekdays((prev) => {
      const set = new Set(Array.isArray(prev) ? prev : []);
      if (set.has(idx)) set.delete(idx);
      else set.add(idx);
      return Array.from(set).sort((a, b) => a - b);
    });
  };

  const WeekdayButton = ({ idx }) => {
    const active = Array.isArray(repeatWeekdays) && repeatWeekdays.includes(idx);
    const className = `btn ${active ? 'btn-primary' : 'btn-secondary'}`;
    return (
      <button
        type="button"
        className={className}
        onClick={() => toggleWeekday(idx)}
      >
        {weekdayLabels[idx]}
      </button>
    );
  };

  const EndKindButton = ({ value, label }) => {
    const active = repeatEndKind === value;
    const className = `btn ${active ? 'btn-primary' : 'btn-secondary'}`;
    return (
      <button
        type="button"
        className={className}
        onClick={() => setRepeatEndKind(value)}
      >
        {label}
      </button>
    );
  };

  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal" onClick={e => e.stopPropagation()}>
      
      {shareModalOpen && (
  <ShareCodeModal
    token={shareToken}
    onClose={() => setShareModalOpen(false)}
  />
)}
        <div className="modal-header">
          <h2>{event ? 'Edit Event' : 'New Event'}</h2>
          <button className="modal-close" onClick={onClose}>×</button>
        </div>

        <div className="modal-body">
          <div className="form-group">
            <label className="form-label">Title</label>
            <input
              type="text"
              className="form-input"
              value={title}
              onChange={e => setTitle(e.target.value)}
              placeholder="Event title"
            />
          </div>

          <div className="form-group">
            <label className="form-label">Description</label>
            <textarea
              className="form-textarea form-textarea--sm"
              value={description}
              onChange={e => setDescription(e.target.value)}
              placeholder="Add details..."
            />
          </div>

          <div className="form-group">
            <label className="form-label">Date</label>
            <input
              type="date"
              className="form-input"
              value={date}
              onChange={e => setDate(e.target.value)}
            />
          </div>

          <div className="form-group">
            <label className="checkbox-row">
              <input
                type="checkbox"
                checked={allDay}
                onChange={e => setAllDay(e.target.checked)}
              />
              <span>All day event</span>
            </label>
          </div>

          {!allDay && (
            <div className="form-row">
              <div className="form-group">
                <label className="form-label">Start Time</label>
                <input
                  type="time"
                  className="form-input"
                  value={time}
                  onChange={e => setTime(e.target.value)}
                />
              </div>
              <div className="form-group">
                <label className="form-label">End Time</label>
                <input
                  type="time"
                  className="form-input"
                  value={endTime}
                  onChange={e => setEndTime(e.target.value)}
                />
              </div>
            </div>
          )}

          <div className="form-group">
            <label className="form-label">Location</label>
            <input
              type="text"
              className="form-input"
              value={location}
              onChange={e => setLocation(e.target.value)}
              placeholder="Add location"
            />
          </div>

          {/* =============================
              Reminder section (existing)
             ============================= */}
          <div className="form-group">
            <label className="form-label">Reminder</label>

            <label className="checkbox-row" style={{ marginBottom: 12 }}>
              <input
                type="checkbox"
                checked={reminderEnabled}
                onChange={e => setReminderEnabled(e.target.checked)}
              />
              <span>Enable reminder</span>
            </label>

            {reminderEnabled && (
              <div>
                <div className="card-actions" style={{ marginBottom: 12 }}>
                  <ReminderModeButton value="at_event" label="At event time" />
                  <ReminderModeButton value="offset" label="Before event" />
                  <ReminderModeButton value="custom" label="Custom time" />
                </div>

                {reminderMode === 'offset' && (
                  <div className="card-actions" style={{ marginBottom: 12 }}>
                    <OffsetButton minutes={5} />
                    <OffsetButton minutes={10} />
                    <OffsetButton minutes={15} />
                    <OffsetButton minutes={30} />
                    <OffsetButton minutes={60} />
                  </div>
                )}

                {reminderMode === 'custom' && (
                  <div className="form-row">
                    <div className="form-group">
                      <label className="form-label">Reminder Date</label>
                      <input
                        type="date"
                        className="form-input"
                        value={customReminderDate}
                        onChange={e => setCustomReminderDate(e.target.value)}
                      />
                    </div>
                    <div className="form-group">
                      <label className="form-label">Reminder Time</label>
                      <input
                        type="time"
                        className="form-input"
                        value={customReminderTime}
                        onChange={e => setCustomReminderTime(e.target.value)}
                      />
                    </div>
                  </div>
                )}

                {allDay && reminderMode !== 'custom' && (
                  <div style={{ color: 'var(--text-secondary)', fontSize: 13, lineHeight: 1.4 }}>
                    For all-day events, use Custom reminder time.
                  </div>
                )}
              </div>
            )}
          </div>

          {/* =============================
              NEW: Repeat section
             ============================= */}
          <div className="form-group">
            <label className="form-label">Repeat</label>

            <label className="checkbox-row" style={{ marginBottom: 12 }}>
              <input
                type="checkbox"
                checked={repeatEnabled}
                onChange={e => setRepeatEnabled(e.target.checked)}
              />
              <span>Repeat event</span>
            </label>

            {repeatEnabled && (
              <div>
                <div className="form-row">
                  <div className="form-group">
                    <label className="form-label">Frequency</label>
                    <select
                      className="form-select"
                      value={repeatFreq}
                      onChange={(e) => {
                        const v = e.target.value;
                        setRepeatFreq(v);

                        // If they switch away from weekly, clear weekday selection
                        if (v !== 'weekly') {
                          setRepeatWeekdays([]);
                        }
                      }}
                    >
                      <option value="daily">Daily</option>
                      <option value="weekly">Weekly</option>
                      <option value="monthly">Monthly</option>
                      <option value="yearly">Yearly</option>
                    </select>
                  </div>

                  <div className="form-group">
                    <label className="form-label">Every</label>
                    <input
  type="number"
  className="form-input"
  min="1"
  step="1"
  value={repeatInterval}
  onChange={(e) => setRepeatInterval(e.target.value)}
  placeholder="1"
/>
                    <div style={{ color: 'var(--text-secondary)', fontSize: 12, marginTop: 6, lineHeight: 1.35 }}>
                      {repeatFreq === 'daily' ? 'days' :
                       repeatFreq === 'weekly' ? 'weeks' :
                       repeatFreq === 'monthly' ? 'months' : 'years'}
                    </div>
                  </div>
                </div>

                {repeatFreq === 'weekly' && (
                  <div className="form-group">
                    <label className="form-label">On</label>
                    <div className="card-actions" style={{ marginBottom: 6 }}>
                      {weekdayLabels.map((_, idx) => (
                        <WeekdayButton key={idx} idx={idx} />
                      ))}
                    </div>
                    <div style={{ color: 'var(--text-secondary)', fontSize: 12, lineHeight: 1.35 }}>
                      If you select none, it defaults to the event’s start weekday.
                    </div>
                  </div>
                )}

                <div className="form-group">
                  <label className="form-label">Ends</label>

                  <div className="card-actions" style={{ marginBottom: 12 }}>
                    <EndKindButton value="never" label="Never" />
                    <EndKindButton value="until" label="Until date" />
                    <EndKindButton value="count" label="After N" />
                  </div>

                  {repeatEndKind === 'until' && (
                    <div className="form-group">
                      <label className="form-label">Until</label>
                      <input
                        type="date"
                        className="form-input"
                        value={repeatUntilDate}
                        onChange={(e) => setRepeatUntilDate(e.target.value)}
                      />
                    </div>
                  )}

                  {repeatEndKind === 'count' && (
                    <div className="form-group">
                      <label className="form-label">Occurrences</label>
                      <input
                        type="number"
                        className="form-input"
                        min="1"
                        value={repeatCount}
                        onChange={(e) => setRepeatCount(Math.max(1, Number(e.target.value || 1)))}
                      />
                    </div>
                  )}

                  <div style={{ color: 'var(--text-secondary)', fontSize: 12, lineHeight: 1.35 }}>
                    Your backend still needs to store and expand recurrence for it to appear on the calendar.
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>

        <div className="modal-actions">
  <button className="btn btn-secondary" onClick={onClose} type="button">
    Cancel
  </button>

  {event?._id && (
    <button
      className="btn btn-secondary"
      onClick={createShareCode}
      type="button"
      disabled={shareLoading}
    >
      {shareLoading ? "Sharing…" : "Share"}
    </button>
  )}

  <button className="btn btn-primary" onClick={handleSave} type="button">
    {event ? "Update" : "Create"}
  </button>
</div>
      </div>
    </div>
  );
}


    // Calendar View - Day List Style
function CalendarView({ onOpenSettings, userTimezone, onOpenEventShare }) {
      const [currentMonth, setCurrentMonth] = useState(new Date());
      const [events, setEvents] = useState([]);
      const [loading, setLoading] = useState(true);
      const [showEventModal, setShowEventModal] = useState(false);
      const [editingEvent, setEditingEvent] = useState(null);
      const [selectedDate, setSelectedDate] = useState(null);
      const createEventRefs = useRef({});

      useEffect(() => {
        loadEvents();
      }, [currentMonth]);

      const loadEvents = async () => {
        try {
          setLoading(true);
          const startOfMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
const endExclusive = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1);

const data = await apiCall(
  `/calendar/events?startDate=${startOfMonth.toISOString()}&endDate=${endExclusive.toISOString()}`
);
          setEvents(data.events);
        } catch (error) {
          tg.showAlert('Failed to load events: ' + error.message);
        } finally {
          setLoading(false);
        }
      };

      const getDaysInMonth = () => {
        const year = currentMonth.getFullYear();
        const month = currentMonth.getMonth();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        const days = [];
        for (let i = 1; i <= daysInMonth; i++) {
          days.push(new Date(year, month, i));
        }

        return days;
      };

      const getEventsForDate = (date) => {
  const dayStart = new Date(date.getFullYear(), date.getMonth(), date.getDate(), 0, 0, 0);
  const dayEnd = new Date(date.getFullYear(), date.getMonth(), date.getDate() + 1, 0, 0, 0);

  return events.filter((event) => {
    const start = new Date(event.startDate);
    const end = event.endDate ? new Date(event.endDate) : null;

    // No end date = treat as instant event on start time
    if (!end || isNaN(end.getTime())) {
      return start >= dayStart && start < dayEnd;
    }

    // Overlap test: event intersects [dayStart, dayEnd)
    return start < dayEnd && end > dayStart;
  });
};

      const isToday = (date) => {
        const today = new Date();
        return date.toDateString() === today.toDateString();
      };

      const handlePrevMonth = () => {
        setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1));
      };

      const handleNextMonth = () => {
        setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1));
      };

      const handleCreateEvent = (date) => {
        setSelectedDate(date);
        setEditingEvent(null);
        setShowEventModal(true);
      };

      const handleEditEvent = (event) => {
        setEditingEvent(event);
        setSelectedDate(null);
        setShowEventModal(true);
      };

      const handleSaveEvent = async (data) => {
        try {
          if (editingEvent) {
            await apiCall(`/calendar/events/${editingEvent._id}`, {
              method: 'PUT',
              body: JSON.stringify(data),
            });
            tg.showAlert('Event updated!');
          } else {
            await apiCall('/calendar/events', {
              method: 'POST',
              body: JSON.stringify(data),
            });
            tg.showAlert('Event created!');
          }
          setShowEventModal(false);
          setSelectedDate(null);
          loadEvents();
        } catch (error) {
          tg.showAlert('Failed to save: ' + error.message);
        }
      };

      const handleDeleteEvent = async (eventId, e) => {
        e.stopPropagation();
        try {
          await apiCall(`/calendar/events/${eventId}`, {
            method: 'DELETE',
          });
          tg.showPopup({ message: 'Event deleted' });
          loadEvents();
        } catch (error) {
          tg.showAlert('Failed to delete: ' + error.message);
        }
      };

      const monthName = currentMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
      const days = getDaysInMonth();

      return (
        <div>
          <div className="calendar-header">
  <div className="calendar-month">
    <button className="calendar-nav-btn" onClick={handlePrevMonth}>‹</button>
    <span>{monthName}</span>
    <button className="calendar-nav-btn" onClick={handleNextMonth}>›</button>
  </div>

  <div className="calendar-header-right">
  <button
    className="icon-btn"
    type="button"
    onClick={() => onOpenEventShare && onOpenEventShare()}
    aria-label="Join shared event"
    title="Join shared event"
  >
    <img src="/icons/link.svg" alt="" />
  </button>

  <button
    className="icon-btn"
    type="button"
    onClick={() => onOpenSettings && onOpenSettings()}
  >
    <img src="/icons/cog.svg" alt="" />
  </button>
</div>
</div>

          {loading ? (
            <div className="loading">
              <div className="spinner" />
              <div>Loading calendar...</div>
            </div>
          ) : (
            <div className="calendar-body">
              {days.map(date => {
                const dayEvents = getEventsForDate(date);
                const dateIsToday = isToday(date);

                return (
                  <div key={date.toISOString()} className="calendar-day">
                    <div className="calendar-day-row">
                      {/* Date box */}
                      <div className="calendar-datebox">
                        <div className={`calendar-datebox-day ${dateIsToday ? 'is-today' : ''}`}>
                          {date.getDate()}
                        </div>
                        <div className="calendar-datebox-dow">
                          {date.toLocaleDateString('en-US', { weekday: 'short' })}
                        </div>
                      </div>

                      {/* Events container */}
                      <div className="calendar-events">
                        {dayEvents.length === 0 ? (
                          <div className="calendar-no-events">
                            <span>No events</span>
                            <button
  ref={el => createEventRefs.current[date.toISOString()] = el}
  onClick={() => handleCreateEvent(date)}
  className="calendar-add-icon-btn"
>
  <img src="/icons/plus.svg" alt="" />
</button>
                          </div>
                        ) : (
                          <div>
                            {dayEvents.map(event => (
                              <div
                                key={event._id}
                                onClick={() => handleEditEvent(event)}
                                className="calendar-event"
                              >
                                <div className="calendar-event-top">
                                  <div className="calendar-event-main">
                                    {event.allDay && (
                                      <div className="calendar-event-allday">
                                        ● All day
                                      </div>
                                    )}
                                    <div className="calendar-event-title">
  {(event.title || event.text || event.name || "(untitled)")}
  {hasReminder(event) && <span className="event-reminder-dot" />}
</div>
                                    {!event.allDay && (
                                      <div className="calendar-event-time">
                                        {formatEventTime(event)}
                                      </div>
                                    )}
                                    {event.location && (
                                      <div className="calendar-event-location">
  <img src="/icons/location.svg" alt="" />
  {event.location}
</div>
                                    )}
                                  </div>
                                  <button
  onClick={(e) => handleDeleteEvent(event._id, e)}
  className="calendar-event-delete"
>
  <img src="/icons/trash.svg" alt="" />
</button>
                                </div>
                              </div>
                            ))}
                            <button
                              ref={el => createEventRefs.current[date.toISOString()] = el}
                              onClick={() => handleCreateEvent(date)}
                              className="calendar-add-event"
                            >
                              + Add event
                            </button>
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          )}
<button
  className="is-hidden"
  data-create-event="1"
  onClick={() => handleCreateEvent(new Date())}
/>
          {showEventModal && (
            <EventModal
  event={editingEvent}
  selectedDate={selectedDate}
  userTimezone={userTimezone}
  onClose={() => {
    setShowEventModal(false);
    setSelectedDate(null);
  }}
  onSave={handleSaveEvent}
/>
          )}
        </div>
      );
    }

    // Reminders View
function RemindersView({ activeView, userTimezone, userDisplayName, onOpenHabits }) {
      const [reminders, setReminders] = useState([]);
      const [loading, setLoading] = useState(true);
      const [showHistory, setShowHistory] = useState(false);
      const [showModal, setShowModal] = useState(false);
      const [editingReminder, setEditingReminder] = useState(null);
      const [filter, setFilter] = useState('all');
      const createReminderRef = useRef(null);

useEffect(() => {
  if (activeView === "reminders") {
    loadReminders();
  }
}, [showHistory, activeView]);

      const loadReminders = async () => {
        try {
          setLoading(true);
          const data = await apiCall(`/reminders?includeHistory=${showHistory}`);
          setReminders(data.reminders);
        } catch (error) {
          tg.showAlert('Failed to load reminders: ' + error.message);
        } finally {
          setLoading(false);
        }
      };

      const handleCreate = () => {
        setEditingReminder(null);
        setShowModal(true);
      };

      const handleEdit = (reminder) => {
        setEditingReminder(reminder);
        setShowModal(true);
      };

      const handleSave = async (data) => {
        try {
          if (editingReminder) {
            await apiCall(`/reminders/${editingReminder._id}`, {
              method: 'PUT',
              body: JSON.stringify(data),
            });
            tg.showAlert('Reminder updated!');
          } else {
            await apiCall('/reminders', {
              method: 'POST',
              body: JSON.stringify(data),
            });
            tg.showAlert('Reminder created!');
          }
          setShowModal(false);
          loadReminders();
        } catch (error) {
          tg.showAlert('Failed to save: ' + error.message);
        }
      };

      const handleSnooze = async (id, minutes) => {
        try {
          await apiCall(`/reminders/${id}/snooze`, {
            method: 'POST',
            body: JSON.stringify({ minutes }),
          });
          tg.showPopup({ message: `Snoozed for ${minutes} minutes` });
          loadReminders();
        } catch (error) {
          tg.showAlert('Failed to snooze: ' + error.message);
        }
      };

      const handleDone = async (id) => {
        try {
          await apiCall(`/reminders/${id}/done`, {
            method: 'POST',
          });
          tg.showPopup({ message: 'Marked as done!' });
          loadReminders();
        } catch (error) {
          tg.showAlert('Failed to mark as done: ' + error.message);
        }
      };

      const handleDelete = async (id) => {
        try {
          await apiCall(`/reminders/${id}`, {
            method: 'DELETE',
          });
          tg.showPopup({ message: 'Reminder deleted' });
          loadReminders();
        } catch (error) {
          tg.showAlert('Failed to delete: ' + error.message);
        }
      };

      const filteredReminders = reminders.filter(r => {
        if (filter === 'all') return true;
        return r.schedule?.kind === filter;
      });

      return (
        <div>
          <div className="header">
  <div>
    <h1>Reminders</h1>

    {(() => {
      const name = (userDisplayName || "").trim();
      return name ? <div className="reminders-greeting">Hello {name}</div> : null;
    })()}
  </div>

  <div className="header-actions">
    {/* HABITS ICON BUTTON */}
    <button
  type="button"
  className="icon-btn"
  aria-label="Habits"
  title="Habits"
  onClick={onOpenHabits}
>
      <img src="/icons/plus.svg" alt="" />
    </button>

    {/* HISTORY TOGGLE */}
    <div className="toggle" onClick={() => setShowHistory(!showHistory)}>
      <span>History</span>
      <div className={`toggle-switch ${showHistory ? 'active' : ''}`} />
    </div>
  </div>
</div>

          <div className="quick-actions">
            <div
              className={`quick-action ${filter === 'all' ? 'active' : ''}`}
              onClick={() => setFilter('all')}
            >
              All
            </div>
            <div
              className={`quick-action ${filter === 'once' ? 'active' : ''}`}
              onClick={() => setFilter('once')}
            >
              Once
            </div>
            <div
              className={`quick-action ${filter === 'daily' ? 'active' : ''}`}
              onClick={() => setFilter('daily')}
            >
              Daily
            </div>
            <div
              className={`quick-action ${filter === 'weekly' ? 'active' : ''}`}
              onClick={() => setFilter('weekly')}
            >
              Weekly
            </div>
            <div
              className={`quick-action ${filter === 'interval' ? 'active' : ''}`}
              onClick={() => setFilter('interval')}
            >
              Interval
            </div>
          </div>

          {loading ? (
            <div className="loading">
              <div className="spinner" />
              <div>Loading reminders...</div>
            </div>
          ) : filteredReminders.length === 0 ? (
            <div className="empty-state">
              <div className="empty-state-icon">
  <img src="/icons/journal.svg" alt="" />
</div>
              <div className="empty-state-text">
                {filter === 'all'
                  ? 'No reminders yet.\nTap the + button to create one!'
                  : `No ${filter} reminders found.`}
              </div>
            </div>
          ) : (
            filteredReminders.map(reminder => (
              <ReminderCard
                key={reminder._id}
                reminder={reminder}
                onEdit={handleEdit}
                onSnooze={handleSnooze}
                onDone={handleDone}
                onDelete={handleDelete}
              />
            ))
          )}

<button
  ref={createReminderRef}
  data-create-reminder="1"
  onClick={handleCreate}
  className="is-hidden"
/>

          {showModal && (
  <ReminderModal
    reminder={editingReminder}
    onClose={() => setShowModal(false)}
    onSave={handleSave}
    userTimezone={userTimezone}
  />
)}
        </div>
      );
    }
    
    // SETTINGS VIEW
function SettingsView({ onBack }) {
  const [loading, setLoading] = useState(true);
  const [timezone, setTimezone] = useState("America/Chicago");
  const [displayName, setDisplayName] = useState("");
  const [saving, setSaving] = useState(false);

// quiet hours state
const [qhEnabled, setQhEnabled] = useState(false);
const [qhStart, setQhStart] = useState("23:00");
const [qhEnd, setQhEnd] = useState("08:00");

  useEffect(() => {
    document.body.classList.remove("modal-open"); // safety
  }, []);

  useEffect(() => {
    (async () => {
      try {
        setLoading(true);
const data = await apiCall(`/settings`);

if (data?.settings?.timezone) setTimezone(String(data.settings.timezone));
if (data?.settings?.displayName !== undefined) {
  setDisplayName(String(data.settings.displayName || ""));
}

const qh = data?.settings?.quietHours;
if (qh) {
  setQhEnabled(!!qh.enabled);
  setQhStart(String(qh.start || "23:00"));
  setQhEnd(String(qh.end || "08:00"));
}
      } catch (e) {
        tg.showAlert("Failed to load settings: " + (e.message || "Unknown error"));
      } finally {
        setLoading(false);
      }
    })();
  }, []);

  const save = async () => {
    try {
      setSaving(true);
      await apiCall(`/settings`, {
        method: "PUT",
body: JSON.stringify({
  timezone,
  displayName,
  quietHours: {
    enabled: qhEnabled,
    start: qhStart,
    end: qhEnd,
  },
}),
      });
      tg.showPopup({ message: "Settings saved" });
    } catch (e) {
      tg.showAlert("Failed to save: " + (e.message || "Unknown error"));
    } finally {
      setSaving(false);
    }
  };

return (
  <div>
    <div className="header">
      <h1>Settings</h1>

      <div className="journal-header-actions">
        <button className="btn btn-secondary" type="button" onClick={onBack}>
          Back
        </button>
      </div>
    </div>

    {loading ? (
      <div className="loading">
        <div className="spinner" />
        <div>Loading settings...</div>
      </div>
    ) : (
      <div
        className="card settings-card"
        onClick={(e) => e.stopPropagation()}
      >
        {/* -------------------
            TIMEZONE SECTION
           ------------------- */}
        <div className="settings-title">Timezone</div>

        <div className="settings-help">
          Use an IANA timezone like <b>Asia/Jakarta</b>. Offsets like <b>+7</b>{" "}
          can be mapped by the bot command too, but the stored value should be
          IANA.
        </div>

        <input
          className="form-input"
          value={timezone}
          onChange={(e) => setTimezone(e.target.value)}
          placeholder="e.g. Asia/Jakarta"
        />

        <div className="settings-actions">
          <button
            className="btn btn-primary btn-sm"
            type="button"
            onClick={save}
            disabled={saving}
          >
            {saving ? "Saving..." : "Save Timezone"}
          </button>
        </div>
        
        {/* -------------------
    DISPLAY NAME SECTION
   ------------------- */}
<div style={{ marginTop: 18 }}>
  <div className="settings-title">Display Name</div>

  <div className="settings-help">
    Optional name shown in the mini app. Leave blank to use your Telegram name.
  </div>

  <input
    className="form-input"
    value={displayName}
    onChange={(e) => setDisplayName(e.target.value)}
    placeholder="e.g. Asteria"
    maxLength={48}
  />

  <div className="settings-actions">
    <button
      className="btn btn-primary btn-sm"
      type="button"
      onClick={save}
      disabled={saving}
    >
      {saving ? "Saving..." : "Save Display Name"}
    </button>
  </div>
</div>

        {/* -------------------
            QUIET HOURS SECTION
           ------------------- */}
        <div className="qh-box">
          <div className="qh-title">Quiet Hours</div>

          <div className="qh-sub">
            If enabled, reminders that would deliver during this window can be
            delayed until quiet hours end.
          </div>

          <div className="qh-toggle">
            <label>
              <input
                type="checkbox"
                checked={qhEnabled}
                onChange={(e) => setQhEnabled(e.target.checked)}
              />
              <span>Enable Quiet Hours</span>
            </label>
          </div>

          <div className={`qh-times ${qhEnabled ? "" : "qh-disabled"}`}>
            <div className="form-group">
              <label className="form-label">Start</label>
              <input
                type="time"
                className="form-input"
                value={qhStart}
                onChange={(e) => setQhStart(e.target.value)}
              />
            </div>

            <div className="form-group">
              <label className="form-label">End</label>
              <input
                type="time"
                className="form-input"
                value={qhEnd}
                onChange={(e) => setQhEnd(e.target.value)}
              />
            </div>
          </div>

          <div className="qh-actions">
            <button
              className="btn btn-primary btn-sm"
              type="button"
              onClick={save}
              disabled={saving}
            >
              {saving ? "Saving..." : "Save Quiet Hours"}
            </button>
          </div>
        </div>
      </div>
    )}
  </div>
);
}

function EventShareView({ onBack }) {
  const [token, setToken] = useState("");
  const [event, setEvent] = useState(null);

  // Join/Joined toggle
  const [mode, setMode] = useState("join"); // "join" | "joined"

  // RSVP state (only meaningful when an event is selected)
  const [rsvp, setRsvp] = useState(""); // "going" | "maybe" | "declined"
  const [rsvpLoading, setRsvpLoading] = useState(false);

  // Joined events list
  const [joinedItems, setJoinedItems] = useState([]); // [{ event, rsvp, joinedAt }]
  const [joinedLoading, setJoinedLoading] = useState(false);

  // status state should carry a "kind"
  const [status, setStatus] = useState("");
  const [statusKind, setStatusKind] = useState("info"); // "info" | "success" | "error"

  const [loading, setLoading] = useState(false);

  // Safe formatting wrapper so the view never blows up
  const safeEventTime = (ev) => {
    try {
      if (!ev?.startDate) return "";
      return formatEventTime(ev);
    } catch {
      return "";
    }
  };

  const reset = () => {
    setToken("");
    setEvent(null);
    setRsvp("");
    setStatus("");
    setStatusKind("info");
    setLoading(false);
    setRsvpLoading(false);
    // Keep mode as-is; user might be browsing Joined.
  };

  // Load joined events when switching to Joined mode
  const loadJoined = async () => {
    try {
      setJoinedLoading(true);
      const data = await apiCall("/eventShare/joined/list");
      const items = Array.isArray(data?.items) ? data.items : [];
      setJoinedItems(items);
    } catch (e) {
      setJoinedItems([]);
      setStatusKind("error");
      setStatus(e?.message || "Failed to load joined events.");
    } finally {
      setJoinedLoading(false);
    }
  };

  useEffect(() => {
    if (mode === "joined") {
      loadJoined();
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [mode]);

  const join = async () => {
    const code = token.trim();
    if (!code) return;

    try {
      setLoading(true);
      setStatus("");
      setStatusKind("info");

      const data = await apiCall("/eventShare/join", {
        method: "POST",
        body: JSON.stringify({ token: code }),
      });

      // Be defensive about the shape coming back
      const joinedEvent = data?.event || null;

      if (!joinedEvent) {
        setEvent(null);
        setStatusKind("error");
        setStatus("Joined, but the server did not return an event payload.");
        return;
      }

      setEvent(joinedEvent);

      // If your join route returns rsvp, capture it; otherwise default.
      setRsvp(String(data?.rsvp || "going"));

      setStatusKind("success");
      setStatus("Joined event successfully.");
    } catch (e) {
      setEvent(null);
      setStatusKind("error");
      setStatus(e?.message || "Invalid or expired code.");
    } finally {
      setLoading(false);
    }
  };

  const updateRsvp = async (next) => {
    if (!event?.id) return;

    try {
      setRsvpLoading(true);
      setStatus("");
      setStatusKind("info");

      await apiCall(`/eventShare/${event.id}/rsvp`, {
        method: "POST",
        body: JSON.stringify({ rsvp: next }),
      });

      setRsvp(next);
      setStatusKind("success");
      setStatus("RSVP updated.");
    } catch (e) {
      setStatusKind("error");
      setStatus(e?.message || "Failed to update RSVP.");
    } finally {
      setRsvpLoading(false);
    }
  };

  // Helper: when you click an item in Joined list, open it in the detail view
  const openFromJoined = (item) => {
    const ev = item?.event || null;
    if (!ev) return;
    setEvent(ev);
    setRsvp(String(item?.rsvp || "going"));
    setMode("join"); // reuse the detail card on the Join tab
    setStatus("");
    setStatusKind("info");
  };

  return (
    <div className="event-share-wrap">
      <div className="header">
        <h1>Shared Event</h1>

        <div className="journal-header-actions">
          <button className="btn btn-secondary" onClick={onBack} type="button">
            Back
          </button>
        </div>
      </div>

      {/* Mode Toggle (always visible) */}
      <div className="event-share-actions" style={{ marginBottom: 12 }}>
        <button
          className={`btn ${mode === "join" ? "btn-primary" : "btn-secondary"}`}
          onClick={() => {
            setMode("join");
            setStatus("");
            setStatusKind("info");
          }}
          type="button"
        >
          Join
        </button>

        <button
          className={`btn ${mode === "joined" ? "btn-primary" : "btn-secondary"}`}
          onClick={() => {
            setMode("joined");
            setEvent(null); // hide detail card while browsing list
            setStatus("");
            setStatusKind("info");
          }}
          type="button"
        >
          Joined
        </button>
      </div>

      {/* JOIN MODE */}
      {mode === "join" && !event && (
        <div className="event-share-card">
          <label className="form-label">Enter Share Code</label>
          <input
            className="form-input event-share-input"
            value={token}
            onChange={(e) => setToken(e.target.value)}
            placeholder="Paste event code…"
            autoCapitalize="none"
            autoCorrect="off"
            spellCheck={false}
          />

          <div className="event-share-actions">
            <button
              className="btn btn-primary"
              onClick={join}
              disabled={loading || !token.trim()}
              type="button"
            >
              {loading ? "Joining…" : "Join Event"}
            </button>

            <button
              className="btn btn-secondary"
              onClick={reset}
              disabled={loading && !status}
              type="button"
            >
              Clear
            </button>
          </div>

          {loading && (
            <div className="loading" style={{ padding: "18px 0 0" }}>
              <div className="spinner" />
              <div>Checking code…</div>
            </div>
          )}

          {!loading && status && (
            <div className={`event-share-status ${statusKind}`}>
              {status}
            </div>
          )}
        </div>
      )}

      {/* EVENT DETAIL (Join mode) */}
      {mode === "join" && event && (
        <div className="event-share-card">
          <div className="event-share-title">{event.title || "(untitled event)"}</div>

          {safeEventTime(event) && (
            <div className="event-share-meta">{safeEventTime(event)}</div>
          )}

          {event.description && (
            <div className="event-share-desc">{event.description}</div>
          )}

          {event.location && (
            <div className="event-share-meta">
              <img
                src="/icons/location.svg"
                alt=""
                style={{
                  width: 14,
                  height: 14,
                  verticalAlign: "-0.12em",
                  marginRight: 8,
                  opacity: 0.85,
                }}
              />
              {event.location}
            </div>
          )}

          <div className="event-share-status success">You’ve joined this event.</div>

          {/* RSVP BUTTONS */}
          <div className="event-share-actions" style={{ marginTop: 12 }}>
            <button
              className={`btn ${rsvp === "going" ? "btn-success" : "btn-secondary"}`}
              type="button"
              disabled={rsvpLoading}
              onClick={() => updateRsvp("going")}
            >
              Going
            </button>

            <button
              className={`btn ${rsvp === "maybe" ? "btn-primary" : "btn-secondary"}`}
              type="button"
              disabled={rsvpLoading}
              onClick={() => updateRsvp("maybe")}
            >
              Maybe
            </button>

            <button
              className={`btn ${rsvp === "declined" ? "btn-danger" : "btn-secondary"}`}
              type="button"
              disabled={rsvpLoading}
              onClick={() => updateRsvp("declined")}
            >
              Not going
            </button>
          </div>

          {/* RSVP status feedback */}
          {!rsvpLoading && status && (
            <div className={`event-share-status ${statusKind}`} style={{ marginTop: 12 }}>
              {status}
            </div>
          )}

          <div className="event-share-actions" style={{ marginTop: 12 }}>
            <button className="btn btn-secondary" onClick={reset} type="button">
              Join another
            </button>
          </div>
        </div>
      )}

      {/* JOINED MODE (LIST) */}
      {mode === "joined" && (
        <div className="event-share-card">
          <div className="event-share-title">Joined events</div>

          {joinedLoading && (
            <div className="loading" style={{ padding: "18px 0 0" }}>
              <div className="spinner" />
              <div>Loading joined events…</div>
            </div>
          )}

          {!joinedLoading && joinedItems.length === 0 && (
            <div className="event-share-desc" style={{ marginTop: 10 }}>
              No joined events yet.
            </div>
          )}

          {!joinedLoading && joinedItems.length > 0 && (
            <div style={{ marginTop: 12, display: "grid", gap: 10 }}>
              {joinedItems.map((it) => (
                <button
                  key={it.event?.id || Math.random()}
                  type="button"
                  className="btn btn-secondary"
                  style={{ textAlign: "left", padding: 12, width: "100%" }}
                  onClick={() => openFromJoined(it)}
                >
                  <div style={{ fontWeight: 800, marginBottom: 6 }}>
                    {it.event?.title || "(untitled event)"}
                  </div>
                  <div style={{ opacity: 0.9, fontSize: 13 }}>
                    {safeEventTime(it.event)}
                  </div>
                  <div style={{ opacity: 0.85, fontSize: 13, marginTop: 6 }}>
                    RSVP: {it.rsvp || "going"}
                  </div>
                </button>
              ))}
            </div>
          )}

          {!joinedLoading && (
            <div className="event-share-actions" style={{ marginTop: 12 }}>
              <button className="btn btn-secondary" onClick={loadJoined} type="button">
                Refresh
              </button>
            </div>
          )}
        </div>
      )}
    </div>
  );
}

// SHARE CODE MODAL
function ShareCodeModal({ onClose, token }) {
  useEffect(() => {
    document.body.classList.add("modal-open");
    return () => document.body.classList.remove("modal-open");
  }, []);

  const copy = async () => {
    try {
      if (!token) return;

      // Prefer clipboard
      if (navigator.clipboard?.writeText) {
        await navigator.clipboard.writeText(token);
      } else {
        // Fallback for older WebViews
        const ta = document.createElement("textarea");
        ta.value = token;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
      }

      tg.showPopup({ message: "Share code copied" });
    } catch (e) {
      tg.showAlert("Could not copy. Please press and hold to copy.");
    }
  };

  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal" onClick={(e) => e.stopPropagation()}>
        <div className="modal-header">
          <h2>Share Code</h2>
          <button className="modal-close" onClick={onClose} type="button">×</button>
        </div>

        <div className="modal-body">
          <div className="share-code-box">
            <div className="share-code-label">Code</div>
            <div className="share-code-token">{token || ""}</div>
            <div className="share-code-help">
              Send this code to someone. They can open the Calendar and tap the link icon to join.
            </div>
          </div>
        </div>

        <div className="modal-actions">
          <button className="btn btn-secondary" onClick={onClose} type="button">
            Close
          </button>
          <button className="btn btn-primary" onClick={copy} type="button" disabled={!token}>
            Copy
          </button>
        </div>
      </div>
    </div>
  );
}

    // Main App Component
function App() {
  // --------------------
  // VIEW STATE
  // --------------------
  const [activeView, setActiveView] = useState("reminders");
  const [previousView, setPreviousView] = useState("reminders");
  const [journalTagFilter, setJournalTagFilter] = useState("");

  // --------------------
  // USER SETTINGS STATE (NEW)
  // --------------------
  const [userTimezone, setUserTimezone] = useState("America/Chicago");
  
  // ---------------------
  // DISPLAY NAME STATE
  // ---------------------
  const [userDisplayName, setUserDisplayName] = useState("");


  // --------------------
  // LOAD USER SETTINGS (NEW)
  // --------------------
  useEffect(() => {
    (async () => {
      try {
        const data = await apiCall("/settings");
        if (data?.settings?.timezone) {
  setUserTimezone(String(data.settings.timezone));
}

if (data?.settings?.displayName !== undefined) {
  setUserDisplayName(String(data.settings.displayName || ""));
}
      } catch (e) {
        // intentionally silent – app still works with default
      }
    })();
  }, []);

  // --------------------
  // NAVIGATION HELPERS
  // --------------------
  function goTo(view) {
    setPreviousView(activeView);
    setActiveView(view);
  }

  function goBack() {
    setActiveView(previousView || "reminders");
  }
  
  function openHabitsFromReminders() {
  goTo("habits");
}
  
  function openJournalTag(tag) {
  const clean = String(tag || "").trim().toLowerCase().replace(/^#/, "");
  if (!clean) return;
  setJournalTagFilter(clean);
  setPreviousView(activeView);
  setActiveView("journal");
}

function clearJournalTag() {
  setJournalTagFilter("");
}

      const remindersViewRef = useRef(null);
      const calendarViewRef = useRef(null);

const handleFabClick = () => {
if (activeView === 'reminders') {
  const btn = document.querySelector('[data-create-reminder="1"]');
  if (btn) btn.click();
}

else if (activeView === 'habits') {
  const btn =
document.querySelector('[data-create-habit="1"]');
  if (btn) btn.click();
} 

else if (activeView === 'calendar') {
  const btn = document.querySelector('[data-create-event="1"]');
  if (btn) btn.click();
}

  else if (activeView === 'journal') {
    const btn = document.querySelector('[data-create-journal="1"]');
    if (btn) btn.click();
  }
  else if (activeView === 'reading') {
  const btn = document.querySelector('[data-create-book="1"]');
  if (btn) btn.click();
}
};

return (
  <div className="app-shell">
    <div className="app-content">
      <div
        className={`view-container ${activeView === 'reminders' ? 'active' : ''}`}
        data-view="reminders"
      >
        <RemindersView
  activeView={activeView}
  userTimezone={userTimezone}
  userDisplayName={userDisplayName}
  onOpenHabits={openHabitsFromReminders}
/>
      </div>
      
      <div
  className={`view-container ${activeView === 'habits' ? 'active' : ''}`}
  data-view="habits"
>
  <HabitsView
    activeView={activeView}
    userTimezone={userTimezone}
    userDisplayName={userDisplayName}
    onBack={goBack}
  />
</div>

      <div
        className={`view-container ${activeView === 'calendar' ? 'active' : ''}`}
        data-view="calendar"
      >
        <CalendarView
  onOpenSettings={() => goTo("settings")}
  onOpenEventShare={() => goTo("event_share")}
  userTimezone={userTimezone}
/>
      </div>
      
      <div
  className={`view-container ${activeView === 'event_share' ? 'active' : ''}`}
  data-view="event_share"
>
  <EventShareView onBack={goBack} />
</div>

      <div
        className={`view-container ${activeView === 'journal' ? 'active' : ''}`}
        data-view="journal"
      >
        <JournalsView
  activeView={activeView}
  tagFilter={journalTagFilter}
  onOpenTags={() => goTo("journal_tags")}
  onClearTag={() => setJournalTagFilter("")}
  onTagSelect={openJournalTag}
/>
      </div>
      
      <div
  className={`view-container ${activeView === 'journal_tags' ? 'active' : ''}`}
  data-view="journal_tags"
>
  <JournalTagsView
    onBack={goBack}
    onPickTag={(tag) => {
      setJournalTagFilter(tag);
      goTo("journal");
    }}
  />
</div>
      
      <div
  className={`view-container ${activeView === 'reading' ? 'active' : ''}`}
  data-view="reading"
>
  <ReadingView activeView={activeView} />
</div>

<div
  className={`view-container ${activeView === 'settings' ? 'active' : ''}`}
  data-view="settings"
>
  <SettingsView onBack={goBack} />
</div>
    </div>

    <button className="fab" onClick={handleFabClick}>
      +
    </button>

    <div className="bottom-nav">
  <button
    className={`nav-item ${activeView === 'reminders' ? 'active' : ''}`}
    onClick={() => goTo('reminders')}
  >
    <div className="nav-item-icon"><img src="/icons/bell.svg" alt="" /></div>
    <div className="nav-item-label">Reminders</div>
  </button>

  <button
    className={`nav-item ${activeView === 'calendar' ? 'active' : ''}`}
    onClick={() => goTo('calendar')}
  >
    <div className="nav-item-icon"><img src="/icons/calendar.svg" alt="" /></div>
    <div className="nav-item-label">Calendar</div>
  </button>

  <button
    className={`nav-item ${activeView === 'journal' ? 'active' : ''}`}
    onClick={() => goTo('journal')}
  >
    <div className="nav-item-icon"><img src="/icons/page.svg" alt="" /></div>
    <div className="nav-item-label">Journal</div>
  </button>

  <button
    className={`nav-item ${activeView === 'reading' ? 'active' : ''}`}
    onClick={() => goTo('reading')}
  >
    <div className="nav-item-icon"><img src="/icons/book.svg" alt="" /></div>
    <div className="nav-item-label">Reading</div>
  </button>
</div>
  </div>
);
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
