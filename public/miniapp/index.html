<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Lystaria</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/luxon@3/build/global/luxon.min.js"></script>

  <!-- Paste your FULL CSS here (the styles block we separated out) -->
  <style>
    * {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

:root {
  --bg-color: #0a0a0a;
  --card-bg: #1a1a1a;
  --text-primary: #ffffff;
  --text-secondary: #888888;
  --accent: #5b8def;
  --accent-hover: #4a7bd8;
  --success: #4caf50;
  --danger: #f44336;
  --warning: #ff9800;
  --border: #2a2a2a;
  --shadow: rgba(0, 0, 0, 0.3);
  
  /* Telegram viewport height (will be set by JS) */
  --tg-viewport-height: 100vh;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
  background: var(--bg-color);
  color: var(--text-primary);
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
}

html, body {
  height: 100%;
}

body {
  overflow: hidden; /* prevent the page from trying to scroll the whole viewport */
}

#root {
  height: 100%;
  min-height: 0; /* important: don't force viewport height */
  padding-bottom: calc(96px + env(safe-area-inset-bottom));
}

.app-shell {
  height: 100%;
  display: flex;
  flex-direction: column;
}

.app-content {
  flex: 1;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding-bottom: calc(96px + env(safe-area-inset-bottom));
}

/* Bottom Navigation */
.bottom-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: var(--card-bg);
  border-top: 1px solid var(--border);
  display: flex;
  justify-content: space-around;
  padding: 12px 0 calc(12px + env(safe-area-inset-bottom));
  z-index: 1000;
}

.nav-item {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  cursor: pointer;
  padding: 8px;
  color: var(--text-secondary);
  transition: all 0.2s;
  border: none;
  background: none;
}

.nav-item.active {
  color: var(--accent);
}

.nav-item-icon {
  font-size: 24px;
}

.nav-item-label {
  font-size: 11px;
  font-weight: 600;
}

/* View Container */
.view-container {
  display: none;
  animation: fadeIn 0.3s;
}

.view-container.active {
  display: block;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

/* Header */
.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
  padding: 16px;
  padding-bottom: 16px;
  border-bottom: 1px solid var(--border);
}

.header h1 {
  font-size: 28px;
  font-weight: 700;
  background: linear-gradient(135deg, #5b8def 0%, #8b7def 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.toggle {
  display: flex;
  gap: 8px;
  align-items: center;
  font-size: 14px;
  color: var(--text-secondary);
  cursor: pointer;
  user-select: none;
}

.toggle-switch {
  width: 44px;
  height: 24px;
  background: var(--border);
  border-radius: 12px;
  position: relative;
  transition: background 0.2s;
}

.toggle-switch.active {
  background: var(--accent);
}

.toggle-switch::after {
  content: '';
  position: absolute;
  width: 18px;
  height: 18px;
  background: white;
  border-radius: 50%;
  top: 3px;
  left: 3px;
  transition: left 0.2s;
}

.toggle-switch.active::after {
  left: 23px;
}

/* Cards */
.card {
  background: var(--card-bg);
  border-radius: 16px;
  padding: 20px;
  margin: 0 16px 12px;
  border: 1px solid var(--border);
  transition: all 0.2s;
  cursor: pointer;
}

.card:hover {
  border-color: var(--accent);
  transform: translateY(-2px);
  box-shadow: 0 8px 16px var(--shadow);
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 12px;
}

.card-time {
  font-size: 13px;
  color: var(--text-secondary);
  display: flex;
  align-items: center;
  gap: 6px;
}

.card-badge {
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
}

.badge-once { background: rgba(91, 141, 239, 0.15); color: #5b8def; }
.badge-daily { background: rgba(76, 175, 80, 0.15); color: #4caf50; }
.badge-weekly { background: rgba(255, 152, 0, 0.15); color: #ff9800; }
.badge-interval { background: rgba(156, 39, 176, 0.15); color: #9c27b0; }

.card-text {
  font-size: 15px;
  line-height: 1.5;
  margin-bottom: 16px;
  color: var(--text-primary);
  white-space: pre-line;
  word-break: break-word;
}

.card-actions {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

/* -------- Reading Progress -------- */
.progress-wrap {
  margin-top: 14px;
  margin-bottom: 14px;
}

.progress-top {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  gap: 12px;
  margin-bottom: 8px;
  color: var(--text-secondary);
  font-size: 13px;
}

.progress-pct {
  color: var(--text-primary);
  font-weight: 700;
  font-size: 13px;
}

.progress-bar {
  width: 100%;
  height: 10px;
  background: rgba(255, 255, 255, 0.08);
  border: 1px solid var(--border);
  border-radius: 999px;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  width: 0%;
  background: linear-gradient(135deg, #5b8def 0%, #8b7def 100%);
  border-radius: 999px;
  transition: width 0.2s ease;
}

.book-summary {
  font-size: 13.5px;
  line-height: 1.45;
  color: var(--text-secondary);
  margin: 10px 0 12px;
  display: -webkit-box;
  -webkit-line-clamp: 4;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

/* Buttons */
.btn {
  padding: 8px 16px;
  border-radius: 8px;
  border: none;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 6px;
}

.btn-primary {
  background: var(--accent);
  color: white;
}

.btn-primary:hover {
  background: var(--accent-hover);
}

.btn-success {
  background: var(--success);
  color: white;
}

.btn-danger {
  background: var(--danger);
  color: white;
}

.btn-secondary {
  background: rgba(255, 255, 255, 0.1);
  color: var(--text-primary);
}

.btn-secondary:hover {
  background: rgba(255, 255, 255, 0.15);
}

.btn:active {
  transform: scale(0.95);
}

/* FAB */
.fab {
  position: fixed;
  bottom: calc(96px + env(safe-area-inset-bottom));
  right: 24px;
  width: 56px;
  height: 56px;
  border-radius: 50%;
  background: linear-gradient(135deg, #5b8def 0%, #8b7def 100%);
  border: none;
  color: white;
  font-size: 24px;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(91, 141, 239, 0.4);
  transition: all 0.2s;
  z-index: 999;
}

.fab:hover {
  transform: scale(1.1);
  box-shadow: 0 6px 20px rgba(91, 141, 239, 0.6);
}

.fab:active {
  transform: scale(0.95);
}

/* Modal */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 2000;
  animation: fadeIn 0.2s;
}

.modal {
  background: var(--card-bg);
  border-radius: 20px;
  padding: 24px;
  width: 90%;
  max-width: 500px;
  max-height: 80vh;
  overflow-y: auto;
  border: 1px solid var(--border);
  animation: slideUp 0.3s;
  display: flex;
  flex-direction: column;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
  flex-shrink: 0;
}

.modal-body {
  flex: 1;
  overflow-y: auto;
  min-height: 0;
}

/* Prevent background scroll when modal is open */
/* Prevent background scroll when modal is open */
body.modal-open {
  overflow: hidden !important;
  position: fixed !important;
  width: 100% !important;
  height: 100% !important;
  top: 0;
  left: 0;
}

body.modal-open .app-content {
  overflow: hidden !important;
}



.modal-actions {
  display: flex;
  gap: 12px;
  margin-top: 24px;
  flex-shrink: 0;
}


@keyframes slideUp {
  from {
    transform: translateY(100px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

.modal-header h2 {
  font-size: 24px;
  font-weight: 700;
}

.modal-close {
  background: none;
  border: none;
  color: var(--text-secondary);
  font-size: 24px;
  cursor: pointer;
  padding: 0;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: all 0.2s;
}

.modal-close:hover {
  background: rgba(255, 255, 255, 0.1);
}

/* Forms */
.form-group {
  margin-bottom: 20px;
}

.form-label {
  display: block;
  font-size: 13px;
  font-weight: 600;
  color: var(--text-secondary);
  margin-bottom: 8px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.form-input,
.form-textarea {
  width: 100%;
  padding: 12px 16px;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid var(--border);
  border-radius: 12px;
  color: var(--text-primary);
  font-size: 15px;
  transition: all 0.2s;
}

.form-input:focus,
.form-textarea:focus {
  outline: none;
  border-color: var(--accent);
  background: rgba(255, 255, 255, 0.08);
}

.form-textarea {
  resize: vertical;
  min-height: 100px;
  font-family: inherit;
}

.form-textarea.form-textarea--sm {
  min-height: 80px;
}

.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

.form-select {
  width: 100%;
  padding: 12px 16px;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid var(--border);
  border-radius: 12px;
  color: var(--text-primary);
  font-size: 15px;
  cursor: pointer;
  transition: all 0.2s;
}

.form-select:focus {
  outline: none;
  border-color: var(--accent);
  background: rgba(255, 255, 255, 0.08);
}

.modal-actions .btn {
  flex: 1;
  justify-content: center;
  padding: 12px;
}

/* Checkbox row (moved from inline styles) */
.checkbox-row {
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
}

/* Empty state */
.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--text-secondary);
}

.empty-state-icon {
  font-size: 64px;
  margin-bottom: 16px;
  opacity: 0.3;
}

.empty-state-text {
  font-size: 16px;
  line-height: 1.6;
}

/* Loading */
.loading {
  text-align: center;
  padding: 40px;
  color: var(--text-secondary);
}

.spinner {
  width: 40px;
  height: 40px;
  border: 3px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin: 0 auto 16px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Quick actions */
.quick-actions {
  display: flex;
  gap: 8px;
  margin: 0 16px 24px;
  overflow-x: auto;
  padding-bottom: 8px;
}

.quick-action {
  padding: 10px 20px;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid var(--border);
  border-radius: 20px;
  color: var(--text-primary);
  font-size: 13px;
  font-weight: 600;
  white-space: nowrap;
  cursor: pointer;
  transition: all 0.2s;
}

.quick-action:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: var(--accent);
}

.quick-action.active {
  background: var(--accent);
  border-color: var(--accent);
}

/* Calendar Header */
.calendar-header {
  padding: 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid var(--border);
}

.calendar-month {
  font-size: 24px;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 12px;
}

.calendar-nav-btn {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid var(--border);
  border-radius: 8px;
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  color: var(--text-primary);
  font-size: 18px;
  transition: all 0.2s;
}

.calendar-nav-btn:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: var(--accent);
}

/* -------- Calendar View (moved from inline styles) -------- */

.calendar-body {
  padding: 16px;
}

.calendar-day {
  margin-bottom: 16px;
}

.calendar-day-row {
  display: flex;
  align-items: flex-start;
  gap: 16px;
}

.calendar-datebox {
  min-width: 60px;
  text-align: center;
}

.calendar-datebox-day {
  font-size: 28px;
  font-weight: 700;
  color: #fff;
  line-height: 1;
}

.calendar-datebox-day.is-today {
  color: #5b8def;
}

.calendar-datebox-dow {
  font-size: 12px;
  color: #888;
  text-transform: uppercase;
  margin-top: 4px;
}

.calendar-events {
  flex: 1;
}

.calendar-no-events {
  background: var(--card-bg);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 16px;
  color: var(--text-secondary);
  font-size: 14px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.calendar-add-icon-btn {
  background: rgba(91, 141, 239, 0.15);
  border: none;
  border-radius: 8px;
  width: 32px;
  height: 32px;
  color: #5b8def;
  font-size: 20px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.calendar-event {
  background: var(--card-bg);
  border: 1px solid var(--border);
  border-left: 4px solid #5b8def;
  border-radius: 12px;
  padding: 12px 16px;
  margin-bottom: 8px;
  cursor: pointer;
  transition: all 0.2s;
}

.calendar-event:hover {
  background: rgba(255, 255, 255, 0.05);
}

.calendar-event-top {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
}

.calendar-event-main {
  flex: 1;
}

.calendar-event-allday {
  display: inline-flex;
  align-items: center;
  background: rgba(76, 175, 80, 0.15);
  color: #4caf50;
  font-size: 11px;
  font-weight: 600;
  padding: 2px 8px;
  border-radius: 6px;
  margin-bottom: 4px;
}

.calendar-event-title {
  font-size: 15px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 4px;
}

.calendar-event-time {
  font-size: 13px;
  color: var(--text-secondary);
}

.calendar-event-location {
  font-size: 13px;
  color: var(--text-secondary);
  margin-top: 2px;
}

.calendar-event-delete {
  background: none;
  border: none;
  color: var(--danger);
  font-size: 18px;
  cursor: pointer;
  padding: 4px;
}

.calendar-add-event {
  background: rgba(255, 255, 255, 0.05);
  border: 1px dashed var(--border);
  border-radius: 12px;
  width: 100%;
  padding: 12px;
  color: var(--text-secondary);
  font-size: 14px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.event-reminder-dot {
  display: inline-block;
  width: 8px;
  height: 8px;
  border-radius: 999px;
  background: var(--warning);
  margin-left: 8px;
  transform: translateY(-1px);
  opacity: 0.9;
}

.calendar-header-right {
  display: flex;
  align-items: center;
  gap: 10px;
}

.icon-btn {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid var(--border);
  border-radius: 10px;
  width: 38px;
  height: 38px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s;
}

.icon-btn:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: var(--accent);
}

.icon-btn img {
  width: 18px;
  height: 18px;
  opacity: 0.9;
}

/* Utility */
.is-hidden {
  display: none !important;
}

/* -------- Journal View -------- */

.journal-header-actions {
  display: flex;
  align-items: center;
  gap: 8px;
}

.tag-row {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-top: 10px;
}

.tag-pill {
  display: inline-flex;
  align-items: center;
  padding: 6px 10px;
  border-radius: 999px;
  font-size: 12px;
  font-weight: 600;

  background: linear-gradient(135deg, #8b7def 0%, #5b8def 100%);
  color: white;
  border: 1px solid rgba(91, 141, 239, 0.45);

  /* optional: makes them pop slightly like the UI accent */
  box-shadow: 0 4px 10px rgba(91, 141, 239, 0.18);
}

.journal-preview {
  font-size: 14px;
  line-height: 1.5;
  color: var(--text-primary);
  white-space: pre-line;
  word-break: break-word;
  opacity: 0.95;
}

/* Journal */
.journal-body-preview {
  display: -webkit-box;
  -webkit-line-clamp: 4; /* preview lines */
  -webkit-box-orient: vertical;
  overflow: hidden;
  white-space: pre-line;
}

/* Journal preview modal actions */
.journal-preview-actions {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.journal-preview-actions .btn {
  width: 100%;
  justify-content: center;
}

.tag-chip {
  display: inline-flex;
  align-items: center;
  padding: 6px 10px;
  border-radius: 999px;
  font-size: 12px;
  font-weight: 600;

  background: linear-gradient(135deg, #8b7def 0%, #5b8def 100%);
  color: white;
  border: 1px solid rgba(91, 141, 239, 0.45);

  margin-right: 8px;
  margin-top: 8px;

  box-shadow: 0 4px 10px rgba(91, 141, 239, 0.18);
}

.load-more-container {
  margin: 16px;
}

.btn-prompt {
  background: linear-gradient(135deg, #8b7def 0%, #5b8def 100%);
  color: white;
}

.btn-prompt:hover {
  filter: brightness(1.08);
}

.btn-prompt:active {
  transform: scale(0.96);
}

.load-more-btn {
  width: 100%;
  justify-content: center;
  padding: 12px;
}

/* ---------------- Icon System (SVG icons replacing emojis) ---------------- */

/* Global sanity */
img {
  max-width: 100%;
  height: auto;
}

/* Inline icon sizing + alignment */
.card-time img,
.btn img,
.nav-item-icon img,
.empty-state-icon img,
.calendar-add-icon-btn img,
.calendar-event-location img,
.calendar-event-delete img {
  display: inline-block;
  width: 1em;
  height: 1em;
  vertical-align: -0.12em;
  object-fit: contain;
}

/* --- Card time (date / time rows) --- */
.card-time {
  gap: 8px;
}
.card-time img {
  width: 16px;
  height: 16px;
  opacity: 0.9;
}

/* --- Buttons with icons --- */
.btn img {
  width: 16px;
  height: 16px;
}

/* --- Bottom navigation icons --- */
.nav-item-icon {
  font-size: 0; /* removes emoji-era baseline spacing */
  line-height: 0;
}
.nav-item-icon img {
  width: 24px;
  height: 24px;
  opacity: 0.9;
}

.nav-item.active .nav-item-icon img {
  opacity: 1;
}

/* --- Empty states --- */
.empty-state-icon img {
  width: 64px;
  height: 64px;
  opacity: 0.3;
}

/* --- Calendar --- */
.calendar-add-icon-btn img {
  width: 18px;
  height: 18px;
}

.calendar-event-location {
  display: flex;
  align-items: center;
  gap: 8px;
}
.calendar-event-location img {
  width: 14px;
  height: 14px;
  opacity: 0.85;
}

.calendar-event-delete img {
  width: 18px;
  height: 18px;
}
  </style>
</head>

<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;
    const { DateTime } = luxon;

// Telegram WebApp guard (browser vs Telegram)
const tg = window.Telegram?.WebApp;

const isTelegram =
  !!tg &&
  typeof tg.initData === "string" &&
  tg.initData.length > 0;

if (!isTelegram) {
  const root = document.getElementById("root");
  if (root) {
    root.innerHTML = `
<div style="min-height:var(--tg-viewport-height,100vh); display:flex; align-items:center; justify-content:center; padding:24px; text-align:center; color:#fff;">
        <div style="max-width:520px;">
          <h2 style="margin-bottom:12px;">Open in Telegram</h2>
          <p style="opacity:.8; line-height:1.6;">
            This mini app must be opened inside Telegram to access
            your journal entries, reminders, and events.
          </p>
        </div>
      </div>
    `;
  }
  throw new Error("Not running inside Telegram WebApp");
}

// Initialize Telegram Web App.. Safe to init now
tg.ready();
tg.expand();

// --- Telegram real viewport height fix (standalone fullscreen vs chat sheet) ---
function syncTelegramViewportHeight() {
  try {
    const h = tg.viewportHeight; // Telegram's real usable height
    if (h && Number.isFinite(h)) {
      document.documentElement.style.setProperty("--tg-viewport-height", `${h}px`);
    }
  } catch (e) {
    // ignore
  }
}

syncTelegramViewportHeight();
tg.onEvent("viewportChanged", syncTelegramViewportHeight);
// ---------------------------------------------------------------------------

    // API base URL
    const API_BASE = window.location.origin + '/api/miniapp';

    // Helper function to make API calls
    async function apiCall(endpoint, options = {}) {
      const response = await fetch(`${API_BASE}${endpoint}`, {
        ...options,
        headers: {
          'Content-Type': 'application/json',
          'X-Telegram-Init-Data': tg.initData,
          ...options.headers,
        },
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'Request failed');
      }

      return response.json();
    }

    // Format date/time
    function formatDateTime(date) {
      const d = new Date(date);
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const tomorrow = new Date(today);
      tomorrow.setDate(tomorrow.getDate() + 1);

      const dateStr = new Date(d.getFullYear(), d.getMonth(), d.getDate());

      let dayStr;
      if (dateStr.getTime() === today.getTime()) {
        dayStr = 'Today';
      } else if (dateStr.getTime() === tomorrow.getTime()) {
        dayStr = 'Tomorrow';
      } else {
        dayStr = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      }

      const timeStr = d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });

      return `${dayStr} at ${timeStr}`;
    }

    function formatEventTime(event) {
      const start = new Date(event.startDate);
      if (event.allDay) {
        return 'All day';
      }
      const timeStr = start.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
      if (event.endDate) {
        const end = new Date(event.endDate);
        const endTimeStr = end.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        return `${timeStr} - ${endTimeStr}`;
      }
      return timeStr;
    }
    
    function hasReminder(event) {
  return !!(event?.reminderId || event?.reminder?.nextRunAt);
}
    
    // Journal helpers
function normalizeTagsFromText(input) {
  const matches = String(input || '').match(/#[A-Za-z0-9_-]+/g) || [];
  const tags = matches
    .map(t => t.slice(1).trim())
    .filter(Boolean)
    .map(t => t.toLowerCase());
  return Array.from(new Set(tags));
}

function tagsToDisplay(tags) {
  const list = Array.isArray(tags) ? tags : [];
  if (list.length === 0) return '';
  return list.map(t => `#${t}`).join(' ');
}

function formatShortDate(date) {
  const d = new Date(date);
  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

function badgeForStatus(status) {
  const s = String(status || "").toLowerCase();
  if (s === "tbr") return { text: "TBR", bg: "rgba(255,152,0,0.15)", fg: "#ff9800" };
  if (s === "reading") return { text: "READING", bg: "rgba(76,175,80,0.15)", fg: "#4caf50" };
  if (s === "finished") return { text: "FINISHED", bg: "rgba(91,141,239,0.15)", fg: "#5b8def" };
  return { text: "BOOK", bg: "rgba(255,255,255,0.08)", fg: "#ffffff" };
}

function statusLabelToValue(input) {
  const s = String(input || "").toLowerCase().trim();
  if (s === "tbr") return "tbr";
  if (s === "reading" || s === "active") return "reading";
  if (s === "finished" || s === "done") return "finished";
  return "tbr";
}


// Book Card Component
function BookCard({ book, onEdit, onDelete }) {
  const [expanded, setExpanded] = useState(false);

  const title = book.title?.trim() ? book.title.trim() : "(untitled)";
  const author = book.author?.trim() ? book.author.trim() : "";
  const badge = badgeForStatus(book.status);

  const isReading = String(book.status || "").toLowerCase() === "reading";

  const totalPages =
    typeof book.totalPages === "number" && Number.isFinite(book.totalPages)
      ? book.totalPages
      : null;

  const currentPage =
    typeof book.currentPage === "number" && Number.isFinite(book.currentPage)
      ? book.currentPage
      : null;

  const hasProgress = isReading && totalPages && totalPages > 0;

  const safeCurrent = hasProgress
    ? Math.min(Math.max(currentPage || 0, 0), totalPages)
    : 0;

  const pct = hasProgress ? Math.round((safeCurrent / totalPages) * 100) : null;

  return (
    <div className="card" onClick={() => setExpanded(!expanded)}>
      <div className="card-header">
        <div>
          <div style={{ fontSize: 16, fontWeight: 700, marginBottom: 6 }}>
            {title}
          </div>

          {author && (
            <div className="card-time">
              <img src="/icons/user.svg" alt="" />
              <span>{author}</span>
            </div>
          )}
        </div>

        <span className="card-badge" style={{ background: badge.bg, color: badge.fg }}>
          {badge.text}
        </span>
      </div>
      
      {book.shortSummary && (
  <div className="book-summary">
    {book.shortSummary}
  </div>
)}

      {hasProgress && (
        <div className="progress-wrap" onClick={(e) => e.stopPropagation()}>
          <div className="progress-top">
            <div>
              {safeCurrent} / {totalPages} pages
            </div>
            <div className="progress-pct">{pct}%</div>
          </div>

          <div className="progress-bar" aria-label="Reading progress">
            <div className="progress-fill" style={{ width: `${pct}%` }} />
          </div>
        </div>
      )}

      {expanded && (
        <div className="card-actions" onClick={(e) => e.stopPropagation()}>
          <button className="btn btn-primary" onClick={() => onEdit(book)}>
            <img src="/icons/pencil.svg" alt="" />
            Edit
          </button>

          <button className="btn btn-danger" onClick={() => onDelete(book._id)}>
            <img src="/icons/trash.svg" alt="" />
          </button>
        </div>
      )}
    </div>
  );
}

// Book Create & Edit Modal
function BookModal({ book, onClose, onSave, onDelete }) {
  const isEdit = !!book?._id;

  const [title, setTitle] = useState(book?.title || "");
  const [author, setAuthor] = useState(book?.author || "");
  const [status, setStatus] = useState(book?.status || "tbr");
  const [shortSummary, setShortSummary] = useState(book?.shortSummary || "");

  // New: progress fields (optional)
  const [totalPages, setTotalPages] = useState(
    typeof book?.totalPages === "number" ? String(book.totalPages) : ""
  );
  const [currentPage, setCurrentPage] = useState(
    typeof book?.currentPage === "number" ? String(book.currentPage) : ""
  );

  const isReading = String(status || "").toLowerCase() === "reading";

  useEffect(() => {
    document.body.classList.add("modal-open");
    return () => document.body.classList.remove("modal-open");
  }, []);

  // If user changes away from reading, clear progress (keeps UI consistent)
  useEffect(() => {
    if (!isReading) {
      setTotalPages("");
      setCurrentPage("");
    }
  }, [isReading]);

  const handleSave = async () => {
    if (!title.trim()) {
      tg.showAlert("Please enter a title");
      return;
    }

    // Build payload
    const payload = {
      title: title.trim(),
      author: author.trim(),
      status: statusLabelToValue(status),
    };
    
       // Add Summary
        if (shortSummary.trim()) {
  payload.shortSummary = shortSummary.trim();
}

    // Only include progress if reading
    if (isReading) {
      const tp = totalPages === "" ? null : Number(totalPages);
      const cp = currentPage === "" ? null : Number(currentPage);

      if (tp !== null && (!Number.isFinite(tp) || tp < 1)) {
        tg.showAlert("Total pages must be a positive number.");
        return;
      }

      if (cp !== null && (!Number.isFinite(cp) || cp < 0)) {
        tg.showAlert("Current page must be 0 or more.");
        return;
      }

      // Clamp if both provided
      let safeTp = tp;
      let safeCp = cp;

      if (safeTp !== null && safeTp > 0 && safeCp !== null) {
        safeCp = Math.min(Math.max(safeCp, 0), safeTp);
      }

      payload.totalPages = safeTp;
      payload.currentPage = safeCp;
    }

    await onSave(payload);
  };

  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal" onClick={(e) => e.stopPropagation()}>
        <div className="modal-header">
          <h2>{isEdit ? "Edit Book" : "New Book"}</h2>
          <button className="modal-close" onClick={onClose}>×</button>
        </div>

        <div className="modal-body">
          <div className="form-group">
            <label className="form-label">Title</label>
            <input
              className="form-input"
              value={title}
              onChange={(e) => setTitle(e.target.value)}
              placeholder="Book title..."
            />
          </div>

          <div className="form-group">
            <label className="form-label">Author (optional)</label>
            <input
              className="form-input"
              value={author}
              onChange={(e) => setAuthor(e.target.value)}
              placeholder="Author name..."
            />
          </div>
          
          <div className="form-group">
  <label className="form-label">Short Summary (optional)</label>
  <textarea
    className="form-textarea form-textarea--sm"
    value={shortSummary}
    onChange={(e) => setShortSummary(e.target.value)}
    placeholder="One or two short sentences about this book…"
    maxLength={180}
  />
</div>

          <div className="form-group">
            <label className="form-label">Status</label>
            <select
              className="form-select"
              value={status}
              onChange={(e) => setStatus(e.target.value)}
            >
              <option value="tbr">TBR</option>
              <option value="reading">Reading/Active</option>
              <option value="finished">Finished</option>
            </select>
          </div>

          {isReading && (
            <div className="form-row">
              <div className="form-group">
                <label className="form-label">Total Pages</label>
                <input
                  type="number"
                  className="form-input"
                  value={totalPages}
                  min="1"
                  onChange={(e) => setTotalPages(e.target.value)}
                  placeholder="e.g. 384"
                />
              </div>

              <div className="form-group">
                <label className="form-label">Current Page</label>
                <input
                  type="number"
                  className="form-input"
                  value={currentPage}
                  min="0"
                  onChange={(e) => setCurrentPage(e.target.value)}
                  placeholder="e.g. 120"
                />
              </div>
            </div>
          )}
        </div>

        <div className="modal-actions">
          {isEdit ? (
            <button className="btn btn-danger" onClick={() => onDelete(book._id)}>
              Delete
            </button>
          ) : (
            <button className="btn btn-secondary" onClick={onClose}>
              Cancel
            </button>
          )}

          <button className="btn btn-primary" onClick={handleSave}>
            {isEdit ? "Update" : "Create"}
          </button>
        </div>
      </div>
    </div>
  );
}

// Book Summary Modal
function SummaryModal({ onClose, title, author, loading, summary, source, error, onSearchAgain }) {
  useEffect(() => {
    document.body.classList.add("modal-open");
    return () => document.body.classList.remove("modal-open");
  }, []);

  const headerTitle = "Summary";

  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal" onClick={(e) => e.stopPropagation()}>
        <div className="modal-header">
          <h2>{headerTitle}</h2>
          <button className="modal-close" onClick={onClose}>×</button>
        </div>

        <div className="modal-body">
          <div style={{ marginBottom: 12, opacity: 0.85, lineHeight: 1.4 }}>
            <div style={{ fontWeight: 700 }}>{title || "Untitled"}</div>
            {author ? <div style={{ color: "var(--text-secondary)" }}>{author}</div> : null}
          </div>

          {loading ? (
            <div className="loading">
              <div className="spinner" />
              <div>Searching…</div>
            </div>
          ) : error ? (
            <div className="empty-state-text">{error}</div>
          ) : summary ? (
            <div style={{ whiteSpace: "pre-line", lineHeight: 1.6, fontSize: 15 }}>
              {summary}
              {source ? (
                <div style={{ marginTop: 14, fontSize: 12, color: "var(--text-secondary)" }}>
                  Source: {source}
                </div>
              ) : null}
            </div>
          ) : (
            <div className="empty-state-text">No summary to show.</div>
          )}
        </div>

        <div className="modal-actions">
          <button className="btn btn-secondary" onClick={onClose}>
            Close
          </button>

          <button className="btn btn-primary" onClick={onSearchAgain} disabled={loading}>
            Search Again
          </button>
        </div>
      </div>
    </div>
  );
}

// Reading View
function ReadingView({ activeView }) {
  const [books, setBooks] = useState([]);
  const [loading, setLoading] = useState(true);

  const [filter, setFilter] = useState("all"); // all | tbr | reading | finished

  const [showBookModal, setShowBookModal] = useState(false);
  const [editingBook, setEditingBook] = useState(null);

  const [summaryOpen, setSummaryOpen] = useState(false);
  const [summaryLoading, setSummaryLoading] = useState(false);
  const [summaryText, setSummaryText] = useState("");
  const [summarySource, setSummarySource] = useState("");
  const [summaryError, setSummaryError] = useState("");
  const [summaryTitle, setSummaryTitle] = useState("");
  const [summaryAuthor, setSummaryAuthor] = useState("");

  useEffect(() => {
    if (activeView === "reading") {
      loadBooks();
    }
  }, [activeView, filter]);

  const loadBooks = async () => {
    try {
      setLoading(true);
      const data = await apiCall(`/books?status=${encodeURIComponent(filter)}`);
      setBooks(Array.isArray(data.books) ? data.books : []);
    } catch (error) {
      tg.showAlert("Failed to load books: " + error.message);
    } finally {
      setLoading(false);
    }
  };

  const handleCreate = () => {
    setEditingBook(null);
    setShowBookModal(true);
  };

  const handleEdit = (book) => {
    setEditingBook(book);
    setShowBookModal(true);
  };

  const handleSave = async (payload) => {
    try {
      if (editingBook?._id) {
        await apiCall(`/books/${editingBook._id}`, {
          method: "PUT",
          body: JSON.stringify(payload),
        });
        tg.showAlert("Book updated!");
      } else {
        await apiCall(`/books`, {
          method: "POST",
          body: JSON.stringify(payload),
        });
        tg.showAlert("Book added!");
      }

      setShowBookModal(false);
      loadBooks();
    } catch (error) {
      tg.showAlert("Failed to save: " + error.message);
    }
  };

  const handleDelete = async (id) => {
    try {
      await apiCall(`/books/${id}`, { method: "DELETE" });
      tg.showPopup({ message: "Book deleted" });
      loadBooks();
    } catch (error) {
      tg.showAlert("Failed to delete: " + error.message);
    }
  };

  const promptSummarySearch = async () => {
    const t = window.prompt("Book title:");
    if (!t || !t.trim()) return;

    const a = window.prompt("Author (optional):") || "";

    await runSummarySearch(t.trim(), a.trim());
  };

  const runSummarySearch = async (title, author) => {
    try {
      setSummaryTitle(title);
      setSummaryAuthor(author);

      setSummaryOpen(true);
      setSummaryLoading(true);
      setSummaryText("");
      setSummarySource("");
      setSummaryError("");

      const data = await apiCall(`/books/summary`, {
        method: "POST",
        body: JSON.stringify({ title, author }),
      });

      setSummaryText(String(data.summary || ""));
      setSummarySource(String(data.source || ""));
    } catch (error) {
      setSummaryError(error.message || "No summary found.");
    } finally {
      setSummaryLoading(false);
    }
  };

  return (
    <div>
      <div className="header">
        <h1>Reading</h1>

        <div className="journal-header-actions">
          <button className="btn btn-prompt" type="button" onClick={promptSummarySearch}>
            Summary
          </button>
        </div>
      </div>

      <div className="quick-actions">
        <div
          className={`quick-action ${filter === "all" ? "active" : ""}`}
          onClick={() => setFilter("all")}
        >
          All
        </div>
        <div
          className={`quick-action ${filter === "tbr" ? "active" : ""}`}
          onClick={() => setFilter("tbr")}
        >
          TBR
        </div>
        <div
          className={`quick-action ${filter === "reading" ? "active" : ""}`}
          onClick={() => setFilter("reading")}
        >
          Reading
        </div>
        <div
          className={`quick-action ${filter === "finished" ? "active" : ""}`}
          onClick={() => setFilter("finished")}
        >
          Finished
        </div>
      </div>

      {loading ? (
        <div className="loading">
          <div className="spinner" />
          <div>Loading books...</div>
        </div>
      ) : books.length === 0 ? (
        <div className="empty-state">
          <div className="empty-state-icon">
            <img src="/icons/book.svg" alt="" />
          </div>
          <div className="empty-state-text">
            No books yet.
            {"\n"}Tap + to add one.
          </div>
        </div>
      ) : (
        books.map((book) => (
          <BookCard key={book._id} book={book} onEdit={handleEdit} onDelete={handleDelete} />
        ))
      )}

      {/* Hidden FAB hook */}
      <button
        className="is-hidden"
        data-create-book="1"
        onClick={handleCreate}
      />

      {showBookModal && (
        <BookModal
          book={editingBook}
          onClose={() => setShowBookModal(false)}
          onSave={handleSave}
          onDelete={handleDelete}
        />
      )}

      {summaryOpen && (
        <SummaryModal
          onClose={() => setSummaryOpen(false)}
          title={summaryTitle}
          author={summaryAuthor}
          loading={summaryLoading}
          summary={summaryText}
          source={summarySource}
          error={summaryError}
          onSearchAgain={promptSummarySearch}
        />
      )}
    </div>
  );
}

// Journal Card Component
function JournalCard({ entry, onView, onEdit, onDelete }) {
  const [expanded, setExpanded] = useState(false);

  const title = entry.title?.trim() ? entry.title.trim() : '(untitled)';
  const tags = Array.isArray(entry.tags) ? entry.tags : [];
  const body = entry.body || '';

  const preview = body.length > 260 ? body.slice(0, 260) + '…' : body;

  return (
<div className="card" onClick={() => onView(entry)}>
      <div className="card-header">
        <div>
          <div style={{ fontSize: 16, fontWeight: 700, marginBottom: 6 }}>
            {title}
          </div>
          <div className="card-time">
  <img src="/icons/cal.svg" alt="" />
  <span>{formatShortDate(entry.createdAt)}</span>
</div>
        </div>

        <span className="card-badge" style={{ background: 'rgba(139,125,239,0.15)', color: '#8b7def' }}>
          journal
        </span>
      </div>

      <div className="journal-preview">{preview}</div>

      {tags.length > 0 && (
        <div className="tag-row">
          {tags.map(t => (
            <span key={t} className="tag-pill">#{t}</span>
          ))}
        </div>
      )}

      {expanded && (
        <div className="card-actions" onClick={e => e.stopPropagation()} style={{ marginTop: 14 }}>
          <button className="btn btn-primary" onClick={() => onEdit(entry)}>
  <img src="/icons/pencil.svg" alt="" />
  Edit
</button>
          <button className="btn btn-danger" onClick={() => onDelete(entry._id)}>
  <img src="/icons/trash.svg" alt="" />
</button>
        </div>
      )}
    </div>
  );
}

// Journal Modal
function JournalModal({ entry, onClose, onSave, onDelete }) {
  const [title, setTitle] = useState(entry?.title || '');
  const [tagsText, setTagsText] = useState(tagsToDisplay(entry?.tags || []));
  const [body, setBody] = useState(entry?.body || '');

  const isEdit = !!entry?._id;
  
  useEffect(() => {
    document.body.classList.add('modal-open');
    return () => {
      document.body.classList.remove('modal-open');
    };
  }, []);

  const handleSave = async () => {
    if (!body.trim()) {
      tg.showAlert('Please enter a journal body');
      return;
    }

    const tags = normalizeTagsFromText(tagsText);

    await onSave({
      title: title.trim(),
      body,
      tags
    });
  };

  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal" onClick={e => e.stopPropagation()}>
        <div className="modal-header">
          <h2>{isEdit ? 'Edit Entry' : 'New Entry'}</h2>
          <button className="modal-close" onClick={onClose}>×</button>
        </div>

        <div className="modal-body">
          <div className="form-group">
            <label className="form-label">Title (optional)</label>
            <input
              type="text"
              className="form-input"
              value={title}
              onChange={e => setTitle(e.target.value)}
              placeholder="Title..."
            />
          </div>

          <div className="form-group">
            <label className="form-label">Tags</label>
            <input
              type="text"
              className="form-input"
              value={tagsText}
              onChange={e => setTagsText(e.target.value)}
              placeholder="#tag-1 #tag-2"
            />
          </div>

          <div className="form-group">
            <label className="form-label">Body</label>
            <textarea
              className="form-textarea"
              value={body}
              onChange={e => setBody(e.target.value)}
              placeholder="Write your entry..."
            />
          </div>
        </div>

        <div className="modal-actions">
          {isEdit ? (
            <button className="btn btn-danger" onClick={() => onDelete(entry._id)}>
              Delete
            </button>
          ) : (
            <button className="btn btn-secondary" onClick={onClose}>
              Cancel
            </button>
          )}

          <button className="btn btn-primary" onClick={handleSave}>
            {isEdit ? 'Update' : 'Create'}
          </button>
        </div>
      </div>
    </div>
  );
}


// Journals View
function JournalsView({ activeView }) {
  const [entries, setEntries] = useState([]);
  const [loading, setLoading] = useState(true);
  const [showModal, setShowModal] = useState(false);
  const [editingEntry, setEditingEntry] = useState(null);
  const [loadingMore, setLoadingMore] = useState(false);
const [cursor, setCursor] = useState(null); // ISO string (createdAt of last)
const [hasMore, setHasMore] = useState(true);

const [viewerEntry, setViewerEntry] = useState(null); // for read-only modal

const [promptModalOpen, setPromptModalOpen] = useState(false);
const [dailyPrompt, setDailyPrompt] = useState("");
const [promptRemaining, setPromptRemaining] = useState(null);
const [promptLoading, setPromptLoading] = useState(false);

const PAGE_SIZE = 10;

useEffect(() => {
  if (activeView === "journal") {
    // reset + load first page every time you enter the Journal tab
    loadFirstPage();
  }
}, [activeView]);

const loadFirstPage = async () => {
  try {
    setLoading(true);

    // reset pagination state
    setEntries([]);
    setCursor(null);
    setHasMore(true);

    const data = await apiCall(`/journal?limit=${PAGE_SIZE}`);
    const list = data.entries || [];

    setEntries(list);

    if (list.length < PAGE_SIZE) {
      setHasMore(false);
      setCursor(null);
    } else {
      const last = list[list.length - 1];
      setCursor(last?.createdAt || null);
    }
  } catch (error) {
    tg.showAlert("Failed to load journal: " + error.message);
  } finally {
    setLoading(false);
  }
};

const loadMore = async () => {
  // guard rails
  if (activeView !== "journal") return;
  if (!hasMore) return;
  if (loadingMore) return;
  if (!cursor) return;

  try {
    setLoadingMore(true);

    const data = await apiCall(
      `/journal?limit=${PAGE_SIZE}&before=${encodeURIComponent(cursor)}`
    );
    const list = data.entries || [];

    // append (do NOT overwrite)
    setEntries((prev) => [...prev, ...list]);

    if (list.length < PAGE_SIZE) {
      setHasMore(false);
      setCursor(null);
    } else {
      const last = list[list.length - 1];
      setCursor(last?.createdAt || null);
    }
  } catch (error) {
    tg.showAlert("Failed to load more: " + error.message);
  } finally {
    setLoadingMore(false);
  }
};

  const handleCreate = () => {
    setEditingEntry(null);
    setShowModal(true);
  };

  const handleEdit = (entry) => {
    setEditingEntry(entry);
    setShowModal(true);
  };

  const handleSave = async (payload) => {
    try {
      if (editingEntry?._id) {
        await apiCall(`/journal/${editingEntry._id}`, {
          method: 'PUT',
          body: JSON.stringify(payload),
        });
        tg.showAlert('Entry updated!');
      } else {
        await apiCall(`/journal`, {
          method: 'POST',
          body: JSON.stringify(payload),
        });
        tg.showAlert('Entry created!');
      }
      setShowModal(false);
      loadFirstPage();
    } catch (error) {
      tg.showAlert('Failed to save: ' + error.message);
    }
  };

  const handleDelete = async (id) => {
    try {
      await apiCall(`/journal/${id}`, { method: 'DELETE' });
      tg.showPopup({ message: 'Entry deleted' });
      loadFirstPage();
    } catch (error) {
      tg.showAlert('Failed to delete: ' + error.message);
    }
  };
  
const handleGeneratePrompt = async () => {
  try {
    setPromptLoading(true);
    setDailyPrompt("");

    const data = await apiCall(`/journal/prompt`, {
      method: "POST",
      body: JSON.stringify({}),
    });

    setDailyPrompt(data.prompt || "");
    setPromptRemaining(
      typeof data.remaining === "number" ? data.remaining : null
    );
  } catch (error) {
    const msg = error?.message || "Failed to generate prompt";
    tg.showAlert(msg);
  } finally {
    setPromptLoading(false);
  }
};

  return (
    <div>
      <div className="header">
        <h1>Journal</h1>
<div className="journal-header-actions">
  <button
  className="btn btn-prompt"
  type="button"
  onClick={() => {
    setPromptModalOpen(true);
    handleGeneratePrompt();
  }}
>
  Prompt
</button>
</div>
      </div>

      {loading ? (
        <div className="loading">
          <div className="spinner" />
          <div>Loading journal...</div>
        </div>
      ) : entries.length === 0 ? (
        <div className="empty-state">
          <div className="empty-state-icon">
  <img src="/icons/edit.svg" alt="" />
</div>
          <div className="empty-state-text">
            No journal entries yet.
            {"\n"}Tap + to create one.
          </div>
        </div>
      ) : (
        <>
          {entries.map((entry) => (
            <JournalCard
  key={entry._id}
  entry={entry}
  onView={(e) => setViewerEntry(e)}
  onEdit={handleEdit}
  onDelete={handleDelete}
/>
          ))}

          {hasMore && (
            <div className="load-more-container">
              <button
                className="btn btn-secondary load-more-btn"
                onClick={loadMore}
                disabled={loadingMore}
              >
                {loadingMore ? "Loading…" : "Load more"}
              </button>
            </div>
          )}
        </>
      )}

{viewerEntry && (
  <JournalEntryModal
    entry={viewerEntry}
    onClose={() => setViewerEntry(null)}
    onEdit={(entry) => {
      setViewerEntry(null);
      setEditingEntry(entry);
      setShowModal(true);
    }}
    onDelete={handleDelete}
  />
)}

<button
  className="is-hidden"
  data-create-journal="1"
  onClick={() => {
    setViewerEntry(null);      // optional but nice: closes preview if open
    setEditingEntry(null);
    setShowModal(true);
  }}
/>

      {showModal && (
        <JournalModal
          entry={editingEntry}
          onClose={() => setShowModal(false)}
          onSave={handleSave}
          onDelete={handleDelete}
        />
      )}
      
      {promptModalOpen && (
  <PromptModal 
    onClose={() => setPromptModalOpen(false)}
    onGenerate={handleGeneratePrompt}
    prompt={dailyPrompt}
    remaining={promptRemaining}
    loading={promptLoading}
  />
)}
      
    </div>
  );
}

// Journal Preview Modal
function JournalEntryModal({ entry, onClose, onEdit, onDelete }) {
  if (!entry) return null;
  
  useEffect(() => {
    document.body.classList.add('modal-open');
    return () => {
      document.body.classList.remove('modal-open');
    };
  }, []);

  const created = entry.createdAt ? new Date(entry.createdAt) : null;
  const dateStr = created
    ? created.toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" })
    : "";

  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal" onClick={(e) => e.stopPropagation()}>
        <div className="modal-header">
          <h2>{entry.title?.trim() ? entry.title : "Journal Entry"}</h2>
          <button className="modal-close" onClick={onClose}>×</button>
        </div>

        <div className="modal-body">
          {dateStr && (
            <div className="card-time" style={{ marginBottom: 12 }}>
  <img src="/icons/cal.svg" alt="" />
  <span>{dateStr}</span>
</div>
          )}

          <div style={{ whiteSpace: "pre-line", lineHeight: 1.6, fontSize: 15 }}>
            {entry.body}
          </div>

          {Array.isArray(entry.tags) && entry.tags.length > 0 && (
            <div className="tag-row">
              {entry.tags.map((t) => (
                <span key={t} className="tag-pill">#{t}</span>
              ))}
            </div>
          )}
        </div>

        <div className="modal-actions journal-preview-actions">
  <button className="btn btn-primary" onClick={() => onEdit(entry)}>
    Edit
  </button>

  <button className="btn btn-secondary" onClick={onClose}>
    Close
  </button>

  <button
    className="btn btn-danger"
    type="button"
    onClick={() => {
      if (!entry?._id) return;
      onDelete(entry._id);
      onClose(); // close the preview modal immediately after delete
    }}
  >
    Delete
  </button>
</div>
      </div>
    </div>
  );
}

// Prompt Modal
function PromptModal({ onClose, onGenerate, prompt, remaining, loading }) {
  useEffect(() => {
    document.body.classList.add('modal-open');
    return () => {
      document.body.classList.remove('modal-open');
    };
  }, []);

  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal" onClick={(e) => e.stopPropagation()}>
        <div className="modal-header">
          <h2>Prompt</h2>
          <button
            className="modal-close"
            onClick={onClose}
            type="button"
          >
            ×
          </button>
        </div>

        <div className="modal-body">
          {loading ? (
            <div className="loading">
              <div className="spinner" />
              <div>Generating…</div>
            </div>
          ) : prompt ? (
            <>
              <div className="journal-prompt-text">{prompt}</div>

              {typeof remaining === "number" && (
                <div className="journal-prompt-meta">
                  Remaining today: {remaining}
                </div>
              )}
            </>
          ) : (
            <div className="empty-state-text">Tap Prompt to generate.</div>
          )}
        </div>

        <div className="modal-actions">
          <button
            className="btn btn-secondary"
            onClick={onClose}
            type="button"
          >
            Close
          </button>

          <button
            className="btn btn-primary"
            onClick={onGenerate}
            disabled={loading}
            type="button"
          >
            Generate Again
          </button>
        </div>
      </div>
    </div>
  );
}

    // Reminder Card Component
    function ReminderCard({ reminder, onEdit, onSnooze, onDone, onDelete }) {
      const [expanded, setExpanded] = useState(false);

      const getBadgeClass = () => {
        const kind = reminder.schedule?.kind || 'once';
        return `card-badge badge-${kind}`;
      };

      return (
        <div className="card" onClick={() => setExpanded(!expanded)}>
          <div className="card-header">
            <div className="card-time">
  <img src="/icons/alarm.svg" alt="" />
  <span>{formatDateTime(reminder.nextRunAt)}</span>
</div>
            <span className={getBadgeClass()}>
              {reminder.schedule?.kind || 'once'}
            </span>
          </div>

          <div className="card-text">{reminder.text}</div>

          {expanded && (
            <div className="card-actions" onClick={e => e.stopPropagation()}>
              <button className="btn btn-primary" onClick={() => onEdit(reminder)}>
  <img src="/icons/pencil.svg" alt="" />
  Edit
</button>
              <button className="btn btn-secondary" onClick={() => onSnooze(reminder._id, 15)}>
  <img src="/icons/alarm.svg" alt="" />
  15m
</button>
              <button className="btn btn-secondary" onClick={() => onSnooze(reminder._id, 60)}>
  <img src="/icons/alarm.svg" alt="" />
  1h
</button>
              <button className="btn btn-success" onClick={() => onDone(reminder._id)}>
  <img src="/icons/check.svg" alt="" />
  Done
</button>
              <button className="btn btn-danger" onClick={() => onDelete(reminder._id)}>
  <img src="/icons/trash.svg" alt="" />
</button>
            </div>
          )}
        </div>
      );
    }

    // Reminder Modal
function ReminderModal({ reminder, onClose, onSave, userTimezone }) {
  const [text, setText] = useState(reminder?.text || '');
  const [date, setDate] = useState('');
  const [time, setTime] = useState('');
  const [scheduleKind, setScheduleKind] = useState(reminder?.schedule?.kind || 'once');
  const [intervalMinutes, setIntervalMinutes] = useState(reminder?.schedule?.intervalMinutes || 30);
  
useEffect(() => {
  console.log('Modal opened - adding modal-open class');
  document.body.classList.add('modal-open');
  return () => {
    console.log('Modal closed - removing modal-open class');
    document.body.classList.remove('modal-open');
  };
}, []);


  useEffect(() => {
    if (reminder) {
      const d = new Date(reminder.nextRunAt);
      setDate(d.toISOString().split('T')[0]);
      setTime(d.toTimeString().slice(0, 5));
    } else {
      const now = new Date();
      setDate(now.toISOString().split('T')[0]);
      setTime('09:00');
    }
  }, [reminder]);

  const handleSave = async () => {
    if (!text.trim()) {
      tg.showAlert('Please enter a message');
      return;
    }

const nextRunAt = DateTime
  .fromISO(`${date}T${time}`, { zone: userTimezone })
  .toUTC()
  .toISO();

    const schedule = scheduleKind === 'once'
      ? { kind: 'once' }
      : scheduleKind === 'interval'
      ? { kind: 'interval', intervalMinutes }
      : { kind: scheduleKind, timeOfDay: time };

    await onSave({
      text,
      nextRunAt,
      schedule,
      timezone: userTimezone,
    });
  };

  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal" onClick={e => e.stopPropagation()}>
        <div className="modal-header">
          <h2>{reminder ? 'Edit Reminder' : 'New Reminder'}</h2>
          <button className="modal-close" onClick={onClose}>×</button>
        </div>

        <div className="modal-body">
          <div className="form-group">
            <label className="form-label">Message</label>
            <textarea
              className="form-textarea"
              value={text}
              onChange={e => setText(e.target.value)}
              placeholder="What do you want to be reminded about?"
            />
          </div>

          <div className="form-row">
            <div className="form-group">
              <label className="form-label">Date</label>
              <input
                type="date"
                className="form-input"
                value={date}
                onChange={e => setDate(e.target.value)}
              />
            </div>
            <div className="form-group">
              <label className="form-label">Time</label>
              <input
                type="time"
                className="form-input"
                value={time}
                onChange={e => setTime(e.target.value)}
              />
            </div>
          </div>

          <div className="form-group">
            <label className="form-label">Repeat</label>
            <select
              className="form-select"
              value={scheduleKind}
              onChange={e => setScheduleKind(e.target.value)}
            >
              <option value="once">Once</option>
              <option value="daily">Daily</option>
              <option value="weekly">Weekly</option>
              <option value="interval">Custom Interval</option>
            </select>
          </div>

          {scheduleKind === 'interval' && (
            <div className="form-group">
              <label className="form-label">Interval (minutes)</label>
              <input
                type="number"
                className="form-input"
                value={intervalMinutes}
                onChange={e => setIntervalMinutes(Number(e.target.value))}
                min="1"
              />
            </div>
          )}
        </div>

        <div className="modal-actions">
          <button className="btn btn-secondary" onClick={onClose}>
            Cancel
          </button>
          <button className="btn btn-primary" onClick={handleSave}>
            {reminder ? 'Update' : 'Create'}
          </button>
        </div>
      </div>
    </div>
  );
}


    // Event Modal
// Event Modal
function EventModal({ event, selectedDate, userTimezone, onClose, onSave }) {
  const [title, setTitle] = useState(event?.title || '');
  const [description, setDescription] = useState(event?.description || '');
  const [date, setDate] = useState('');
  const [time, setTime] = useState('');
  const [endTime, setEndTime] = useState('');
  const [allDay, setAllDay] = useState(event?.allDay || false);
  const [location, setLocation] = useState(event?.location || '');

  // Reminder UI state (default OFF)
  const [reminderEnabled, setReminderEnabled] = useState(false);
  const [reminderMode, setReminderMode] = useState('at_event');
  const [offsetMinutes, setOffsetMinutes] = useState(10);
  const [customReminderDate, setCustomReminderDate] = useState('');
  const [customReminderTime, setCustomReminderTime] = useState('');

  // =============================
  // NEW: Recurrence UI state
  // =============================
  const [repeatEnabled, setRepeatEnabled] = useState(false);
  const [repeatFreq, setRepeatFreq] = useState('weekly'); // daily | weekly | monthly | yearly
  const [repeatInterval, setRepeatInterval] = useState(1); // every X
  const [repeatWeekdays, setRepeatWeekdays] = useState([]); // [0..6] Sun..Sat (only for weekly)
  const [repeatEndKind, setRepeatEndKind] = useState('never'); // never | until | count
  const [repeatUntilDate, setRepeatUntilDate] = useState(''); // YYYY-MM-DD
  const [repeatCount, setRepeatCount] = useState(10); // occurrences

  useEffect(() => {
    document.body.classList.add('modal-open');
    return () => {
      document.body.classList.remove('modal-open');
    };
  }, []);

  useEffect(() => {
    // -----------------------------
    // Base event fields
    // -----------------------------
    if (event) {
      const d = new Date(event.startDate);
      setDate(d.toISOString().split('T')[0]);
      setTime(d.toTimeString().slice(0, 5));
      setAllDay(!!event.allDay);
      setLocation(event.location || '');
      setDescription(event.description || '');
      setTitle(event.title || '');

      if (event.endDate) {
        const e = new Date(event.endDate);
        setEndTime(e.toTimeString().slice(0, 5));
      } else {
        setEndTime('');
      }
    } else if (selectedDate) {
      setDate(selectedDate.toISOString().split('T')[0]);
      setTime('09:00');
      setEndTime('10:00');
      setAllDay(false);
      setLocation('');
      setDescription('');
      setTitle('');
    } else {
      const now = new Date();
      setDate(now.toISOString().split('T')[0]);
      setTime('09:00');
      setEndTime('10:00');
      setAllDay(false);
      setLocation('');
      setDescription('');
      setTitle('');
    }

    // -----------------------------
    // Reminder defaults + prefill
    // -----------------------------
    setReminderEnabled(false);
    setReminderMode('at_event');
    setOffsetMinutes(10);

    {
      const now = new Date();
      setCustomReminderDate(now.toISOString().split('T')[0]);
      setCustomReminderTime('09:00');
    }

    if (event && (event.reminder?.nextRunAt || event.reminderId)) {
  setReminderEnabled(true);

  // If backend only gives reminderId (no nextRunAt),
  // we can't calculate offset/custom accurately.
  if (!event.reminder?.nextRunAt) {
    setReminderMode('at_event');
  } else {
    const rNext = new Date(event.reminder.nextRunAt);
    const eStart = new Date(event.startDate);

    const diffMs = eStart.getTime() - rNext.getTime();
    const diffMinutes = Math.round(diffMs / 60000);

    if (Math.abs(diffMinutes) <= 1) {
      setReminderMode('at_event');
    } else if (diffMinutes > 0) {
      setReminderMode('offset');
      setOffsetMinutes(Math.max(1, diffMinutes));
    } else {
      setReminderMode('custom');
      setCustomReminderDate(rNext.toISOString().split('T')[0]);
      setCustomReminderTime(rNext.toTimeString().slice(0, 5));
    }
  }
}

    // -----------------------------
    // NEW: Recurrence defaults + prefill
    // -----------------------------
    setRepeatEnabled(false);
    setRepeatFreq('weekly');
    setRepeatInterval(1);
    setRepeatWeekdays([]);
    setRepeatEndKind('never');
    setRepeatUntilDate('');
    setRepeatCount(10);

    if (event && event.recurrence && event.recurrence.freq) {
      const r = event.recurrence;

      setRepeatEnabled(true);
      setRepeatFreq(String(r.freq || 'weekly'));
      setRepeatInterval(Math.max(1, Number(r.interval || 1)));

      if (Array.isArray(r.byWeekday)) {
        setRepeatWeekdays(
          r.byWeekday
            .map(n => Number(n))
            .filter(n => Number.isFinite(n) && n >= 0 && n <= 6)
        );
      }

      if (r.end && r.end.kind) {
        setRepeatEndKind(String(r.end.kind));

        if (r.end.kind === 'until' && r.end.until) {
          const until = new Date(r.end.until);
          if (!isNaN(until.getTime())) {
            setRepeatUntilDate(until.toISOString().split('T')[0]);
          }
        }

        if (r.end.kind === 'count' && typeof r.end.count === 'number') {
          setRepeatCount(Math.max(1, Number(r.end.count)));
        }
      }
    }
  }, [event, selectedDate]);

  const handleSave = async () => {
    if (!title.trim()) {
      tg.showAlert('Please enter a title');
      return;
    }

const zone = userTimezone || "America/Chicago";

// Build start in USER timezone, then convert to UTC ISO
const startISO = allDay
  ? DateTime.fromISO(date, { zone }).startOf("day").toUTC().toISO()
  : DateTime.fromISO(`${date}T${time}`, { zone }).toUTC().toISO();

// Build end in USER timezone, then convert to UTC ISO
const endISO =
  endTime && !allDay
    ? DateTime.fromISO(`${date}T${endTime}`, { zone }).toUTC().toISO()
    : null;

    // -----------------------------
    // Reminder payload
    // -----------------------------
    let reminderPayload = { enabled: false };

    if (reminderEnabled) {
      if (allDay && reminderMode !== 'custom') {
        tg.showAlert('For all-day events, please use Custom reminder time.');
        return;
      }

      if (reminderMode === 'at_event') {
        reminderPayload = { enabled: true, mode: 'at_event' };
      } else if (reminderMode === 'offset') {
        reminderPayload = { enabled: true, mode: 'offset', offsetMinutes };
      } else {
        if (!customReminderDate || !customReminderTime) {
          tg.showAlert('Please choose a custom reminder date and time.');
          return;
        }
const customISO = DateTime
  .fromISO(`${customReminderDate}T${customReminderTime}`, { zone })
  .toUTC()
  .toISO();

reminderPayload = {
  enabled: true,
  mode: 'custom',
  customDateTime: customISO,
};
      }
    }

    // -----------------------------
    // NEW: Recurrence payload
    // -----------------------------
    let recurrence = null;

    if (repeatEnabled) {
      const freq = String(repeatFreq || 'weekly');
      const interval = Math.max(1, Number(repeatInterval || 1));

      let byWeekday = undefined;
      if (freq === 'weekly') {
        const list = Array.isArray(repeatWeekdays)
          ? repeatWeekdays.map(n => Number(n)).filter(n => n >= 0 && n <= 6)
          : [];

const startWeekday = new Date(date + "T00:00:00").getDay(); // 0..6

if (list.length === 0) {
  byWeekday = [startWeekday];
} else {
  byWeekday = Array.from(new Set(list));
}
      }

let end = { kind: "never" };

if (repeatEndKind === "until") {
  if (!repeatUntilDate) {
    tg.showAlert('Choose an "until" date for repeating events.');
    return;
  }

  const untilISO = DateTime
    .fromISO(repeatUntilDate, { zone })
    .endOf("day")
    .toUTC()
    .toISO();

  end = { kind: "until", until: untilISO };
}

if (repeatEndKind === "count") {
  const c = Math.max(1, Number(repeatCount || 1));
  end = { kind: "count", count: c };
}

      recurrence = {
        freq,
        interval,
        ...(byWeekday ? { byWeekday } : {}),
        end,
      };
    }

    await onSave({
      title,
      description,
      startDate: startISO,
endDate: endISO || undefined,
      allDay,
      location,
      reminder: reminderPayload,
      recurrence,
    });
  };

  const ReminderModeButton = ({ value, label }) => {
    const active = reminderMode === value;
    const className = `btn ${active ? 'btn-primary' : 'btn-secondary'}`;
    return (
      <button
        type="button"
        className={className}
        onClick={() => setReminderMode(value)}
      >
        {label}
      </button>
    );
  };

  const OffsetButton = ({ minutes }) => {
    const active = offsetMinutes === minutes;
    const className = `btn ${active ? 'btn-primary' : 'btn-secondary'}`;
    return (
      <button
        type="button"
        className={className}
        onClick={() => setOffsetMinutes(minutes)}
      >
        {minutes}m
      </button>
    );
  };

  // =============================
  // NEW: Repeat UI helpers
  // =============================
  const weekdayLabels = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

  const toggleWeekday = (idx) => {
    setRepeatWeekdays((prev) => {
      const set = new Set(Array.isArray(prev) ? prev : []);
      if (set.has(idx)) set.delete(idx);
      else set.add(idx);
      return Array.from(set).sort((a, b) => a - b);
    });
  };

  const WeekdayButton = ({ idx }) => {
    const active = Array.isArray(repeatWeekdays) && repeatWeekdays.includes(idx);
    const className = `btn ${active ? 'btn-primary' : 'btn-secondary'}`;
    return (
      <button
        type="button"
        className={className}
        onClick={() => toggleWeekday(idx)}
      >
        {weekdayLabels[idx]}
      </button>
    );
  };

  const EndKindButton = ({ value, label }) => {
    const active = repeatEndKind === value;
    const className = `btn ${active ? 'btn-primary' : 'btn-secondary'}`;
    return (
      <button
        type="button"
        className={className}
        onClick={() => setRepeatEndKind(value)}
      >
        {label}
      </button>
    );
  };

  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal" onClick={e => e.stopPropagation()}>
        <div className="modal-header">
          <h2>{event ? 'Edit Event' : 'New Event'}</h2>
          <button className="modal-close" onClick={onClose}>×</button>
        </div>

        <div className="modal-body">
          <div className="form-group">
            <label className="form-label">Title</label>
            <input
              type="text"
              className="form-input"
              value={title}
              onChange={e => setTitle(e.target.value)}
              placeholder="Event title"
            />
          </div>

          <div className="form-group">
            <label className="form-label">Description</label>
            <textarea
              className="form-textarea form-textarea--sm"
              value={description}
              onChange={e => setDescription(e.target.value)}
              placeholder="Add details..."
            />
          </div>

          <div className="form-group">
            <label className="form-label">Date</label>
            <input
              type="date"
              className="form-input"
              value={date}
              onChange={e => setDate(e.target.value)}
            />
          </div>

          <div className="form-group">
            <label className="checkbox-row">
              <input
                type="checkbox"
                checked={allDay}
                onChange={e => setAllDay(e.target.checked)}
              />
              <span>All day event</span>
            </label>
          </div>

          {!allDay && (
            <div className="form-row">
              <div className="form-group">
                <label className="form-label">Start Time</label>
                <input
                  type="time"
                  className="form-input"
                  value={time}
                  onChange={e => setTime(e.target.value)}
                />
              </div>
              <div className="form-group">
                <label className="form-label">End Time</label>
                <input
                  type="time"
                  className="form-input"
                  value={endTime}
                  onChange={e => setEndTime(e.target.value)}
                />
              </div>
            </div>
          )}

          <div className="form-group">
            <label className="form-label">Location</label>
            <input
              type="text"
              className="form-input"
              value={location}
              onChange={e => setLocation(e.target.value)}
              placeholder="Add location"
            />
          </div>

          {/* =============================
              Reminder section (existing)
             ============================= */}
          <div className="form-group">
            <label className="form-label">Reminder</label>

            <label className="checkbox-row" style={{ marginBottom: 12 }}>
              <input
                type="checkbox"
                checked={reminderEnabled}
                onChange={e => setReminderEnabled(e.target.checked)}
              />
              <span>Enable reminder</span>
            </label>

            {reminderEnabled && (
              <div>
                <div className="card-actions" style={{ marginBottom: 12 }}>
                  <ReminderModeButton value="at_event" label="At event time" />
                  <ReminderModeButton value="offset" label="Before event" />
                  <ReminderModeButton value="custom" label="Custom time" />
                </div>

                {reminderMode === 'offset' && (
                  <div className="card-actions" style={{ marginBottom: 12 }}>
                    <OffsetButton minutes={5} />
                    <OffsetButton minutes={10} />
                    <OffsetButton minutes={15} />
                    <OffsetButton minutes={30} />
                    <OffsetButton minutes={60} />
                  </div>
                )}

                {reminderMode === 'custom' && (
                  <div className="form-row">
                    <div className="form-group">
                      <label className="form-label">Reminder Date</label>
                      <input
                        type="date"
                        className="form-input"
                        value={customReminderDate}
                        onChange={e => setCustomReminderDate(e.target.value)}
                      />
                    </div>
                    <div className="form-group">
                      <label className="form-label">Reminder Time</label>
                      <input
                        type="time"
                        className="form-input"
                        value={customReminderTime}
                        onChange={e => setCustomReminderTime(e.target.value)}
                      />
                    </div>
                  </div>
                )}

                {allDay && reminderMode !== 'custom' && (
                  <div style={{ color: 'var(--text-secondary)', fontSize: 13, lineHeight: 1.4 }}>
                    For all-day events, use Custom reminder time.
                  </div>
                )}
              </div>
            )}
          </div>

          {/* =============================
              NEW: Repeat section
             ============================= */}
          <div className="form-group">
            <label className="form-label">Repeat</label>

            <label className="checkbox-row" style={{ marginBottom: 12 }}>
              <input
                type="checkbox"
                checked={repeatEnabled}
                onChange={e => setRepeatEnabled(e.target.checked)}
              />
              <span>Repeat event</span>
            </label>

            {repeatEnabled && (
              <div>
                <div className="form-row">
                  <div className="form-group">
                    <label className="form-label">Frequency</label>
                    <select
                      className="form-select"
                      value={repeatFreq}
                      onChange={(e) => {
                        const v = e.target.value;
                        setRepeatFreq(v);

                        // If they switch away from weekly, clear weekday selection
                        if (v !== 'weekly') {
                          setRepeatWeekdays([]);
                        }
                      }}
                    >
                      <option value="daily">Daily</option>
                      <option value="weekly">Weekly</option>
                      <option value="monthly">Monthly</option>
                      <option value="yearly">Yearly</option>
                    </select>
                  </div>

                  <div className="form-group">
                    <label className="form-label">Every</label>
                    <input
                      type="number"
                      className="form-input"
                      min="1"
                      value={repeatInterval}
                      onChange={(e) => setRepeatInterval(Math.max(1, Number(e.target.value || 1)))}
                      placeholder="1"
                    />
                    <div style={{ color: 'var(--text-secondary)', fontSize: 12, marginTop: 6, lineHeight: 1.35 }}>
                      {repeatFreq === 'daily' ? 'days' :
                       repeatFreq === 'weekly' ? 'weeks' :
                       repeatFreq === 'monthly' ? 'months' : 'years'}
                    </div>
                  </div>
                </div>

                {repeatFreq === 'weekly' && (
                  <div className="form-group">
                    <label className="form-label">On</label>
                    <div className="card-actions" style={{ marginBottom: 6 }}>
                      {weekdayLabels.map((_, idx) => (
                        <WeekdayButton key={idx} idx={idx} />
                      ))}
                    </div>
                    <div style={{ color: 'var(--text-secondary)', fontSize: 12, lineHeight: 1.35 }}>
                      If you select none, it defaults to the event’s start weekday.
                    </div>
                  </div>
                )}

                <div className="form-group">
                  <label className="form-label">Ends</label>

                  <div className="card-actions" style={{ marginBottom: 12 }}>
                    <EndKindButton value="never" label="Never" />
                    <EndKindButton value="until" label="Until date" />
                    <EndKindButton value="count" label="After N" />
                  </div>

                  {repeatEndKind === 'until' && (
                    <div className="form-group">
                      <label className="form-label">Until</label>
                      <input
                        type="date"
                        className="form-input"
                        value={repeatUntilDate}
                        onChange={(e) => setRepeatUntilDate(e.target.value)}
                      />
                    </div>
                  )}

                  {repeatEndKind === 'count' && (
                    <div className="form-group">
                      <label className="form-label">Occurrences</label>
                      <input
                        type="number"
                        className="form-input"
                        min="1"
                        value={repeatCount}
                        onChange={(e) => setRepeatCount(Math.max(1, Number(e.target.value || 1)))}
                      />
                    </div>
                  )}

                  <div style={{ color: 'var(--text-secondary)', fontSize: 12, lineHeight: 1.35 }}>
                    Your backend still needs to store and expand recurrence for it to appear on the calendar.
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>

        <div className="modal-actions">
          <button className="btn btn-secondary" onClick={onClose}>
            Cancel
          </button>
          <button className="btn btn-primary" onClick={handleSave}>
            {event ? 'Update' : 'Create'}
          </button>
        </div>
      </div>
    </div>
  );
}


    // Calendar View - Day List Style
function CalendarView({ onOpenSettings, userTimezone }) {
      const [currentMonth, setCurrentMonth] = useState(new Date());
      const [events, setEvents] = useState([]);
      const [loading, setLoading] = useState(true);
      const [showEventModal, setShowEventModal] = useState(false);
      const [editingEvent, setEditingEvent] = useState(null);
      const [selectedDate, setSelectedDate] = useState(null);
      const createEventRefs = useRef({});

      useEffect(() => {
        loadEvents();
      }, [currentMonth]);

      const loadEvents = async () => {
        try {
          setLoading(true);
          const startOfMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
const endExclusive = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1);

const data = await apiCall(
  `/calendar/events?startDate=${startOfMonth.toISOString()}&endDate=${endExclusive.toISOString()}`
);
          setEvents(data.events);
        } catch (error) {
          tg.showAlert('Failed to load events: ' + error.message);
        } finally {
          setLoading(false);
        }
      };

      const getDaysInMonth = () => {
        const year = currentMonth.getFullYear();
        const month = currentMonth.getMonth();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        const days = [];
        for (let i = 1; i <= daysInMonth; i++) {
          days.push(new Date(year, month, i));
        }

        return days;
      };

      const getEventsForDate = (date) => {
  const dayStart = new Date(date.getFullYear(), date.getMonth(), date.getDate(), 0, 0, 0);
  const dayEnd = new Date(date.getFullYear(), date.getMonth(), date.getDate() + 1, 0, 0, 0);

  return events.filter((event) => {
    const start = new Date(event.startDate);
    const end = event.endDate ? new Date(event.endDate) : null;

    // No end date = treat as instant event on start time
    if (!end || isNaN(end.getTime())) {
      return start >= dayStart && start < dayEnd;
    }

    // Overlap test: event intersects [dayStart, dayEnd)
    return start < dayEnd && end > dayStart;
  });
};

      const isToday = (date) => {
        const today = new Date();
        return date.toDateString() === today.toDateString();
      };

      const handlePrevMonth = () => {
        setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1));
      };

      const handleNextMonth = () => {
        setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1));
      };

      const handleCreateEvent = (date) => {
        setSelectedDate(date);
        setEditingEvent(null);
        setShowEventModal(true);
      };

      const handleEditEvent = (event) => {
        setEditingEvent(event);
        setSelectedDate(null);
        setShowEventModal(true);
      };

      const handleSaveEvent = async (data) => {
        try {
          if (editingEvent) {
            await apiCall(`/calendar/events/${editingEvent._id}`, {
              method: 'PUT',
              body: JSON.stringify(data),
            });
            tg.showAlert('Event updated!');
          } else {
            await apiCall('/calendar/events', {
              method: 'POST',
              body: JSON.stringify(data),
            });
            tg.showAlert('Event created!');
          }
          setShowEventModal(false);
          setSelectedDate(null);
          loadEvents();
        } catch (error) {
          tg.showAlert('Failed to save: ' + error.message);
        }
      };

      const handleDeleteEvent = async (eventId, e) => {
        e.stopPropagation();
        try {
          await apiCall(`/calendar/events/${eventId}`, {
            method: 'DELETE',
          });
          tg.showPopup({ message: 'Event deleted' });
          loadEvents();
        } catch (error) {
          tg.showAlert('Failed to delete: ' + error.message);
        }
      };

      const monthName = currentMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
      const days = getDaysInMonth();

      return (
        <div>
          <div className="calendar-header">
  <div className="calendar-month">
    <button className="calendar-nav-btn" onClick={handlePrevMonth}>‹</button>
    <span>{monthName}</span>
    <button className="calendar-nav-btn" onClick={handleNextMonth}>›</button>
  </div>

  <div className="calendar-header-right">
    <button
      className="icon-btn"
      type="button"
      onClick={() => onOpenSettings && onOpenSettings()}
      aria-label="Settings"
      title="Settings"
    >
      <img src="/icons/cog.svg" alt="" />
    </button>
  </div>
</div>

          {loading ? (
            <div className="loading">
              <div className="spinner" />
              <div>Loading calendar...</div>
            </div>
          ) : (
            <div className="calendar-body">
              {days.map(date => {
                const dayEvents = getEventsForDate(date);
                const dateIsToday = isToday(date);

                return (
                  <div key={date.toISOString()} className="calendar-day">
                    <div className="calendar-day-row">
                      {/* Date box */}
                      <div className="calendar-datebox">
                        <div className={`calendar-datebox-day ${dateIsToday ? 'is-today' : ''}`}>
                          {date.getDate()}
                        </div>
                        <div className="calendar-datebox-dow">
                          {date.toLocaleDateString('en-US', { weekday: 'short' })}
                        </div>
                      </div>

                      {/* Events container */}
                      <div className="calendar-events">
                        {dayEvents.length === 0 ? (
                          <div className="calendar-no-events">
                            <span>No events</span>
                            <button
  ref={el => createEventRefs.current[date.toISOString()] = el}
  onClick={() => handleCreateEvent(date)}
  className="calendar-add-icon-btn"
>
  <img src="/icons/plus.svg" alt="" />
</button>
                          </div>
                        ) : (
                          <div>
                            {dayEvents.map(event => (
                              <div
                                key={event._id}
                                onClick={() => handleEditEvent(event)}
                                className="calendar-event"
                              >
                                <div className="calendar-event-top">
                                  <div className="calendar-event-main">
                                    {event.allDay && (
                                      <div className="calendar-event-allday">
                                        ● All day
                                      </div>
                                    )}
                                    <div className="calendar-event-title">
  {(event.title || event.text || event.name || "(untitled)")}
  {hasReminder(event) && <span className="event-reminder-dot" />}
</div>
                                    {!event.allDay && (
                                      <div className="calendar-event-time">
                                        {formatEventTime(event)}
                                      </div>
                                    )}
                                    {event.location && (
                                      <div className="calendar-event-location">
  <img src="/icons/location.svg" alt="" />
  {event.location}
</div>
                                    )}
                                  </div>
                                  <button
  onClick={(e) => handleDeleteEvent(event._id, e)}
  className="calendar-event-delete"
>
  <img src="/icons/trash.svg" alt="" />
</button>
                                </div>
                              </div>
                            ))}
                            <button
                              ref={el => createEventRefs.current[date.toISOString()] = el}
                              onClick={() => handleCreateEvent(date)}
                              className="calendar-add-event"
                            >
                              + Add event
                            </button>
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          )}

          {showEventModal && (
            <EventModal
  event={editingEvent}
  selectedDate={selectedDate}
  userTimezone={userTimezone}
  onClose={() => {
    setShowEventModal(false);
    setSelectedDate(null);
  }}
  onSave={handleSaveEvent}
/>
          )}
        </div>
      );
    }

    // Reminders View
function RemindersView({ activeView, userTimezone }) {
      const [reminders, setReminders] = useState([]);
      const [loading, setLoading] = useState(true);
      const [showHistory, setShowHistory] = useState(false);
      const [showModal, setShowModal] = useState(false);
      const [editingReminder, setEditingReminder] = useState(null);
      const [filter, setFilter] = useState('all');
      const createReminderRef = useRef(null);

useEffect(() => {
  if (activeView === "reminders") {
    loadReminders();
  }
}, [showHistory, activeView]);

      const loadReminders = async () => {
        try {
          setLoading(true);
          const data = await apiCall(`/reminders?includeHistory=${showHistory}`);
          setReminders(data.reminders);
        } catch (error) {
          tg.showAlert('Failed to load reminders: ' + error.message);
        } finally {
          setLoading(false);
        }
      };

      const handleCreate = () => {
        setEditingReminder(null);
        setShowModal(true);
      };

      const handleEdit = (reminder) => {
        setEditingReminder(reminder);
        setShowModal(true);
      };

      const handleSave = async (data) => {
        try {
          if (editingReminder) {
            await apiCall(`/reminders/${editingReminder._id}`, {
              method: 'PUT',
              body: JSON.stringify(data),
            });
            tg.showAlert('Reminder updated!');
          } else {
            await apiCall('/reminders', {
              method: 'POST',
              body: JSON.stringify(data),
            });
            tg.showAlert('Reminder created!');
          }
          setShowModal(false);
          loadReminders();
        } catch (error) {
          tg.showAlert('Failed to save: ' + error.message);
        }
      };

      const handleSnooze = async (id, minutes) => {
        try {
          await apiCall(`/reminders/${id}/snooze`, {
            method: 'POST',
            body: JSON.stringify({ minutes }),
          });
          tg.showPopup({ message: `Snoozed for ${minutes} minutes` });
          loadReminders();
        } catch (error) {
          tg.showAlert('Failed to snooze: ' + error.message);
        }
      };

      const handleDone = async (id) => {
        try {
          await apiCall(`/reminders/${id}/done`, {
            method: 'POST',
          });
          tg.showPopup({ message: 'Marked as done!' });
          loadReminders();
        } catch (error) {
          tg.showAlert('Failed to mark as done: ' + error.message);
        }
      };

      const handleDelete = async (id) => {
        try {
          await apiCall(`/reminders/${id}`, {
            method: 'DELETE',
          });
          tg.showPopup({ message: 'Reminder deleted' });
          loadReminders();
        } catch (error) {
          tg.showAlert('Failed to delete: ' + error.message);
        }
      };

      const filteredReminders = reminders.filter(r => {
        if (filter === 'all') return true;
        return r.schedule?.kind === filter;
      });

      return (
        <div>
          <div className="header">
            <h1>Reminders</h1>
            <div className="toggle" onClick={() => setShowHistory(!showHistory)}>
              <span>History</span>
              <div className={`toggle-switch ${showHistory ? 'active' : ''}`} />
            </div>
          </div>

          <div className="quick-actions">
            <div
              className={`quick-action ${filter === 'all' ? 'active' : ''}`}
              onClick={() => setFilter('all')}
            >
              All
            </div>
            <div
              className={`quick-action ${filter === 'once' ? 'active' : ''}`}
              onClick={() => setFilter('once')}
            >
              Once
            </div>
            <div
              className={`quick-action ${filter === 'daily' ? 'active' : ''}`}
              onClick={() => setFilter('daily')}
            >
              Daily
            </div>
            <div
              className={`quick-action ${filter === 'weekly' ? 'active' : ''}`}
              onClick={() => setFilter('weekly')}
            >
              Weekly
            </div>
            <div
              className={`quick-action ${filter === 'interval' ? 'active' : ''}`}
              onClick={() => setFilter('interval')}
            >
              Interval
            </div>
          </div>

          {loading ? (
            <div className="loading">
              <div className="spinner" />
              <div>Loading reminders...</div>
            </div>
          ) : filteredReminders.length === 0 ? (
            <div className="empty-state">
              <div className="empty-state-icon">
  <img src="/icons/journal.svg" alt="" />
</div>
              <div className="empty-state-text">
                {filter === 'all'
                  ? 'No reminders yet.\nTap the + button to create one!'
                  : `No ${filter} reminders found.`}
              </div>
            </div>
          ) : (
            filteredReminders.map(reminder => (
              <ReminderCard
                key={reminder._id}
                reminder={reminder}
                onEdit={handleEdit}
                onSnooze={handleSnooze}
                onDone={handleDone}
                onDelete={handleDelete}
              />
            ))
          )}

<button
  ref={createReminderRef}
  data-create-reminder="1"
  onClick={handleCreate}
  className="is-hidden"
/>

          {showModal && (
  <ReminderModal
    reminder={editingReminder}
    onClose={() => setShowModal(false)}
    onSave={handleSave}
    userTimezone={userTimezone}
  />
)}
        </div>
      );
    }
    
    // SETTINGS VIEW
function SettingsView({ onBack }) {
  const [loading, setLoading] = useState(true);
  const [timezone, setTimezone] = useState("America/Chicago");
  const [saving, setSaving] = useState(false);

  useEffect(() => {
    document.body.classList.remove("modal-open"); // safety
  }, []);

  useEffect(() => {
    (async () => {
      try {
        setLoading(true);
        const data = await apiCall(`/settings`);
        if (data?.settings?.timezone) setTimezone(String(data.settings.timezone));
      } catch (e) {
        tg.showAlert("Failed to load settings: " + (e.message || "Unknown error"));
      } finally {
        setLoading(false);
      }
    })();
  }, []);

  const save = async () => {
    try {
      setSaving(true);
      await apiCall(`/settings`, {
        method: "PUT",
        body: JSON.stringify({ timezone }),
      });
      tg.showPopup({ message: "Settings saved" });
    } catch (e) {
      tg.showAlert("Failed to save: " + (e.message || "Unknown error"));
    } finally {
      setSaving(false);
    }
  };

  return (
    <div>
      <div className="header">
        <h1>Settings</h1>

        <div className="journal-header-actions">
          <button className="btn btn-secondary" type="button" onClick={onBack}>
            Back
          </button>
        </div>
      </div>

      {loading ? (
        <div className="loading">
          <div className="spinner" />
          <div>Loading settings...</div>
        </div>
      ) : (
        <>
          <div className="card" style={{ cursor: "default" }} onClick={(e) => e.stopPropagation()}>
            <div style={{ fontSize: 14, fontWeight: 700, marginBottom: 10 }}>
              Timezone
            </div>

            <div style={{ color: "var(--text-secondary)", fontSize: 13, lineHeight: 1.4, marginBottom: 12 }}>
              Use an IANA timezone like <b>Asia/Jakarta</b>. Offsets like <b>+7</b> can be mapped by the bot command too,
              but the stored value should be IANA.
            </div>

            <input
              className="form-input"
              value={timezone}
              onChange={(e) => setTimezone(e.target.value)}
              placeholder="e.g. Asia/Jakarta"
            />

            <div style={{ marginTop: 12, display: "flex", gap: 10 }}>
              <button className="btn btn-primary" type="button" onClick={save} disabled={saving}>
                {saving ? "Saving..." : "Save"}
              </button>
            </div>
          </div>
        </>
      )}
    </div>
  );
}

    // Main App Component
function App() {
  // --------------------
  // VIEW STATE
  // --------------------
  const [activeView, setActiveView] = useState("reminders");
  const [previousView, setPreviousView] = useState("reminders");

  // --------------------
  // USER SETTINGS STATE (NEW)
  // --------------------
  const [userTimezone, setUserTimezone] = useState("America/Chicago");

  // --------------------
  // LOAD USER SETTINGS (NEW)
  // --------------------
  useEffect(() => {
    (async () => {
      try {
        const data = await apiCall("/settings");
        if (data?.settings?.timezone) {
          setUserTimezone(String(data.settings.timezone));
        }
      } catch (e) {
        // intentionally silent – app still works with default
      }
    })();
  }, []);

  // --------------------
  // NAVIGATION HELPERS
  // --------------------
  function goTo(view) {
    setPreviousView(activeView);
    setActiveView(view);
  }

  function goBack() {
    setActiveView(previousView || "reminders");
  }

      const remindersViewRef = useRef(null);
      const calendarViewRef = useRef(null);

const handleFabClick = () => {
if (activeView === 'reminders') {
  const btn = document.querySelector('[data-create-reminder="1"]');
  if (btn) btn.click();
}

  else if (activeView === 'calendar') {
    const today = new Date();
    const todayBtn = document.querySelector(
      `[data-date="${today.toDateString()}"]`
    );
    if (todayBtn) todayBtn.click();
  }

  else if (activeView === 'journal') {
    const btn = document.querySelector('[data-create-journal="1"]');
    if (btn) btn.click();
  }
  else if (activeView === 'reading') {
  const btn = document.querySelector('[data-create-book="1"]');
  if (btn) btn.click();
}
};

return (
  <div className="app-shell">
    <div className="app-content">
      <div
        className={`view-container ${activeView === 'reminders' ? 'active' : ''}`}
        data-view="reminders"
      >
        <RemindersView activeView={activeView} userTimezone={userTimezone} />
      </div>

      <div
        className={`view-container ${activeView === 'calendar' ? 'active' : ''}`}
        data-view="calendar"
      >
        <CalendarView
  onOpenSettings={() => goTo("settings")}
  userTimezone={userTimezone}
/>
      </div>

      <div
        className={`view-container ${activeView === 'journal' ? 'active' : ''}`}
        data-view="journal"
      >
        <JournalsView activeView={activeView} />
      </div>
      
      <div
  className={`view-container ${activeView === 'reading' ? 'active' : ''}`}
  data-view="reading"
>
  <ReadingView activeView={activeView} />
</div>

<div
  className={`view-container ${activeView === 'settings' ? 'active' : ''}`}
  data-view="settings"
>
  <SettingsView onBack={goBack} />
</div>
    </div>

    <button className="fab" onClick={handleFabClick}>
      +
    </button>

    <div className="bottom-nav">
      <button
        className={`nav-item ${activeView === 'reminders' ? 'active' : ''}`}
        onClick={() => setActiveView('reminders')}
      >
        <div className="nav-item-icon">
  <img src="/icons/bell.svg" alt="" />
</div>
        <div className="nav-item-label">Reminders</div>
      </button>

      <button
        className={`nav-item ${activeView === 'calendar' ? 'active' : ''}`}
        onClick={() => setActiveView('calendar')}
      >
        <div className="nav-item-icon">
  <img src="/icons/calendar.svg" alt="" />
</div>
        <div className="nav-item-label">Calendar</div>
      </button>

      <button
        className={`nav-item ${activeView === 'journal' ? 'active' : ''}`}
        onClick={() => setActiveView('journal')}
      >
        <div className="nav-item-icon">
  <img src="/icons/page.svg" alt="" />
</div>
        <div className="nav-item-label">Journal</div>
      </button>
      
      <button
  className={`nav-item ${activeView === 'reading' ? 'active' : ''}`}
  onClick={() => setActiveView('reading')}
>
  <div className="nav-item-icon">
    <img src="/icons/book.svg" alt="" />
  </div>
  <div className="nav-item-label">Reading</div>
</button>
    </div>
  </div>
);
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
